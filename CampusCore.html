<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusCore - DPS Nadergul</title>
    <style>
        :root {
            --color-primary: #5ca870;
            --color-primary-hover: #4d9160;
            --color-secondary: #7ec490;
            --color-accent: #9dd4aa;
            --color-danger: #d32f2f;
            --color-warning: #f57c00;
            --color-success: #5ca870;
            --color-info: #1976d2;
            --color-border: #e0e0e0;
            --color-bg: #f5f5f5;
            --color-text: #333;
            --color-text-light: #666;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 50%, #9dd4aa 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        .login-container {
            display: flex;
            min-height: 100vh;
            background: #ffffff;
        }

        .login-left {
            width: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            background: #2d7a6e;
            padding: 80px 60px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .login-left h1 {
            font-size: 64px;
            font-weight: 900;
            margin-bottom: 20px;
            letter-spacing: 3px;
            position: relative;
            z-index: 1;
            text-transform: uppercase;
            font-family: Arial, sans-serif;
        }

        .login-left p {
            font-size: 22px;
            font-weight: 300;
            position: relative;
            z-index: 1;
            margin-bottom: 60px;
            font-family: Arial, sans-serif;
        }

        .login-illustration {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1;
            width: 100%;
            max-width: 150px;
        }

        .login-illustration svg {
            width: 100%;
            height: auto;
        }

        .login-right {
            width: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            background: #e8e8e8;
        }

        .login-box {
            width: 90%;
            max-width: 400px;
            background: white;
            padding: 0;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            overflow: hidden;
            position: relative;
        }

        .login-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: #5ca870;
        }

        .login-box-content {
            padding: 40px 35px;
        }

        .login-box h2 {
            display: none;
        }

        .login-box .subtitle {
            display: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #888;
            font-size: 13px;
            text-transform: capitalize;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: Arial, sans-serif;
            transition: all 0.3s;
            background: #f8f8f8;
            color: #666;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #5ca870;
            background: white;
            box-shadow: 0 0 0 3px rgba(92, 168, 112, 0.1);
        }

        .form-group input::placeholder {
            color: #aaa;
        }

        .password-wrapper {
            position: relative;
        }

        .password-wrapper input {
            padding-right: 40px;
        }

        .toggle-password {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
            color: #999;
        }

        .toggle-password:hover {
            color: #5ca870;
        }

        .btn-login {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            background: #5ca870;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            margin-top: 12px;
            box-shadow: none;
            font-family: Arial, sans-serif;
            text-transform: capitalize;
        }

        .btn-login:hover {
            background: #4d9160;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(92, 168, 112, 0.3);
        }

        .btn-login:active {
            transform: translateY(0);
        }

        .login-error {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: #fadbd8;
            color: #c0392b;
            border-radius: 6px;
            font-size: 13px;
            border-left: 4px solid #c0392b;
        }

        .login-success {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: #d5f4e6;
            color: #27ae60;
            border-radius: 6px;
            font-size: 13px;
            border-left: 4px solid #27ae60;
        }

        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #5ca870 0%, #4d9160 100%);
            color: white;
            padding: 25px;
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
            border-right: 4px solid #7ec490;
        }

        .logo-section {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--color-secondary);
        }

        .logo-icon {
            width: 55px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 28px;
            margin-right: 15px;
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .logo-text h2 {
            font-size: 22px;
            margin: 0;
            font-weight: 800;
            font-family: 'Georgia', serif;
        }

        .logo-text p {
            font-size: 12px;
            margin: 3px 0 0 0;
            opacity: 0.9;
            font-style: italic;
        }

        .user-block {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .user-avatar {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.25);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 32px;
            font-weight: 800;
            border: 3px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: white;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .user-id {
            font-size: 12px;
            opacity: 0.8;
        }

        .user-role {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
            text-transform: uppercase;
        }

        .menu {
            list-style: none;
        }

        .menu-item {
            margin-bottom: 5px;
        }

        .menu-link {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            font-weight: 600;
        }

        .menu-link:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateX(5px);
        }

        .menu-link.active {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            font-weight: 700;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .menu-icon {
            width: 20px;
            margin-right: 12px;
            text-align: center;
            font-size: 16px;
        }

        .logout-btn {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: rgba(231, 76, 60, 0.2);
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin-top: 30px;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: rgba(231, 76, 60, 0.4);
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            background: #ffffff;
        }

        .header-banner {
            background: linear-gradient(135deg, #5ca870 0%, #4d9160 50%, #7ec490 100%);
            color: white;
            padding: 45px 35px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 5px solid #7ec490;
            box-shadow: 0 6px 24px rgba(92, 168, 112, 0.2);
        }

        .header-banner::before {
            content: 'üìö ‚úèÔ∏è üéì üìñ ‚úíÔ∏è';
            position: absolute;
            font-size: 60px;
            opacity: 0.08;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            letter-spacing: 40px;
            white-space: nowrap;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translate(-50%, -50%);
            }
            50% {
                transform: translate(-50%, -52%);
            }
        }

        .header-banner h1 {
            font-size: 34px;
            margin-bottom: 12px;
            font-family: 'Georgia', serif;
            font-weight: 800;
            letter-spacing: 1.5px;
            text-shadow: 0 3px 12px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        .header-banner p {
            font-size: 16px;
            opacity: 0.95;
            font-style: italic;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .content-area {
            background: linear-gradient(135deg, #fafafa 0%, #f0f9f3 100%);
            padding: 35px;
            min-height: calc(100vh - 150px);
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 6px 24px rgba(46, 125, 50, 0.08);
            border: 2px solid var(--color-accent);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-secondary) 100%);
        }

        .card:hover {
            box-shadow: 0 10px 35px rgba(46, 125, 50, 0.12);
            transform: translateY(-5px);
            border-color: var(--color-secondary);
        }

        .card h3 {
            color: var(--color-primary);
            margin-bottom: 25px;
            font-size: 26px;
            font-weight: 800;
            font-family: 'Georgia', serif;
            border-bottom: 2px solid rgba(129, 199, 132, 0.3);
            padding-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .card h4 {
            color: var(--color-primary);
            margin-bottom: 18px;
            font-size: 19px;
            font-weight: 700;
            font-family: 'Georgia', serif;
            display: flex;
            align-items: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, white 0%, #f1f8e9 100%);
            padding: 28px;
            border-radius: 14px;
            box-shadow: 0 5px 18px rgba(46, 125, 50, 0.12);
            border: 2px solid var(--color-secondary);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(180deg, var(--color-primary) 0%, var(--color-secondary) 100%);
        }

        .stat-card::after {
            content: '';
            position: absolute;
            bottom: -50px;
            right: -50px;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(129, 199, 132, 0.15) 0%, transparent 70%);
            border-radius: 50%;
        }

        .stat-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 10px 30px rgba(46, 125, 50, 0.18);
            border-color: var(--color-primary);
        }

        .stat-value {
            font-size: 44px;
            font-weight: 900;
            color: var(--color-primary);
            margin-bottom: 10px;
            font-family: 'Georgia', serif;
            text-shadow: 0 2px 8px rgba(46, 125, 50, 0.15);
            position: relative;
            z-index: 1;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            position: relative;
            z-index: 1;
        }

        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 18px;
            margin-bottom: 25px;
        }

        .attendance-stat {
            padding: 24px 20px;
            border-radius: 14px;
            text-align: center;
            color: white;
            box-shadow: 0 5px 18px rgba(0, 0, 0, 0.18);
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.4);
            position: relative;
            overflow: hidden;
        }

        .attendance-stat::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
            border-radius: 50%;
        }

        .attendance-stat:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.28);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .attendance-stat.present {
            background: linear-gradient(135deg, #5ca870 0%, #4d9160 100%);
        }

        .attendance-stat.absent {
            background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);
        }

        .attendance-stat.late {
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
        }

        .attendance-stat-number {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 8px;
            font-family: 'Georgia', serif;
            text-shadow: 0 3px 10px rgba(0, 0, 0, 0.25);
            position: relative;
            z-index: 1;
        }

        .attendance-stat-label {
            font-size: 13px;
            opacity: 0.95;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            position: relative;
            z-index: 1;
        }

        .attendance-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(46, 125, 50, 0.08);
            border: 2px solid rgba(129, 199, 132, 0.3);
        }

        .attendance-table th,
        .attendance-table td {
            padding: 16px 18px;
            text-align: left;
            border-bottom: 1px solid rgba(129, 199, 132, 0.2);
            font-size: 14px;
        }

        .attendance-table th {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: white;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-size: 12px;
            border-bottom: none;
        }

        .attendance-table tbody tr {
            transition: all 0.3s ease;
            background: white;
        }

        .attendance-table tbody tr:hover {
            background: linear-gradient(135deg, #f9fdf9 0%, #f1f8f1 100%);
            transform: translateX(3px);
        }

        .attendance-table tbody tr:last-child td {
            border-bottom: none;
        }

        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-present {
            background: linear-gradient(135deg, #5ca870 0%, #4d9160 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(92, 168, 112, 0.3);
        }

        .badge-absent {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }

        .badge-late {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
        }

        .badge-good {
            background: linear-gradient(135deg, #7ec490 0%, #5ca870 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(92, 168, 112, 0.3);
        }

        .badge-excellent {
            background: linear-gradient(135deg, #5ca870 0%, #4d9160 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(92, 168, 112, 0.3);
        }

        .badge-distracting {
            background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(239, 83, 80, 0.3);
        }

        .form-section {
            background: linear-gradient(135deg, white 0%, #fafdf8 100%);
            padding: 28px;
            border-radius: 14px;
            margin-bottom: 24px;
            border: 2px solid rgba(129, 199, 132, 0.3);
            border-left: 5px solid var(--color-primary);
            box-shadow: 0 4px 16px rgba(46, 125, 50, 0.08);
            transition: all 0.3s ease;
        }

        .form-section:hover {
            box-shadow: 0 6px 20px rgba(46, 125, 50, 0.12);
            border-left-color: var(--color-secondary);
        }

        .form-section h4 {
            color: var(--color-primary);
            margin-bottom: 20px;
            font-family: 'Georgia', serif;
            font-weight: 700;
            font-size: 19px;
            border-bottom: 2px solid rgba(129, 199, 132, 0.3);
            padding-bottom: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-control {
            display: flex;
            flex-direction: column;
        }

        .form-control label {
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 13px;
            color: var(--color-text);
        }

        .form-control input,
        .form-control select,
        .form-control textarea {
            padding: 12px;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Georgia', 'Times New Roman', serif;
            transition: all 0.3s;
            background: white;
        }

        .form-control input:focus,
        .form-control select:focus,
        .form-control textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 4px rgba(139, 21, 56, 0.1);
            background: linear-gradient(135deg, #ffffff 0%, #fffef8 100%);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #5ca870 0%, #4d9160 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(92, 168, 112, 0.3);
            font-family: 'Georgia', serif;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #4d9160 0%, #5ca870 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(92, 168, 112, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(229, 57, 53, 0.3);
            font-family: 'Georgia', serif;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(229, 57, 53, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #7ec490 0%, #5ca870 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(92, 168, 112, 0.3);
            font-family: 'Georgia', serif;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #5ca870 0%, #4d9160 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(92, 168, 112, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
            font-family: 'Georgia', serif;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #5a6268 0%, #545b62 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }

        /* Modal System */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            position: relative;
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-icon {
            font-size: 32px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-icon.success {
            background: linear-gradient(135deg, #7ec490 0%, #5ca870 100%);
        }

        .modal-icon.error {
            background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
        }

        .modal-icon.warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        .modal-icon.info {
            background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: #2c3e50;
            font-family: 'Georgia', serif;
            margin: 0;
        }

        .modal-message {
            font-size: 16px;
            color: #555;
            line-height: 1.6;
            margin-bottom: 25px;
            font-family: 'Georgia', serif;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.3s;
            font-family: 'Georgia', serif;
        }

        .modal-btn-confirm {
            background: linear-gradient(135deg, #5ca870 0%, #4d9160 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(92, 168, 112, 0.3);
        }

        .modal-btn-confirm:hover {
            background: linear-gradient(135deg, #4d9160 0%, #5ca870 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(92, 168, 112, 0.4);
        }

        .modal-btn-cancel {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .modal-btn-cancel:hover {
            background: linear-gradient(135deg, #5a6268 0%, #545b62 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }

        .modal-btn-danger {
            background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(229, 57, 53, 0.3);
        }

        .modal-btn-danger:hover {
            background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(229, 57, 53, 0.4);
        }

        .issue-card {
            background: white;
            border-left: 5px solid var(--color-warning);
            padding: 20px;
            margin-bottom: 18px;
            border-radius: 12px;
            border: 2px solid rgba(245, 124, 0, 0.15);
            box-shadow: 0 4px 14px rgba(245, 124, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .issue-card::before {
            content: '‚ö†Ô∏è';
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            opacity: 0.1;
        }

        .issue-card:hover {
            box-shadow: 0 6px 22px rgba(245, 124, 0, 0.15);
            transform: translateX(5px);
            border-color: var(--color-warning);
        }

        .issue-card.critical {
            border-left-color: var(--color-danger);
            background: linear-gradient(135deg, #fff 0%, #fff8f7 100%);
            border-color: rgba(211, 47, 47, 0.15);
            box-shadow: 0 4px 14px rgba(211, 47, 47, 0.1);
        }

        .issue-card.critical::before {
            content: 'üö®';
        }

        .issue-card.critical:hover {
            box-shadow: 0 6px 22px rgba(211, 47, 47, 0.15);
            border-color: var(--color-danger);
        }

        .holiday-list {
            background: white;
            border-radius: 14px;
            overflow: hidden;
            border: 2px solid rgba(129, 199, 132, 0.3);
            box-shadow: 0 4px 16px rgba(46, 125, 50, 0.08);
        }

        .holiday-item {
            padding: 18px 24px;
            border-bottom: 1px solid rgba(129, 199, 132, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            background: white;
            position: relative;
        }

        .holiday-item::before {
            content: 'üéâ';
            position: absolute;
            left: -30px;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .holiday-item:hover {
            background: linear-gradient(135deg, #f9fdf9 0%, #f1f8f1 100%);
            padding-left: 32px;
            box-shadow: inset 4px 0 0 var(--color-secondary);
        }

        .holiday-item:hover::before {
            left: 8px;
        }

        .holiday-item:last-child {
            border-bottom: none;
        }

        .holiday-date {
            font-weight: 700;
            color: var(--color-primary);
            font-family: 'Georgia', serif;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .holiday-reason {
            font-size: 14px;
            color: var(--color-text-light);
            font-style: italic;
            margin-top: 4px;
        }

        .timetable {
            overflow-x: auto;
        }

        .timetable-grid {
            display: grid;
            grid-template-columns: 100px repeat(6, 1fr);
            gap: 2px;
            background: rgba(129, 199, 132, 0.3);
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(46, 125, 50, 0.08);
        }

        .timetable-cell {
            background: white;
            padding: 16px 14px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .timetable-cell:hover {
            background: linear-gradient(135deg, #f9fdf9 0%, #f1f8f1 100%);
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.15);
        }

        .timetable-cell.header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: white;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            padding: 18px 14px;
        }

        .timetable-cell.time {
            background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);
            font-weight: 700;
            color: var(--color-primary);
            font-size: 12px;
            border-right: 2px solid rgba(129, 199, 132, 0.3);
        }

        .search-box {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid rgba(129, 199, 132, 0.3);
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 20px;
            font-family: 'Georgia', 'Times New Roman', serif;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(46, 125, 50, 0.05);
        }

        .search-box:focus {
            outline: none;
            border-color: var(--color-secondary);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.12);
            background: linear-gradient(135deg, #ffffff 0%, #f9fdf9 100%);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 16px 18px;
            border: 2px solid rgba(129, 199, 132, 0.3);
            border-radius: 12px;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .checkbox-item:hover {
            background: linear-gradient(135deg, #f9fdf9 0%, #f1f8f1 100%);
            border-color: var(--color-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.12);
        }

        .checkbox-item input {
            margin-right: 14px;
            cursor: pointer;
            width: 20px;
            height: 20px;
            accent-color: var(--color-primary);
        }

        .checkbox-item input:checked {
            transform: scale(1.1);
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            flex: 1;
            font-weight: 500;
            color: var(--color-text);
            font-size: 14px;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }

        @media (max-width: 768px) {
            .login-left {
                display: none;
            }

            .login-right {
                width: 100%;
            }

            .sidebar {
                width: 70px;
            }

            .menu-link span:last-child {
                display: none;
            }

            .header-banner {
                padding: 30px 20px;
            }

            .header-banner h1 {
                font-size: 24px;
            }

            .content-area {
                padding: 20px;
            }

            .card {
                padding: 20px;
            }

            .stat-card {
                padding: 20px;
            }

            .attendance-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .timetable-grid {
                grid-template-columns: 80px repeat(3, 1fr);
                font-size: 11px;
            }

            .timetable-cell:hover {
                transform: scale(1.02);
            }
        }
    </style>
</head>
<body>

<div id="loginScreen" class="login-container">
    <div class="login-left">
        <div>
            <h1>CAMPUSCORE</h1>
            <p>The Bridge to a Smarter Tomorrow</p>
        </div>
        <div class="login-illustration">
            <img src="logo.png" alt="School Logo" style="width: 100%; height: auto; mix-blend-mode: multiply; opacity: 0.95;">
        </div>
    </div>

    <div class="login-right">
        <div class="login-box">
            <div class="login-box-content">
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="role">Role</label>
                        <select id="role" required>
                            <option value="">Role</option>
                            <option value="parent">Parent</option>
                            <option value="teacher">Teacher</option>
                            <option value="coordinator">Coordinator</option>
                            <option value="viceprincipal">Vice Principal</option>
                            <option value="classteacher">Class Teacher</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="username">Username</label>
                        <input id="username" type="text" placeholder="Username" required>
                    </div>

                    <div class="form-group">
                        <label for="password">Password</label>
                        <div class="password-wrapper">
                            <input id="password" type="password" placeholder="Password" required>
                            <button id="togglePassword" type="button" class="toggle-password" title="Toggle password visibility">üëÅÔ∏è</button>
                        </div>
                    </div>

                    <button type="submit" class="btn-login">Sign In</button>
                    <div id="loginSuccess" class="login-success"></div>
                    <div id="loginError" class="login-error"></div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="dashboardScreen" class="dashboard" style="display: none;">
    <aside class="sidebar">
        <div class="logo-section">
            <div class="logo-icon"><img src="campus-logo.png" alt="CampusCore Logo"></div>
            <div class="logo-text">
                <h2>CampusCore</h2>
                <p>DPS Nadergul</p>
            </div>
        </div>

        <div class="user-block">
            <div id="userAvatar" class="user-avatar">A</div>
            <div id="userName" class="user-name">User</div>
            <div id="userId" class="user-id">ID: N/A</div>
            <div id="userRole" class="user-role">Role</div>
            <div style="margin-top: 10px; font-size: 10px; opacity: 0.7; text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px;">
                <span style="width: 6px; height: 6px; background: #4caf50; border-radius: 50%; display: inline-block; animation: pulse 2s infinite;"></span>
                Real-time Sync Active
            </div>
        </div>

        <ul id="menuItems" class="menu"></ul>

        <button id="logoutBtn" class="logout-btn" type="button">üö™ Logout</button>
    </aside>

    <main class="main-content">
        <div class="header-banner">
            <h1 id="headerTitle">Welcome to CampusCore</h1>
            <p id="headerSub">Smart School Management Dashboard</p>
        </div>

        <div id="contentArea" class="content-area"></div>
    </main>
</div>

<script>
const DATABASE = {
    students: [
        { id: 3180076, name: 'Kasula Ashwath', class: '8B', parentId: 'P3180076A', status: 'active' },
        { id: 3180077, name: 'Srikar', class: '8B', parentId: 'P3180077A', status: 'active' },
        { id: 3180078, name: 'Fatima', class: '8B', parentId: 'P3180078A', status: 'active' },
        { id: 3240504, name: 'Sai Charan', class: '8B', parentId: 'P3240504A', status: 'active' },
        { id: 3180079, name: 'Dhyuthi', class: '10A', parentId: 'P3180079A', status: 'active' },
        { id: 3180080, name: 'Sricharan', class: '10A', parentId: 'P3180080A', status: 'active' }
    ],
    parents: [
        { id: 'P3180076A', name: 'Parent of Kasula', studentId: 3180076, phone: '9876543210' },
        { id: 'P3180077A', name: 'Parent of Srikar', studentId: 3180077, phone: '9876543211' },
        { id: 'P3180078A', name: 'Parent of Fatima', studentId: 3180078, phone: '9876543212' },
        { id: 'P3240504A', name: 'Parent of Sai Charan', studentId: 3240504, phone: '9876543213' },
        { id: 'P3180079A', name: 'Parent of Dhyuthi', studentId: 3180079, phone: '9876543214' },
        { id: 'P3180080A', name: 'Parent of Sricharan', studentId: 3180080, phone: '9876543215' }
    ],
    teachers: [
        { id: 'T001', name: 'English Teacher', subjects: 'English', classes: '10A', status: 'active' },
        { id: 'T002', name: 'Math Teacher', subjects: 'Mathematics', classes: '10A,10B', status: 'active' },
        { id: 'T003', name: 'Science Teacher', subjects: 'Physics', classes: '10A', status: 'active' }
    ],
    classteachers: [
        { id: 'CT10A', name: 'PRASNA KUMAR', class: '10A', status: 'active' },
        { id: 'CT8B', name: 'Class Teacher 8B', class: '8B', status: 'active' }
    ],
    coordinators: [
        { id: 'C001', name: 'ANITHA', department: 'General', status: 'active' }
    ],
    viceprincipals: [
        { id: 'VP001', name: 'Srishia Vice Principal', school: 'DPS Nadergul', status: 'active' }
    ],
    superviceprincipals: [
        { id: 'AP000123', name: 'Super Principal', school: 'DPS Nadergul', status: 'active' }
    ],
    attendance: [],
    issues: [],
    homework: [],
    examSchedules: [],
    examResults: [],
    teacherTimetables: [],
    teacherAppointments: [],
    marksSubmissions: [],
    studentDocuments: [],
    bulkUploads: [],
    reportCards: [],
    teacherDuties: [],
    holidays: [
        { date: '2025-12-25', reason: 'Christmas' },
        { date: '2026-01-26', reason: 'Republic Day' },
        { date: '2026-03-08', reason: 'Maha Shivaratri' }
    ],
    ccaCalendars: [],
    classes: [],
    timetables: [
        {
            class: '10A',
            periods: [
                { time: '8:00-8:45', mon: 'English', tue: 'Math', wed: 'Science', thu: 'Hindi', fri: 'History', sat: 'PE' },
                { time: '8:45-9:30', mon: 'Math', tue: 'English', wed: 'History', thu: 'Science', fri: 'Geography', sat: 'Art' },
                { time: '9:30-10:15', mon: 'Science', tue: 'Hindi', wed: 'English', thu: 'Geography', fri: 'Math', sat: 'Music' }
            ]
        },
        {
            class: '8B',
            periods: [
                { time: '8:45-9:30', mon: 'MATH', tue: 'MATH', wed: 'LIBRARY', thu: 'PYS', fri: 'GK/VE', sat: 'LS' },
                { time: '9:30-10:15', mon: 'CD/WD', tue: 'GAMES', wed: 'PHYSICS', thu: 'PYS', fri: 'COMPUTER', sat: 'Art' },
                { time: '10:15-10:25', mon: 'Break', tue: 'Break', wed: 'Break', thu: 'Break', fri: 'Break', sat: 'Break' },
                { time: '10:25-11:10', mon: 'MATH', tue: '3L', wed: 'MUSIC', thu: 'MATH', fri: '2L', sat: 'Music' },
                { time: '11:10-11:45', mon: 'ENGLISH', tue: 'MATH', wed: '2L', thu: 'BIOLOGY', fri: 'SOCIAL', sat: '3L' },
                { time: '11:45-12:30', mon: 'BIOLOGY', tue: '2L', wed: '3L', thu: 'PHYSICS', fri: 'BIOLOGY', sat: '2L' },
                { time: '12:30-01:10', mon: 'Lunch', tue: 'Lunch', wed: 'Lunch', thu: 'Lunch', fri: 'Lunch', sat: 'Lunch' },
                { time: '01:10-01:55', mon: 'SOCIAL', tue: 'SOCIAL', wed: 'MATH', thu: 'SOCIAL', fri: 'CHEMHISTORY', sat: 'CHEMHISTORY' },
                { time: '01:55-02:40', mon: '2L', tue: 'PHYSICS', wed: 'SOCIAL', thu: 'ENGLISH', fri: 'English', sat: 'SOCIAL' },
                { time: '02:40-03:25', mon: 'Computer', tue: 'ENGLISH', wed: 'Computer', thu: '2L', fri: 'MATH', sat: 'MATH' }
            ]
        }
    ],
    users: [
        { username: 'P3180076A', password: 'parent123', role: 'parent', name: 'Ashwath Parent' },
        { username: 'P3180077A', password: 'parent123', role: 'parent', name: 'Srikar Parent' },
        { username: 'P3180078A', password: 'parent123', role: 'parent', name: 'Fatima Parent' },
        { username: 'P3240504A', password: 'parent123', role: 'parent', name: 'Sai Charan Parent' },
        { username: 'P3180079A', password: 'parent123', role: 'parent', name: 'Dhyuthi Parent' },
        { username: 'P3180080A', password: 'parent123', role: 'parent', name: 'Sricharan Parent' },
        { username: 'T001', password: 'teacher123', role: 'teacher', name: 'English Teacher' },
        { username: 'T002', password: 'teacher123', role: 'teacher', name: 'Math Teacher' },
        { username: 'T003', password: 'teacher123', role: 'teacher', name: 'Science Teacher' },
        { username: 'C001', password: 'coord123', role: 'coordinator', name: 'Coordinator Anitha' },
        { username: 'VP001', password: 'VP123', role: 'viceprincipal', name: 'Srishia Vice Principal' },
        { username: 'AP000123', password: 'DPSSITE123', role: 'superviceprincipal', name: 'Super Principal' },
        { username: 'CT10A', password: 'CLASS123', role: 'classteacher', name: 'Class Teacher 10A' },
        { username: 'CT8B', password: 'CLASS123', role: 'classteacher', name: 'Class Teacher 8B' }
    ]
};

let currentUser = null;
let db = null;

function getDB() {
    try {
        const saved = localStorage.getItem('campusCoreDB');
        const loadedDB = saved ? JSON.parse(saved) : DATABASE;

        // Ensure all required fields exist (for backward compatibility)
        if (!loadedDB.examResults) {
            loadedDB.examResults = [];
        }
        if (!loadedDB.teacherTimetables) {
            loadedDB.teacherTimetables = [];
        }
        if (!loadedDB.teacherAppointments) {
            loadedDB.teacherAppointments = [];
        }
        if (!loadedDB.marksSubmissions) {
            loadedDB.marksSubmissions = [];
        }
        if (!loadedDB.reportCards) {
            loadedDB.reportCards = [];
        }

        return loadedDB;
    } catch (e) {
        return DATABASE;
    }
}

function saveDB() {
    try {
        db.lastUpdated = Date.now();
        localStorage.setItem('campusCoreDB', JSON.stringify(db));
        // Broadcast change to other tabs
        localStorage.setItem('campusCoreDB_sync', Date.now().toString());
    } catch (e) {
        console.warn('DB save failed:', e);
    }
}

function initDB() {
    if (!localStorage.getItem('campusCoreDB')) {
        localStorage.setItem('campusCoreDB', JSON.stringify(DATABASE));
    }
    db = getDB();
}

// Modal System Functions
function showModal(title, message, type = 'info') {
    // Close any existing modal first
    const existingModal = document.querySelector('.modal-overlay');
    if (existingModal) {
        existingModal.remove();
    }

    // Determine icon based on type
    const icons = {
        success: '‚úì',
        error: '‚úï',
        warning: '‚ö†',
        info: '‚Ñπ'
    };

    const icon = icons[type] || icons.info;

    // Create modal
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay';
    modalOverlay.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon ${type}">${icon}</div>
                <h3 class="modal-title">${title}</h3>
            </div>
            <div class="modal-message">${message}</div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-confirm" onclick="closeModal()">OK</button>
            </div>
        </div>
    `;

    document.body.appendChild(modalOverlay);

    // Close on overlay click
    modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
            closeModal();
        }
    });

    // Close on ESC key
    const escHandler = (e) => {
        if (e.key === 'Escape') {
            closeModal();
            document.removeEventListener('keydown', escHandler);
        }
    };
    document.addEventListener('keydown', escHandler);
}

function showConfirm(title, message, onConfirm, onCancel = null, confirmText = 'Confirm', cancelText = 'Cancel', isDangerous = false) {
    // Close any existing modal first
    const existingModal = document.querySelector('.modal-overlay');
    if (existingModal) {
        existingModal.remove();
    }

    // Create modal
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay';

    const confirmBtnClass = isDangerous ? 'modal-btn-danger' : 'modal-btn-confirm';

    modalOverlay.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon warning">‚ö†</div>
                <h3 class="modal-title">${title}</h3>
            </div>
            <div class="modal-message">${message}</div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal(false)">${cancelText}</button>
                <button class="modal-btn ${confirmBtnClass}" onclick="closeModal(true)">${confirmText}</button>
            </div>
        </div>
    `;

    document.body.appendChild(modalOverlay);

    // Store callbacks
    window._modalConfirmCallback = onConfirm;
    window._modalCancelCallback = onCancel;

    // Close on overlay click (treated as cancel)
    modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
            closeModal(false);
        }
    });

    // Close on ESC key (treated as cancel)
    const escHandler = (e) => {
        if (e.key === 'Escape') {
            closeModal(false);
            document.removeEventListener('keydown', escHandler);
        }
    };
    document.addEventListener('keydown', escHandler);
}

function closeModal(confirmed = null) {
    const modalOverlay = document.querySelector('.modal-overlay');
    if (modalOverlay) {
        modalOverlay.remove();
    }

    // Handle confirm/cancel callbacks
    if (confirmed === true && window._modalConfirmCallback) {
        window._modalConfirmCallback();
        delete window._modalConfirmCallback;
        delete window._modalCancelCallback;
    } else if (confirmed === false && window._modalCancelCallback) {
        window._modalCancelCallback();
        delete window._modalConfirmCallback;
        delete window._modalCancelCallback;
    }
}

function showError(msg) {
    const err = document.getElementById('loginError');
    const suc = document.getElementById('loginSuccess');
    if (err) {
        err.textContent = msg;
        err.style.display = 'block';
    }
    if (suc) suc.style.display = 'none';
}

function showSuccess(msg) {
    const suc = document.getElementById('loginSuccess');
    const err = document.getElementById('loginError');
    if (suc) {
        suc.textContent = msg;
        suc.style.display = 'block';
    }
    if (err) err.style.display = 'none';
}

function showLogin() {
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('dashboardScreen').style.display = 'none';
}

function showDashboard() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('dashboardScreen').style.display = 'flex';
    renderUserInfo();
    renderMenu();
    renderDefaultTab();
}

function handleLogin(event) {
    event.preventDefault();

    const role = document.getElementById('role').value;
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();

    if (!role) {
        showError('Please select a role.');
        return;
    }

    if (!username || !password) {
        showError('Please enter username and password.');
        return;
    }

    // Allow Super VP to login through Vice Principal option
    let user = null;
    if (role === 'viceprincipal') {
        user = db.users.find(u =>
            u.username === username &&
            u.password === password &&
            (u.role === 'viceprincipal' || u.role === 'superviceprincipal')
        );
    } else {
        user = db.users.find(u =>
            u.username === username &&
            u.password === password &&
            u.role === role
        );
    }

    if (!user) {
        showError('Invalid credentials. Please try again.');
        return;
    }

    if (user.status === 'inactive') {
        showError('Your account has been deactivated. Please contact administration.');
        return;
    }

    currentUser = { ...user };
    try {
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
    } catch (e) {}

    showSuccess('‚úÖ Login successful! Redirecting...');
    setTimeout(showDashboard, 500);
}

document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.getElementById('togglePassword');
    if (toggleBtn) {
        toggleBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const pwd = document.getElementById('password');
            if (pwd.type === 'password') {
                pwd.type = 'text';
                this.textContent = 'üôà';
            } else {
                pwd.type = 'password';
                this.textContent = 'üëÅÔ∏è';
            }
        });
    }

    initDB();
    try {
        const saved = localStorage.getItem('currentUser');
        if (saved) {
            currentUser = JSON.parse(saved);
            if (db.users.some(u => u.username === currentUser.username)) {
                showDashboard();
            } else {
                localStorage.removeItem('currentUser');
                showLogin();
            }
        } else {
            showLogin();
        }
    } catch (e) {
        showLogin();
    }
});

function renderUserInfo() {
    let userData = { name: currentUser.name, id: currentUser.username, role: currentUser.role };

    if (currentUser.role === 'parent') {
        const student = db.students.find(s => s.parentId === currentUser.username);
        if (student) {
            userData.id = student.id;
            userData.name = student.name;
        }
    }

    const avatar = document.getElementById('userAvatar');
    const uname = document.getElementById('userName');
    const uid = document.getElementById('userId');
    const urole = document.getElementById('userRole');

    if (avatar) avatar.textContent = userData.name ? userData.name.charAt(0).toUpperCase() : 'U';
    if (uname) uname.textContent = userData.name || 'User';
    if (uid) uid.textContent = 'ID: ' + (userData.id || 'N/A');
    if (urole) urole.textContent = currentUser.role.toUpperCase();
}

function renderMenu() {
    const menu = document.getElementById('menuItems');
    menu.innerHTML = '';

    const menuItems = {
        parent: [
            { name: 'Home', icon: 'üè†', tab: 'home' },
            { name: 'Attendance', icon: 'üìã', tab: 'attendance' },
            { name: 'Homework', icon: 'üìö', tab: 'viewhomework' },
            { name: 'Exam Results', icon: 'üìä', tab: 'viewexamresults' },
            { name: 'Report Cards', icon: 'üìã', tab: 'viewreportcards' },
            { name: 'Exam Schedule', icon: 'üìÖ', tab: 'examschedule' },
            { name: 'Timetable', icon: '‚è∞', tab: 'timetable' },
            { name: 'Profile', icon: 'üë§', tab: 'profile' },
            { name: 'Change Password', icon: 'üîê', tab: 'changepassword' }
        ],
        teacher: [
            { name: 'Home', icon: 'üè†', tab: 'home' },
            { name: 'My Duties', icon: 'üìã', tab: 'myduties' },
            { name: 'Mark Attendance', icon: '‚úÖ', tab: 'markattendance' },
            { name: 'Homework', icon: 'üìö', tab: 'homework' },
            { name: 'Exam Results', icon: 'üìä', tab: 'examresults' },
            { name: 'Upload Marks', icon: 'üìù', tab: 'uploadmarks' },
            { name: 'My Classes', icon: 'üìñ', tab: 'myclasses' },
            { name: 'Timetable', icon: '‚è∞', tab: 'timetable' },
            { name: 'Report Issues', icon: '‚ö†Ô∏è', tab: 'teacherissues' },
            { name: 'Profile', icon: 'üë§', tab: 'profile' },
            { name: 'Change Password', icon: 'üîê', tab: 'changepassword' }
        ],
        coordinator: [
            { name: 'Home', icon: 'üè†', tab: 'home' },
            { name: 'Manage Issues', icon: '‚ö†Ô∏è', tab: 'coordissues' },
            { name: 'Homework', icon: 'üìö', tab: 'homework' },
            { name: 'Exam Schedule', icon: 'üìã', tab: 'uploadexam' },
            { name: 'Classes', icon: 'üè´', tab: 'classes' },
            { name: 'Timetable', icon: '‚è∞', tab: 'managetimetable' },
            { name: 'CCA Calendar', icon: 'üìÖ', tab: 'uploadcca' },
            { name: 'Profile', icon: 'üë§', tab: 'profile' },
            { name: 'Change Password', icon: 'üîê', tab: 'changepassword' }
        ],
        viceprincipal: [
            { name: 'Home', icon: 'üè†', tab: 'home' },
            { name: 'Appoint Teacher', icon: 'üë®‚Äçüè´', tab: 'appointteacher' },
            { name: 'Assign Duties', icon: 'üìù', tab: 'assignduties' },
            { name: 'Issues', icon: '‚ö†Ô∏è', tab: 'vpissues' },
            { name: 'Homework', icon: 'üìö', tab: 'homework' },
            { name: 'Remove Student', icon: 'üö´', tab: 'removestudent' },
            { name: 'Holidays', icon: 'üéâ', tab: 'holidays' },
            { name: 'Classes', icon: 'üè´', tab: 'classes' },
            { name: 'Register', icon: 'üìù', tab: 'register' },
            { name: 'Timetable', icon: '‚è∞', tab: 'managetimetable' },
            { name: 'Analytics', icon: 'üìä', tab: 'analytics' },
            { name: 'Profile', icon: 'üë§', tab: 'profile' },
            { name: 'Change Password', icon: 'üîê', tab: 'changepassword' }
        ],
        superviceprincipal: [
            { name: 'Home', icon: 'üè†', tab: 'home' },
            { name: 'Appoint Teacher', icon: 'üë®‚Äçüè´', tab: 'appointteacher' },
            { name: 'Assign Duties', icon: 'üìù', tab: 'assignduties' },
            { name: 'Issues', icon: '‚ö†Ô∏è', tab: 'svpissues' },
            { name: 'Homework', icon: 'üìö', tab: 'homework' },
            { name: 'Remove Student', icon: 'üö´', tab: 'removestudent' },
            { name: 'Delete Student Data', icon: 'üóëÔ∏è', tab: 'deletestudent' },
            { name: 'Holidays', icon: 'üéâ', tab: 'holidays' },
            { name: 'Classes', icon: 'üè´', tab: 'classes' },
            { name: 'Register', icon: 'üìù', tab: 'register' },
            { name: 'Timetable', icon: '‚è∞', tab: 'managetimetable' },
            { name: 'Analytics', icon: 'üìä', tab: 'analytics' },
            { name: 'Profile', icon: 'üë§', tab: 'profile' },
            { name: 'Change Password', icon: 'üîê', tab: 'changepassword' }
        ],
        classteacher: [
            { name: 'Home', icon: 'üè†', tab: 'home' },
            { name: 'Class Dashboard', icon: 'üìä', tab: 'classdashboard' },
            { name: 'Mark Attendance', icon: '‚úÖ', tab: 'ctmarkattendance' },
            { name: 'Homework', icon: 'üìö', tab: 'homework' },
            { name: 'Exam Results', icon: 'üìä', tab: 'examresults' },
            { name: 'Report Cards', icon: 'üìã', tab: 'reportcards' },
            { name: 'Timetable', icon: '‚è∞', tab: 'timetable' },
            { name: 'Profile', icon: 'üë§', tab: 'profile' },
            { name: 'Change Password', icon: 'üîê', tab: 'changepassword' }
        ]
    };

    const items = menuItems[currentUser.role] || [];
    items.forEach(item => {
        const li = document.createElement('li');
        li.className = 'menu-item';

        const btn = document.createElement('button');
        btn.className = 'menu-link';
        btn.innerHTML = `<span class="menu-icon">${item.icon}</span><span>${item.name}</span>`;
        btn.type = 'button';
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            renderTab(item.tab, btn);
        });

        li.appendChild(btn);
        menu.appendChild(li);
    });
}

function renderDefaultTab() {
    renderTab('home');
}

function renderHomeTab(contentArea) {
    // Refresh database for real-time updates
    db = getDB();

    let html = '<h2>Dashboard</h2>';

    if (currentUser.role === 'parent') {
        const student = db.students.find(s => s.parentId === currentUser.username);
        if (student) {
            const attendance = db.attendance.filter(a => a.studentId === student.id);
            const present = attendance.filter(a => a.type === 'present').length;
            const absent = attendance.filter(a => a.type === 'absent').length;
            const pct = attendance.length ? ((present / attendance.length) * 100).toFixed(1) : 0;

            html += `<div class="stats-grid">
                <div class="stat-card"><div class="stat-value">${pct}%</div><div class="stat-label">Attendance Rate</div></div>
                <div class="stat-card"><div class="stat-value">${present}</div><div class="stat-label">Days Present</div></div>
                <div class="stat-card"><div class="stat-value">${absent}</div><div class="stat-label">Days Absent</div></div>
            </div>`;
        }
    } else if (currentUser.role === 'teacher') {
        const classes = 4;
        html += `<div class="stats-grid">
            <div class="stat-card"><div class="stat-value">${classes}</div><div class="stat-label">Classes Assigned</div></div>
            <div class="stat-card"><div class="stat-value">${db.students.length}</div><div class="stat-label">Total Students</div></div>
            <div class="stat-card"><div class="stat-value">${db.attendance.length}</div><div class="stat-label">Attendance Records</div></div>
        </div>`;
    } else if (currentUser.role === 'coordinator') {
        const pending = db.issues.filter(i => i.status === 'pending').length;
        html += `<div class="stats-grid">
            <div class="stat-card"><div class="stat-value">${pending}</div><div class="stat-label">Pending Issues</div></div>
            <div class="stat-card"><div class="stat-value">${db.students.length}</div><div class="stat-label">Students</div></div>
            <div class="stat-card"><div class="stat-value">${db.teachers.length}</div><div class="stat-label">Teachers</div></div>
        </div>`;
    } else if (currentUser.role === 'viceprincipal' || currentUser.role === 'superviceprincipal') {
        const critical = db.issues.filter(i => i.status === 'escalated').length;
        html += `<div class="stats-grid">
            <div class="stat-card"><div class="stat-value">${db.students.length}</div><div class="stat-label">Total Students</div></div>
            <div class="stat-card"><div class="stat-value">${db.teachers.length}</div><div class="stat-label">Teachers</div></div>
            <div class="stat-card"><div class="stat-value">${critical}</div><div class="stat-label">Critical Issues</div></div>
            <div class="stat-card"><div class="stat-value">${db.attendance.length}</div><div class="stat-label">Attendance Records</div></div>
        </div>`;
    } else if (currentUser.role === 'classteacher') {
        const cls = currentUser.username === 'CT8B' ? '8B' : '10A';
        const students = db.students.filter(s => s.class === cls);
        html += `<div class="card"><h3>Class Teacher - ${cls}</h3><p><strong>Class:</strong> ${cls}</p><p><strong>Total Students:</strong> ${students.length}</p></div>`;
    } else {
        html += '<div class="card"><h3>Welcome, ' + currentUser.name + '!</h3><p>Select an option from the menu to continue.</p></div>';
    }

    contentArea.innerHTML = html;
}

function renderAttendanceTab(contentArea) {
    // Refresh database for real-time updates
    db = getDB();

    const student = db.students.find(s => s.parentId === currentUser.username);

    if (!student) {
        contentArea.innerHTML = '<div class="card"><p>No student linked to your account.</p></div>';
        return;
    }

    const attendance = db.attendance.filter(a => a.studentId === student.id);
    const present = attendance.filter(a => a.type === 'present').length;
    const absent = attendance.filter(a => a.type === 'absent').length;
    const late = attendance.filter(a => a.type === 'late').length;
    const pct = attendance.length ? ((present / attendance.length) * 100).toFixed(1) : 0;

    let html = '<h2>Attendance Records - ' + student.name + '</h2>';
    html += '<div class="attendance-grid">';
    html += `<div class="attendance-stat present"><div class="attendance-stat-number">${pct}%</div><div class="attendance-stat-label">Attendance</div></div>`;
    html += `<div class="attendance-stat present"><div class="attendance-stat-number">${present}</div><div class="attendance-stat-label">Present</div></div>`;
    html += `<div class="attendance-stat absent"><div class="attendance-stat-number">${absent}</div><div class="attendance-stat-label">Absent</div></div>`;
    html += `<div class="attendance-stat late"><div class="attendance-stat-number">${late}</div><div class="attendance-stat-label">Late</div></div>`;
    html += '</div>';

    html += '<div class="card"><h3>Daily Records</h3>';
    html += '<table class="attendance-table"><thead><tr><th>Date</th><th>Period</th><th>Status</th><th>Behavior</th></tr></thead><tbody>';

    if (attendance.length > 0) {
        attendance.forEach(a => {
            html += `<tr><td>${a.date}</td><td>${a.period}</td><td><span class="badge badge-${a.type}">${a.type.toUpperCase()}</span></td><td><span class="badge badge-${a.behavior}">${a.behavior.toUpperCase()}</span></td></tr>`;
        });
    } else {
        html += '<tr><td colspan="4" style="text-align:center;">No attendance records yet.</td></tr>';
    }

    html += '</tbody></table></div>';
    contentArea.innerHTML = html;
}

function renderTimetableTab(contentArea) {
    // Refresh database for real-time updates
    db = getDB();

    let html = '<h2>View Timetable</h2>';
    html += '<div class="card"><div class="form-row">';
    html += '<div class="form-control"><label for="ttGrade">Grade</label><select id="ttGrade" onchange="window.updateTimetableDisplay()"><option value="">Select Grade</option>';
    
    for (let i = 1; i <= 10; i++) {
        html += `<option value="${i}">${i}</option>`;
    }
    
    html += '</select></div>';
    html += '<div class="form-control"><label for="ttSection">Section</label><select id="ttSection" onchange="window.updateTimetableDisplay()"><option value="">Select Section</option>';
    
    for (let i = 65; i <= 75; i++) {
        const section = String.fromCharCode(i);
        html += `<option value="${section}">${section}</option>`;
    }
    
    html += '</select></div></div></div>';
    html += '<div id="timetableDisplay"></div>';
    contentArea.innerHTML = html;
}

window.updateTimetableDisplay = function() {
    const grade = document.getElementById('ttGrade').value;
    const section = document.getElementById('ttSection').value;
    const display = document.getElementById('timetableDisplay');
    
    if (!grade || !section) {
        display.innerHTML = '';
        return;
    }
    
    const className = grade + section;
    const timetable = db.timetables.find(t => t.class === className);
    
    let html = '';
    if (timetable) {
        html = `<div class="card"><h3>Timetable - Class ${className}</h3>`;
        html += '<div class="timetable"><div class="timetable-grid">';
        html += '<div class="timetable-cell header">Time</div>';
        ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'].forEach(day => {
            html += `<div class="timetable-cell header">${day.substring(0, 3)}</div>`;
        });
        
        timetable.periods.forEach(p => {
            html += `<div class="timetable-cell time">${p.time}</div>`;
            html += `<div class="timetable-cell">${p.mon}</div>`;
            html += `<div class="timetable-cell">${p.tue}</div>`;
            html += `<div class="timetable-cell">${p.wed}</div>`;
            html += `<div class="timetable-cell">${p.thu}</div>`;
            html += `<div class="timetable-cell">${p.fri}</div>`;
            html += `<div class="timetable-cell">${p.sat}</div>`;
        });
        
        html += '</div></div></div>';
    } else {
        html = '<div class="card"><p>No timetable available for Class ' + className + '.</p></div>';
    }
    
    display.innerHTML = html;
};

function renderProfileTab(contentArea) {
    let html = '<h2>My Profile</h2>';

    if (currentUser.role === 'parent') {
        const student = db.students.find(s => s.parentId === currentUser.username);
        const parent = db.parents.find(p => p.id === currentUser.username);

        html += '<div class="card"><h3>Student Information</h3>';
        if (student) html += `<p><strong>Name:</strong> ${student.name}</p><p><strong>ID:</strong> ${student.id}</p><p><strong>Class:</strong> ${student.class}</p>`;
        html += '</div>';

        html += '<div class="card"><h3>Parent Information</h3>';
        if (parent) html += `<p><strong>Name:</strong> ${parent.name}</p><p><strong>Phone:</strong> ${parent.phone}</p>`;
        html += `<p><strong>Username:</strong> ${currentUser.username}</p></div>`;
    } else if (currentUser.role === 'teacher') {
        const teacher = db.teachers.find(t => t.id === currentUser.username);
        html += '<div class="card"><h3>Teacher Information</h3>';
        if (teacher) {
            html += `<p><strong>Name:</strong> ${teacher.name}</p><p><strong>ID:</strong> ${teacher.id}</p><p><strong>Subject:</strong> ${teacher.subjects}</p><p><strong>Classes:</strong> ${teacher.classes}</p>`;
        }
        html += '</div>';
    } else {
        html += '<div class="card"><h3>Account Information</h3>';
        html += `<p><strong>Name:</strong> ${currentUser.name}</p><p><strong>Username:</strong> ${currentUser.username}</p><p><strong>Role:</strong> ${currentUser.role.toUpperCase()}</p>`;
        html += '</div>';
    }

    contentArea.innerHTML = html;
}

function renderMarkAttendanceTab(contentArea) {
    // Refresh database for real-time updates
    db = getDB();

    const teacher = db.teachers.find(t => t.id === currentUser.username);
    if (!teacher || !teacher.classes) {
        contentArea.innerHTML = '<div class="card"><p>No classes assigned to you.</p></div>';
        return;
    }

    const teacherClasses = teacher.classes.split(',').map(c => c.trim());

    let html = '<h2>Mark Attendance</h2>';
    html += '<div class="card"><h3>Select Class & Mark Attendance</h3>';
    html += '<form onsubmit="window.handleMarkAttendance(event)">';

    html += '<div class="form-row">';
    html += '<div class="form-control"><label>Class:</label><select id="attendanceClass" onchange="window.loadStudentsForAttendance()" required><option value="">Select Class</option>';
    teacherClasses.forEach(cls => {
        html += `<option value="${cls}">${cls}</option>`;
    });
    html += '</select></div>';
    html += '<div class="form-control"><label>Period:</label><select id="period" required><option value="1">Period 1 (8:00-8:45)</option><option value="2">Period 2 (8:45-9:30)</option><option value="3">Period 3 (9:30-10:15)</option></select></div>';
    html += '</div>';

    html += '<div class="form-control"><label>Select Students:</label></div>';
    html += '<div class="checkbox-group" id="studentCheckboxes"></div>';

    html += '<div id="selectedStudents"></div>';
    html += '<div class="btn-group"><button type="submit" class="btn-primary">Save Attendance</button></div></form></div>';

    contentArea.innerHTML = html;
}

window.loadStudentsForAttendance = function() {
    const className = document.getElementById('attendanceClass').value;
    if (!className) {
        document.getElementById('studentCheckboxes').innerHTML = '';
        document.getElementById('selectedStudents').innerHTML = '';
        return;
    }

    const students = db.students.filter(s => s.class === className && s.status === 'active');
    let checkboxHtml = '';
    students.forEach(s => {
        checkboxHtml += `
            <div class="checkbox-item">
                <input type="checkbox" id="chk${s.id}" class="studentCheckbox" value="${s.id}" onchange="window.updateStudentList()">
                <label for="chk${s.id}">${s.name}</label>
            </div>
        `;
    });
    document.getElementById('studentCheckboxes').innerHTML = checkboxHtml;
    document.getElementById('selectedStudents').innerHTML = '';
}

window.updateStudentList = function() {
    const checkboxes = document.querySelectorAll('.studentCheckbox:checked');
    const selected = Array.from(checkboxes).map(cb => {
        const student = db.students.find(s => s.id == cb.value);
        return student;
    });

    let html = '';
    if (selected.length > 0) {
        html += '<div class="card"><h3>Attendance for Selected Students</h3>';
        selected.forEach(s => {
            html += `<div class="form-section"><h4>${s.name}</h4><div class="form-row">
                <div class="form-control"><label>Attendance:</label><select id="att${s.id}"><option value="present">Present</option><option value="absent">Absent</option><option value="late">Late</option></select></div>
                <div class="form-control"><label>Behavior:</label><select id="beh${s.id}"><option value="good">Good</option><option value="excellent">Excellent</option><option value="distracting">Distracting</option></select></div>
            </div></div>`;
        });
        html += '</div>';
    }
    document.getElementById('selectedStudents').innerHTML = html;
};

window.handleMarkAttendance = function(event) {
    event.preventDefault();

    const period = document.getElementById('period').value;
    const checkboxes = document.querySelectorAll('.studentCheckbox:checked');
    const today = new Date().toISOString().split('T')[0];

    if (checkboxes.length === 0) {
        showModal('Warning', 'Please select at least one student.', 'warning');
        return;
    }

    let addedCount = 0;
    let skippedCount = 0;

    checkboxes.forEach(cb => {
        const studentId = parseInt(cb.value);
        const attEl = document.getElementById('att' + studentId);
        const behEl = document.getElementById('beh' + studentId);

        // Check for duplicate entry
        const existing = db.attendance.find(a =>
            a.studentId === studentId &&
            a.date === today &&
            a.period === period
        );

        if (existing) {
            skippedCount++;
        } else {
            db.attendance.push({
                studentId: studentId,
                date: today,
                period: period,
                type: attEl ? attEl.value : 'present',
                behavior: behEl ? behEl.value : 'good',
                markedBy: currentUser.username
            });
            addedCount++;
        }
    });

    saveDB();

    let message = '';
    if (addedCount > 0) {
        message += `${addedCount} attendance record(s) saved successfully!`;
    }
    if (skippedCount > 0) {
        message += `\n${skippedCount} duplicate record(s) skipped.`;
    }

    showModal('Success', message, 'success');
    renderTab('markattendance');
};

function renderMyClassesTab(contentArea) {
    // Refresh database for real-time updates
    db = getDB();

    const teacher = db.teachers.find(t => t.id === currentUser.username);
    let html = '<h2>My Teaching Schedule</h2>';

    if (!teacher) {
        contentArea.innerHTML = '<div class="card"><p>Teacher information not found.</p></div>';
        return;
    }

    const classes = teacher.classes.split(',').map(c => c.trim());

    html += `<div class="stats-grid">
        <div class="stat-card"><div class="stat-value">${classes.length}</div><div class="stat-label">My Classes</div></div>
        <div class="stat-card"><div class="stat-value">${teacher.subjects}</div><div class="stat-label">Subject</div></div>
    </div>`;

    // Display teacher's personal timetable
    html += `<div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h3>My ${teacher.subjects} Teaching Schedule</h3>
                <p><strong>Teaching:</strong> ${classes.join(', ')}</p>
            </div>
            <button class="btn-primary" onclick="window.editTeacherTimetable()">‚úèÔ∏è Edit My Schedule</button>
        </div>`;

    // Get or create teacher's personal timetable
    let teacherTimetable = db.teacherTimetables ? db.teacherTimetables.find(t => t.teacherId === currentUser.username) : null;

    if (teacherTimetable && teacherTimetable.periods && teacherTimetable.periods.length > 0) {
        html += `<div style="overflow-x: auto;">
            <table class="attendance-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Monday</th>
                        <th>Tuesday</th>
                        <th>Wednesday</th>
                        <th>Thursday</th>
                        <th>Friday</th>
                        <th>Saturday</th>
                    </tr>
                </thead>
                <tbody>`;

        teacherTimetable.periods.forEach(period => {
            html += `<tr>
                <td><strong>${period.time}</strong></td>
                <td>${period.mon ? `Class ${period.mon}` : '-'}</td>
                <td>${period.tue ? `Class ${period.tue}` : '-'}</td>
                <td>${period.wed ? `Class ${period.wed}` : '-'}</td>
                <td>${period.thu ? `Class ${period.thu}` : '-'}</td>
                <td>${period.fri ? `Class ${period.fri}` : '-'}</td>
                <td>${period.sat ? `Class ${period.sat}` : '-'}</td>
            </tr>`;
        });

        html += `</tbody></table></div>`;
    } else {
        html += '<p>No teaching schedule set yet. Click "Edit My Schedule" to create your timetable.</p>';
    }

    html += '</div>';

    // Show list of classes
    html += '<div class="card"><h3>My Classes Overview</h3>';
    classes.forEach(cls => {
        const studentsInClass = db.students.filter(s => s.class === cls && s.status === 'active').length;
        html += `<div style="padding: 15px; margin-bottom: 10px; border: 2px solid var(--color-accent); border-radius: 8px;">
            <h4>Class ${cls}</h4>
            <p><strong>Students:</strong> ${studentsInClass} | <strong>Subject:</strong> ${teacher.subjects}</p>
        </div>`;
    });
    html += '</div>';

    contentArea.innerHTML = html;
}

window.editTeacherTimetable = function() {
    const teacher = db.teachers.find(t => t.id === currentUser.username);
    if (!teacher) {
        showModal('Error', 'Teacher information not found.', 'error');
        return;
    }

    const classes = teacher.classes.split(',').map(c => c.trim());
    const teacherTimetable = db.teacherTimetables ? db.teacherTimetables.find(t => t.teacherId === currentUser.username) : null;

    let html = `<h2>Edit My ${teacher.subjects} Teaching Schedule</h2>`;
    html += '<div class="card">';
    html += '<div style="margin-bottom: 20px;"><button class="btn-secondary" onclick="renderTab(\'myclasses\')">‚Üê Back to My Classes</button></div>';
    html += '<p style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><strong>Instructions:</strong> Enter the class you teach at each time slot. For example, if you teach Class 10A on Monday at 8:00-8:45, enter "10A" in that cell. Leave empty for free periods.</p>';
    html += '<form onsubmit="window.handleSaveTeacherTimetable(event)">';

    const periods = teacherTimetable && teacherTimetable.periods ? teacherTimetable.periods : [
        { time: '8:00-8:45', mon: '', tue: '', wed: '', thu: '', fri: '', sat: '' },
        { time: '8:45-9:30', mon: '', tue: '', wed: '', thu: '', fri: '', sat: '' },
        { time: '9:30-10:15', mon: '', tue: '', wed: '', thu: '', fri: '', sat: '' },
        { time: '10:15-10:25', mon: 'Break', tue: 'Break', wed: 'Break', thu: 'Break', fri: 'Break', sat: 'Break' },
        { time: '10:25-11:10', mon: '', tue: '', wed: '', thu: '', fri: '', sat: '' },
        { time: '11:10-11:55', mon: '', tue: '', wed: '', thu: '', fri: '', sat: '' }
    ];

    html += '<div style="overflow-x: auto;"><table class="attendance-table"><thead><tr>';
    html += '<th>Time</th><th>Monday</th><th>Tuesday</th><th>Wednesday</th><th>Thursday</th><th>Friday</th><th>Saturday</th>';
    html += '</tr></thead><tbody>';

    periods.forEach((period, index) => {
        html += `<tr>
            <td><input type="text" id="time${index}" value="${period.time}" style="width: 100px;" required></td>
            <td><input type="text" id="mon${index}" value="${period.mon || ''}" style="width: 120px;" placeholder="e.g., 10A" list="classList"></td>
            <td><input type="text" id="tue${index}" value="${period.tue || ''}" style="width: 120px;" placeholder="e.g., 10A" list="classList"></td>
            <td><input type="text" id="wed${index}" value="${period.wed || ''}" style="width: 120px;" placeholder="e.g., 10A" list="classList"></td>
            <td><input type="text" id="thu${index}" value="${period.thu || ''}" style="width: 120px;" placeholder="e.g., 10A" list="classList"></td>
            <td><input type="text" id="fri${index}" value="${period.fri || ''}" style="width: 120px;" placeholder="e.g., 10A" list="classList"></td>
            <td><input type="text" id="sat${index}" value="${period.sat || ''}" style="width: 120px;" placeholder="e.g., 10A" list="classList"></td>
        </tr>`;
    });

    html += '</tbody></table></div>';

    // Add datalist for class suggestions
    html += '<datalist id="classList">';
    classes.forEach(cls => {
        html += `<option value="${cls}">`;
    });
    html += '<option value="Break">';
    html += '</datalist>';

    html += '<input type="hidden" id="periodCount" value="' + periods.length + '">';
    html += '<div class="btn-group" style="margin-top: 20px;">';
    html += '<button type="button" class="btn-secondary" onclick="window.addTeacherTimetablePeriod()">+ Add Period</button>';
    html += '<button type="submit" class="btn-primary">üíæ Save My Schedule</button>';
    html += '</div></form></div>';

    document.getElementById('contentArea').innerHTML = html;
};

window.addTeacherTimetablePeriod = function() {
    const periodCount = parseInt(document.getElementById('periodCount').value);
    const tbody = document.querySelector('.attendance-table tbody');

    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td><input type="text" id="time${periodCount}" value="" style="width: 100px;" placeholder="12:00-12:45" required></td>
        <td><input type="text" id="mon${periodCount}" value="" style="width: 120px;" placeholder="e.g., 10A" list="classList"></td>
        <td><input type="text" id="tue${periodCount}" value="" style="width: 120px;" placeholder="e.g., 10A" list="classList"></td>
        <td><input type="text" id="wed${periodCount}" value="" style="width: 120px;" placeholder="e.g., 10A" list="classList"></td>
        <td><input type="text" id="thu${periodCount}" value="" style="width: 120px;" placeholder="e.g., 10A" list="classList"></td>
        <td><input type="text" id="fri${periodCount}" value="" style="width: 120px;" placeholder="e.g., 10A" list="classList"></td>
        <td><input type="text" id="sat${periodCount}" value="" style="width: 120px;" placeholder="e.g., 10A" list="classList"></td>
    `;

    tbody.appendChild(newRow);
    document.getElementById('periodCount').value = periodCount + 1;
};

window.handleSaveTeacherTimetable = function(event) {
    event.preventDefault();

    const periodCount = parseInt(document.getElementById('periodCount').value);
    const periods = [];

    for (let i = 0; i < periodCount; i++) {
        const timeEl = document.getElementById('time' + i);
        const monEl = document.getElementById('mon' + i);
        const tueEl = document.getElementById('tue' + i);
        const wedEl = document.getElementById('wed' + i);
        const thuEl = document.getElementById('thu' + i);
        const friEl = document.getElementById('fri' + i);
        const satEl = document.getElementById('sat' + i);

        if (timeEl) {
            periods.push({
                time: timeEl.value,
                mon: monEl ? monEl.value : '',
                tue: tueEl ? tueEl.value : '',
                wed: wedEl ? wedEl.value : '',
                thu: thuEl ? thuEl.value : '',
                fri: friEl ? friEl.value : '',
                sat: satEl ? satEl.value : ''
            });
        }
    }

    // Initialize teacherTimetables array if it doesn't exist
    if (!db.teacherTimetables) {
        db.teacherTimetables = [];
    }

    // Find existing teacher timetable or create new
    const existingIndex = db.teacherTimetables.findIndex(t => t.teacherId === currentUser.username);

    if (existingIndex !== -1) {
        db.teacherTimetables[existingIndex].periods = periods;
    } else {
        db.teacherTimetables.push({
            teacherId: currentUser.username,
            teacherName: currentUser.name,
            subject: db.teachers.find(t => t.id === currentUser.username).subjects,
            periods: periods
        });
    }

    saveDB();
    showModal('Success', 'Your teaching schedule saved successfully!', 'success');
    renderTab('myclasses');
};

window.handleChangeClass = function(event) {
    event.preventDefault();
    const grade = document.getElementById('changeGrade').value;
    const section = document.getElementById('changeSection').value.toUpperCase();
    const newClass = grade + section;

    const teacher = db.teachers.find(t => t.id === currentUser.username);
    if (teacher) {
        teacher.classes = newClass;
        saveDB();
        showModal('Success', 'Class updated to ' + newClass, 'success');
        renderTab('myclasses');
    }
};

function renderTeacherIssuesTab(contentArea) {
    let html = '<h2>Report Issue</h2>';
    html += '<div class="card"><form onsubmit="window.handleReportIssue(event)">';
    
    html += '<div class="form-row"><div class="form-control"><label>Grade:</label><select id="issueGrade" onchange="window.updateIssueStudents()"><option value="">Select...</option>';
    for (let i = 1; i <= 10; i++) {
        html += `<option value="${i}">${i}</option>`;
    }
    html += '</select></div>';
    
    html += '<div class="form-control"><label>Section:</label><select id="issueSection" onchange="window.updateIssueStudents()"><option value="">Select...</option>';
    for (let i = 65; i <= 75; i++) {
        const section = String.fromCharCode(i);
        html += `<option value="${section}">${section}</option>`;
    }
    html += '</select></div></div>';
    
    html += '<div class="form-row"><div class="form-control"><label>Student:</label><select id="issueStudent" required><option value="">Select...</option></select></div>';
    html += '<div class="form-control"><label>Severity:</label><select id="issueSeverity" required><option value="low">Low</option><option value="medium">Medium</option><option value="high">High (Escalate)</option></select></div></div>';
    
    html += '<div class="form-control"><label>Description:</label><textarea id="issueDesc" rows="4" required></textarea></div>';
    html += '<div class="btn-group"><button type="submit" class="btn-primary">Report Issue</button></div></form></div>';

    const myIssues = db.issues.filter(i => i.reportedBy === currentUser.username);
    html += '<div class="card"><h3>My Reported Issues</h3>';
    if (myIssues.length > 0) {
        myIssues.forEach(issue => {
            html += `<div class="issue-card ${issue.severity === 'high' ? 'critical' : ''}"><strong>${issue.studentName}</strong> - ${issue.problem} <br><small>Status: ${issue.status}</small></div>`;
        });
    } else {
        html += '<p>No issues reported yet.</p>';
    }
    html += '</div>';

    contentArea.innerHTML = html;
};

window.updateIssueStudents = function() {
    const grade = document.getElementById('issueGrade').value;
    const section = document.getElementById('issueSection').value;
    const select = document.getElementById('issueStudent');
    
    select.innerHTML = '<option value="">Select...</option>';
    
    if (grade && section) {
        const className = grade + section;
        const students = db.students.filter(s => s.class === className);
        students.forEach(s => {
            const option = document.createElement('option');
            option.value = s.id;
            option.textContent = s.name;
            select.appendChild(option);
        });
    }
};

window.handleReportIssue = function(event) {
    event.preventDefault();

    const studentId = document.getElementById('issueStudent').value;
    const severity = document.getElementById('issueSeverity').value;
    const description = document.getElementById('issueDesc').value;
    const student = db.students.find(s => s.id == studentId);

    const issue = {
        id: 'ISS' + Date.now(),
        studentId: studentId,
        studentName: student ? student.name : 'Unknown',
        problem: description,
        severity: severity,
        status: severity === 'high' ? 'escalated' : 'pending',
        reportedBy: currentUser.username,
        reportedDate: new Date().toISOString().split('T')[0]
    };

    db.issues.push(issue);
    saveDB();
    showModal('Success', 'Issue reported successfully!', 'success');
    renderTab('teacherissues');
};

function renderCoordIssuesTab(contentArea) {
    const pending = db.issues.filter(i => i.status === 'pending');
    let html = '<h2>Manage Issues</h2><div class="card"><h3>Pending Issues</h3>';

    if (pending.length > 0) {
        pending.forEach(issue => {
            html += `<div class="issue-card"><strong>${issue.studentName}</strong> - ${issue.problem} <br>
                <small>Severity: ${issue.severity} | Reported by: ${issue.reportedBy}</small>
                <div class="btn-group">
                    <button class="btn-success" onclick="window.updateIssueStatus('${issue.id}', 'resolved')">Resolve</button>
                    <button class="btn-danger" onclick="window.updateIssueStatus('${issue.id}', 'escalated')">Escalate</button>
                </div>
            </div>`;
        });
    } else {
        html += '<p>No pending issues.</p>';
    }

    html += '</div>';
    
    html += '<div class="card"><h3>Add Class Teacher</h3>';
    html += '<form onsubmit="window.handleAddClassTeacher(event)">';
    html += '<div class="form-row"><div class="form-control"><label>Grade:</label><input type="number" id="ctGrade" min="1" max="10" required></div>';
    html += '<div class="form-control"><label>Section:</label><input type="text" id="ctSection" maxlength="1" placeholder="A" required></div></div>';
    html += '<div class="form-row"><div class="form-control"><label>Teacher Name:</label><input type="text" id="ctName" required></div>';
    html += '<div class="form-control"><label>Teacher ID:</label><input type="text" id="ctId" required></div></div>';
    html += '<div class="form-control"><label>Password:</label><input type="password" id="ctPassword" required></div>';
    html += '<div class="btn-group"><button type="submit" class="btn-primary">Add Class Teacher</button></div>';
    html += '</form></div>';

    contentArea.innerHTML = html;
};

window.handleAddClassTeacher = function(event) {
    event.preventDefault();
    const grade = document.getElementById('ctGrade').value;
    const section = document.getElementById('ctSection').value.toUpperCase();
    const name = document.getElementById('ctName').value;
    const id = document.getElementById('ctId').value;
    const password = document.getElementById('ctPassword').value;

    db.classteachers.push({ id: id, name: name, class: grade + section, status: 'active' });
    db.users.push({ username: id, password: password, role: 'classteacher', name: name });

    saveDB();
    showModal('Success', 'Class Teacher added successfully!', 'success');
    renderTab('coordissues');
};

window.updateIssueStatus = function(id, status) {
    const issue = db.issues.find(i => i.id === id);
    if (issue) {
        issue.status = status;
        saveDB();
        renderTab('coordissues');
    }
};

function renderVPIssuesTab(contentArea) {
    const escalated = db.issues.filter(i => i.status === 'escalated');
    let html = '<h2>Critical Issues (Escalated)</h2>';
    
    html += '<div class="card"><h3>üîç Search Students</h3>';
    html += '<input type="text" id="vpSearchBox" class="search-box" placeholder="Search student by name or ID..." onkeyup="window.filterVPStudents()">';
    
    html += '<table class="attendance-table" id="vpStudentTable">';
    html += '<thead><tr><th>Student ID</th><th>Name</th><th>Class</th></tr></thead><tbody>';
    
    db.students.forEach(s => {
        html += `<tr class="vp-student-row"><td>${s.id}</td><td>${s.name}</td><td>${s.class}</td></tr>`;
    });
    
    html += '</tbody></table></div>';

    html += '<div class="card"><h3>Critical Issues</h3>';

    if (escalated.length > 0) {
        escalated.forEach(issue => {
            html += `<div class="issue-card critical"><strong>${issue.studentName}</strong> - ${issue.problem} <br>
                <small>Severity: ${issue.severity} | Reported: ${issue.reportedDate}</small>
                <div class="btn-group">
                    <button class="btn-success" onclick="window.updateIssueStatus('${issue.id}', 'resolved')">Resolve</button>
                </div>
            </div>`;
        });
    } else {
        html += '<p>No critical issues.</p>';
    }

    html += '</div>';
    
    html += '<div class="card"><h3>Add Class Teacher</h3>';
    html += '<form onsubmit="window.handleAddVPClassTeacher(event)">';
    html += '<div class="form-row"><div class="form-control"><label>Grade:</label><input type="number" id="vpCtGrade" min="1" max="10" required></div>';
    html += '<div class="form-control"><label>Section:</label><input type="text" id="vpCtSection" maxlength="1" placeholder="A" required></div></div>';
    html += '<div class="form-row"><div class="form-control"><label>Teacher Name:</label><input type="text" id="vpCtName" required></div>';
    html += '<div class="form-control"><label>Teacher ID:</label><input type="text" id="vpCtId" required></div></div>';
    html += '<div class="form-control"><label>Password:</label><input type="password" id="vpCtPassword" required></div>';
    html += '<div class="btn-group"><button type="submit" class="btn-primary">Add Class Teacher</button></div>';
    html += '</form></div>';

    contentArea.innerHTML = html;
};

window.filterVPStudents = function() {
    const searchBox = document.getElementById('vpSearchBox');
    const filter = (searchBox.value || '').toUpperCase();
    const table = document.getElementById('vpStudentTable');
    const rows = table.getElementsByClassName('vp-student-row');

    for (let i = 0; i < rows.length; i++) {
        const text = rows[i].textContent || rows[i].innerText;
        rows[i].style.display = text.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
    }
};

window.handleAddVPClassTeacher = function(event) {
    event.preventDefault();
    const grade = document.getElementById('vpCtGrade').value;
    const section = document.getElementById('vpCtSection').value.toUpperCase();
    const name = document.getElementById('vpCtName').value;
    const id = document.getElementById('vpCtId').value;
    const password = document.getElementById('vpCtPassword').value;

    db.classteachers.push({ id: id, name: name, class: grade + section, status: 'active' });
    db.users.push({ username: id, password: password, role: 'classteacher', name: name });

    saveDB();
    showModal('Success', 'Class Teacher added successfully!', 'success');
    renderTab('vpissues');
};

function renderHolidaysTab(contentArea) {
    let html = '<h2>Manage Holidays</h2>';
    html += '<div class="card"><h3>Add Holiday</h3><form onsubmit="window.handleAddHoliday(event)">';
    html += '<div class="form-row"><div class="form-control"><label>Date:</label><input type="date" id="holidayDate" required></div><div class="form-control"><label>Reason:</label><input type="text" id="holidayReason" required></div></div>';
    html += '<div class="btn-group"><button type="submit" class="btn-primary">Add Holiday</button></div></form></div>';

    html += '<div class="card"><h3>Holidays</h3><div class="holiday-list">';
    db.holidays.forEach(h => {
        html += `<div class="holiday-item"><div><div class="holiday-date">${h.date}</div><div class="holiday-reason">${h.reason}</div></div><button class="btn-danger" onclick="window.deleteHoliday('${h.date}')" style="padding:6px 12px; font-size:12px;">Delete</button></div>`;
    });
    html += '</div></div>';

    contentArea.innerHTML = html;
}

window.handleAddHoliday = function(event) {
    event.preventDefault();
    const date = document.getElementById('holidayDate').value;
    const reason = document.getElementById('holidayReason').value;

    db.holidays.push({ date: date, reason: reason });
    saveDB();
    showModal('Success', 'Holiday added!', 'success');
    renderTab('holidays');
}

window.deleteHoliday = function(date) {
    showConfirm(
        'Delete Holiday',
        'Are you sure you want to delete this holiday?',
        () => {
            db.holidays = db.holidays.filter(h => h.date !== date);
            saveDB();
            renderTab('holidays');
        },
        null,
        'Delete',
        'Cancel',
        true
    );
}

function renderRegisterTab(contentArea) {
    let html = '<h2>Register Users</h2>';

    html += '<div class="card"><h3>Register Student</h3><form onsubmit="window.handleRegisterStudent(event)">';
    html += '<div class="form-row">';
    html += '<div class="form-control"><label>Student ID Number:</label><input type="number" id="studentId" placeholder="e.g., 3240504" required></div>';
    html += '<div class="form-control"><label>Student Name:</label><input type="text" id="studentName" required></div>';
    html += '</div>';
    html += '<div class="form-row">';
    html += '<div class="form-control"><label>Grade:</label><select id="studentGrade" required><option value="">Select Grade</option>';
    for (let i = 1; i <= 10; i++) {
        html += `<option value="${i}">${i}</option>`;
    }
    html += '</select></div>';
    html += '<div class="form-control"><label>Section:</label><select id="studentSection" required><option value="">Select Section</option>';
    for (let i = 65; i <= 75; i++) {
        html += `<option value="${String.fromCharCode(i)}">${String.fromCharCode(i)}</option>`;
    }
    html += '</select></div>';
    html += '</div>';
    html += '<div class="form-row">';
    html += '<div class="form-control"><label>Parent CampusCore Username:</label><input type="text" id="parentUsername" placeholder="e.g., P3240504A" required></div>';
    html += '<div class="form-control"><label>Parent Name:</label><input type="text" id="parentName" required></div>';
    html += '</div>';
    html += '<div class="form-row">';
    html += '<div class="form-control"><label>Parent Phone:</label><input type="tel" id="parentPhone" required></div>';
    html += '<div class="form-control"><label>Parent Password:</label><input type="password" id="parentPassword" required></div>';
    html += '</div>';
    html += '<div class="btn-group"><button type="submit" class="btn-primary">Register Student & Parent</button></div></form></div>';

    html += '<div class="card"><h3>Register Teacher</h3><form onsubmit="window.handleRegisterTeacher(event)">';
    html += '<div class="form-row"><div class="form-control"><label>Name:</label><input type="text" id="teacherName" required></div><div class="form-control"><label>ID:</label><input type="text" id="teacherId" required></div></div>';
    html += '<div class="form-row"><div class="form-control"><label>Subject:</label><input type="text" id="teacherSubject" required></div><div class="form-control"><label>Classes:</label><input type="text" id="teacherClasses" placeholder="10A,10B" required></div></div>';
    html += '<div class="form-control"><label>Password:</label><input type="password" id="teacherPassword" required></div>';
    html += '<div class="btn-group"><button type="submit" class="btn-primary">Register</button></div></form></div>';

    contentArea.innerHTML = html;
}

window.handleRegisterStudent = function(event) {
    event.preventDefault();

    const studentId = parseInt(document.getElementById('studentId').value);
    const name = document.getElementById('studentName').value;
    const grade = document.getElementById('studentGrade').value;
    const section = document.getElementById('studentSection').value;
    const cls = grade + section;
    const parentId = document.getElementById('parentUsername').value.trim();
    const parentName = document.getElementById('parentName').value;
    const parentPhone = document.getElementById('parentPhone').value;
    const parentPassword = document.getElementById('parentPassword').value;

    // Validation: Check if student ID already exists
    if (db.students.find(s => s.id == studentId)) {
        showModal('Error', 'Student ID ' + studentId + ' already exists!\nPlease use a different ID number.', 'error');
        return;
    }

    // Validation: Check if parent username already exists
    if (db.users.find(u => u.username === parentId)) {
        showModal('Error', 'Username "' + parentId + '" already exists!\nPlease use a different CampusCore username.', 'error');
        return;
    }

    // Validation: Check if parent username matches format
    if (!/^P\d+[A-Z]$/.test(parentId)) {
        showModal('Error', 'Parent username must follow the format "P[number][letter]"\nExample: P3240504A, P1234567B', 'error');
        return;
    }

    // Register student and parent
    db.students.push({ id: studentId, name: name, class: cls, parentId: parentId, status: 'active' });
    db.parents.push({ id: parentId, name: parentName, studentId: studentId, phone: parentPhone });
    db.users.push({ username: parentId, password: parentPassword, role: 'parent', name: parentName, status: 'active' });

    saveDB();
    showModal('Success', `Student registered successfully!\n\nStudent Details:\nName: ${name}\nID: ${studentId}\nClass: ${cls}\n\nParent Login:\nUsername: ${parentId}\nPassword: ${parentPassword}\n\nPlease save these credentials!`, 'success');
    renderTab('register');
}

window.handleRegisterTeacher = function(event) {
    event.preventDefault();

    const id_val = document.getElementById('teacherId').value;
    const name = document.getElementById('teacherName').value;
    const subject = document.getElementById('teacherSubject').value;
    const classes = document.getElementById('teacherClasses').value;
    const password = document.getElementById('teacherPassword').value;

    db.teachers.push({ id: id_val, name: name, subjects: subject, classes: classes, status: 'active' });
    db.users.push({ username: id_val, password: password, role: 'teacher', name: name });

    saveDB();
    showModal('Success', `Teacher registered!\nUsername: ${id_val}`, 'success');
    renderTab('register');
}

function renderAnalyticsTab(contentArea) {
    let html = '<h2>School Analytics</h2>';
    html += `<div class="stats-grid">
        <div class="stat-card"><div class="stat-value">${db.students.length}</div><div class="stat-label">Total Students</div></div>
        <div class="stat-card"><div class="stat-value">${db.teachers.length}</div><div class="stat-label">Teachers</div></div>
        <div class="stat-card"><div class="stat-value">${db.coordinators.length}</div><div class="stat-label">Coordinators</div></div>
        <div class="stat-card"><div class="stat-value">${db.issues.length}</div><div class="stat-label">Total Issues</div></div>
    </div>`;

    html += '<div class="card"><h3>üîç Search Students</h3>';
    html += '<input type="text" id="studentSearch" class="search-box" placeholder="Search by name or student ID..." onkeyup="window.filterAnalyticsStudents()">';

    html += '<table class="attendance-table" id="studentsTable">';
    html += '<thead><tr><th>Student ID</th><th>Name</th><th>Class</th><th>Parent ID</th></tr></thead><tbody>';

    db.students.forEach(s => {
        html += `<tr class="student-row"><td>${s.id}</td><td>${s.name}</td><td>${s.class}</td><td>${s.parentId}</td></tr>`;
    });

    html += '</tbody></table></div>';

    html += '<div class="card"><h3>üîç Search Teachers</h3>';
    html += '<input type="text" id="teacherSearch" class="search-box" placeholder="Search by name or teacher ID..." onkeyup="window.filterAnalyticsTeachers()">';

    html += '<table class="attendance-table" id="teachersTable">';
    html += '<thead><tr><th>Teacher ID</th><th>Name</th><th>Subject</th><th>Classes</th></tr></thead><tbody>';

    db.teachers.forEach(t => {
        html += `<tr class="teacher-row"><td>${t.id}</td><td>${t.name}</td><td>${t.subjects}</td><td>${t.classes}</td></tr>`;
    });

    html += '</tbody></table></div>';

    html += '<div class="card"><h3>üîç Search Coordinators</h3>';
    html += '<input type="text" id="coordinatorSearch" class="search-box" placeholder="Search by name or coordinator ID..." onkeyup="window.filterAnalyticsCoordinators()">';

    html += '<table class="attendance-table" id="coordinatorsTable">';
    html += '<thead><tr><th>Coordinator ID</th><th>Name</th><th>Department</th></tr></thead><tbody>';

    db.coordinators.forEach(c => {
        html += `<tr class="coordinator-row"><td>${c.id}</td><td>${c.name}</td><td>${c.department}</td></tr>`;
    });

    html += '</tbody></table></div>';

    contentArea.innerHTML = html;
}

window.filterAnalyticsStudents = function() {
    const input = document.getElementById('studentSearch');
    const filter = (input.value || '').toUpperCase();
    const table = document.getElementById('studentsTable');
    const rows = table.getElementsByClassName('student-row');

    for (let i = 0; i < rows.length; i++) {
        const text = rows[i].textContent || rows[i].innerText;
        rows[i].style.display = text.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
    }
}

window.filterAnalyticsTeachers = function() {
    const input = document.getElementById('teacherSearch');
    const filter = (input.value || '').toUpperCase();
    const table = document.getElementById('teachersTable');
    const rows = table.getElementsByClassName('teacher-row');

    for (let i = 0; i < rows.length; i++) {
        const text = rows[i].textContent || rows[i].innerText;
        rows[i].style.display = text.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
    }
}

window.filterAnalyticsCoordinators = function() {
    const input = document.getElementById('coordinatorSearch');
    const filter = (input.value || '').toUpperCase();
    const table = document.getElementById('coordinatorsTable');
    const rows = table.getElementsByClassName('coordinator-row');

    for (let i = 0; i < rows.length; i++) {
        const text = rows[i].textContent || rows[i].innerText;
        rows[i].style.display = text.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
    }
}

function renderClassesTab(contentArea) {
    if (!db.classes) db.classes = [];

    let html = '<h2>Classes & Class Teachers Management</h2>';

    html += '<div class="card"><h3>Add / Edit Class</h3>';
    html += '<form onsubmit="window.handleSaveClass(event)">';
    html += '<div class="form-section"><div class="form-row">';
    html += '<div class="form-control"><label for="clsGrade">Grade</label><input type="number" id="clsGrade" min="1" max="10" required></div>';
    html += '<div class="form-control"><label for="clsSection">Section (A-K)</label><input type="text" id="clsSection" maxlength="1" placeholder="A" required></div>';
    html += '<div class="form-control"><label for="clsTeacher">Class Teacher ID</label><input type="text" id="clsTeacher" placeholder="e.g., CT8B"></div>';
    html += '</div></div>';
    html += '<div class="btn-group"><button type="submit" class="btn-primary">üíæ Save Class</button></div>';
    html += '</form></div>';

    html += '<div class="card"><h3>All Classes (Grades 1-10)</h3>';
    html += '<table class="attendance-table">';
    html += '<thead><tr><th>Grade</th><th>Section</th><th>Class</th><th>Class Teacher</th></tr></thead><tbody>';

    if (db.classes && db.classes.length) {
        db.classes.forEach(c => {
            html += '<tr><td>' + c.grade + '</td><td>' + c.section + '</td><td>' + c.className + '</td><td>' + (c.classTeacher || '-') + '</td></tr>';
        });
    } else {
        html += '<tr><td colspan="4">No classes defined yet.</td></tr>';
    }

    html += '</tbody></table></div>';

    contentArea.innerHTML = html;
}

window.handleSaveClass = function(event) {
    if (event) event.preventDefault();
    if (!db.classes) db.classes = [];

    const grade = parseInt(document.getElementById('clsGrade').value, 10);
    const section = (document.getElementById('clsSection').value || '').toUpperCase();
    const teacherId = document.getElementById('clsTeacher').value || '';

    const className = grade + section;
    const existing = db.classes.find(c => c.grade === grade && c.section === section);

    if (existing) {
        existing.classTeacher = teacherId || null;
    } else {
        db.classes.push({
            id: 'G' + grade + section,
            grade: grade,
            section: section,
            className: className,
            classTeacher: teacherId || null
        });
    }

    saveDB();
    showModal('Success', 'Class saved successfully!', 'success');
    renderTab('classes');
}

function renderUploadCCATab(contentArea) {
    let html = '<h2>Upload CCA Calendar / Timetable</h2>';
    html += '<div class="card"><h3>Upload Lock Sheet / Timetable Image</h3>';
    html += '<form onsubmit="window.handleUploadCCA(event)">';
    html += '<div class="form-section"><div class="form-row">';
    html += '<div class="form-control"><label for="ccaMonth">Month</label><input type="month" id="ccaMonth" required></div>';
    html += '<div class="form-control"><label for="ccaImage">Timetable Image</label><input type="file" id="ccaImage" accept="image/*" required></div>';
    html += '</div></div>';
    html += '<div class="btn-group"><button type="submit" class="btn-primary">Upload</button></div>';
    html += '</form></div>';

    html += '<div class="card"><h3>Uploaded Timetables</h3>';
    if (db.ccaCalendars && db.ccaCalendars.length) {
        db.ccaCalendars.forEach(c => {
            html += '<div style="margin-bottom:15px;">';
            html += '<p><strong>Month:</strong> ' + c.month + ' | <strong>Uploaded By:</strong> ' + c.uploadedBy + '</p>';
            if (c.imageData) {
                html += '<img src="' + c.imageData + '" alt="Timetable" style="max-width:100%;border:1px solid #ccc;border-radius:6px;">';
            }
            html += '</div>';
        });
    } else {
        html += '<p>No timetables uploaded yet.</p>';
    }
    html += '</div>';

    contentArea.innerHTML = html;
}

window.handleUploadCCA = function(event) {
    if (event) event.preventDefault();

    const month = document.getElementById('ccaMonth') ? document.getElementById('ccaMonth').value : '';
    const fileInput = document.getElementById('ccaImage');
    const file = fileInput && fileInput.files ? fileInput.files[0] : null;

    if (!month || !file) {
        showModal('Warning', 'Please select month and image.', 'warning');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        if (!db.ccaCalendars) db.ccaCalendars = [];
        db.ccaCalendars.push({
            month: month,
            uploadedBy: currentUser.username,
            uploadedDate: new Date().toISOString().split('T')[0],
            imageData: e.target.result
        });
        saveDB();
        showModal('Success', 'Timetable uploaded!', 'success');
        renderTab('uploadcca');
    };
    reader.readAsDataURL(file);
}

function renderChangePasswordTab(contentArea) {
    contentArea.innerHTML = '<h2>Change Password</h2><div class="card"><form onsubmit="window.handleChangePassword(event)">';
    contentArea.innerHTML += '<div class="form-control"><label>Old Password:</label><input type="password" id="oldPassword" required></div>';
    contentArea.innerHTML += '<div class="form-control" style="margin-top:15px;"><label>New Password:</label><input type="password" id="newPassword" required></div>';
    contentArea.innerHTML += '<div class="btn-group"><button type="submit" class="btn-primary">Update Password</button></div></form></div>';
}

window.handleChangePassword = function(event) {
    event.preventDefault();

    const oldPwd = document.getElementById('oldPassword').value;
    const newPwd = document.getElementById('newPassword').value;

    const user = db.users.find(u => u.username === currentUser.username);
    if (!user || user.password !== oldPwd) {
        showModal('Error', 'Old password is incorrect.', 'error');
        return;
    }

    user.password = newPwd;
    currentUser.password = newPwd;
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    saveDB();

    showModal('Success', 'Password updated successfully!', 'success');
    renderTab('changepassword');
}

function renderClassDashboardTab(contentArea) {
    // Refresh database for real-time updates
    db = getDB();

    const classTeacher = db.classteachers.find(ct => ct.id === currentUser.username);
    if (!classTeacher) {
        contentArea.innerHTML = '<div class="card"><p>Class teacher information not found.</p></div>';
        return;
    }

    const cls = classTeacher.class;
    const students = db.students.filter(s => s.class === cls && s.status === 'active');

    let html = `<h2>Class ${cls} Dashboard</h2>`;
    html += `<div class="stats-grid">
        <div class="stat-card"><div class="stat-value">${students.length}</div><div class="stat-label">Total Students</div></div>
    </div>`;

    html += '<div class="card"><h3>Students in Class ' + cls + '</h3><ul>';
    if (students.length > 0) {
        students.forEach(s => {
            html += `<li><strong>${s.name}</strong> - ID: ${s.id}</li>`;
        });
    } else {
        html += '<li>No students in this class.</li>';
    }
    html += '</ul></div>';

    contentArea.innerHTML = html;
}

function renderCTMarkAttendanceTab(contentArea) {
    // Refresh database for real-time updates
    db = getDB();

    const classTeacher = db.classteachers.find(ct => ct.id === currentUser.username);
    if (!classTeacher) {
        contentArea.innerHTML = '<div class="card"><p>Class teacher information not found.</p></div>';
        return;
    }

    const cls = classTeacher.class;
    const students = db.students.filter(s => s.class === cls && s.status === 'active');

    let html = `<h2>Mark Attendance - Class ${cls}</h2>`;
    html += '<div class="card"><h3>Daily Attendance</h3>';
    html += '<form onsubmit="window.handleCTMarkAttendance(event)">';
    html += '<div class="form-section"><div class="form-row">';
    html += '<div class="form-control"><label for="ctPeriod">Period</label>';
    html += '<select id="ctPeriod" required>';
    html += '<option value="Morning">Morning</option>';
    html += '<option value="1">Period 1</option>';
    html += '<option value="2">Period 2</option>';
    html += '<option value="3">Period 3</option>';
    html += '<option value="4">Period 4</option>';
    html += '<option value="5">Period 5</option>';
    html += '</select></div></div></div>';

    students.forEach(s => {
        html += '<div class="form-section"><h4>' + s.name + ' (' + s.id + ')</h4><div class="form-row">';
        html += '<div class="form-control"><label for="ctatt' + s.id + '">Attendance</label>';
        html += '<select id="ctatt' + s.id + '" required>';
        html += '<option value="present">Present</option>';
        html += '<option value="absent">Absent</option>';
        html += '<option value="late">Late</option>';
        html += '</select></div>';
        html += '<div class="form-control"><label for="ctbeh' + s.id + '">Behavior</label>';
        html += '<select id="ctbeh' + s.id + '" required>';
        html += '<option value="excellent">Excellent</option>';
        html += '<option value="good">Good</option>';
        html += '<option value="distracting">Distracting</option>';
        html += '</select></div>';
        html += '</div></div>';
    });

    html += '<div class="btn-group"><button type="submit" class="btn-primary">‚úÖ Save Attendance</button></div>';
    html += '</form></div>';

    contentArea.innerHTML = html;
}

window.handleCTMarkAttendance = function(event) {
    event.preventDefault();

    const classTeacher = db.classteachers.find(ct => ct.id === currentUser.username);
    if (!classTeacher) {
        showModal('Error', 'Class teacher information not found.', 'error');
        return;
    }

    const cls = classTeacher.class;
    const students = db.students.filter(s => s.class === cls && s.status === 'active');
    const period = document.getElementById('ctPeriod') ? document.getElementById('ctPeriod').value : 'Morning';
    const today = new Date().toISOString().split('T')[0];

    let addedCount = 0;
    let skippedCount = 0;

    students.forEach(s => {
        const attEl = document.getElementById('ctatt' + s.id);
        const behEl = document.getElementById('ctbeh' + s.id);

        if (attEl && behEl) {
            // Check for duplicate entry
            const existing = db.attendance.find(a =>
                a.studentId === s.id &&
                a.date === today &&
                a.period === period
            );

            if (existing) {
                skippedCount++;
            } else {
                db.attendance.push({
                    studentId: s.id,
                    date: today,
                    period: period,
                    type: attEl.value,
                    behavior: behEl.value,
                    subject: 'Class Teacher',
                    markedBy: currentUser.username
                });
                addedCount++;
            }
        }
    });

    saveDB();

    let message = '';
    if (addedCount > 0) {
        message += `${addedCount} attendance record(s) saved for Class ${cls}!`;
    }
    if (skippedCount > 0) {
        message += `\n${skippedCount} duplicate record(s) skipped.`;
    }

    showModal('Success', message, 'success');
    renderTab('ctmarkattendance');
}

function renderHomeworkTab(contentArea) {
    // Refresh database for real-time updates
    db = getDB();

    let html = '<h2>Homework Management</h2>';

    // Add homework form
    html += '<div class="card"><h3>Add New Homework</h3>';
    html += '<form onsubmit="window.handleAddHomework(event)">';
    html += '<div class="form-row">';
    html += '<div class="form-control"><label>Date:</label><input type="date" id="hwDate" required></div>';
    html += '<div class="form-control"><label>Grade:</label><select id="hwGrade" required><option value="">Select...</option>';
    for (let i = 1; i <= 10; i++) html += `<option value="${i}">${i}</option>`;
    html += '</select></div>';
    html += '<div class="form-control"><label>Section:</label><select id="hwSection" required><option value="">Select...</option>';
    for (let i = 65; i <= 75; i++) html += `<option value="${String.fromCharCode(i)}">${String.fromCharCode(i)}</option>`;
    html += '</select></div>';
    html += '</div><div class="form-row">';
    html += '<div class="form-control"><label>Subject:</label><input type="text" id="hwSubject" required></div>';
    html += '</div>';
    html += '<div class="form-control"><label>Homework Description:</label><textarea id="hwDesc" rows="4" required></textarea></div>';
    html += '<div class="btn-group"><button type="submit" class="btn-primary">Add Homework</button></div>';
    html += '</form></div>';

    // Show all homework with filter for VP/SVP
    html += '<div class="card"><h3>All Homework</h3>';

    if (currentUser.role === 'viceprincipal' || currentUser.role === 'superviceprincipal') {
        html += '<input type="text" id="hwSearch" class="search-box" placeholder="Search by date, subject, class, or teacher..." onkeyup="window.filterHomework()">';
    }

    html += '<table class="attendance-table" id="homeworkTable"><thead><tr><th>Date</th><th>Class</th><th>Subject</th><th>Description</th><th>Added By</th><th>Actions</th></tr></thead><tbody>';

    if (db.homework && db.homework.length > 0) {
        db.homework.forEach(hw => {
            html += `<tr class="hw-row"><td>${hw.date}</td><td>${hw.class}</td><td>${hw.subject}</td><td>${hw.description}</td><td>${hw.addedBy}</td>`;
            if (['teacher', 'coordinator', 'classteacher'].includes(currentUser.role)) {
                html += `<td><button class="btn-danger" onclick="window.deleteHomework('${hw.id}')" style="padding:6px 12px; font-size:12px;">Delete</button></td>`;
            } else {
                html += '<td>-</td>';
            }
            html += '</tr>';
        });
    } else {
        html += '<tr><td colspan="6" style="text-align:center;">No homework added yet.</td></tr>';
    }

    html += '</tbody></table></div>';
    contentArea.innerHTML = html;
}

window.handleAddHomework = function(event) {
    event.preventDefault();
    const date = document.getElementById('hwDate').value;
    const grade = document.getElementById('hwGrade').value;
    const section = document.getElementById('hwSection').value;
    const subject = document.getElementById('hwSubject').value;
    const description = document.getElementById('hwDesc').value;

    if (!db.homework) db.homework = [];

    db.homework.push({
        id: 'HW' + Date.now(),
        date: date,
        class: grade + section,
        subject: subject,
        description: description,
        addedBy: currentUser.username,
        addedDate: new Date().toISOString().split('T')[0]
    });

    saveDB();
    showModal('Success', 'Homework added successfully!', 'success');
    renderTab('homework');
};

window.deleteHomework = function(id) {
    showConfirm(
        'Delete Homework',
        'Are you sure you want to delete this homework assignment?',
        () => {
            db.homework = db.homework.filter(h => h.id !== id);
            saveDB();
            renderTab('homework');
        },
        null,
        'Delete',
        'Cancel',
        true
    );
};

window.filterHomework = function() {
    const searchBox = document.getElementById('hwSearch');
    const filter = (searchBox.value || '').toUpperCase();
    const table = document.getElementById('homeworkTable');
    const rows = table.getElementsByClassName('hw-row');

    for (let i = 0; i < rows.length; i++) {
        const text = rows[i].textContent || rows[i].innerText;
        rows[i].style.display = text.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
    }
};

function renderViewHomeworkTab(contentArea) {
    // Refresh database for real-time updates
    db = getDB();

    let html = '<h2>Homework</h2>';
    const student = db.students.find(s => s.parentId === currentUser.username);

    if (!student) {
        contentArea.innerHTML = '<div class="card"><p>No student linked to your account.</p></div>';
        return;
    }

    html += '<div class="card"><h3>Homework for Class ' + student.class + '</h3>';
    html += '<table class="attendance-table"><thead><tr><th>Date</th><th>Subject</th><th>Description</th></tr></thead><tbody>';

    const classHomework = db.homework.filter(h => h.class === student.class);

    if (classHomework.length > 0) {
        classHomework.forEach(hw => {
            html += `<tr><td>${hw.date}</td><td>${hw.subject}</td><td>${hw.description}</td></tr>`;
        });
    } else {
        html += '<tr><td colspan="3" style="text-align:center;">No homework assigned yet.</td></tr>';
    }

    html += '</tbody></table></div>';
    contentArea.innerHTML = html;
}

function renderManageTimetableTab(contentArea) {
    let html = '<h2>Manage Timetable</h2>';

    html += '<div class="card"><h3>Add/Update Timetable</h3>';
    html += '<form onsubmit="window.handleSaveTimetable(event)">';
    html += '<div class="form-row">';
    html += '<div class="form-control"><label>Grade:</label><input type="number" id="ttGradeManage" min="1" max="10" required></div>';
    html += '<div class="form-control"><label>Section:</label><input type="text" id="ttSectionManage" maxlength="1" placeholder="A" required></div>';
    html += '</div>';
    html += '<div class="form-control"><label>Number of Periods:</label><input type="number" id="ttPeriods" min="1" max="10" value="6" required></div>';
    html += '<div id="periodInputs"></div>';
    html += '<div class="btn-group"><button type="button" class="btn-primary" onclick="window.generatePeriodInputs()">Generate Period Fields</button><button type="submit" class="btn-success">Save Timetable</button></div>';
    html += '</form></div>';

    html += '<div class="card"><h3>Existing Timetables</h3>';
    html += '<table class="attendance-table"><thead><tr><th>Class</th><th>Periods</th><th>Action</th></tr></thead><tbody>';

    if (db.timetables && db.timetables.length > 0) {
        db.timetables.forEach((tt, idx) => {
            html += `<tr><td>${tt.class}</td><td>${tt.periods.length}</td><td><button class="btn-danger" onclick="window.deleteTimetable(${idx})" style="padding:6px 12px;font-size:12px;">Delete</button></td></tr>`;
        });
    } else {
        html += '<tr><td colspan="3" style="text-align:center;">No timetables available.</td></tr>';
    }

    html += '</tbody></table></div>';
    contentArea.innerHTML = html;
}

window.generatePeriodInputs = function() {
    const numPeriods = parseInt(document.getElementById('ttPeriods').value);
    const container = document.getElementById('periodInputs');
    let html = '<h4 style="margin-top:20px;">Period Details</h4>';

    for (let i = 0; i < numPeriods; i++) {
        html += `<div class="form-section"><h4>Period ${i + 1}</h4>`;
        html += '<div class="form-row">';
        html += `<div class="form-control"><label>Time:</label><input type="text" id="time${i}" placeholder="8:00-8:45" required></div>`;
        html += `<div class="form-control"><label>Monday:</label><input type="text" id="mon${i}" required></div>`;
        html += `<div class="form-control"><label>Tuesday:</label><input type="text" id="tue${i}" required></div>`;
        html += '</div><div class="form-row">';
        html += `<div class="form-control"><label>Wednesday:</label><input type="text" id="wed${i}" required></div>`;
        html += `<div class="form-control"><label>Thursday:</label><input type="text" id="thu${i}" required></div>`;
        html += `<div class="form-control"><label>Friday:</label><input type="text" id="fri${i}" required></div>`;
        html += `<div class="form-control"><label>Saturday:</label><input type="text" id="sat${i}" required></div>`;
        html += '</div></div>';
    }

    container.innerHTML = html;
};

window.handleSaveTimetable = function(event) {
    event.preventDefault();
    const grade = document.getElementById('ttGradeManage').value;
    const section = document.getElementById('ttSectionManage').value.toUpperCase();
    const className = grade + section;
    const numPeriods = parseInt(document.getElementById('ttPeriods').value);

    const periods = [];
    for (let i = 0; i < numPeriods; i++) {
        periods.push({
            time: document.getElementById('time' + i).value,
            mon: document.getElementById('mon' + i).value,
            tue: document.getElementById('tue' + i).value,
            wed: document.getElementById('wed' + i).value,
            thu: document.getElementById('thu' + i).value,
            fri: document.getElementById('fri' + i).value,
            sat: document.getElementById('sat' + i).value
        });
    }

    const existing = db.timetables.findIndex(t => t.class === className);
    if (existing > -1) {
        db.timetables[existing].periods = periods;
    } else {
        db.timetables.push({ class: className, periods: periods });
    }

    saveDB();
    showModal('Success', 'Timetable saved successfully!', 'success');
    renderTab('managetimetable');
};

window.deleteTimetable = function(index) {
    showConfirm(
        'Delete Timetable',
        'Are you sure you want to delete this timetable?',
        () => {
            db.timetables.splice(index, 1);
            saveDB();
            renderTab('managetimetable');
        },
        null,
        'Delete',
        'Cancel',
        true
    );
};

function renderSVPIssuesTab(contentArea) {
    renderVPIssuesTab(contentArea);
}

function renderRemoveStudentTab(contentArea) {
    let html = '<h2>Remove Student (Deactivate)</h2>';
    html += '<div class="card"><h3>üîç Search and Remove Student</h3>';
    html += '<input type="text" id="removeSearchBox" class="search-box" placeholder="Search student by name or ID..." onkeyup="window.filterRemoveStudents()">';

    html += '<table class="attendance-table" id="removeStudentTable">';
    html += '<thead><tr><th>Student ID</th><th>Name</th><th>Class</th><th>Status</th><th>Action</th></tr></thead><tbody>';

    db.students.forEach(s => {
        html += `<tr class="remove-student-row"><td>${s.id}</td><td>${s.name}</td><td>${s.class}</td><td><span class="badge badge-${s.status === 'active' ? 'present' : 'absent'}">${s.status.toUpperCase()}</span></td><td>`;
        if (s.status === 'active') {
            html += `<button class="btn-danger" onclick="window.deactivateStudent(${s.id})" style="padding:6px 12px; font-size:12px;">Deactivate</button>`;
        } else {
            html += `<button class="btn-success" onclick="window.activateStudent(${s.id})" style="padding:6px 12px; font-size:12px;">Activate</button>`;
        }
        html += '</td></tr>';
    });

    html += '</tbody></table></div>';
    contentArea.innerHTML = html;
}

window.filterRemoveStudents = function() {
    const searchBox = document.getElementById('removeSearchBox');
    const filter = (searchBox.value || '').toUpperCase();
    const table = document.getElementById('removeStudentTable');
    const rows = table.getElementsByClassName('remove-student-row');

    for (let i = 0; i < rows.length; i++) {
        const text = rows[i].textContent || rows[i].innerText;
        rows[i].style.display = text.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
    }
};

window.deactivateStudent = function(studentId) {
    showConfirm(
        'Deactivate Student',
        'Are you sure you want to deactivate this student? They will no longer have access to the system.',
        () => {
            const student = db.students.find(s => s.id == studentId);
            if (student) {
                student.status = 'inactive';

                // Deactivate parent account
                const parent = db.parents.find(p => p.studentId == studentId);
                if (parent) {
                    const user = db.users.find(u => u.username === parent.id);
                    if (user) user.status = 'inactive';
                }

                saveDB();
                showModal('Success', 'Student deactivated successfully!', 'success');
                renderTab('removestudent');
            }
        },
        null,
        'Deactivate',
        'Cancel',
        true
    );
};

window.activateStudent = function(studentId) {
    const student = db.students.find(s => s.id == studentId);
    if (student) {
        student.status = 'active';

        // Activate parent account
        const parent = db.parents.find(p => p.studentId == studentId);
        if (parent) {
            const user = db.users.find(u => u.username === parent.id);
            if (user) user.status = 'active';
        }

        saveDB();
        showModal('Success', 'Student activated successfully!', 'success');
        renderTab('removestudent');
    }
};

function renderDeleteStudentTab(contentArea) {
    let html = '<h2>Delete Student Data (Permanent)</h2>';
    html += '<div class="card" style="border-left-color: var(--color-danger);"><h3>‚ö†Ô∏è WARNING: This action is irreversible!</h3>';
    html += '<p>Deleting student data will permanently remove all records including attendance, homework, and account access.</p>';
    html += '</div>';

    html += '<div class="card"><h3>üîç Search and Delete Student</h3>';
    html += '<input type="text" id="deleteSearchBox" class="search-box" placeholder="Search student by name or ID..." onkeyup="window.filterDeleteStudents()">';

    html += '<table class="attendance-table" id="deleteStudentTable">';
    html += '<thead><tr><th>Student ID</th><th>Name</th><th>Class</th><th>Status</th><th>Action</th></tr></thead><tbody>';

    db.students.forEach(s => {
        html += `<tr class="delete-student-row"><td>${s.id}</td><td>${s.name}</td><td>${s.class}</td><td><span class="badge badge-${s.status === 'active' ? 'present' : 'absent'}">${s.status.toUpperCase()}</span></td><td>`;
        html += `<button class="btn-danger" onclick="window.permanentDeleteStudent(${s.id})" style="padding:6px 12px; font-size:12px;">üóëÔ∏è DELETE PERMANENTLY</button>`;
        html += '</td></tr>';
    });

    html += '</tbody></table></div>';
    contentArea.innerHTML = html;
}

window.filterDeleteStudents = function() {
    const searchBox = document.getElementById('deleteSearchBox');
    const filter = (searchBox.value || '').toUpperCase();
    const table = document.getElementById('deleteStudentTable');
    const rows = table.getElementsByClassName('delete-student-row');

    for (let i = 0; i < rows.length; i++) {
        const text = rows[i].textContent || rows[i].innerText;
        rows[i].style.display = text.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
    }
};

window.permanentDeleteStudent = function(studentId) {
    showConfirm(
        '‚ö†Ô∏è WARNING: Permanent Delete',
        'Are you absolutely sure you want to PERMANENTLY DELETE this student and all associated data? This action cannot be undone!',
        () => {
            // Second confirmation
            showConfirm(
                'Final Confirmation',
                'This will remove ALL records including attendance, homework, marks, and account access. Are you sure you want to continue?',
                () => {
                    // Remove student
                    db.students = db.students.filter(s => s.id != studentId);

                    // Remove parent
                    const parent = db.parents.find(p => p.studentId == studentId);
                    if (parent) {
                        db.parents = db.parents.filter(p => p.studentId != studentId);
                        db.users = db.users.filter(u => u.username !== parent.id);
                    }

                    // Remove attendance
                    db.attendance = db.attendance.filter(a => a.studentId != studentId);

                    // Remove issues
                    db.issues = db.issues.filter(i => i.studentId != studentId);

                    saveDB();
                    showModal('Success', 'Student data deleted permanently!', 'success');
                    renderTab('deletestudent');
                },
                null,
                'Delete Permanently',
                'Cancel',
                true
            );
        },
        null,
        'Continue',
        'Cancel',
        true
    );
};

function renderUploadExamTab(contentArea) {
    let html = '<h2>Exam Schedule Management</h2>';

    html += '<div class="card"><h3>Upload Exam Schedule</h3>';
    html += '<form onsubmit="window.handleUploadExam(event)">';
    html += '<div class="form-row">';
    html += '<div class="form-control"><label>Grade:</label><select id="examGrade" required><option value="">Select...</option>';
    for (let i = 1; i <= 10; i++) html += `<option value="${i}">${i}</option>`;
    html += '</select></div>';
    html += '<div class="form-control"><label>Exam Name:</label><input type="text" id="examName" placeholder="Mid Term, Finals, etc." required></div>';
    html += '</div>';
    html += '<div class="form-control"><label>Schedule Image:</label><input type="file" id="examImage" accept="image/*" required></div>';
    html += '<div class="btn-group"><button type="submit" class="btn-primary">Upload Schedule</button></div>';
    html += '</form></div>';

    html += '<div class="card"><h3>Uploaded Exam Schedules</h3>';

    if (db.examSchedules && db.examSchedules.length > 0) {
        db.examSchedules.forEach((ex, idx) => {
            html += '<div style="margin-bottom:20px; border:2px solid var(--color-border); padding:15px; border-radius:10px;">';
            html += `<p><strong>Grade:</strong> ${ex.grade} | <strong>Exam:</strong> ${ex.examName} | <strong>Uploaded:</strong> ${ex.uploadedDate}</p>`;
            if (ex.imageData) {
                html += `<img src="${ex.imageData}" alt="Exam Schedule" style="max-width:100%; border:1px solid #ccc; border-radius:6px; margin-top:10px;">`;
            }
            html += `<button class="btn-danger" onclick="window.deleteExamSchedule(${idx})" style="margin-top:10px;padding:6px 12px;font-size:12px;">Delete</button>`;
            html += '</div>';
        });
    } else {
        html += '<p>No exam schedules uploaded yet.</p>';
    }

    html += '</div>';
    contentArea.innerHTML = html;
}

window.handleUploadExam = function(event) {
    if (event) event.preventDefault();

    const grade = document.getElementById('examGrade').value;
    const examName = document.getElementById('examName').value;
    const fileInput = document.getElementById('examImage');
    const file = fileInput && fileInput.files ? fileInput.files[0] : null;

    if (!grade || !examName || !file) {
        showModal('Warning', 'Please fill all fields and select an image.', 'warning');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        if (!db.examSchedules) db.examSchedules = [];
        db.examSchedules.push({
            grade: grade,
            examName: examName,
            uploadedBy: currentUser.username,
            uploadedDate: new Date().toISOString().split('T')[0],
            imageData: e.target.result
        });
        saveDB();
        showModal('Success', 'Exam schedule uploaded successfully!', 'success');
        renderTab('uploadexam');
    };
    reader.readAsDataURL(file);
};

window.deleteExamSchedule = function(index) {
    showConfirm(
        'Delete Exam Schedule',
        'Are you sure you want to delete this exam schedule?',
        () => {
            db.examSchedules.splice(index, 1);
            saveDB();
            renderTab('uploadexam');
        },
        null,
        'Delete',
        'Cancel',
        true
    );
};

function renderExamScheduleTab(contentArea) {
    // Refresh database for real-time updates
    db = getDB();

    let html = '<h2>Exam Schedule</h2>';
    const student = db.students.find(s => s.parentId === currentUser.username);

    if (!student) {
        contentArea.innerHTML = '<div class="card"><p>No student linked to your account.</p></div>';
        return;
    }

    const studentGrade = parseInt(student.class.replace(/[^0-9]/g, ''));

    html += `<div class="card"><h3>Exam Schedules for Grade ${studentGrade}</h3>`;

    const gradeExams = db.examSchedules.filter(ex => parseInt(ex.grade) === studentGrade);

    if (gradeExams.length > 0) {
        gradeExams.forEach(ex => {
            html += '<div style="margin-bottom:20px; border:2px solid var(--color-primary); padding:15px; border-radius:10px;">';
            html += `<h4 style="color: var(--color-primary);">${ex.examName}</h4>`;
            html += `<p><strong>Uploaded:</strong> ${ex.uploadedDate}</p>`;
            if (ex.imageData) {
                html += `<img src="${ex.imageData}" alt="Exam Schedule" style="max-width:100%; border:2px solid var(--color-border); border-radius:8px; margin-top:10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">`;
            }
            html += '</div>';
        });
    } else {
        html += '<p>No exam schedules available for your grade yet.</p>';
    }

    html += '</div>';
    contentArea.innerHTML = html;
}

function renderExamResultsTab(contentArea) {
    // Refresh database to get latest data
    db = getDB();

    let html = '<h2>Exam Results Management</h2>';

    // Check both teachers and class teachers
    let teacher = db.teachers.find(t => t.id === currentUser.username);
    let teacherClasses = [];

    if (teacher) {
        teacherClasses = teacher.classes ? teacher.classes.split(',').map(c => c.trim()) : [];
    } else {
        // Check if user is a class teacher
        const classTeacher = db.classteachers.find(ct => ct.id === currentUser.username);
        if (classTeacher) {
            teacherClasses = [classTeacher.class];
        } else {
            contentArea.innerHTML = '<div class="card"><p>Teacher information not found.</p></div>';
            return;
        }
    }

    html += `<div class="card">
        <h3>Add Exam Result</h3>
        <form class="form-section" onsubmit="window.handleAddExamResult(event); return false;">
            <div class="form-row">
                <div class="form-control">
                    <label for="resultClass">Class</label>
                    <select id="resultClass" required onchange="window.loadStudentsForResults(this.value)">
                        <option value="">Select Class</option>
                        ${teacherClasses.map(cls => `<option value="${cls}">${cls}</option>`).join('')}
                    </select>
                </div>
                <div class="form-control">
                    <label for="resultStudent">Student</label>
                    <select id="resultStudent" required>
                        <option value="">Select Student</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-control">
                    <label for="resultExamName">Exam Name</label>
                    <input type="text" id="resultExamName" placeholder="e.g., Mid Term Exam 2025" required>
                </div>
                <div class="form-control">
                    <label for="resultSubject">Subject</label>
                    <input type="text" id="resultSubject" placeholder="e.g., Mathematics" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-control">
                    <label for="resultMarksObtained">Marks Obtained</label>
                    <input type="number" id="resultMarksObtained" min="0" placeholder="e.g., 85" required>
                </div>
                <div class="form-control">
                    <label for="resultTotalMarks">Total Marks</label>
                    <input type="number" id="resultTotalMarks" min="1" placeholder="e.g., 100" required>
                </div>
            </div>
            <div class="form-control">
                <label for="resultRemarks">Remarks (Optional)</label>
                <textarea id="resultRemarks" rows="2" placeholder="Additional comments about performance"></textarea>
            </div>
            <div class="btn-group">
                <button type="submit" class="btn-primary">Add Result</button>
            </div>
        </form>
    </div>`;

    html += `<div class="card">
        <h3>View & Manage Results</h3>
        <div class="form-control" style="max-width: 300px; margin-bottom: 20px;">
            <label for="filterResultClass">Filter by Class</label>
            <select id="filterResultClass" onchange="window.filterExamResults(this.value)">
                <option value="">All Classes</option>
                ${teacherClasses.map(cls => `<option value="${cls}">${cls}</option>`).join('')}
            </select>
        </div>
        <div id="resultsTableContainer"></div>
    </div>`;

    contentArea.innerHTML = html;
    window.filterExamResults('');
}

window.loadStudentsForResults = function(className) {
    const studentSelect = document.getElementById('resultStudent');
    studentSelect.innerHTML = '<option value="">Select Student</option>';

    if (!className) return;

    const students = db.students.filter(s => s.class === className && s.status === 'active');
    students.forEach(student => {
        studentSelect.innerHTML += `<option value="${student.id}">${student.name} (${student.id})</option>`;
    });
};

window.handleAddExamResult = function(event) {
    event.preventDefault();

    try {
        const studentId = parseInt(document.getElementById('resultStudent').value);
        const className = document.getElementById('resultClass').value;
        const examName = document.getElementById('resultExamName').value.trim();
        const subject = document.getElementById('resultSubject').value.trim();
        const marksObtained = parseInt(document.getElementById('resultMarksObtained').value);
        const totalMarks = parseInt(document.getElementById('resultTotalMarks').value);
        const remarks = document.getElementById('resultRemarks').value.trim();

        // Validation
        if (!studentId || isNaN(studentId)) {
            showModal('Warning', 'Please select a student!', 'warning');
            return;
        }

        if (!className) {
            showModal('Warning', 'Please select a class!', 'warning');
            return;
        }

        if (!examName) {
            showModal('Warning', 'Please enter exam name!', 'warning');
            return;
        }

        if (!subject) {
            showModal('Warning', 'Please enter subject!', 'warning');
            return;
        }

        if (isNaN(marksObtained) || isNaN(totalMarks)) {
            showModal('Warning', 'Please enter valid marks!', 'warning');
            return;
        }

        if (marksObtained > totalMarks) {
            showModal('Warning', 'Marks obtained cannot be greater than total marks!', 'warning');
            return;
        }

        if (totalMarks <= 0) {
            showModal('Warning', 'Total marks must be greater than 0!', 'warning');
            return;
        }

        const percentage = ((marksObtained / totalMarks) * 100).toFixed(2);
        let grade = 'F';
        if (percentage >= 90) grade = 'A+';
        else if (percentage >= 80) grade = 'A';
        else if (percentage >= 70) grade = 'B';
        else if (percentage >= 60) grade = 'C';
        else if (percentage >= 50) grade = 'D';

        const result = {
            id: Date.now(),
            studentId: studentId,
            class: className,
            examName: examName,
            subject: subject,
            marksObtained: marksObtained,
            totalMarks: totalMarks,
            percentage: percentage,
            grade: grade,
            remarks: remarks,
            addedBy: currentUser.username,
            addedDate: new Date().toISOString().split('T')[0]
        };

        // Get fresh database instance
        db = getDB();

        // Ensure examResults array exists
        if (!db) {
            showModal('Error', 'Database not found. Please refresh the page and try again.', 'error');
            return;
        }

        if (!db.examResults) {
            db.examResults = [];
        }

        db.examResults.push(result);
        saveDB();

        showModal('Success', 'Exam result added successfully!', 'success');

        // Reset form
        document.getElementById('resultClass').value = '';
        document.getElementById('resultStudent').innerHTML = '<option value="">Select Student</option>';
        document.getElementById('resultExamName').value = '';
        document.getElementById('resultSubject').value = '';
        document.getElementById('resultMarksObtained').value = '';
        document.getElementById('resultTotalMarks').value = '';
        document.getElementById('resultRemarks').value = '';

        // Refresh the results table
        window.filterExamResults(document.getElementById('filterResultClass').value);
    } catch (error) {
        console.error('Error adding exam result:', error);
        showModal('Error', 'Error adding exam result: ' + error.message, 'error');
    }
};

window.filterExamResults = function(className) {
    const container = document.getElementById('resultsTableContainer');
    if (!container) return;

    let results = db.examResults;
    if (className) {
        results = results.filter(r => r.class === className);
    }

    // Get teacher's classes (check both teachers and class teachers)
    let teacherClasses = [];
    const teacher = db.teachers.find(t => t.id === currentUser.username);
    if (teacher) {
        teacherClasses = teacher.classes ? teacher.classes.split(',').map(c => c.trim()) : [];
    } else {
        const classTeacher = db.classteachers.find(ct => ct.id === currentUser.username);
        if (classTeacher) {
            teacherClasses = [classTeacher.class];
        }
    }
    results = results.filter(r => teacherClasses.includes(r.class));

    if (results.length === 0) {
        container.innerHTML = '<p>No exam results found.</p>';
        return;
    }

    let html = `<table class="attendance-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Class</th>
                <th>Student</th>
                <th>Exam</th>
                <th>Subject</th>
                <th>Marks</th>
                <th>Percentage</th>
                <th>Grade</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>`;

    results.forEach(result => {
        const student = db.students.find(s => s.id === result.studentId);
        const studentName = student ? student.name : 'Unknown';

        html += `<tr>
            <td>${result.addedDate}</td>
            <td>${result.class}</td>
            <td>${studentName}</td>
            <td>${result.examName}</td>
            <td>${result.subject}</td>
            <td>${result.marksObtained}/${result.totalMarks}</td>
            <td>${result.percentage}%</td>
            <td><span class="badge badge-${result.grade === 'F' ? 'absent' : 'present'}">${result.grade}</span></td>
            <td>
                <button class="btn-danger" style="padding: 8px 12px; font-size: 12px;" onclick="window.deleteExamResult(${result.id})">Delete</button>
            </td>
        </tr>`;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
};

window.deleteExamResult = function(resultId) {
    showConfirm(
        'Delete Exam Result',
        'Are you sure you want to delete this exam result?',
        () => {
            const index = db.examResults.findIndex(r => r.id === resultId);
            if (index !== -1) {
                db.examResults.splice(index, 1);
                saveDB();
                showModal('Success', 'Exam result deleted successfully!', 'success');
                window.filterExamResults(document.getElementById('filterResultClass').value);
            }
        },
        null,
        'Delete',
        'Cancel',
        true
    );
};

function renderViewExamResultsTab(contentArea) {
    // Refresh database to get latest results
    db = getDB();

    let html = '<h2>Exam Results</h2>';

    const student = db.students.find(s => s.parentId === currentUser.username);
    if (!student) {
        contentArea.innerHTML = '<div class="card"><p>No student linked to your account.</p></div>';
        return;
    }

    const studentResults = db.examResults.filter(r => r.studentId === student.id);

    html += `<div class="card">
        <h3>${student.name}'s Exam Results (${student.class})</h3>`;

    if (studentResults.length === 0) {
        html += '<p>No exam results available yet.</p>';
    } else {
        // Group results by exam name
        const groupedResults = {};
        studentResults.forEach(result => {
            if (!groupedResults[result.examName]) {
                groupedResults[result.examName] = [];
            }
            groupedResults[result.examName].push(result);
        });

        Object.keys(groupedResults).forEach(examName => {
            const examResults = groupedResults[examName];
            const totalMarksObtained = examResults.reduce((sum, r) => sum + r.marksObtained, 0);
            const totalMarks = examResults.reduce((sum, r) => sum + r.totalMarks, 0);
            const overallPercentage = ((totalMarksObtained / totalMarks) * 100).toFixed(2);

            html += `<div style="margin-bottom: 30px; border: 2px solid var(--color-accent); padding: 20px; border-radius: 14px; background: linear-gradient(135deg, white 0%, #f9fdf9 100%);">
                <h4 style="color: var(--color-primary); margin-bottom: 15px;">${examName}</h4>
                <div style="background: var(--color-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <p><strong>Overall Percentage:</strong> <span style="font-size: 24px; color: var(--color-primary); font-weight: 800;">${overallPercentage}%</span></p>
                    <p><strong>Total Marks:</strong> ${totalMarksObtained} / ${totalMarks}</p>
                    <p><strong>Date:</strong> ${examResults[0].addedDate}</p>
                </div>
                <table class="attendance-table">
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Marks Obtained</th>
                            <th>Total Marks</th>
                            <th>Percentage</th>
                            <th>Grade</th>
                            <th>Remarks</th>
                            <th>Document</th>
                        </tr>
                    </thead>
                    <tbody>`;

            examResults.forEach(result => {
                let documentBtn = '<span style="color: #999;">-</span>';

                if (result.hasDocument && result.documentId && db.studentDocuments) {
                    const doc = db.studentDocuments.find(d => d.id === result.documentId);
                    if (doc) {
                        documentBtn = `<button onclick="window.viewStudentDocument(${doc.id})" class="btn-primary" style="padding: 5px 10px; font-size: 12px;">üìé View</button>`;
                    }
                }

                html += `<tr>
                    <td><strong>${result.subject}</strong></td>
                    <td>${result.marksObtained}</td>
                    <td>${result.totalMarks}</td>
                    <td>${result.percentage}%</td>
                    <td><span class="badge badge-${result.grade === 'F' ? 'absent' : 'excellent'}">${result.grade}</span></td>
                    <td>${result.remarks || '-'}</td>
                    <td>${documentBtn}</td>
                </tr>`;
            });

            html += `</tbody>
                </table>
            </div>`;
        });
    }

    html += '</div>';
    contentArea.innerHTML = html;
}

// ==================== VIEW REPORT CARDS TAB (PARENT) ====================
function renderViewReportCardsTab(contentArea) {
    // Refresh database for real-time updates
    db = getDB();

    console.log('=== REPORT CARDS VIEW DEBUG ===');
    console.log('Current database state:', db);
    console.log('Student Documents in DB:', db.studentDocuments);

    let html = '<h2>Report Cards</h2>';

    const student = db.students.find(s => s.parentId === currentUser.username);
    if (!student) {
        contentArea.innerHTML = '<div class="card"><p>No student linked to your account.</p></div>';
        return;
    }

    const studentReportCards = db.reportCards.filter(rc => rc.studentId === student.id && rc.sentToParent === true);
    const studentDocuments = db.studentDocuments ? db.studentDocuments.filter(d => d.studentId === student.id) : [];

    // Debug info
    console.log('=== PARENT VIEW DEBUG ===');
    console.log('Looking for Student ID:', student.id, 'Type:', typeof student.id);
    console.log('Student Name:', student.name);
    console.log('Generated report cards:', studentReportCards.length);
    console.log('Uploaded report cards:', studentDocuments.length);

    html += `<div class="card">
        <h3>${student.name}'s Report Cards (${student.class})</h3>`;

    // Check if there are any report cards (generated or uploaded)
    if (studentReportCards.length === 0 && studentDocuments.length === 0) {
        html += '<p>No report cards available yet.</p>';
    } else {
        html += `<table class="attendance-table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Date</th>
                    <th>Report Card / Exam</th>
                    <th>Description</th>
                    <th>File Size</th>
                    <th>Uploaded By</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>`;

        // Display generated report cards
        studentReportCards.forEach(rc => {
            html += `<tr>
                <td><span class="badge badge-present">Generated</span></td>
                <td>${rc.generatedDate}</td>
                <td><strong>${rc.examName}</strong></td>
                <td>Overall: ${rc.overallPercentage}%</td>
                <td>-</td>
                <td>${rc.generatedBy}</td>
                <td>
                    <button class="btn-primary" style="padding: 8px 12px; font-size: 12px;" onclick="window.viewParentReportCard(${rc.id})">View Details</button>
                </td>
            </tr>`;
        });

        // Display uploaded report cards
        studentDocuments.forEach(doc => {
            html += `<tr>
                <td><span class="badge badge-late">Uploaded</span></td>
                <td>${doc.uploadedDate}</td>
                <td><strong>${doc.fileName}</strong></td>
                <td>${doc.description || 'Report Card'}</td>
                <td>${(doc.fileSize / 1024).toFixed(2)} KB</td>
                <td>${doc.uploadedBy}</td>
                <td>
                    <button onclick="window.viewStudentDocument(${doc.id})" class="btn-primary" style="padding: 5px 10px; font-size: 12px;">üëÅÔ∏è View</button>
                    <button onclick="window.downloadStudentDocument(${doc.id})" class="btn-secondary" style="padding: 5px 10px; font-size: 12px;">‚¨áÔ∏è Download</button>
                </td>
            </tr>`;
        });

        html += '</tbody></table>';
    }

    html += '</div>';
    contentArea.innerHTML = html;
}

window.debugDocuments = function() {
    const student = db.students.find(s => s.parentId === currentUser.username);

    let debugInfo = `=== DATABASE DEBUG INFO ===\n\n`;
    debugInfo += `Current Student:\n`;
    debugInfo += `- ID: ${student.id} (Type: ${typeof student.id})\n`;
    debugInfo += `- Name: ${student.name}\n`;
    debugInfo += `- Class: ${student.class}\n`;
    debugInfo += `- Parent ID: ${student.parentId}\n\n`;

    debugInfo += `Student Documents in Database:\n`;
    debugInfo += `- Total Count: ${db.studentDocuments ? db.studentDocuments.length : 0}\n\n`;

    if (db.studentDocuments && db.studentDocuments.length > 0) {
        debugInfo += `All Documents:\n`;
        db.studentDocuments.forEach((doc, index) => {
            debugInfo += `${index + 1}. File: ${doc.fileName}\n`;
            debugInfo += `   Student ID: ${doc.studentId} (Type: ${typeof doc.studentId})\n`;
            debugInfo += `   Match: ${doc.studentId === student.id ? 'YES ‚úì' : 'NO ‚úó'}\n`;
            debugInfo += `   Date: ${doc.uploadedDate}\n`;
            debugInfo += `   Category: ${doc.category}\n`;
            debugInfo += `   Auto-Published: ${doc.autoPublished}\n\n`;
        });
    } else {
        debugInfo += `No documents in database!\n\n`;
    }

    debugInfo += `\nCheck browser console for more details.`;

    showModal('Information', debugInfo, 'info');
    console.log(debugInfo);
    console.log('Full database object:', db);
};

window.viewParentReportCard = function(reportCardId) {
    const rc = db.reportCards.find(r => r.id === reportCardId);
    if (!rc) return;

    const student = db.students.find(s => s.id === rc.studentId);

    let html = `
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 800px; margin: 0 auto;">
            <div style="text-align: center; border-bottom: 3px solid var(--color-primary); padding-bottom: 20px; margin-bottom: 20px;">
                <h1 style="color: var(--color-primary); margin: 0;">DPS Nadergul</h1>
                <h2 style="margin: 10px 0;">Report Card</h2>
                <p style="font-size: 18px;"><strong>${rc.examName}</strong></p>
            </div>

            <div style="margin-bottom: 20px;">
                <p><strong>Student Name:</strong> ${student ? student.name : 'Unknown'}</p>
                <p><strong>Class:</strong> ${rc.class}</p>
                <p><strong>Student ID:</strong> ${rc.studentId}</p>
            </div>

            <table class="attendance-table">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Marks Obtained</th>
                        <th>Total Marks</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>`;

    rc.marks.forEach(mark => {
        html += `<tr>
            <td><strong>${mark.subject}</strong></td>
            <td>${mark.marksObtained}</td>
            <td>${mark.totalMarks}</td>
            <td>${mark.percentage}%</td>
        </tr>`;
    });

    html += `</tbody></table>

            <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f0f8ff 0%, #e8f5e9 100%); border-radius: 10px; text-align: center;">
                <h3 style="color: var(--color-primary); margin: 0;">Overall Percentage</h3>
                <p style="font-size: 48px; font-weight: 800; color: var(--color-primary); margin: 10px 0;">${rc.overallPercentage}%</p>
            </div>

            <div style="margin-top: 30px; text-align: center;">
                <button class="btn-secondary" onclick="window.print()">üñ®Ô∏è Print Report Card</button>
                <button class="btn-primary" onclick="renderTab('viewreportcards')">‚Üê Back</button>
            </div>
        </div>
    `;

    document.getElementById('contentArea').innerHTML = html;
};

// ==================== APPOINT TEACHER TAB (VP/SVP) ====================
function renderAppointTeacherTab(contentArea) {
    // Refresh database for real-time updates
    db = getDB();

    let html = '<h2>Appoint Teacher to Classes</h2>';

    // Add Teacher Assignment Form
    html += `<div class="card">
        <h3>Assign Teacher to Class & Subject</h3>
        <form onsubmit="window.handleAppointTeacher(event); return false;">
            <div class="form-row">
                <div class="form-control">
                    <label for="appointTeacher">Teacher</label>
                    <select id="appointTeacher" required>
                        <option value="">Select Teacher</option>
                        ${db.teachers.map(t => `<option value="${t.id}">${t.name} (${t.subjects})</option>`).join('')}
                    </select>
                </div>
                <div class="form-control">
                    <label for="appointClass">Class</label>
                    <select id="appointClass" required>
                        <option value="">Select Class</option>
                        ${['1A', '1B', '2A', '2B', '3A', '3B', '4A', '4B', '5A', '5B', '6A', '6B', '7A', '7B', '8A', '8B', '9A', '9B', '10A', '10B'].map(c => `<option value="${c}">${c}</option>`).join('')}
                    </select>
                </div>
                <div class="form-control">
                    <label for="appointSubject">Subject</label>
                    <input type="text" id="appointSubject" placeholder="e.g., Mathematics" required>
                </div>
            </div>
            <div class="btn-group">
                <button type="submit" class="btn-primary">Assign Teacher</button>
            </div>
        </form>
    </div>`;

    // View Current Appointments
    html += `<div class="card">
        <h3>Current Teacher Appointments</h3>`;

    if (db.teacherAppointments.length === 0) {
        html += '<p>No teacher appointments yet.</p>';
    } else {
        html += `<table class="attendance-table">
            <thead>
                <tr>
                    <th>Teacher</th>
                    <th>Class</th>
                    <th>Subject</th>
                    <th>Assigned Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>`;

        db.teacherAppointments.forEach(apt => {
            const teacher = db.teachers.find(t => t.id === apt.teacherId);
            html += `<tr>
                <td>${teacher ? teacher.name : 'Unknown'}</td>
                <td>${apt.class}</td>
                <td>${apt.subject}</td>
                <td>${apt.assignedDate}</td>
                <td>
                    <button class="btn-danger" style="padding: 8px 12px; font-size: 12px;" onclick="window.deleteAppointment(${apt.id})">Delete</button>
                </td>
            </tr>`;
        });

        html += '</tbody></table>';
    }

    html += '</div>';
    contentArea.innerHTML = html;
}

window.handleAppointTeacher = function(event) {
    event.preventDefault();

    const teacherId = document.getElementById('appointTeacher').value;
    const className = document.getElementById('appointClass').value;
    const subject = document.getElementById('appointSubject').value.trim();

    if (!teacherId || !className || !subject) {
        showModal('Warning', 'Please fill in all fields!', 'warning');
        return;
    }

    // Check for duplicate
    const existing = db.teacherAppointments.find(a =>
        a.teacherId === teacherId &&
        a.class === className &&
        a.subject.toLowerCase() === subject.toLowerCase()
    );

    if (existing) {
        showModal('Warning', 'This teacher is already assigned to this class and subject!', 'warning');
        return;
    }

    const appointment = {
        id: Date.now(),
        teacherId: teacherId,
        class: className,
        subject: subject,
        assignedBy: currentUser.username,
        assignedDate: new Date().toISOString().split('T')[0]
    };

    db.teacherAppointments.push(appointment);

    // Update teacher's classes
    const teacher = db.teachers.find(t => t.id === teacherId);
    if (teacher) {
        const currentClasses = teacher.classes ? teacher.classes.split(',').map(c => c.trim()) : [];
        if (!currentClasses.includes(className)) {
            currentClasses.push(className);
            teacher.classes = currentClasses.join(',');
        }
    }

    saveDB();
    showModal('Success', 'Teacher appointed successfully!', 'success');
    renderTab('appointteacher');
};

window.deleteAppointment = function(appointmentId) {
    showConfirm(
        'Delete Appointment',
        'Are you sure you want to delete this teacher appointment?',
        () => {
            const index = db.teacherAppointments.findIndex(a => a.id === appointmentId);
            if (index !== -1) {
                db.teacherAppointments.splice(index, 1);
                saveDB();
                showModal('Success', 'Appointment deleted successfully!', 'success');
                renderTab('appointteacher');
            }
        },
        null,
        'Delete',
        'Cancel',
        true
    );
};

// ==================== UPLOAD MARKS TAB (TEACHER) ====================
function renderUploadMarksTab(contentArea) {
    // Refresh database for real-time updates
    db = getDB();

    const teacher = db.teachers.find(t => t.id === currentUser.username);
    if (!teacher) {
        contentArea.innerHTML = '<div class="card"><p>Teacher information not found.</p></div>';
        return;
    }

    const classes = teacher.classes ? teacher.classes.split(',').map(c => c.trim()) : [];

    let html = '<h2>Upload Student Marks</h2>';

    // Manual Entry Form
    html += `<div class="card">
        <h3>Manual Entry</h3>
        <form onsubmit="window.handleManualMarksEntry(event); return false;">
            <div class="form-row">
                <div class="form-control">
                    <label for="marksClass">Class</label>
                    <select id="marksClass" required onchange="window.loadStudentsForMarks(this.value)">
                        <option value="">Select Class</option>
                        ${classes.map(cls => `<option value="${cls}">${cls}</option>`).join('')}
                    </select>
                </div>
                <div class="form-control">
                    <label for="marksStudent">Student</label>
                    <select id="marksStudent" required onchange="window.loadStudentCurrentInfo()">
                        <option value="">Select Student</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-control">
                    <label for="marksSubject">Subject</label>
                    <input type="text" id="marksSubject" value="${teacher.subjects}" required>
                </div>
                <div class="form-control">
                    <label for="marksExam">Exam Name</label>
                    <input type="text" id="marksExam" placeholder="e.g., Mid Term Exam" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-control">
                    <label for="marksObtained">Marks Obtained</label>
                    <input type="number" id="marksObtained" min="0" required>
                </div>
                <div class="form-control">
                    <label for="marksTotal">Total Marks</label>
                    <input type="number" id="marksTotal" min="1" required>
                </div>
            </div>
            <div class="card" style="background: #f8f9fa; padding: 15px; margin-top: 15px;">
                <h4 style="margin-top: 0; color: #495057;">Update Student Information (Optional)</h4>
                <div class="form-row">
                    <div class="form-control">
                        <label for="newClass">Change Class/Section</label>
                        <input type="text" id="newClass" placeholder="e.g., 9A, 10B (leave empty to keep current)">
                        <small style="color: #6c757d;">Current class will be shown after selecting student</small>
                    </div>
                    <div class="form-control">
                        <label for="studentDocument">Upload Document/File (Any Type)</label>
                        <input type="file" id="studentDocument" accept="*/*">
                        <small style="color: #6c757d;">Upload any document for this student (PDF, image, doc, etc.)</small>
                    </div>
                </div>
                <div id="currentStudentInfo" style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; display: none;">
                    <strong>Current Info:</strong> <span id="studentInfoText"></span>
                </div>
                <div class="form-control" style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="autoPublish" checked style="width: 20px; height: 20px;">
                        <span><strong>Auto-Publish to Parents</strong> (Marks will be immediately visible to parents/students without approval)</span>
                    </label>
                </div>
            </div>
            <div class="btn-group">
                <button type="submit" class="btn-primary">Submit Marks & Update Student</button>
            </div>
        </form>
    </div>`;

    // Upload Report Card Form
    html += `<div class="card">
        <h3>üìã Upload Report Card</h3>
        <p style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <strong>Upload student report cards in any format:</strong><br>
            ‚Ä¢ <strong>PDF Files:</strong> Digital report cards<br>
            ‚Ä¢ <strong>Images (PNG, JPG):</strong> Scanned report cards<br>
            ‚Ä¢ <strong>Word Documents:</strong> Editable report cards<br>
            ‚Ä¢ <strong>CSV Files:</strong> Bulk marks upload (Format: studentId, examName, subject, marksObtained, totalMarks)
        </p>
        <form onsubmit="window.handleBulkUpload(event); return false;">
            <div class="form-row">
                <div class="form-control">
                    <label for="bulkClass">Select Class</label>
                    <select id="bulkClass" onchange="window.loadStudentsForBulk(this.value)">
                        <option value="">Select Class</option>
                        ${classes.map(cls => `<option value="${cls}">${cls}</option>`).join('')}
                    </select>
                    <small style="color: #6c757d;">Required for report card uploads</small>
                </div>
                <div class="form-control">
                    <label for="bulkStudent">Select Student</label>
                    <select id="bulkStudent">
                        <option value="">Select Student</option>
                    </select>
                    <small style="color: #6c757d;">Report card will be sent to this student</small>
                </div>
            </div>
            <div class="form-control">
                <label for="bulkFile">Upload Report Card (Any Format)</label>
                <input type="file" id="bulkFile" accept="*/*" required onchange="window.previewBulkFile(event)">
                <small style="color: #6c757d;">Supports PDF, Images, Word documents, CSV, and more</small>
            </div>
            <div class="form-control">
                <label for="bulkFileDescription">Report Card Description</label>
                <input type="text" id="bulkFileDescription" placeholder="e.g., Mid Term Report Card, Final Exam Report">
            </div>
            <div class="form-control">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="bulkAutoPublish" checked style="width: 20px; height: 20px;">
                    <span><strong>Auto-Publish to Student/Parent</strong> (Report card will be immediately visible)</span>
                </label>
            </div>
            <div id="bulkFilePreview" style="margin-top: 20px;"></div>
            <div class="btn-group">
                <button type="submit" class="btn-primary">Upload Report Card</button>
            </div>
        </form>
    </div>`;

    // View Submitted Marks
    html += `<div class="card">
        <h3>My Submitted Marks</h3>`;

    const mySubmissions = db.marksSubmissions.filter(s => s.submittedBy === currentUser.username);

    if (mySubmissions.length === 0) {
        html += '<p>No marks submitted yet.</p>';
    } else {
        html += `<table class="attendance-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Student</th>
                    <th>Class</th>
                    <th>Exam</th>
                    <th>Subject</th>
                    <th>Marks</th>
                    <th>Status</th>
                    <th>Document</th>
                </tr>
            </thead>
            <tbody>`;

        mySubmissions.forEach(sub => {
            const student = db.students.find(s => s.id === sub.studentId);
            let documentBtn = '<span style="color: #999;">-</span>';

            if (sub.hasDocument && sub.documentId && db.studentDocuments) {
                const doc = db.studentDocuments.find(d => d.id === sub.documentId);
                if (doc) {
                    documentBtn = `<button onclick="window.viewStudentDocument(${doc.id})" class="btn-primary" style="padding: 5px 10px; font-size: 12px;">üìé ${doc.fileName}</button>`;
                }
            }

            html += `<tr>
                <td>${sub.submittedDate}</td>
                <td>${student ? student.name : 'Unknown'}</td>
                <td><strong>${sub.class}</strong></td>
                <td>${sub.examName}</td>
                <td>${sub.subject}</td>
                <td>${sub.marksObtained}/${sub.totalMarks} (${sub.percentage}%)</td>
                <td><span class="badge badge-${sub.status === 'approved' ? 'present' : sub.status === 'rejected' ? 'absent' : 'late'}">${sub.status}</span></td>
                <td>${documentBtn}</td>
            </tr>`;
        });

        html += '</tbody></table>';
    }

    html += '</div>';

    // View Uploaded Report Cards
    html += `<div class="card">
        <h3>üìã Uploaded Report Cards</h3>`;

    const myBulkUploads = db.bulkUploads ? db.bulkUploads.filter(b => b.uploadedBy === currentUser.username) : [];

    if (myBulkUploads.length === 0) {
        html += '<p>No report cards uploaded yet.</p>';
    } else {
        html += `<table class="attendance-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Student</th>
                    <th>File Name</th>
                    <th>File Type</th>
                    <th>Size</th>
                    <th>Description</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>`;

        myBulkUploads.forEach(upload => {
            const studentName = upload.studentName || 'All Students';
            const statusBadge = upload.autoPublished ? '<span class="badge badge-present">Published</span>' : '<span class="badge badge-late">Pending</span>';

            html += `<tr>
                <td>${upload.uploadedDate}</td>
                <td><strong>${studentName}</strong></td>
                <td>${upload.fileName}</td>
                <td>${upload.fileType}</td>
                <td>${(upload.fileSize / 1024).toFixed(2)} KB</td>
                <td>${upload.description}</td>
                <td>${statusBadge}</td>
                <td>
                    <button onclick="window.viewBulkUpload(${upload.id})" class="btn-primary" style="padding: 5px 10px; font-size: 12px;">üëÅÔ∏è View</button>
                    <button onclick="window.downloadBulkUpload(${upload.id})" class="btn-secondary" style="padding: 5px 10px; font-size: 12px;">‚¨áÔ∏è Download</button>
                </td>
            </tr>`;
        });

        html += '</tbody></table>';
    }

    html += '</div>';
    contentArea.innerHTML = html;
}

window.loadStudentsForMarks = function(className) {
    const studentSelect = document.getElementById('marksStudent');
    studentSelect.innerHTML = '<option value="">Select Student</option>';

    if (!className) return;

    const students = db.students.filter(s => s.class === className && s.status === 'active');
    students.forEach(student => {
        studentSelect.innerHTML += `<option value="${student.id}">${student.name} (${student.id})</option>`;
    });
};

window.loadStudentsForBulk = function(className) {
    const studentSelect = document.getElementById('bulkStudent');
    studentSelect.innerHTML = '<option value="">Select Student</option>';

    if (!className) return;

    const students = db.students.filter(s => s.class === className && s.status === 'active');
    students.forEach(student => {
        studentSelect.innerHTML += `<option value="${student.id}">${student.name} (${student.id})</option>`;
    });
};

window.loadStudentCurrentInfo = function() {
    const studentId = parseInt(document.getElementById('marksStudent').value);
    if (!studentId) {
        document.getElementById('currentStudentInfo').style.display = 'none';
        return;
    }

    const student = db.students.find(s => s.id === studentId);
    if (student) {
        document.getElementById('studentInfoText').innerHTML = `
            <strong>${student.name}</strong> |
            Class: <span style="color: #007bff; font-weight: bold;">${student.class}</span> |
            Student ID: ${student.id}
        `;
        document.getElementById('currentStudentInfo').style.display = 'block';
        document.getElementById('newClass').placeholder = `Current: ${student.class} (enter new class to change)`;
    }
};

window.handleManualMarksEntry = function(event) {
    event.preventDefault();

    const studentId = parseInt(document.getElementById('marksStudent').value);
    const className = document.getElementById('marksClass').value;
    const subject = document.getElementById('marksSubject').value.trim();
    const examName = document.getElementById('marksExam').value.trim();
    const marksObtained = parseInt(document.getElementById('marksObtained').value);
    const totalMarks = parseInt(document.getElementById('marksTotal').value);
    const newClass = document.getElementById('newClass').value.trim();
    const fileInput = document.getElementById('studentDocument');
    const autoPublish = document.getElementById('autoPublish').checked;

    if (!studentId || !className || !subject || !examName) {
        showModal('Warning', 'Please fill in all fields!', 'warning');
        return;
    }

    if (marksObtained > totalMarks) {
        showModal('Warning', 'Marks obtained cannot be greater than total marks!', 'warning');
        return;
    }

    const percentage = ((marksObtained / totalMarks) * 100).toFixed(2);

    // Calculate grade based on percentage
    let grade = 'F';
    if (percentage >= 90) grade = 'A+';
    else if (percentage >= 80) grade = 'A';
    else if (percentage >= 70) grade = 'B+';
    else if (percentage >= 60) grade = 'B';
    else if (percentage >= 50) grade = 'C+';
    else if (percentage >= 40) grade = 'C';
    else if (percentage >= 33) grade = 'D';

    // Update student class if new class is provided
    if (newClass) {
        const student = db.students.find(s => s.id === studentId);
        if (student) {
            const oldClass = student.class;
            student.class = newClass;
            console.log(`Updated student ${student.name} class from ${oldClass} to ${newClass}`);
        }
    }

    // Handle file upload if a file is selected
    if (fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            const fileData = {
                id: Date.now(),
                studentId: studentId,
                fileName: file.name,
                fileType: file.type,
                fileSize: file.size,
                fileData: e.target.result, // Base64 encoded file
                uploadedBy: currentUser.username,
                uploadedDate: new Date().toISOString().split('T')[0],
                description: `Uploaded with marks entry for ${examName}`
            };

            // Initialize studentDocuments array if it doesn't exist
            if (!db.studentDocuments) {
                db.studentDocuments = [];
            }

            db.studentDocuments.push(fileData);
            console.log(`Uploaded file ${file.name} for student ${studentId}`);

            // Save marks submission
            const submission = {
                id: Date.now() + 1,
                studentId: studentId,
                class: newClass || className,
                subject: subject,
                examName: examName,
                marksObtained: marksObtained,
                totalMarks: totalMarks,
                percentage: percentage,
                status: autoPublish ? 'approved' : 'pending',
                submittedBy: currentUser.username,
                submittedDate: new Date().toISOString().split('T')[0],
                hasDocument: true,
                documentId: fileData.id
            };

            db.marksSubmissions.push(submission);

            // If auto-publish is enabled, also add to examResults for immediate parent visibility
            if (autoPublish) {
                const examResult = {
                    id: Date.now() + 2,
                    studentId: studentId,
                    class: newClass || className,
                    subject: subject,
                    examName: examName,
                    marksObtained: marksObtained,
                    totalMarks: totalMarks,
                    percentage: percentage,
                    grade: grade,
                    remarks: 'Auto-published',
                    addedBy: currentUser.username,
                    addedDate: new Date().toISOString().split('T')[0],
                    hasDocument: true,
                    documentId: fileData.id
                };
                db.examResults.push(examResult);
            }

            saveDB();

            let message = autoPublish ? 'Marks published successfully! Now visible to parents/students.' : 'Marks submitted successfully! Awaiting class teacher approval.';
            if (newClass) message += `\nStudent class updated to ${newClass}.`;
            message += `\nDocument "${file.name}" uploaded.`;

            showModal('Success', message, 'success');
            renderTab('uploadmarks');
        };

        reader.readAsDataURL(file);
    } else {
        // No file to upload, just submit marks
        const submission = {
            id: Date.now(),
            studentId: studentId,
            class: newClass || className,
            subject: subject,
            examName: examName,
            marksObtained: marksObtained,
            totalMarks: totalMarks,
            percentage: percentage,
            status: autoPublish ? 'approved' : 'pending',
            submittedBy: currentUser.username,
            submittedDate: new Date().toISOString().split('T')[0],
            hasDocument: false
        };

        db.marksSubmissions.push(submission);

        // If auto-publish is enabled, also add to examResults for immediate parent visibility
        if (autoPublish) {
            const examResult = {
                id: Date.now() + 1,
                studentId: studentId,
                class: newClass || className,
                subject: subject,
                examName: examName,
                marksObtained: marksObtained,
                totalMarks: totalMarks,
                percentage: percentage,
                grade: grade,
                remarks: 'Auto-published',
                addedBy: currentUser.username,
                addedDate: new Date().toISOString().split('T')[0],
                hasDocument: false
            };
            db.examResults.push(examResult);
        }

        saveDB();

        let message = autoPublish ? 'Marks published successfully! Now visible to parents/students.' : 'Marks submitted successfully! Awaiting class teacher approval.';
        if (newClass) message += `\nStudent class updated to ${newClass}.`;

        showModal('Success', message, 'success');
        renderTab('uploadmarks');
    }
};

window.viewStudentDocument = function(docId) {
    if (!db.studentDocuments) {
        showModal('Error', 'No documents found.', 'error');
        return;
    }

    const doc = db.studentDocuments.find(d => d.id === docId);
    if (!doc) {
        showModal('Error', 'Document not found.', 'error');
        return;
    }

    const student = db.students.find(s => s.id === doc.studentId);
    const studentName = student ? student.name : 'Unknown Student';

    // Create modal to display document info and download option
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';

    const modalContent = document.createElement('div');
    modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%;';

    modalContent.innerHTML = `
        <h3 style="margin-top: 0;">üìã Report Card Details</h3>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <p style="margin: 5px 0;"><strong>Student:</strong> ${studentName} (ID: ${doc.studentId})</p>
            <p style="margin: 5px 0;"><strong>Report Card:</strong> ${doc.fileName}</p>
            <p style="margin: 5px 0;"><strong>File Type:</strong> ${doc.fileType || 'Unknown'}</p>
            <p style="margin: 5px 0;"><strong>File Size:</strong> ${(doc.fileSize / 1024).toFixed(2)} KB</p>
            <p style="margin: 5px 0;"><strong>Uploaded By:</strong> ${doc.uploadedBy}</p>
            <p style="margin: 5px 0;"><strong>Upload Date:</strong> ${doc.uploadedDate}</p>
            <p style="margin: 5px 0;"><strong>Description:</strong> ${doc.description || 'Report Card'}</p>
        </div>
        ${doc.fileType && doc.fileType.startsWith('image/') ?
            `<div style="margin: 20px 0; text-align: center;">
                <img src="${doc.fileData}" style="max-width: 100%; max-height: 400px; border: 1px solid #ddd; border-radius: 5px;">
            </div>` : ''}
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="window.downloadStudentDocument(${doc.id})" class="btn-primary">‚¨áÔ∏è Download</button>
            <button onclick="this.closest('[style*=position]').remove()" class="btn-secondary">Close</button>
        </div>
    `;

    modal.appendChild(modalContent);
    document.body.appendChild(modal);

    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
};

window.downloadStudentDocument = function(docId) {
    const doc = db.studentDocuments.find(d => d.id === docId);
    if (!doc) {
        showModal('Error', 'Document not found.', 'error');
        return;
    }

    // Create a download link
    const link = document.createElement('a');
    link.href = doc.fileData;
    link.download = doc.fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showModal('Success', 'Download started!', 'success');
};

window.viewBulkUpload = function(uploadId) {
    if (!db.bulkUploads) {
        showModal('Error', 'No bulk uploads found.', 'error');
        return;
    }

    const upload = db.bulkUploads.find(u => u.id === uploadId);
    if (!upload) {
        showModal('Error', 'File not found.', 'error');
        return;
    }

    // Create modal to display file info and preview
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';

    const modalContent = document.createElement('div');
    modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 10px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;';

    const studentInfo = upload.studentName ? `<p style="margin: 5px 0;"><strong>Sent To:</strong> ${upload.studentName}</p>` : '';
    const statusInfo = upload.autoPublished ? '<span class="badge badge-present">Published</span>' : '<span class="badge badge-late">Pending Approval</span>';

    modalContent.innerHTML = `
        <h3 style="margin-top: 0;">üìã Report Card Details</h3>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <p style="margin: 5px 0;"><strong>File Name:</strong> ${upload.fileName}</p>
            <p style="margin: 5px 0;"><strong>File Type:</strong> ${upload.fileType}</p>
            <p style="margin: 5px 0;"><strong>File Size:</strong> ${(upload.fileSize / 1024).toFixed(2)} KB</p>
            ${studentInfo}
            <p style="margin: 5px 0;"><strong>Uploaded By:</strong> ${upload.uploadedBy}</p>
            <p style="margin: 5px 0;"><strong>Uploaded Date:</strong> ${upload.uploadedDate}</p>
            <p style="margin: 5px 0;"><strong>Description:</strong> ${upload.description || 'N/A'}</p>
            <p style="margin: 5px 0;"><strong>Status:</strong> ${statusInfo}</p>
        </div>
        ${upload.fileType && upload.fileType.startsWith('image/') ?
            `<div style="margin: 20px 0; text-align: center;">
                <h4>Preview:</h4>
                <img src="${upload.fileData}" style="max-width: 100%; max-height: 400px; border: 1px solid #ddd; border-radius: 5px;">
            </div>` :
            `<div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; margin: 20px 0;">
                <p style="margin: 0;"><strong>‚ÑπÔ∏è Preview not available for this file type.</strong></p>
                <p style="margin: 5px 0 0 0;">Use the download button below to access the file.</p>
            </div>`}
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button onclick="window.downloadBulkUpload(${upload.id})" class="btn-primary">‚¨áÔ∏è Download</button>
            <button onclick="this.closest('[style*=position]').remove()" class="btn-secondary">Close</button>
        </div>
    `;

    modal.appendChild(modalContent);
    document.body.appendChild(modal);

    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
};

window.downloadBulkUpload = function(uploadId) {
    const upload = db.bulkUploads.find(u => u.id === uploadId);
    if (!upload) {
        showModal('Error', 'File not found.', 'error');
        return;
    }

    // Create a download link
    const link = document.createElement('a');
    link.href = upload.fileData;
    link.download = upload.fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showModal('Success', 'Download started!', 'success');
};

window.previewBulkFile = function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const previewDiv = document.getElementById('bulkFilePreview');
    const fileExt = file.name.split('.').pop().toLowerCase();
    const fileType = file.type;

    // Display file info
    let html = `<div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
        <p style="margin: 5px 0;"><strong>üìé File Selected:</strong> ${file.name}</p>
        <p style="margin: 5px 0;"><strong>üìä File Type:</strong> ${fileType || 'Unknown'}</p>
        <p style="margin: 5px 0;"><strong>üíæ File Size:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
    </div>`;

    // Preview based on file type
    if (fileExt === 'csv' || fileExt === 'txt' || fileType === 'text/csv' || fileType === 'text/plain') {
        // Preview CSV/Text files
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split('\n').filter(line => line.trim());

            html += '<h4>File Preview:</h4><table class="attendance-table"><thead><tr><th>Student ID</th><th>Exam</th><th>Subject</th><th>Marks</th><th>Total</th></tr></thead><tbody>';

            lines.forEach((line, index) => {
                if (index === 0 && line.includes('studentId')) return; // Skip header
                const parts = line.split(/,|\t/).map(p => p.trim()); // Split by comma or tab
                if (parts.length >= 5) {
                    html += `<tr><td>${parts[0]}</td><td>${parts[1]}</td><td>${parts[2]}</td><td>${parts[3]}</td><td>${parts[4]}</td></tr>`;
                }
            });

            html += '</tbody></table>';
            previewDiv.innerHTML = html;
        };
        reader.readAsText(file);
    } else if (fileType && fileType.startsWith('image/')) {
        // Preview images
        const reader = new FileReader();
        reader.onload = function(e) {
            html += `<div style="text-align: center; margin-top: 15px;">
                <h4>Image Preview:</h4>
                <img src="${e.target.result}" style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 5px;">
            </div>`;
            previewDiv.innerHTML = html;
        };
        reader.readAsDataURL(file);
    } else {
        // For other file types (PDF, Excel, Word, etc.)
        html += `<div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107;">
            <p style="margin: 0;"><strong>‚ÑπÔ∏è Preview not available for this file type.</strong></p>
            <p style="margin: 5px 0 0 0;">The file will be uploaded and stored. If it's a CSV/Excel file, marks will be extracted during upload.</p>
        </div>`;
        previewDiv.innerHTML = html;
    }
};

window.handleBulkUpload = function(event) {
    event.preventDefault();

    console.log('=== BULK UPLOAD STARTED ===');

    const fileInput = document.getElementById('bulkFile');
    const file = fileInput.files[0];
    const studentId = parseInt(document.getElementById('bulkStudent').value);
    const className = document.getElementById('bulkClass').value;
    const description = document.getElementById('bulkFileDescription').value.trim();
    const autoPublish = document.getElementById('bulkAutoPublish').checked;

    console.log('Form values:');
    console.log('- File:', file ? file.name : 'NONE');
    console.log('- Student ID:', studentId, 'Type:', typeof studentId);
    console.log('- Class Name:', className);
    console.log('- Description:', description);
    console.log('- Auto Publish:', autoPublish);

    if (!file) {
        showModal('Warning', 'Please select a file!', 'warning');
        return;
    }

    const fileExt = file.name.split('.').pop().toLowerCase();
    const fileType = file.type;

    console.log('File type:', fileType, 'Extension:', fileExt);

    // Check if it's a CSV/Text file that can be parsed for marks
    if (fileExt === 'csv' || fileExt === 'txt' || fileType === 'text/csv' || fileType === 'text/plain') {
        // Parse CSV/Text file for marks
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split('\n').filter(line => line.trim());
            let added = 0;
            let errors = 0;

            lines.forEach((line, index) => {
                if (index === 0 && line.includes('studentId')) return; // Skip header

                const parts = line.split(/,|\t/).map(p => p.trim()); // Split by comma or tab
                if (parts.length >= 5) {
                    const csvStudentId = parseInt(parts[0]);
                    const examName = parts[1];
                    const subject = parts[2];
                    const marksObtained = parseInt(parts[3]);
                    const totalMarks = parseInt(parts[4]);

                    if (csvStudentId && examName && subject && !isNaN(marksObtained) && !isNaN(totalMarks)) {
                        const student = db.students.find(s => s.id === csvStudentId);
                        if (student && marksObtained <= totalMarks) {
                            const percentage = ((marksObtained / totalMarks) * 100).toFixed(2);

                            // Calculate grade
                            let grade = 'F';
                            if (percentage >= 90) grade = 'A+';
                            else if (percentage >= 80) grade = 'A';
                            else if (percentage >= 70) grade = 'B+';
                            else if (percentage >= 60) grade = 'B';
                            else if (percentage >= 50) grade = 'C+';
                            else if (percentage >= 40) grade = 'C';
                            else if (percentage >= 33) grade = 'D';

                            db.marksSubmissions.push({
                                id: Date.now() + added,
                                studentId: csvStudentId,
                                class: student.class,
                                subject: subject,
                                examName: examName,
                                marksObtained: marksObtained,
                                totalMarks: totalMarks,
                                percentage: percentage,
                                status: autoPublish ? 'approved' : 'pending',
                                submittedBy: currentUser.username,
                                submittedDate: new Date().toISOString().split('T')[0],
                                hasDocument: false
                            });

                            // If auto-publish, also add to examResults
                            if (autoPublish) {
                                db.examResults.push({
                                    id: Date.now() + added + 10000,
                                    studentId: csvStudentId,
                                    class: student.class,
                                    subject: subject,
                                    examName: examName,
                                    marksObtained: marksObtained,
                                    totalMarks: totalMarks,
                                    percentage: percentage,
                                    grade: grade,
                                    remarks: 'Auto-published from CSV',
                                    addedBy: currentUser.username,
                                    addedDate: new Date().toISOString().split('T')[0],
                                    hasDocument: false
                                });
                            }

                            added++;
                        } else {
                            errors++;
                        }
                    } else {
                        errors++;
                    }
                }
            });

            saveDB();
            const publishMsg = autoPublish ? ' and published to parents/students' : '';
            showModal('Success', `CSV upload complete!\n${added} marks submitted${publishMsg} successfully.\n${errors} entries had errors.`, 'success');
            renderTab('uploadmarks');
        };
        reader.readAsText(file);
    } else {
        console.log('=== NON-CSV FILE - STUDENT DOCUMENT ===');

        // For other file types (PDF, Excel, Images, etc.), must select a student
        if (!studentId || !className) {
            console.error('Missing student ID or class:', {studentId, className});
            showModal('Warning', 'Please select a class and student for non-CSV file uploads!', 'warning');
            return;
        }

        console.log('Searching for student with ID:', studentId);
        const student = db.students.find(s => s.id === studentId);
        console.log('Student found:', student);

        if (!student) {
            console.error('Student not found in database!');
            console.log('All students:', db.students);
            showModal('Error', 'Student not found!', 'error');
            return;
        }

        console.log('Starting file read for student:', student.name, 'ID:', student.id);

        // Store as student document
        const reader = new FileReader();
        reader.onload = function(e) {
            console.log('File read complete, creating document object...');
            // Initialize studentDocuments array if it doesn't exist
            if (!db.studentDocuments) {
                db.studentDocuments = [];
            }

            const fileData = {
                id: Date.now(),
                studentId: studentId,
                fileName: file.name,
                fileType: file.type || 'Unknown',
                fileSize: file.size,
                fileData: e.target.result, // Base64 encoded
                uploadedBy: currentUser.username,
                uploadedDate: new Date().toISOString().split('T')[0],
                description: description || `Report Card: ${file.name}`,
                category: 'report_card',
                autoPublished: autoPublish
            };

            console.log('Saving file to student documents:', fileData);
            console.log('Student ID:', studentId, 'Student Name:', student.name);

            db.studentDocuments.push(fileData);

            // Also add to bulkUploads for teacher reference
            if (!db.bulkUploads) {
                db.bulkUploads = [];
            }

            db.bulkUploads.push({
                id: Date.now() + 1,
                studentId: studentId,
                studentName: student.name,
                fileName: file.name,
                fileType: file.type || 'Unknown',
                fileSize: file.size,
                fileData: e.target.result,
                uploadedBy: currentUser.username,
                uploadedDate: new Date().toISOString().split('T')[0],
                description: description || `Report Card - ${student.name}`,
                category: 'report_card',
                documentId: fileData.id,
                autoPublished: autoPublish
            });

            saveDB();

            console.log('Database saved. Total student documents:', db.studentDocuments.length);
            console.log('All student documents:', db.studentDocuments);

            const publishMsg = autoPublish ? ' and is now visible to the student/parent' : ' (pending approval)';
            showModal('Success', `Report card "${file.name}" uploaded successfully to ${student.name}${publishMsg}!\n\nStudent ID: ${studentId}\nReport card saved with ID: ${fileData.id}`, 'success');
            renderTab('uploadmarks');
        };
        reader.readAsDataURL(file);
    }
};

// ==================== REPORT CARDS TAB (CLASS TEACHER) ====================
function renderReportCardsTab(contentArea) {
    // Refresh database for real-time updates
    db = getDB();

    const classTeacher = db.classteachers.find(ct => ct.id === currentUser.username);
    if (!classTeacher) {
        contentArea.innerHTML = '<div class="card"><p>Class teacher information not found.</p></div>';
        return;
    }

    const cls = classTeacher.class;

    let html = '<h2>Report Cards Management</h2>';

    // Pending Marks Submissions
    const pendingSubmissions = db.marksSubmissions.filter(s => {
        const student = db.students.find(st => st.id === s.studentId);
        return student && student.class === cls && s.status === 'pending';
    });

    html += `<div class="card">
        <h3>Pending Marks Approval (Class ${cls})</h3>`;

    if (pendingSubmissions.length === 0) {
        html += '<p>No pending submissions.</p>';
    } else {
        html += `<table class="attendance-table">
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Subject</th>
                    <th>Exam</th>
                    <th>Marks</th>
                    <th>Percentage</th>
                    <th>Submitted By</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>`;

        pendingSubmissions.forEach(sub => {
            const student = db.students.find(s => s.id === sub.studentId);
            const teacher = db.teachers.find(t => t.id === sub.submittedBy);

            html += `<tr>
                <td>${student ? student.name : 'Unknown'}</td>
                <td>${sub.subject}</td>
                <td>${sub.examName}</td>
                <td>${sub.marksObtained}/${sub.totalMarks}</td>
                <td>${sub.percentage}%</td>
                <td>${teacher ? teacher.name : 'Unknown'}</td>
                <td>
                    <button class="btn-primary" style="padding: 8px 12px; font-size: 12px; margin-right: 5px;" onclick="window.approveMarks(${sub.id})">Approve</button>
                    <button class="btn-danger" style="padding: 8px 12px; font-size: 12px;" onclick="window.rejectMarks(${sub.id})">Reject</button>
                </td>
            </tr>`;
        });

        html += '</tbody></table>';
    }

    html += '</div>';

    // Generate Report Cards
    html += `<div class="card">
        <h3>Generate Report Cards</h3>
        <form onsubmit="window.generateReportCards(event, '${cls}'); return false;">
            <div class="form-control">
                <label for="rcExam">Exam Name</label>
                <input type="text" id="rcExam" placeholder="e.g., Mid Term Exam 2025" required>
            </div>
            <div class="btn-group">
                <button type="submit" class="btn-primary">Generate Report Cards for Class ${cls}</button>
            </div>
        </form>
    </div>`;

    // View Generated Report Cards
    const classReportCards = db.reportCards.filter(rc => rc.class === cls);

    html += `<div class="card">
        <h3>Generated Report Cards</h3>`;

    if (classReportCards.length === 0) {
        html += '<p>No report cards generated yet.</p>';
    } else {
        html += `<table class="attendance-table">
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Exam</th>
                    <th>Overall %</th>
                    <th>Generated Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>`;

        classReportCards.forEach(rc => {
            const student = db.students.find(s => s.id === rc.studentId);

            html += `<tr>
                <td>${student ? student.name : 'Unknown'}</td>
                <td>${rc.examName}</td>
                <td><strong>${rc.overallPercentage}%</strong></td>
                <td>${rc.generatedDate}</td>
                <td>
                    <button class="btn-primary" style="padding: 8px 12px; font-size: 12px; margin-right: 5px;" onclick="window.viewReportCard(${rc.id})">View</button>
                    <button class="btn-secondary" style="padding: 8px 12px; font-size: 12px;" onclick="window.sendToParent(${rc.id})">Send to Parent</button>
                </td>
            </tr>`;
        });

        html += '</tbody></table>';
    }

    html += '</div>';
    contentArea.innerHTML = html;
}

window.approveMarks = function(submissionId) {
    const submission = db.marksSubmissions.find(s => s.id === submissionId);
    if (submission) {
        submission.status = 'approved';
        submission.approvedBy = currentUser.username;
        submission.approvedDate = new Date().toISOString().split('T')[0];
        saveDB();
        showModal('Success', 'Marks approved!', 'success');
        renderTab('reportcards');
    }
};

window.rejectMarks = function(submissionId) {
    const reason = prompt('Enter reason for rejection:');
    if (!reason) return;

    const submission = db.marksSubmissions.find(s => s.id === submissionId);
    if (submission) {
        submission.status = 'rejected';
        submission.rejectedBy = currentUser.username;
        submission.rejectedDate = new Date().toISOString().split('T')[0];
        submission.rejectionReason = reason;
        saveDB();
        showModal('Success', 'Marks rejected!', 'success');
        renderTab('reportcards');
    }
};

window.generateReportCards = function(event, className) {
    event.preventDefault();

    const examName = document.getElementById('rcExam').value.trim();
    if (!examName) {
        showModal('Warning', 'Please enter exam name!', 'warning');
        return;
    }

    const students = db.students.filter(s => s.class === className && s.status === 'active');
    let generated = 0;

    students.forEach(student => {
        // Get all approved marks for this student and exam
        const studentMarks = db.marksSubmissions.filter(s =>
            s.studentId === student.id &&
            s.examName === examName &&
            s.status === 'approved'
        );

        if (studentMarks.length > 0) {
            const totalMarksObtained = studentMarks.reduce((sum, m) => sum + m.marksObtained, 0);
            const totalMarks = studentMarks.reduce((sum, m) => sum + m.totalMarks, 0);
            const overallPercentage = ((totalMarksObtained / totalMarks) * 100).toFixed(2);

            // Check if report card already exists
            const existing = db.reportCards.find(rc =>
                rc.studentId === student.id &&
                rc.examName === examName
            );

            if (!existing) {
                db.reportCards.push({
                    id: Date.now() + generated,
                    studentId: student.id,
                    class: className,
                    examName: examName,
                    marks: studentMarks,
                    overallPercentage: overallPercentage,
                    generatedBy: currentUser.username,
                    generatedDate: new Date().toISOString().split('T')[0],
                    sentToParent: false
                });
                generated++;
            }
        }
    });

    saveDB();
    showModal('Success', `${generated} report card(s) generated successfully!`, 'success');
    renderTab('reportcards');
};

window.viewReportCard = function(reportCardId) {
    const rc = db.reportCards.find(r => r.id === reportCardId);
    if (!rc) return;

    const student = db.students.find(s => s.id === rc.studentId);

    let html = `
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 800px; margin: 0 auto;">
            <div style="text-align: center; border-bottom: 3px solid var(--color-primary); padding-bottom: 20px; margin-bottom: 20px;">
                <h1 style="color: var(--color-primary); margin: 0;">DPS Nadergul</h1>
                <h2 style="margin: 10px 0;">Report Card</h2>
                <p style="font-size: 18px;"><strong>${rc.examName}</strong></p>
            </div>

            <div style="margin-bottom: 20px;">
                <p><strong>Student Name:</strong> ${student ? student.name : 'Unknown'}</p>
                <p><strong>Class:</strong> ${rc.class}</p>
                <p><strong>Student ID:</strong> ${rc.studentId}</p>
            </div>

            <table class="attendance-table">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Marks Obtained</th>
                        <th>Total Marks</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>`;

    rc.marks.forEach(mark => {
        html += `<tr>
            <td><strong>${mark.subject}</strong></td>
            <td>${mark.marksObtained}</td>
            <td>${mark.totalMarks}</td>
            <td>${mark.percentage}%</td>
        </tr>`;
    });

    html += `</tbody></table>

            <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f0f8ff 0%, #e8f5e9 100%); border-radius: 10px; text-align: center;">
                <h3 style="color: var(--color-primary); margin: 0;">Overall Percentage</h3>
                <p style="font-size: 48px; font-weight: 800; color: var(--color-primary); margin: 10px 0;">${rc.overallPercentage}%</p>
            </div>

            <div style="margin-top: 30px; text-align: center;">
                <button class="btn-secondary" onclick="window.print()">üñ®Ô∏è Print Report Card</button>
                <button class="btn-primary" onclick="renderTab('reportcards')">‚Üê Back</button>
            </div>
        </div>
    `;

    document.getElementById('contentArea').innerHTML = html;
};

window.sendToParent = function(reportCardId) {
    const rc = db.reportCards.find(r => r.id === reportCardId);
    if (rc) {
        rc.sentToParent = true;
        rc.sentDate = new Date().toISOString().split('T')[0];
        saveDB();
        showModal('Success', 'Report card sent to parent! They can now view it in their dashboard.', 'success');
        renderTab('reportcards');
    }
};

// Multi-tab real-time sync system
let lastKnownUpdate = Date.now();
let currentActiveTab = 'home';

function reloadCurrentView() {
    // Reload database from localStorage
    db = getDB();

    // Get current active tab
    const activeMenu = document.querySelector('.menu-link.active');
    if (activeMenu) {
        const tabName = activeMenu.parentElement.querySelector('.menu-link').textContent.trim();
        const tabMap = {
            'Home': 'home',
            'Attendance': 'attendance',
            'Homework': currentUser.role === 'parent' ? 'viewhomework' : 'homework',
            'Mark Attendance': 'markattendance',
            'My Classes': 'myclasses',
            'Report Issues': 'teacherissues',
            'Manage Issues': 'coordissues',
            'Issues': currentUser.role === 'superviceprincipal' ? 'svpissues' : 'vpissues',
            'Timetable': currentUser.role === 'coordinator' || currentUser.role === 'viceprincipal' || currentUser.role === 'superviceprincipal' ? 'managetimetable' : 'timetable',
            'Profile': 'profile',
            'Holidays': 'holidays',
            'Register': 'register',
            'Analytics': 'analytics',
            'Classes': 'classes',
            'CCA Calendar': 'uploadcca',
            'Class Dashboard': 'classdashboard',
            'Remove Student': 'removestudent',
            'Delete Student Data': 'deletestudent',
            'Exam Schedule': currentUser.role === 'coordinator' ? 'uploadexam' : 'examschedule',
            'Exam Results': currentUser.role === 'parent' ? 'viewexamresults' : 'examresults'
        };

        currentActiveTab = tabMap[tabName] || 'home';
    }

    // Re-render current view
    if (currentUser) {
        renderTab(currentActiveTab);
    }
}

// Listen for changes from other tabs
window.addEventListener('storage', function(e) {
    if (e.key === 'campusCoreDB_sync' && currentUser) {
        const newUpdate = parseInt(e.newValue);
        if (newUpdate > lastKnownUpdate) {
            lastKnownUpdate = newUpdate;
            console.log('üîÑ Database updated from another tab - syncing...');
            reloadCurrentView();

            // Show notification
            showSyncNotification();
        }
    }

    // Handle user logout in another tab
    if (e.key === 'currentUser' && e.newValue === null && currentUser) {
        console.log('üö™ User logged out in another tab');
        currentUser = null;
        showLogin();
    }
});

// Reload data when tab becomes visible
document.addEventListener('visibilitychange', function() {
    if (!document.hidden && currentUser) {
        const currentDB = getDB();
        if (currentDB.lastUpdated && currentDB.lastUpdated > lastKnownUpdate) {
            lastKnownUpdate = currentDB.lastUpdated;
            console.log('üîÑ Tab visible - syncing latest data...');
            reloadCurrentView();
        }
    }
});

// Show sync notification
function showSyncNotification() {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, var(--color-success) 0%, #1b5e20 100%);
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        z-index: 10000;
        font-weight: 600;
        font-size: 14px;
        animation: slideIn 0.3s ease-out;
    `;
    notification.innerHTML = 'üîÑ Data synced from another tab';
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}

// Add animation styles
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// ==================== MY DUTIES TAB (TEACHER) ====================
function renderMyDutiesTab(contentArea) {
    // Refresh database for real-time updates
    db = getDB();

    // Initialize teacherDuties if it doesn't exist
    if (!db.teacherDuties) {
        db.teacherDuties = [];
        saveDB();
    }

    const teacher = db.teachers.find(t => t.id === currentUser.username);
    if (!teacher) {
        contentArea.innerHTML = '<div class="card"><p>Teacher information not found.</p></div>';
        return;
    }

    let html = '<h2>My Duties</h2>';

    // Get duties assigned to this teacher
    const myDuties = db.teacherDuties.filter(d => d.teacherId === currentUser.username);

    html += `<div class="card">
        <h3>üìã Assigned Duties</h3>`;

    if (myDuties.length === 0) {
        html += '<p>No duties assigned yet.</p>';
    } else {
        // Group duties by status
        const pendingDuties = myDuties.filter(d => d.status === 'pending');
        const completedDuties = myDuties.filter(d => d.status === 'completed');

        if (pendingDuties.length > 0) {
            html += `<h4 style="color: #ff6b6b; margin-top: 20px;">‚è≥ Pending Duties (${pendingDuties.length})</h4>`;
            html += `<table class="attendance-table">
                <thead>
                    <tr>
                        <th>Date Assigned</th>
                        <th>Duty</th>
                        <th>Description</th>
                        <th>Assigned By</th>
                        <th>Priority</th>
                        <th>Deadline</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>`;

            pendingDuties.forEach(duty => {
                const priorityColor = duty.priority === 'high' ? 'absent' : (duty.priority === 'medium' ? 'late' : 'present');
                html += `<tr>
                    <td>${duty.assignedDate}</td>
                    <td><strong>${duty.title}</strong></td>
                    <td>${duty.description || '-'}</td>
                    <td>${duty.assignedBy}</td>
                    <td><span class="badge badge-${priorityColor}">${duty.priority.toUpperCase()}</span></td>
                    <td>${duty.deadline || '-'}</td>
                    <td>
                        <button onclick="window.markDutyComplete(${duty.id})" class="btn-primary" style="padding: 5px 10px; font-size: 12px;">‚úì Mark Complete</button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
        }

        if (completedDuties.length > 0) {
            html += `<h4 style="color: #51cf66; margin-top: 30px;">‚úÖ Completed Duties (${completedDuties.length})</h4>`;
            html += `<table class="attendance-table">
                <thead>
                    <tr>
                        <th>Date Assigned</th>
                        <th>Duty</th>
                        <th>Description</th>
                        <th>Assigned By</th>
                        <th>Priority</th>
                        <th>Completed Date</th>
                    </tr>
                </thead>
                <tbody>`;

            completedDuties.forEach(duty => {
                const priorityColor = duty.priority === 'high' ? 'absent' : (duty.priority === 'medium' ? 'late' : 'present');
                html += `<tr style="opacity: 0.7;">
                    <td>${duty.assignedDate}</td>
                    <td><strong>${duty.title}</strong></td>
                    <td>${duty.description || '-'}</td>
                    <td>${duty.assignedBy}</td>
                    <td><span class="badge badge-${priorityColor}">${duty.priority.toUpperCase()}</span></td>
                    <td>${duty.completedDate || '-'}</td>
                </tr>`;
            });

            html += '</tbody></table>';
        }
    }

    html += '</div>';
    contentArea.innerHTML = html;
}

window.markDutyComplete = function(dutyId) {
    showConfirm(
        'Complete Duty',
        'Mark this duty as completed?',
        () => {
            // Initialize teacherDuties if it doesn't exist
            if (!db.teacherDuties) {
                db.teacherDuties = [];
            }

            const duty = db.teacherDuties.find(d => d.id === dutyId);
            if (duty) {
                duty.status = 'completed';
                duty.completedDate = new Date().toISOString().split('T')[0];
                saveDB();
                showModal('Success', 'Duty marked as completed!', 'success');
                renderTab('myduties');
            }
        },
        null,
        'Mark Complete',
        'Cancel',
        false
    );
};

// ==================== ASSIGN DUTIES TAB (VICE PRINCIPAL) ====================
function renderAssignDutiesTab(contentArea) {
    // Refresh database for real-time updates
    db = getDB();

    // Initialize teacherDuties if it doesn't exist
    if (!db.teacherDuties) {
        db.teacherDuties = [];
        saveDB();
    }

    let html = '<h2>Assign Duties to Teachers</h2>';

    // Form to assign new duty
    html += `<div class="card">
        <h3>üìù Assign New Duty</h3>
        <form onsubmit="window.handleAssignDuty(event); return false;">
            <div class="form-row">
                <div class="form-control">
                    <label for="dutyTeacher">Select Teacher</label>
                    <select id="dutyTeacher" required>
                        <option value="">Select Teacher</option>
                        ${db.teachers.map(t => `<option value="${t.id}">${t.name} (${t.subjects})</option>`).join('')}
                    </select>
                </div>
                <div class="form-control">
                    <label for="dutyPriority">Priority</label>
                    <select id="dutyPriority" required>
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-control">
                    <label for="dutyTitle">Duty Title</label>
                    <input type="text" id="dutyTitle" placeholder="e.g., Exam Invigilation, Sports Day Supervision" required>
                </div>
                <div class="form-control">
                    <label for="dutyDeadline">Deadline (Optional)</label>
                    <input type="date" id="dutyDeadline">
                </div>
            </div>
            <div class="form-control">
                <label for="dutyDescription">Description</label>
                <textarea id="dutyDescription" rows="3" placeholder="Enter duty details..."></textarea>
            </div>
            <div class="btn-group">
                <button type="submit" class="btn-primary">Assign Duty</button>
            </div>
        </form>
    </div>`;

    // View all assigned duties
    html += `<div class="card">
        <h3>üìä All Assigned Duties</h3>`;

    if (db.teacherDuties.length === 0) {
        html += '<p>No duties assigned yet.</p>';
    } else {
        html += `<table class="attendance-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Teacher</th>
                    <th>Duty</th>
                    <th>Description</th>
                    <th>Priority</th>
                    <th>Deadline</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>`;

        db.teacherDuties.forEach(duty => {
            const teacher = db.teachers.find(t => t.id === duty.teacherId);
            const teacherName = teacher ? teacher.name : 'Unknown';
            const priorityColor = duty.priority === 'high' ? 'absent' : (duty.priority === 'medium' ? 'late' : 'present');
            const statusColor = duty.status === 'completed' ? 'present' : 'late';

            html += `<tr>
                <td>${duty.assignedDate}</td>
                <td><strong>${teacherName}</strong></td>
                <td>${duty.title}</td>
                <td>${duty.description || '-'}</td>
                <td><span class="badge badge-${priorityColor}">${duty.priority.toUpperCase()}</span></td>
                <td>${duty.deadline || '-'}</td>
                <td><span class="badge badge-${statusColor}">${duty.status.toUpperCase()}</span></td>
                <td>
                    ${duty.status === 'pending' ?
                        `<button onclick="window.deleteDuty(${duty.id})" class="btn-secondary" style="padding: 5px 10px; font-size: 12px;">üóëÔ∏è Delete</button>` :
                        `<span style="color: #999;">Completed</span>`}
                </td>
            </tr>`;
        });

        html += '</tbody></table>';
    }

    html += '</div>';
    contentArea.innerHTML = html;
}

window.handleAssignDuty = function(event) {
    event.preventDefault();

    const teacherId = document.getElementById('dutyTeacher').value;
    const title = document.getElementById('dutyTitle').value.trim();
    const description = document.getElementById('dutyDescription').value.trim();
    const priority = document.getElementById('dutyPriority').value;
    const deadline = document.getElementById('dutyDeadline').value;

    if (!teacherId || !title) {
        showModal('Warning', 'Please fill in all required fields!', 'warning');
        return;
    }

    // Initialize teacherDuties if it doesn't exist
    if (!db.teacherDuties) {
        db.teacherDuties = [];
    }

    const duty = {
        id: Date.now(),
        teacherId: teacherId,
        title: title,
        description: description,
        priority: priority,
        deadline: deadline || null,
        status: 'pending',
        assignedBy: currentUser.username,
        assignedDate: new Date().toISOString().split('T')[0],
        completedDate: null
    };

    db.teacherDuties.push(duty);
    saveDB();

    const teacher = db.teachers.find(t => t.id === teacherId);
    showModal('Success', `Duty assigned to ${teacher ? teacher.name : 'teacher'} successfully!`, 'success');
    renderTab('assignduties');
};

window.deleteDuty = function(dutyId) {
    showConfirm(
        'Delete Duty',
        'Are you sure you want to delete this duty assignment?',
        () => {
            // Initialize teacherDuties if it doesn't exist
            if (!db.teacherDuties) {
                db.teacherDuties = [];
            }

            const index = db.teacherDuties.findIndex(d => d.id === dutyId);
            if (index !== -1) {
                db.teacherDuties.splice(index, 1);
                saveDB();
                showModal('Success', 'Duty deleted successfully!', 'success');
                renderTab('assignduties');
            }
        },
        null,
        'Delete',
        'Cancel',
        true
    );
};

// Track active tab for reload
function renderTab(tabName, menuLink = null) {
    currentActiveTab = tabName;
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = '';

    const tabs = {
        home: renderHomeTab,
        attendance: renderAttendanceTab,
        timetable: renderTimetableTab,
        profile: renderProfileTab,
        markattendance: renderMarkAttendanceTab,
        myclasses: renderMyClassesTab,
        myduties: renderMyDutiesTab,
        assignduties: renderAssignDutiesTab,
        teacherissues: renderTeacherIssuesTab,
        coordissues: renderCoordIssuesTab,
        vpissues: renderVPIssuesTab,
        svpissues: renderSVPIssuesTab,
        holidays: renderHolidaysTab,
        register: renderRegisterTab,
        analytics: renderAnalyticsTab,
        classes: renderClassesTab,
        uploadcca: renderUploadCCATab,
        changepassword: renderChangePasswordTab,
        classdashboard: renderClassDashboardTab,
        ctmarkattendance: renderCTMarkAttendanceTab,
        homework: renderHomeworkTab,
        viewhomework: renderViewHomeworkTab,
        managetimetable: renderManageTimetableTab,
        removestudent: renderRemoveStudentTab,
        deletestudent: renderDeleteStudentTab,
        uploadexam: renderUploadExamTab,
        examschedule: renderExamScheduleTab,
        examresults: renderExamResultsTab,
        viewexamresults: renderViewExamResultsTab,
        viewreportcards: renderViewReportCardsTab,
        appointteacher: renderAppointTeacherTab,
        uploadmarks: renderUploadMarksTab,
        reportcards: renderReportCardsTab
    };

    if (tabs[tabName]) {
        tabs[tabName](contentArea);
        document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
        if (menuLink) menuLink.classList.add('active');
    }
}

window.addEventListener('DOMContentLoaded', function() {
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
            showConfirm(
                'Logout',
                'Are you sure you want to logout?',
                () => {
                    currentUser = null;
                    localStorage.removeItem('currentUser');
                    showLogin();
                    document.getElementById('loginForm').reset();
                },
                null,
                'Logout',
                'Cancel',
                false
            );
        });
    }

    // Initialize last update time
    if (db && db.lastUpdated) {
        lastKnownUpdate = db.lastUpdated;
    }

    console.log('‚úÖ Multi-tab real-time sync enabled');
});
</script>

</body>
</html>
