<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusCore - Dashboard</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

<div class="dashboard">
    <!-- Sidebar -->
    <aside class="sidebar">
        <!-- Logo Section -->
        <div class="logo-section">
            <div class="logo-icon">
                <img src="logo.png" alt="CampusCore Logo" style="width: 55px; height: 55px; object-fit: contain;">
            </div>
            <div class="logo-text">
                <h2>CAMPUSCORE</h2>
                <p>Smart Campus</p>
            </div>
        </div>

        <!-- User Block -->
        <div class="user-block">
            <div class="user-avatar" id="userAvatar">?</div>
            <div class="user-name" id="userName">Loading...</div>
            <div class="user-id" id="userId"></div>
            <div class="user-role" id="userRole"></div>
        </div>

        <!-- Menu -->
        <nav>
            <ul class="menu" id="menuList">
                <!-- Menu items will be dynamically generated -->
            </ul>
        </nav>

        <!-- Logout Button -->
        <button class="logout-btn" id="logoutBtn">
            <span class="menu-icon">üö™</span>
            <span>Logout</span>
        </button>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- PROMPT 1 - NEW CODE: Sticky Top Banner -->
        <div class="sticky-top-banner" id="stickyBanner">
            <div class="banner-left">
                <button class="hamburger-menu" id="hamburgerMenu" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <span class="banner-datetime" id="bannerDateTime">Loading...</span>
            </div>
            <div class="banner-right">
                <span class="banner-role-badge" id="bannerRole">User</span>
                <span class="banner-tasks" id="bannerTasks">‚ö° 0 Pending Tasks</span>
                <!-- PROMPT 3 - NEW CODE: Enhanced Notification Center -->
                <div class="banner-notifications" id="bannerNotifications">
                    <button class="notification-btn" id="notificationBtn" aria-label="Notifications">
                        üîî <span class="notification-count hidden" id="notificationCount">0</span>
                    </button>
                    <div class="notification-dropdown hidden" id="notificationDropdown">
                        <div class="notification-header">
                            <span>üîî Notifications</span>
                            <button class="notification-close-btn" id="notificationCloseBtn">‚úï</button>
                        </div>
                        <div class="notification-actions">
                            <button class="notification-action-btn" onclick="markAllNotificationsAsRead()">Mark all as read</button>
                            <button class="notification-action-btn" onclick="clearAllNotifications()">Clear all</button>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <div class="notification-empty">No new notifications</div>
                        </div>
                    </div>
                </div>
                <!-- END PROMPT 3 - NEW CODE -->
                <!-- PROMPT 2 - NEW CODE: Global Search Button -->
                <button class="search-toggle-btn" id="searchToggle" aria-label="Global search" title="Search everything">
                    üîç
                </button>
                <!-- END PROMPT 2 - NEW CODE -->
                <button class="theme-toggle-btn" id="themeToggle" aria-label="Toggle dark mode" title="Toggle dark/light mode">
                    <span class="theme-icon">‚òÄÔ∏è</span>
                </button>
            </div>
        </div>
        <!-- END PROMPT 1 - NEW CODE -->

        <!-- Header Banner -->
        <div class="header-banner">
            <h1>Delhi Public School, Nadergul</h1>
            <p>Excellence in Education</p>
        </div>

        <!-- PROMPT 1 - NEW CODE: Main Content Wrapper with Activity Feed -->
        <div class="content-wrapper">
            <!-- Content Area -->
            <div class="content-area" id="contentArea">
                <!-- Dynamic content will be loaded here -->
            </div>

            <!-- Activity Feed Panel (Right Side) -->
            <aside class="activity-feed-panel" id="activityFeedPanel">
                <div class="activity-feed-header">
                    <h3>Activity Feed</h3>
                    <span class="activity-feed-subtitle">Last 10 activities</span>
                </div>
                <div class="activity-feed-list" id="activityFeedList">
                    <div class="activity-item">
                        <div class="activity-time">Loading...</div>
                        <div class="activity-content">Fetching recent activities...</div>
                    </div>
                </div>
            </aside>
        </div>
        <!-- END PROMPT 1 - NEW CODE -->
    </main>
</div>

<!-- PROMPT 1 - NEW CODE: Sidebar Backdrop for Mobile -->
<div class="sidebar-backdrop hidden" id="sidebarBackdrop"></div>
<!-- END PROMPT 1 - NEW CODE -->

<!-- PROMPT 2 - NEW CODE: Global Search Overlay -->
<div class="search-overlay hidden" id="searchOverlay">
    <div class="search-panel">
        <div class="search-header">
            <input type="text" id="searchInput" class="search-input" placeholder="Search students, teachers, attendance, marks..." autocomplete="off">
            <button class="search-close-btn" id="searchCloseBtn" aria-label="Close search">‚úï</button>
        </div>
        <div class="search-results" id="searchResults">
            <div class="search-empty">Type to search across all data...</div>
        </div>
    </div>
</div>
<!-- END PROMPT 2 - NEW CODE -->

<!-- Loading Overlay -->
<div class="loading-overlay hidden" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>
</div>

<!-- Load Supabase from CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Load application scripts -->
<script src="assets/js/supabase-client.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/database.js"></script>
<script src="assets/js/utils.js"></script>

<script>
// Global variables
let currentTab = 'home';
let initialized = false;

// Menu items by role
const menuItems = {
    parent: [
        { id: 'home', icon: 'üè†', label: 'Dashboard' },
        { id: 'attendance', icon: 'üìä', label: 'Attendance' },
        { id: 'viewhomework', icon: 'üìù', label: 'Homework' },
        { id: 'viewexamresults', icon: 'üìà', label: 'Exam Results' },
        { id: 'viewreportcards', icon: 'üìÑ', label: 'Report Cards' },
        { id: 'examschedule', icon: 'üìÖ', label: 'Exam Schedule' },
        { id: 'timetable', icon: 'üóìÔ∏è', label: 'Timetable' },
        { id: 'profile', icon: 'üë§', label: 'Profile' },
        { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ],
    teacher: [
        { id: 'home', icon: 'üè†', label: 'Dashboard' },
        { id: 'myduties', icon: 'üìã', label: 'My Duties' },
        { id: 'markattendance', icon: '‚úÖ', label: 'Mark Attendance' },
        { id: 'homework', icon: 'üìù', label: 'Homework' },
        { id: 'examresults', icon: 'üìä', label: 'Exam Results' },
        { id: 'uploadmarks', icon: 'üìà', label: 'Upload Marks' },
        { id: 'myclasses', icon: 'üë•', label: 'My Classes' },
        { id: 'teacherissues', icon: '‚ö†Ô∏è', label: 'Issues' },
        { id: 'teacheranalytics', icon: 'üìä', label: 'My Analytics' }, // PROMPT 3 - NEW CODE
        { id: 'timetable', icon: 'üóìÔ∏è', label: 'Timetable' },
        { id: 'profile', icon: 'üë§', label: 'Profile' },
        { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ],
    coordinator: [
        { id: 'home', icon: 'üè†', label: 'Dashboard' },
        { id: 'coordissues', icon: '‚ö†Ô∏è', label: 'Issues' },
        { id: 'issuesdashboard', icon: 'üìã', label: 'Issues Dashboard' }, // PROMPT 3 - NEW CODE
        { id: 'coordinatoranalytics', icon: 'üìä', label: 'Analytics Dashboard' }, // PROMPT 3 - NEW CODE
        { id: 'attendanceanalytics', icon: 'üìà', label: 'Attendance Analytics' }, // PROMPT 3 - NEW CODE
        { id: 'performanceanalytics', icon: 'üéØ', label: 'Performance Analytics' }, // PROMPT 3 - NEW CODE
        { id: 'uploadexam', icon: 'üìã', label: 'Upload Exam' },
        { id: 'classes', icon: 'üë•', label: 'Classes' },
        { id: 'managetimetable', icon: 'üóìÔ∏è', label: 'Manage Timetable' },
        { id: 'uploadcca', icon: 'üé®', label: 'Upload CCA' },
        { id: 'bulkupload', icon: 'üì§', label: 'Bulk Upload' }, // PROMPT 2 - NEW CODE
        { id: 'timetable', icon: 'üìÖ', label: 'View Timetable' },
        { id: 'profile', icon: 'üë§', label: 'Profile' },
        { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ],
    viceprincipal: [
      { id: 'home', icon: 'üè†', label: 'Dashboard' },
    { id: 'classmanagement', icon: 'üè´', label: 'Class Management' },
    { id: 'homeworkmanagement', icon: 'üìö', label: 'Homework Management' },
    { id: 'timetablemanagement', icon: 'üóìÔ∏è', label: 'Timetable Management' },
    { id: 'teacherschedule', icon: 'üë®‚Äçüè´', label: 'Teacher Schedule' },
    { id: 'examschedule', icon: 'üìù', label: 'Exam Schedule' },
    { id: 'manualmarks', icon: 'üìä', label: 'Manual Marks Upload' },
    { id: 'bulkupload', icon: 'üì§', label: 'New Students Upload' },
    { id: 'marksapproval', icon: '‚úÖ', label: 'Marks Approval' },
    { id: 'appointteacher', icon: 'üë®‚Äçüè´', label: 'Appoint Teacher' },
    { id: 'assignduties', icon: 'üìã', label: 'Assign Duties' },
    { id: 'vpissues', icon: '‚ö†Ô∏è', label: 'Issues' },
    { id: 'issuesdashboard', icon: 'üìã', label: 'Issues Dashboard' },
    { id: 'escalatedissues', icon: 'üö®', label: 'Escalated Issues' },
    { id: 'attendanceanalytics', icon: 'üìà', label: 'Attendance Analytics' },
    { id: 'performanceanalytics', icon: 'üéØ', label: 'Performance Analytics' },
    { id: 'studentanalysis', icon: 'üë•', label: 'Student Analysis' },
    { id: 'removestudent', icon: 'üö´', label: 'Remove Student' },
    { id: 'deletestudent', icon: '‚ùå', label: 'Delete Student' },
    { id: 'holidays', icon: 'üéâ', label: 'Holidays' },
    { id: 'register', icon: 'üìù', label: 'Register' },
    { id: 'timetable', icon: 'üóìÔ∏è', label: 'Timetable' },
    { id: 'profile', icon: 'üë§', label: 'Profile' },
    { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ],
    superviceprincipal: [
        { id: 'home', icon: 'üè†', label: 'Dashboard' },
        { id: 'appointteacher', icon: 'üë®‚Äçüè´', label: 'Appoint Teacher' },
        { id: 'assignduties', icon: 'üìã', label: 'Assign Duties' },
        { id: 'svpissues', icon: '‚ö†Ô∏è', label: 'Issues' },
        { id: 'issuesdashboard', icon: 'üìã', label: 'Issues Dashboard' }, // PROMPT 3 - NEW CODE
        { id: 'principalanalytics', icon: 'üìä', label: 'Analytics Dashboard' }, // PROMPT 3 - NEW CODE
        { id: 'attendanceanalytics', icon: 'üìà', label: 'Attendance Analytics' }, // PROMPT 3 - NEW CODE
        { id: 'performanceanalytics', icon: 'üéØ', label: 'Performance Analytics' }, // PROMPT 3 - NEW CODE
        { id: 'removestudent', icon: 'üö´', label: 'Remove Student' },
        { id: 'deletestudent', icon: '‚ùå', label: 'Delete Student' },
        { id: 'bulkupload', icon: 'üì§', label: 'Bulk Upload' }, // PROMPT 2 - NEW CODE
        { id: 'holidays', icon: 'üéâ', label: 'Holidays' },
        { id: 'register', icon: 'üìù', label: 'Register' },
        { id: 'timetable', icon: 'üóìÔ∏è', label: 'Timetable' },
        { id: 'profile', icon: 'üë§', label: 'Profile' },
        { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ],
    hassan: [
        { id: 'home', icon: 'üè†', label: 'Dashboard' },
        { id: 'manageposts', icon: 'üë•', label: 'Manage Posts' },
        { id: 'appointteacher', icon: 'üë®‚Äçüè´', label: 'Appoint Teacher' },
        { id: 'assignduties', icon: 'üìã', label: 'Assign Duties' },
        { id: 'hassanissues', icon: '‚ö†Ô∏è', label: 'Issues' },
        { id: 'issuesdashboard', icon: 'üìã', label: 'Issues Dashboard' }, // PROMPT 3 - NEW CODE
        { id: 'principalanalytics', icon: 'üìä', label: 'Analytics Dashboard' }, // PROMPT 3 - NEW CODE
        { id: 'attendanceanalytics', icon: 'üìà', label: 'Attendance Analytics' }, // PROMPT 3 - NEW CODE
        { id: 'performanceanalytics', icon: 'üéØ', label: 'Performance Analytics' }, // PROMPT 3 - NEW CODE
        { id: 'removestudent', icon: 'üö´', label: 'Remove Student' },
        { id: 'deletestudent', icon: '‚ùå', label: 'Delete Student' },
        { id: 'bulkupload', icon: 'üì§', label: 'Bulk Upload' }, // PROMPT 2 - NEW CODE
        { id: 'holidays', icon: 'üéâ', label: 'Holidays' },
        { id: 'register', icon: 'üìù', label: 'Register' },
        { id: 'timetable', icon: 'üóìÔ∏è', label: 'Timetable' },
        { id: 'profile', icon: 'üë§', label: 'Profile' },
        { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ],
    classteacher: [
        { id: 'home', icon: 'üè†', label: 'Dashboard' },
        { id: 'classdashboard', icon: 'üìä', label: 'Class Dashboard' },
        { id: 'ctmarkattendance', icon: '‚úÖ', label: 'Mark Attendance' },
        { id: 'reportcards', icon: 'üìÑ', label: 'Report Cards' },
        { id: 'ctmanagetimetable', icon: 'üìÖ', label: 'Upload Timetable' },
        { id: 'myduties', icon: 'üìã', label: 'My Duties' },
        { id: 'homework', icon: 'üìù', label: 'Homework' },
        { id: 'teacherissues', icon: '‚ö†Ô∏è', label: 'Issues' },
        { id: 'timetable', icon: 'üóìÔ∏è', label: 'View Timetable' },
        { id: 'profile', icon: 'üë§', label: 'Profile' },
        { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ]
};

// Initialize application
async function initApp() {
    if (initialized) return;

    try {
        showLoading();

        // Initialize Supabase client
        await window.supabaseClient.init();

        // Initialize database
        window.database.init();

        // Check authentication
        if (!window.auth.requireAuth()) {
            return;
        }

        // Get current user
        const currentUser = window.auth.getCurrentUser();

        // Render user info
        renderUserInfo(currentUser);

        // Render menu
        renderMenu(currentUser.role);

        // Render default tab (home)
        renderTab('home');

        initialized = true;
        hideLoading();
    } catch (error) {
        console.error('Initialization error:', error);
        hideLoading();
        showModal('Error', 'Failed to initialize application. Please refresh the page.', 'error');
    }
}

// Render user info
function renderUserInfo(user) {
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const userId = document.getElementById('userId');
    const userRole = document.getElementById('userRole');

    // Generate avatar initials
    const initials = user.name ? user.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : '?';
    userAvatar.textContent = initials;

    userName.textContent = user.name || user.username;
    userId.textContent = `@${user.username}`;
    userRole.textContent = formatRole(user.role);
}

// Format role for display
function formatRole(role) {
    const roleMap = {
        parent: 'Parent',
        teacher: 'Teacher',
        coordinator: 'Coordinator',
        viceprincipal: 'Vice Principal',
        superviceprincipal: 'Super Vice Principal',
        hassan: 'Hassan Sir (Admin)',
        classteacher: 'Class Teacher'
    };
    return roleMap[role] || role;
}

// PROMPT 1 - NEW CODE: Organize menu items into sections
function organizeMenuSections(items, role) {
    const sections = {
        main: { title: 'MAIN', items: [], icon: '‚ñº' },
        academic: { title: 'ACADEMIC', items: [], icon: '‚ñº' },
        admin: { title: 'ADMIN', items: [], icon: '‚ñº' },
        reports: { title: 'REPORTS', items: [], icon: '‚ñº' }
    };

    const mainIds = ['home', 'profile', 'changepassword', 'classdashboard'];
    const academicIds = ['attendance', 'markattendance', 'ctmarkattendance', 'homework', 'viewhomework', 'examresults', 'uploadmarks', 'viewexamresults', 'viewreportcards', 'examschedule', 'timetable', 'managetimetable', 'ctmanagetimetable', 'myclasses', 'uploadexam', 'uploadcca'];
    const adminIds = ['manageposts', 'appointteacher', 'assignduties', 'removestudent', 'deletestudent', 'holidays', 'register', 'myduties', 'classes', 'classmanagement', 'homeworkmanagement', 'timetablemanagement', 'teacherschedule', 'examschedule', 'manualmarks', 'bulkupload', 'marksapproval', 'teacherissues', 'coordissues', 'vpissues', 'svpissues', 'hassanissues', 'issuesdashboard', 'escalatedissues']; // PROMPT 2 & 3 - NEW CODE
    const reportsIds = ['reportcards', 'analytics', 'principalanalytics', 'coordinatoranalytics', 'teacheranalytics', 'attendanceanalytics', 'performanceanalytics', 'studentanalysis']; // PROMPT 3 - NEW CODE

    items.forEach(item => {
        if (mainIds.includes(item.id)) {
            sections.main.items.push(item);
        } else if (academicIds.includes(item.id)) {
            sections.academic.items.push(item);
        } else if (adminIds.includes(item.id)) {
            sections.admin.items.push(item);
        } else if (reportsIds.includes(item.id)) {
            sections.reports.items.push(item);
        } else {
            sections.main.items.push(item); // Default to main
        }
    });

    // Filter out empty sections
    return Object.entries(sections)
        .filter(([key, section]) => section.items.length > 0)
        .map(([key, section]) => ({ key, ...section }));
}

// Render menu based on role
function renderMenu(role) {
    const menuList = document.getElementById('menuList');
    const items = menuItems[role] || menuItems.parent;

    // PROMPT 1 - NEW CODE: Organize into collapsible sections
    const sections = organizeMenuSections(items, role);

    // Load saved collapse states
    const collapsedSections = JSON.parse(localStorage.getItem('sidebarSections') || '{"main": false, "academic": false, "admin": false, "reports": false}');

    menuList.innerHTML = sections.map(section => `
        <li class="menu-section">
            <button class="menu-section-header" data-section="${section.key}" onclick="toggleMenuSection('${section.key}')">
                <span class="section-arrow ${collapsedSections[section.key] ? 'collapsed' : ''}">${collapsedSections[section.key] ? '‚ñ∂' : '‚ñº'}</span>
                <span class="section-title">${section.title}</span>
            </button>
            <ul class="menu-section-items ${collapsedSections[section.key] ? 'collapsed' : ''}" data-section-items="${section.key}">
                ${section.items.map(item => `
                    <li class="menu-item">
                        <button class="menu-link" data-tab="${item.id}">
                            <span class="menu-icon">${item.icon}</span>
                            <span>${item.label}</span>
                        </button>
                    </li>
                `).join('')}
            </ul>
        </li>
    `).join('');
    // END PROMPT 1 - NEW CODE

    // Add click event listeners
    menuList.querySelectorAll('.menu-link').forEach(link => {
        link.addEventListener('click', function() {
            const tab = this.getAttribute('data-tab');
            renderTab(tab);

            // Update active state
            menuList.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
            this.classList.add('active');

            // PROMPT 1 - NEW CODE: Close sidebar on mobile after selecting
            if (window.innerWidth < 768) {
                document.querySelector('.sidebar').classList.remove('mobile-open');
                document.getElementById('sidebarBackdrop').classList.add('hidden');
            }
            // END PROMPT 1 - NEW CODE
        });
    });

    // Set home as active by default
    const homeLink = menuList.querySelector('[data-tab="home"]');
    if (homeLink) {
        homeLink.classList.add('active');
    }
}

// Render tab content
function renderTab(tabId) {
    currentTab = tabId;
    const contentArea = document.getElementById('contentArea');

    // Clear content
    contentArea.innerHTML = '';

    // Render tab-specific content
    switch(tabId) {
        case 'home':
            renderHomeDashboard();
            break;
        case 'attendance':
            renderAttendance();
            break;
        case 'viewhomework':
            renderViewHomework();
            break;
        case 'viewexamresults':
            renderViewExamResults();
            break;
        case 'viewreportcards':
            renderViewReportCards();
            break;
        case 'examschedule':
            renderExamSchedule();
            break;
        case 'timetable':
            renderTimetable();
            break;
        case 'profile':
            renderProfile();
            break;
        case 'changepassword':
            renderChangePassword();
            break;
        // Teacher tabs
        case 'myduties':
            renderMyDuties();
            break;
        case 'markattendance':
            renderMarkAttendance();
            break;
        case 'homework':
            renderHomework();
            break;
        case 'examresults':
            renderExamResults();
            break;
        case 'uploadmarks':
            renderUploadMarks();
            break;
        case 'myclasses':
            renderMyClasses();
            break;
        case 'teacherissues':
            renderTeacherIssues();
            break;
        // Coordinator tabs
        case 'coordissues':
            renderCoordIssues();
            break;
        case 'uploadexam':
            renderUploadExam();
            break;
        case 'classes':
            renderClasses();
            break;
        case 'managetimetable':
            renderManageTimetable();
            break;
        case 'uploadcca':
            renderUploadCCA();
            break;
        // Vice Principal tabs
        case 'appointteacher':
            renderAppointTeacher();
            break;
        case 'classmanagement':
            renderClassManagement();
            break;
        case 'assignduties':
            renderAssignDuties();
            break;
        case 'vpissues':
        case 'svpissues':
        case 'hassanissues':
            renderVPIssues();
            break;
        case 'manageposts':
            renderManagePosts();
            break;
        case 'removestudent':
            renderRemoveStudent();
            break;
        case 'deletestudent':
            renderDeleteStudent();
            break;
        case 'holidays':
            renderHolidays();
            break;
        case 'register':
            renderRegister();
            break;
        case 'analytics':
            renderAnalytics();
            break;
        // Class Teacher tabs
        case 'classdashboard':
            renderClassDashboard();
            break;
        case 'ctmarkattendance':
            renderCTMarkAttendance();
            break;
        case 'reportcards':
            renderReportCards();
            break;
        case 'ctmanagetimetable':
            renderCTManageTimetable();
            break;
        // PROMPT 2 - NEW CODE: Bulk Upload tab
        case 'bulkupload':
            renderBulkUpload();
            break;
        // END PROMPT 2 - NEW CODE
        // PROMPT 3 - NEW CODE: Analytics and Dashboard tabs
        case 'issuesdashboard':
            renderIssuesDashboard();
            break;
        case 'escalatedissues':
            renderEscalatedIssues();
            break;
        case 'principalanalytics':
            renderPrincipalAnalytics();
            break;
        case 'coordinatoranalytics':
            renderCoordinatorAnalytics();
            break;
        case 'teacheranalytics':
            renderTeacherAnalytics();
            break;
        case 'attendanceanalytics':
            renderAttendanceAnalytics();
            break;
        case 'performanceanalytics':
            renderPerformanceAnalytics();
            break;
        case 'studentanalysis':
            renderStudentAnalysis();
            break;
        // END PROMPT 3 - NEW CODE
        default:
            renderComingSoon(tabId);
    }
}

// Tab rendering functions

async function renderHomeDashboard() {
    const currentUser = window.auth.getCurrentUser();
    const contentArea = document.getElementById('contentArea');

    // Show loading state
    contentArea.innerHTML = `
        <div class="card">
            <h3>Welcome, ${currentUser.name}!</h3>
            <p>You are logged in as <strong>${formatRole(currentUser.role)}</strong></p>

            <div class="stats-grid" style="margin-top: 30px;">
                <div class="stat-card">
                    <div class="stat-value">Loading...</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">Loading...</div>
                    <div class="stat-label">Total Teachers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">Loading...</div>
                    <div class="stat-label">Total Classes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">Loading...</div>
                    <div class="stat-label">Pending Issues</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Quick Actions</h3>
            <div class="btn-group">
                <button class="btn-primary" onclick="renderTab('profile')">View Profile</button>
                <button class="btn-secondary" onclick="renderTab('changepassword')">Change Password</button>
            </div>
        </div>
    `;

    try {
        const client = window.supabaseClient.getClient();

        // Fetch statistics in parallel
        const [studentsResult, teachersResult, classesResult, issuesResult] = await Promise.all([
            client.from('students').select('id', { count: 'exact', head: true }),
            client.from('teachers').select('id', { count: 'exact', head: true }),
            client.from('classes').select('id', { count: 'exact', head: true }),
            client.from('issues').select('id', { count: 'exact', head: true }).eq('status', 'pending')
        ]);

        const totalStudents = studentsResult.count || 0;
        const totalTeachers = teachersResult.count || 0;
        const totalClasses = classesResult.count || 0;
        const pendingIssues = issuesResult.count || 0;

        // PROMPT 1 - NEW CODE: Get previous stats for growth calculation
        const prevStats = JSON.parse(localStorage.getItem('dashboardStats') || '{}');
        const studentsGrowth = prevStats.students ? totalStudents - prevStats.students : 0;
        const teachersGrowth = prevStats.teachers ? totalTeachers - prevStats.teachers : 0;
        const classesGrowth = prevStats.classes ? totalClasses - prevStats.classes : 0;

        // Save current stats for next comparison
        localStorage.setItem('dashboardStats', JSON.stringify({
            students: totalStudents,
            teachers: totalTeachers,
            classes: totalClasses
        }));
        // END PROMPT 1 - NEW CODE

        // Update with actual data
        contentArea.innerHTML = `
            <div class="card">
                <h3>Welcome, ${currentUser.name}!</h3>
                <p>You are logged in as <strong>${formatRole(currentUser.role)}</strong></p>

                <!-- PROMPT 1 - NEW CODE: Interactive Stats Cards -->
                <div class="stats-grid" style="margin-top: 30px;">
                    <div class="stat-card interactive-stat-card" onclick="showStudentsDetail()" title="Click to view all students">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-value">${totalStudents} ${studentsGrowth !== 0 ? `<span class="growth-indicator ${studentsGrowth > 0 ? 'positive' : 'negative'}">${studentsGrowth > 0 ? '‚Üë' : '‚Üì'}</span>` : ''}</div>
                        <div class="stat-label">Total Students</div>
                        <div class="stat-subtitle">${studentsGrowth !== 0 ? `${Math.abs(studentsGrowth)} ${studentsGrowth > 0 ? 'more' : 'less'} than before` : 'Click to view details'}</div>
                    </div>
                    <div class="stat-card interactive-stat-card" onclick="showTeachersDetail()" title="Click to view all teachers">
                        <div class="stat-icon">üë®‚Äçüè´</div>
                        <div class="stat-value">${totalTeachers} ${teachersGrowth !== 0 ? `<span class="growth-indicator ${teachersGrowth > 0 ? 'positive' : 'negative'}">${teachersGrowth > 0 ? '‚Üë' : '‚Üì'}</span>` : ''}</div>
                        <div class="stat-label">Total Teachers</div>
                        <div class="stat-subtitle">${teachersGrowth !== 0 ? `${Math.abs(teachersGrowth)} ${teachersGrowth > 0 ? 'more' : 'less'} than before` : 'Click to view details'}</div>
                    </div>
                    <div class="stat-card interactive-stat-card" onclick="showClassesDetail()" title="Click to view all classes">
                        <div class="stat-icon">üè´</div>
                        <div class="stat-value">${totalClasses} ${classesGrowth !== 0 ? `<span class="growth-indicator ${classesGrowth > 0 ? 'positive' : 'negative'}">${classesGrowth > 0 ? '‚Üë' : '‚Üì'}</span>` : ''}</div>
                        <div class="stat-label">Total Classes</div>
                        <div class="stat-subtitle">${classesGrowth !== 0 ? `${Math.abs(classesGrowth)} ${classesGrowth > 0 ? 'more' : 'less'} than before` : 'Click to view details'}</div>
                    </div>
                    <div class="stat-card interactive-stat-card" onclick="showAttendanceDetail()" title="Click to view attendance details">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value">${pendingIssues}</div>
                        <div class="stat-label">Pending Issues</div>
                        <div class="stat-subtitle">Click to view details</div>
                    </div>
                </div>
                <!-- END PROMPT 1 - NEW CODE -->
            </div>

            <div class="card">
                <h3>Quick Actions</h3>
                <div class="btn-group">
                    <button class="btn-primary" onclick="renderTab('profile')">View Profile</button>
                    <button class="btn-secondary" onclick="renderTab('changepassword')">Change Password</button>
                </div>
            </div>
        `;
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>Welcome, ${currentUser.name}!</h3>
                <p>You are logged in as <strong>${formatRole(currentUser.role)}</strong></p>

                <div class="stats-grid" style="margin-top: 30px;">
                    <div class="stat-card">
                        <div class="stat-value">-</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">-</div>
                        <div class="stat-label">Total Teachers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">-</div>
                        <div class="stat-label">Total Classes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">-</div>
                        <div class="stat-label">Pending Issues</div>
                    </div>
                </div>
                <p style="color: #e74c3c; margin-top: 20px;">Error loading statistics. Please refresh the page.</p>
            </div>

            <div class="card">
                <h3>Quick Actions</h3>
                <div class="btn-group">
                    <button class="btn-primary" onclick="renderTab('profile')">View Profile</button>
                    <button class="btn-secondary" onclick="renderTab('changepassword')">Change Password</button>
                </div>
            </div>
        `;
    }
}

async function renderAttendance() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        showLoading();

        // Get parent's student
        const { data: parent } = await client
            .from('parents')
            .select('student_id')
            .eq('id', currentUser.username)
            .maybeSingle();

        if (!parent) {
            hideLoading();
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìä Attendance Records</h3>
                    <p style="color: #e74c3c;">Parent information not found.</p>
                </div>
            `;
            return;
        }

        // Get student info
        const { data: student } = await client
            .from('students')
            .select('id, name, class')
            .eq('id', parent.student_id)
            .maybeSingle();

        // Get attendance records for the student
        const { data: attendanceRecords } = await client
            .from('attendance')
            .select('*')
            .eq('student_id', parent.student_id)
            .order('date', { ascending: false })
            .limit(50);

        // Calculate statistics
        const total = attendanceRecords?.length || 0;
        const present = attendanceRecords?.filter(a => a.status === 'present').length || 0;
        const absent = attendanceRecords?.filter(a => a.status === 'absent').length || 0;
        const late = attendanceRecords?.filter(a => a.status === 'late').length || 0;
        const percentage = total > 0 ? ((present + late) / total * 100).toFixed(1) : 0;

        hideLoading();

        contentArea.innerHTML = `
            <div class="card">
                <h3>üìä Attendance Records - ${student?.name || 'Student'}</h3>
                <p style="color: #666; margin-bottom: 20px;">Class: ${student?.class || 'N/A'}</p>

                <div class="attendance-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;">${total}</div>
                        <div style="opacity: 0.9;">Total Days</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); padding: 20px; border-radius: 10px; color: white; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;">${present}</div>
                        <div style="opacity: 0.9;">Present</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; color: white; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;">${absent}</div>
                        <div style="opacity: 0.9;">Absent</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #FFA726 0%, #FB8C00 100%); padding: 20px; border-radius: 10px; color: white; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;">${late}</div>
                        <div style="opacity: 0.9;">Late</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #00BCD4 0%, #0097A7 100%); padding: 20px; border-radius: 10px; color: white; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;">${percentage}%</div>
                        <div style="opacity: 0.9;">Attendance Rate</div>
                    </div>
                </div>

                <h4>Recent Attendance</h4>
                ${attendanceRecords && attendanceRecords.length > 0 ? `
                    <table style="width: 100%; margin-top: 15px;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Period</th>
                                <th>Status</th>
                                <th>Behavior</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${attendanceRecords.map(a => {
                                const date = new Date(a.date).toLocaleDateString();
                                const statusColor = a.status === 'present' ? '#4CAF50' : a.status === 'absent' ? '#f44336' : '#FF9800';
                                return `
                                    <tr>
                                        <td>${date}</td>
                                        <td>Period ${a.period}</td>
                                        <td><span class="badge" style="background: ${statusColor};">${a.status.toUpperCase()}</span></td>
                                        <td>${a.behavior || 'N/A'}</td>
                                        <td>${a.remarks || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                ` : '<p style="margin-top: 15px; color: #666;">No attendance records found.</p>'}
            </div>
        `;
    } catch (error) {
        hideLoading();
        console.error('Error loading attendance:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìä Attendance Records</h3>
                <p style="color: #e74c3c;">Error loading attendance data. Please try again.</p>
            </div>
        `;
    }
}

async function renderViewHomework() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        // Get parent's student
        const { data: parent } = await client
            .from('parents')
            .select('student_id')
            .eq('id', currentUser.username)
            .maybeSingle();

        if (!parent) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìù Homework</h3>
                    <p style="color: #e74c3c;">Parent information not found.</p>
                </div>
            `;
            return;
        }

        // Get student's class
        const { data: student } = await client
            .from('students')
            .select('class, name')
            .eq('id', parent.student_id)
            .maybeSingle();

        if (!student) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìù Homework</h3>
                    <p style="color: #e74c3c;">Student information not found.</p>
                </div>
            `;
            return;
        }

        // Get homework for student's class
        const { data: homework } = await client
            .from('homework')
            .select('*')
            .eq('class', student.class)
            .order('date', { ascending: false })
            .limit(50);

        contentArea.innerHTML = `
            <div class="card">
                <h3>üìù Homework - ${student.name} (${student.class})</h3>

                ${homework && homework.length > 0 ? `
                    <table style="width: 100%; margin-top: 20px;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Subject</th>
                                <th>Title</th>
                                <th>Description</th>
                                <th>Due Date</th>
                                <th>Assigned By</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${homework.map(hw => `
                                <tr>
                                    <td>${new Date(hw.date).toLocaleDateString()}</td>
                                    <td><strong>${hw.subject}</strong></td>
                                    <td>${hw.title}</td>
                                    <td>${hw.description || 'N/A'}</td>
                                    <td>${hw.due_date ? new Date(hw.due_date).toLocaleDateString() : 'N/A'}</td>
                                    <td>${hw.assigned_by || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p style="margin-top: 20px; color: #666;">No homework assigned yet.</p>'}
            </div>
        `;
    } catch (error) {
        console.error('Error loading homework:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìù Homework</h3>
                <p style="color: #e74c3c;">Error loading homework. Please try again.</p>
            </div>
        `;
    }
}

async function renderViewExamResults() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        // Get parent's student
        const { data: parent } = await client
            .from('parents')
            .select('student_id')
            .eq('id', currentUser.username)
            .maybeSingle();

        if (!parent) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìà Exam Results</h3>
                    <p style="color: #e74c3c;">Parent information not found.</p>
                </div>
            `;
            return;
        }

        // Get student info
        const { data: student } = await client
            .from('students')
            .select('name')
            .eq('id', parent.student_id)
            .maybeSingle();

        // Get exam results for student
        const { data: results } = await client
            .from('exam_results')
            .select('*')
            .eq('student_id', parent.student_id)
            .order('created_at', { ascending: false });

        contentArea.innerHTML = `
            <div class="card">
                <h3>üìà Exam Results - ${student?.name || 'Student'}</h3>

                ${results && results.length > 0 ? `
                    <table style="width: 100%; margin-top: 20px;">
                        <thead>
                            <tr>
                                <th>Exam Name</th>
                                <th>Subject</th>
                                <th>Marks Obtained</th>
                                <th>Total Marks</th>
                                <th>Percentage</th>
                                <th>Grade</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map(result => {
                                const percentage = result.total_marks > 0
                                    ? ((result.marks / result.total_marks) * 100).toFixed(2)
                                    : 'N/A';
                                return `
                                    <tr>
                                        <td><strong>${result.exam_name}</strong></td>
                                        <td>${result.subject}</td>
                                        <td>${result.marks}</td>
                                        <td>${result.total_marks}</td>
                                        <td>${percentage}%</td>
                                        <td><span class="badge badge-${result.grade || 'normal'}">${result.grade || 'N/A'}</span></td>
                                        <td>${result.remarks || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                ` : '<p style="margin-top: 20px; color: #666;">No exam results available yet.</p>'}
            </div>
        `;
    } catch (error) {
        console.error('Error loading exam results:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìà Exam Results</h3>
                <p style="color: #e74c3c;">Error loading exam results. Please try again.</p>
            </div>
        `;
    }
}

async function renderViewReportCards() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        // Get parent's student
        const { data: parent } = await client
            .from('parents')
            .select('student_id')
            .eq('id', currentUser.username)
            .maybeSingle();

        if (!parent) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìÑ Report Cards</h3>
                    <p style="color: #e74c3c;">Parent information not found.</p>
                </div>
            `;
            return;
        }

        // Get student info
        const { data: student } = await client
            .from('students')
            .select('name, class')
            .eq('id', parent.student_id)
            .maybeSingle();

        // Get report cards for student
        const { data: reportCards } = await client
            .from('report_cards')
            .select('*')
            .eq('student_id', parent.student_id)
            .order('created_at', { ascending: false });

        contentArea.innerHTML = `
            <div class="card">
                <h3>üìÑ Report Cards - ${student?.name || 'Student'} (${student?.class || ''})</h3>

                ${reportCards && reportCards.length > 0 ? `
                    <div style="margin-top: 20px;">
                        ${reportCards.map(card => `
                            <div style="border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 8px; background: #f9f9f9;">
                                <h4 style="margin-top: 0;">${card.term} - ${card.academic_year}</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                    <div>
                                        <strong>Overall Percentage:</strong>
                                        <div style="font-size: 24px; color: var(--color-primary); margin-top: 5px;">
                                            ${card.overall_percentage ? card.overall_percentage + '%' : 'N/A'}
                                        </div>
                                    </div>
                                    <div>
                                        <strong>Overall Grade:</strong>
                                        <div style="font-size: 24px; color: var(--color-primary); margin-top: 5px;">
                                            ${card.overall_grade || 'N/A'}
                                        </div>
                                    </div>
                                </div>
                                ${card.remarks ? `
                                    <div style="margin-top: 15px;">
                                        <strong>Remarks:</strong>
                                        <p style="margin: 5px 0 0 0;">${card.remarks}</p>
                                    </div>
                                ` : ''}
                                <div style="margin-top: 15px; color: #666; font-size: 0.9em;">
                                    Generated on: ${new Date(card.created_at).toLocaleDateString()}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : '<p style="margin-top: 20px; color: #666;">No report cards available yet.</p>'}
            </div>
        `;
    } catch (error) {
        console.error('Error loading report cards:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìÑ Report Cards</h3>
                <p style="color: #e74c3c;">Error loading report cards. Please try again.</p>
            </div>
        `;
    }
}

async function renderExamSchedule() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        // Get parent's student
        const { data: parent } = await client
            .from('parents')
            .select('student_id')
            .eq('id', currentUser.username)
            .maybeSingle();

        if (!parent) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìÖ Exam Schedule</h3>
                    <p style="color: #e74c3c;">Parent information not found.</p>
                </div>
            `;
            return;
        }

        // Get student's class
        const { data: student } = await client
            .from('students')
            .select('class, name')
            .eq('id', parent.student_id)
            .maybeSingle();

        if (!student) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìÖ Exam Schedule</h3>
                    <p style="color: #e74c3c;">Student information not found.</p>
                </div>
            `;
            return;
        }

        // Get exam schedules for student's class
        const { data: exams } = await client
            .from('exam_schedules')
            .select('*')
            .eq('class', student.class)
            .order('date', { ascending: true });

        const today = new Date();
        const upcomingExams = exams?.filter(exam => new Date(exam.date) >= today) || [];
        const pastExams = exams?.filter(exam => new Date(exam.date) < today) || [];

        contentArea.innerHTML = `
            <div class="card">
                <h3>üìÖ Exam Schedule - ${student.name} (${student.class})</h3>

                ${upcomingExams.length > 0 ? `
                    <div style="margin-top: 20px;">
                        <h4>Upcoming Exams</h4>
                        <table style="width: 100%; margin-top: 15px;">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Exam Name</th>
                                    <th>Subject</th>
                                    <th>Time</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${upcomingExams.map(exam => `
                                    <tr style="background: #e8f5e9;">
                                        <td><strong>${new Date(exam.date).toLocaleDateString()}</strong></td>
                                        <td>${exam.exam_name}</td>
                                        <td>${exam.subject}</td>
                                        <td>${exam.time || 'TBA'}</td>
                                        <td>${exam.duration || 'TBA'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : ''}

                ${pastExams.length > 0 ? `
                    <div style="margin-top: 30px;">
                        <h4>Past Exams</h4>
                        <table style="width: 100%; margin-top: 15px;">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Exam Name</th>
                                    <th>Subject</th>
                                    <th>Time</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pastExams.map(exam => `
                                    <tr style="opacity: 0.6;">
                                        <td>${new Date(exam.date).toLocaleDateString()}</td>
                                        <td>${exam.exam_name}</td>
                                        <td>${exam.subject}</td>
                                        <td>${exam.time || 'TBA'}</td>
                                        <td>${exam.duration || 'TBA'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : ''}

                ${!exams || exams.length === 0 ? '<p style="margin-top: 20px; color: #666;">No exam schedules available yet.</p>' : ''}
            </div>
        `;
    } catch (error) {
        console.error('Error loading exam schedule:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìÖ Exam Schedule</h3>
                <p style="color: #e74c3c;">Error loading exam schedule. Please try again.</p>
            </div>
        `;
    }
}

async function renderTimetable() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        showLoading();

        let className = '';

        // Determine the class based on user role
        if (currentUser.role === 'parent') {
            // Get parent's student class
            const { data: parent } = await client
                .from('parents')
                .select('student_id')
                .eq('id', currentUser.username)
                .maybeSingle();

            if (parent) {
                const { data: student } = await client
                    .from('students')
                    .select('class')
                    .eq('id', parent.student_id)
                    .maybeSingle();
                className = student?.class || '';
            }
        } else if (currentUser.role === 'classteacher') {
            // Get class teacher's class
            const { data: classTeacher } = await client
                .from('class_teachers')
                .select('class')
                .eq('id', currentUser.username)
                .maybeSingle();
            className = classTeacher?.class || '';
        } else if (currentUser.role === 'teacher') {
            // For teachers, get all classes
            const { data: classes } = await client
                .from('classes')
                .select('name')
                .order('name');

            hideLoading();

            contentArea.innerHTML = `
                <div class="card">
                    <h3>üóìÔ∏è Class Timetable</h3>
                    <p style="margin-bottom: 20px; color: #666;">Select a class to view its timetable</p>

                    <div class="form-group" style="max-width: 300px;">
                        <label>Select Class</label>
                        <select id="classSelect" class="form-control" onchange="showClassTimetable(this.value)">
                            <option value="">-- Select Class --</option>
                            ${classes?.map(c => `<option value="${c.name}">${c.name}</option>`).join('') || ''}
                        </select>
                    </div>

                    <div id="timetableContent"></div>
                </div>
            `;
            return;
        }

        // Fetch timetable for the class
        const { data: timetable } = await client
            .from('timetables')
            .select('*')
            .eq('class', className)
            .maybeSingle();

        hideLoading();

        contentArea.innerHTML = `
            <div class="card">
                <h3>üóìÔ∏è Class Timetable</h3>
                <p style="margin-bottom: 20px; color: #666;">Class: ${className}</p>

                ${timetable && timetable.periods ? `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; min-width: 600px;">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Monday</th>
                                    <th>Tuesday</th>
                                    <th>Wednesday</th>
                                    <th>Thursday</th>
                                    <th>Friday</th>
                                    <th>Saturday</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.keys(timetable.periods || {}).map(period => `
                                    <tr>
                                        <td><strong>${period}</strong></td>
                                        <td>${timetable.periods[period].monday || '-'}</td>
                                        <td>${timetable.periods[period].tuesday || '-'}</td>
                                        <td>${timetable.periods[period].wednesday || '-'}</td>
                                        <td>${timetable.periods[period].thursday || '-'}</td>
                                        <td>${timetable.periods[period].friday || '-'}</td>
                                        <td>${timetable.periods[period].saturday || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 30px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px;">üìö Notes</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #666;">
                            <li>School timings: 8:00 AM - 3:30 PM</li>
                            <li>Lunch break: 12:30 PM - 1:15 PM</li>
                            <li>Each period: 45 minutes</li>
                        </ul>
                    </div>
                ` : '<p style="margin-top: 15px; color: #666;">No timetable found for this class. Please contact your coordinator.</p>'}
            </div>
        `;
    } catch (error) {
        hideLoading();
        console.error('Error loading timetable:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üóìÔ∏è Class Timetable</h3>
                <p style="color: #e74c3c;">Error loading timetable. Please try again.</p>
            </div>
        `;
    }
}

// Function to show timetable for a selected class (for teachers)
window.showClassTimetable = async function(className) {
    if (!className) {
        document.getElementById('timetableContent').innerHTML = '';
        return;
    }

    const client = window.supabaseClient.getClient();

    const { data: timetable } = await client
        .from('timetables')
        .select('*')
        .eq('class', className)
        .maybeSingle();

    document.getElementById('timetableContent').innerHTML = `
        <div style="margin-top: 30px;">
            <h4>Timetable for ${className}</h4>
            ${timetable && timetable.image_data ? `
                <div style="margin-top: 20px; text-align: center;">
                    <img src="${timetable.image_data}" alt="Timetable for ${className}"
                         style="max-width: 100%; border: 2px solid #ddd; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                </div>
            ` : timetable && timetable.periods ? `
                <div style="overflow-x: auto; margin-top: 15px;">
                    <table style="width: 100%; min-width: 600px;">
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th>Monday</th>
                                <th>Tuesday</th>
                                <th>Wednesday</th>
                                <th>Thursday</th>
                                <th>Friday</th>
                                <th>Saturday</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.keys(timetable.periods || {}).map(period => `
                                <tr>
                                    <td><strong>${period}</strong></td>
                                    <td>${timetable.periods[period].monday || '-'}</td>
                                    <td>${timetable.periods[period].tuesday || '-'}</td>
                                    <td>${timetable.periods[period].wednesday || '-'}</td>
                                    <td>${timetable.periods[period].thursday || '-'}</td>
                                    <td>${timetable.periods[period].friday || '-'}</td>
                                    <td>${timetable.periods[period].saturday || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : '<p style="margin-top: 15px;">No timetable found for this class.</p>'}
        </div>
    `;
};

async function renderProfile() {
    const currentUser = window.auth.getCurrentUser();
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    let teacherData = null;
    let classTeacherData = null;

    // Fetch teacher-specific data if user is a teacher
    if (currentUser.role === 'teacher') {
        const { data } = await client
            .from('teachers')
            .select('*')
            .eq('id', currentUser.username)
            .maybeSingle();
        teacherData = data;
    }

    // Fetch class teacher-specific data if user is a class teacher
    if (currentUser.role === 'classteacher') {
        const { data } = await client
            .from('class_teachers')
            .select('*')
            .eq('id', currentUser.username)
            .maybeSingle();
        classTeacherData = data;
    }

    contentArea.innerHTML = `
        <div class="card">
            <h3>Profile Information</h3>

            <div id="profileViewMode">
                <div class="form-section">
                    <div class="form-row">
                        <div class="form-control">
                            <label>Name</label>
                            <input type="text" value="${currentUser.name || ''}" readonly>
                        </div>
                        <div class="form-control">
                            <label>Username</label>
                            <input type="text" value="${currentUser.username}" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-control">
                            <label>Role</label>
                            <input type="text" value="${formatRole(currentUser.role)}" readonly>
                        </div>
                    </div>
                    ${teacherData ? `
                        <div class="form-row">
                            <div class="form-control">
                                <label>Subjects Teaching</label>
                                <input type="text" value="${teacherData.subjects || 'Not assigned'}" readonly>
                            </div>
                            <div class="form-control">
                                <label>Classes Teaching</label>
                                <input type="text" value="${teacherData.classes || 'Not assigned'}" readonly>
                            </div>
                        </div>
                    ` : ''}
                    ${classTeacherData ? `
                        <div class="form-row">
                            <div class="form-control">
                                <label>Assigned Class</label>
                                <input type="text" value="${classTeacherData.class || 'Not assigned'}" readonly>
                            </div>
                        </div>
                    ` : ''}
                </div>
                ${(currentUser.role === 'teacher' || currentUser.role === 'classteacher') ? `
                    <div class="btn-group" style="margin-top: 20px;">
                        <button type="button" class="btn-primary" onclick="toggleProfileEdit()">‚úèÔ∏è Edit Profile</button>
                    </div>
                ` : ''}
            </div>

            <div id="profileEditMode" style="display: none;">
                <form id="profileEditForm" class="form-section">
                    <div class="form-row">
                        <div class="form-control">
                            <label>Name *</label>
                            <input type="text" id="editName" value="${currentUser.name || ''}" required>
                        </div>
                        <div class="form-control">
                            <label>Username</label>
                            <input type="text" value="${currentUser.username}" readonly>
                        </div>
                    </div>
                    ${teacherData ? `
                        <div class="form-row">
                            <div class="form-control">
                                <label>Subjects Teaching (comma separated)</label>
                                <input type="text" id="editSubjects" value="${teacherData.subjects || ''}" placeholder="e.g., Mathematics, Physics">
                            </div>
                            <div class="form-control">
                                <label>Classes Teaching (comma separated) *</label>
                                <input type="text" id="editClasses" value="${teacherData.classes || ''}" placeholder="e.g., 8B, 10A" required>
                            </div>
                        </div>
                    ` : ''}
                    <div class="btn-group" style="margin-top: 20px;">
                        <button type="submit" class="btn-primary">üíæ Save Changes</button>
                        <button type="button" class="btn-secondary" onclick="toggleProfileEdit()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    `;

    // Add form submit handler
    const editForm = document.getElementById('profileEditForm');
    if (editForm) {
        editForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            await saveProfileChanges(teacherData, classTeacherData);
        });
    }
}

window.toggleProfileEdit = function() {
    const viewMode = document.getElementById('profileViewMode');
    const editMode = document.getElementById('profileEditMode');

    if (viewMode.style.display === 'none') {
        viewMode.style.display = 'block';
        editMode.style.display = 'none';
    } else {
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
    }
};

async function saveProfileChanges(teacherData, classTeacherData) {
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    const newName = document.getElementById('editName').value.trim();

    if (!newName) {
        showModal('Error', 'Name is required', 'error');
        return;
    }

    try {
        showLoading();

        // Update user table
        const { error: userError } = await client
            .from('users')
            .update({ name: newName })
            .eq('username', currentUser.username);

        if (userError) throw new Error(`Failed to update user: ${userError.message}`);

        // Update teacher-specific data
        if (currentUser.role === 'teacher' && teacherData) {
            const newSubjects = document.getElementById('editSubjects').value.trim();
            const newClasses = document.getElementById('editClasses').value.trim();

            if (!newClasses) {
                throw new Error('Classes teaching is required');
            }

            const { error: teacherError } = await client
                .from('teachers')
                .update({
                    name: newName,
                    subjects: newSubjects,
                    classes: newClasses
                })
                .eq('id', currentUser.username);

            if (teacherError) throw new Error(`Failed to update teacher: ${teacherError.message}`);
        }

        // Update class teacher-specific data
        if (currentUser.role === 'classteacher' && classTeacherData) {
            const { error: ctError } = await client
                .from('class_teachers')
                .update({ name: newName })
                .eq('id', currentUser.username);

            if (ctError) throw new Error(`Failed to update class teacher: ${ctError.message}`);
        }

        // Update session storage
        currentUser.name = newName;
        sessionStorage.setItem('currentUser', JSON.stringify(currentUser));

        hideLoading();
        showModal('Success', 'Profile updated successfully!', 'success');

        // Refresh profile display
        renderProfile();
        updateUserInfo(currentUser);
    } catch (error) {
        hideLoading();
        showModal('Error', error.message || 'Failed to update profile', 'error');
    }
}

function renderChangePassword() {
    const contentArea = document.getElementById('contentArea');

    contentArea.innerHTML = `
        <div class="card">
            <h3>Change Password</h3>
            <form id="changePasswordForm" class="form-section">
                <div class="form-row">
                    <div class="form-control">
                        <label>Current Password</label>
                        <input type="password" id="currentPassword" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-control">
                        <label>New Password</label>
                        <input type="password" id="newPassword" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-control">
                        <label>Confirm New Password</label>
                        <input type="password" id="confirmPassword" required>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn-primary">Change Password</button>
                    <button type="button" class="btn-secondary" onclick="renderTab('home')">Cancel</button>
                </div>
            </form>
        </div>
    `;

    // Add form submit handler
    document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            showModal('Error', 'New passwords do not match', 'error');
            return;
        }

        try {
            showLoading();
            await window.auth.changePassword(currentPassword, newPassword);
            hideLoading();
            showModal('Success', 'Password changed successfully', 'success');
            renderTab('home');
        } catch (error) {
            hideLoading();
            showModal('Error', error.message || 'Failed to change password', 'error');
        }
    });
}

// Teacher tab functions
async function renderMyDuties() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        // Get duties for current teacher
        const { data: duties } = await client
            .from('teacher_duties')
            .select('*')
            .eq('teacher_id', currentUser.username)
            .order('duty_date', { ascending: true });

        const today = new Date();
        const upcomingDuties = duties?.filter(duty => new Date(duty.duty_date) >= today) || [];
        const pastDuties = duties?.filter(duty => new Date(duty.duty_date) < today) || [];

        contentArea.innerHTML = `
            <div class="card">
                <h3>üìã My Duties</h3>

                ${upcomingDuties.length > 0 ? `
                    <div style="margin-top: 20px;">
                        <h4>Upcoming Duties</h4>
                        <table style="width: 100%; margin-top: 15px;">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Duty Name</th>
                                    <th>Time</th>
                                    <th>Location</th>
                                    <th>Assigned By</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${upcomingDuties.map(duty => `
                                    <tr style="background: #e8f5e9;">
                                        <td><strong>${new Date(duty.duty_date).toLocaleDateString()}</strong></td>
                                        <td>${duty.duty_name}</td>
                                        <td>${duty.duty_time || 'N/A'}</td>
                                        <td>${duty.location || 'N/A'}</td>
                                        <td>${duty.assigned_by || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : '<p style="margin-top: 20px; color: #666;">No upcoming duties.</p>'}

                ${pastDuties.length > 0 ? `
                    <div style="margin-top: 30px;">
                        <h4>Past Duties</h4>
                        <table style="width: 100%; margin-top: 15px;">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Duty Name</th>
                                    <th>Time</th>
                                    <th>Location</th>
                                    <th>Assigned By</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pastDuties.map(duty => `
                                    <tr style="opacity: 0.6;">
                                        <td>${new Date(duty.duty_date).toLocaleDateString()}</td>
                                        <td>${duty.duty_name}</td>
                                        <td>${duty.duty_time || 'N/A'}</td>
                                        <td>${duty.location || 'N/A'}</td>
                                        <td>${duty.assigned_by || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : ''}
            </div>
        `;
    } catch (error) {
        console.error('Error loading duties:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìã My Duties</h3>
                <p style="color: #e74c3c;">Error loading duties. Please try again.</p>
            </div>
        `;
    }
}

async function renderMarkAttendance() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();
    const currentUser = window.auth.getCurrentUser();

    // Get teacher's assigned classes
    const { data: teacherInfo } = await client
        .from('teachers')
        .select('classes')
        .eq('id', currentUser.username)
        .maybeSingle();

    let teacherClasses = [];
    if (teacherInfo && teacherInfo.classes) {
        // Parse comma-separated classes
        teacherClasses = teacherInfo.classes.split(',').map(c => c.trim());
    }

    // Get all classes from database
    const { data: allClasses } = await client
        .from('classes')
        .select('*')
        .order('name');

    // Filter to only show classes assigned to this teacher
    const classes = allClasses?.filter(c => teacherClasses.includes(c.name)) || [];

    contentArea.innerHTML = `
        <div class="card">
            <h3>‚úÖ Mark Attendance</h3>
            ${teacherClasses.length === 0 ? `
                <p style="color: #e67e22; padding: 20px; background: #fff3cd; border-radius: 8px; margin-bottom: 20px;">
                    ‚ö†Ô∏è You have no classes assigned yet. Please update your profile to add the classes you teach.
                    <br><br>
                    <button class="btn-primary" onclick="renderTab('profile')">Go to Profile</button>
                </p>
            ` : ''}

            <div style="margin-bottom: 30px;">
                <div class="form-group">
                    <label for="attendanceClass">Select Class ${teacherClasses.length > 0 ? '(Your assigned classes only)' : ''}</label>
                    <select id="attendanceClass" ${teacherClasses.length === 0 ? 'disabled' : ''}>
                        <option value="">-- Select Class --</option>
                        ${classes.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label for="attendanceDate">Date</label>
                    <input type="date" id="attendanceDate" value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="form-group">
                    <label for="attendancePeriod">Period</label>
                    <select id="attendancePeriod">
                        <option value="1">Period 1</option>
                        <option value="2">Period 2</option>
                        <option value="3">Period 3</option>
                        <option value="4">Period 4</option>
                        <option value="5">Period 5</option>
                        <option value="6">Period 6</option>
                        <option value="7">Period 7</option>
                        <option value="8">Period 8</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="loadStudentsForAttendance()">Load Students</button>
            </div>

            <div id="attendanceStudentsList"></div>
        </div>
    `;
}

window.loadStudentsForAttendance = async function() {
    const className = document.getElementById('attendanceClass').value;
    const date = document.getElementById('attendanceDate').value;
    const period = document.getElementById('attendancePeriod').value;

    if (!className) {
        showModal('Error', 'Please select a class', 'error');
        return;
    }

    const client = window.supabaseClient.getClient();

    // Get students in the class
    const { data: students } = await client
        .from('students')
        .select('*')
        .eq('class', className)
        .eq('status', 'active')
        .order('name');

    if (!students || students.length === 0) {
        document.getElementById('attendanceStudentsList').innerHTML = '<p>No students found in this class.</p>';
        return;
    }

    // Get existing attendance for this date and period
    const { data: existingAttendance } = await client
        .from('attendance')
        .select('*')
        .eq('date', date)
        .eq('period', period)
        .in('student_id', students.map(s => s.id));

    const attendanceMap = {};
    existingAttendance?.forEach(att => {
        attendanceMap[att.student_id] = att;
    });

    document.getElementById('attendanceStudentsList').innerHTML = `
        <h4>Students in ${className}</h4>
        <form id="attendanceForm">
            <table style="width: 100%; margin-top: 15px;">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Behavior</th>
                    </tr>
                </thead>
                <tbody>
                    ${students.map(student => {
                        const att = attendanceMap[student.id];
                        return `
                            <tr>
                                <td>${student.id}</td>
                                <td>${student.name}</td>
                                <td>
                                    <select class="attendance-status" data-student-id="${student.id}">
                                        <option value="present" ${att?.type === 'present' ? 'selected' : ''}>Present</option>
                                        <option value="absent" ${att?.type === 'absent' ? 'selected' : ''}>Absent</option>
                                        <option value="late" ${att?.type === 'late' ? 'selected' : ''}>Late</option>
                                    </select>
                                </td>
                                <td>
                                    <select class="attendance-behavior" data-student-id="${student.id}">
                                        <option value="excellent" ${att?.behavior === 'excellent' ? 'selected' : ''}>Excellent</option>
                                        <option value="good" ${att?.behavior === 'good' || !att ? 'selected' : ''}>Good</option>
                                        <option value="distracting" ${att?.behavior === 'distracting' ? 'selected' : ''}>Distracting</option>
                                    </select>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
            <div style="margin-top: 20px;">
                <button type="submit" class="btn-primary">Submit Attendance</button>
            </div>
        </form>
    `;

    document.getElementById('attendanceForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await submitAttendance(students, date, period);
    });
};

async function submitAttendance(students, date, period) {
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    const attendanceRecords = students.map(student => {
        const statusSelect = document.querySelector(`.attendance-status[data-student-id="${student.id}"]`);
        const behaviorSelect = document.querySelector(`.attendance-behavior[data-student-id="${student.id}"]`);

        return {
            student_id: student.id,
            date: date,
            period: period,
            type: statusSelect.value,
            behavior: behaviorSelect.value,
            marked_by: currentUser.username
        };
    });

    try {
        showLoading();

        // Delete existing attendance for this date/period/students
        await client
            .from('attendance')
            .delete()
            .eq('date', date)
            .eq('period', period)
            .in('student_id', students.map(s => s.id));

        // Insert new attendance records
        const { error } = await client
            .from('attendance')
            .insert(attendanceRecords);

        if (error) throw error;

        hideLoading();
        showModal('Success', 'Attendance submitted successfully!', 'success');
    } catch (error) {
        hideLoading();
        showModal('Error', error.message || 'Failed to submit attendance', 'error');
    }
}

async function renderHomework() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();
    const currentUser = window.auth.getCurrentUser();

    // Get all classes
    const { data: classes } = await client
        .from('classes')
        .select('*')
        .order('name');

    // Get existing homework assigned by this teacher
    const { data: homeworkList } = await client
        .from('homework')
        .select('*')
        .eq('assigned_by', currentUser.username)
        .order('date', { ascending: false })
        .limit(20);

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìù Homework Management</h3>

            <h4>Assign New Homework</h4>
            <form id="homeworkForm" style="max-width: 600px; margin-bottom: 40px;">
                <div class="form-group">
                    <label for="hwClass">Class</label>
                    <select id="hwClass" required>
                        <option value="">-- Select Class --</option>
                        ${classes?.map(c => `<option value="${c.name}">${c.name}</option>`).join('') || ''}
                    </select>
                </div>
                <div class="form-group">
                    <label for="hwSubject">Subject</label>
                    <input type="text" id="hwSubject" placeholder="e.g., Mathematics" required>
                </div>
                <div class="form-group">
                    <label for="hwTitle">Title</label>
                    <input type="text" id="hwTitle" placeholder="e.g., Chapter 5 Exercises" required>
                </div>
                <div class="form-group">
                    <label for="hwDescription">Description</label>
                    <textarea id="hwDescription" rows="3" placeholder="Details about the homework"></textarea>
                </div>
                <div class="form-group">
                    <label for="hwDate">Assigned Date</label>
                    <input type="date" id="hwDate" value="${new Date().toISOString().split('T')[0]}" required>
                </div>
                <div class="form-group">
                    <label for="hwDueDate">Due Date</label>
                    <input type="date" id="hwDueDate">
                </div>
                <button type="submit" class="btn-primary">Assign Homework</button>
            </form>

            <h4>Recently Assigned Homework</h4>
            ${homeworkList && homeworkList.length > 0 ? `
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Class</th>
                            <th>Subject</th>
                            <th>Title</th>
                            <th>Due Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${homeworkList.map(hw => `
                            <tr>
                                <td>${new Date(hw.date).toLocaleDateString()}</td>
                                <td>${hw.class}</td>
                                <td>${hw.subject}</td>
                                <td>${hw.title}</td>
                                <td>${hw.due_date ? new Date(hw.due_date).toLocaleDateString() : 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p style="margin-top: 15px;">No homework assigned yet.</p>'}
        </div>
    `;

    document.getElementById('homeworkForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const homeworkData = {
            class: document.getElementById('hwClass').value,
            subject: document.getElementById('hwSubject').value,
            title: document.getElementById('hwTitle').value,
            description: document.getElementById('hwDescription').value,
            date: document.getElementById('hwDate').value,
            due_date: document.getElementById('hwDueDate').value || null,
            assigned_by: currentUser.username
        };

        try {
            showLoading();
            const { error } = await client
                .from('homework')
                .insert([homeworkData]);

            if (error) throw error;

            hideLoading();
            showModal('Success', 'Homework assigned successfully!', 'success');
            renderHomework(); // Refresh the page
        } catch (error) {
            hideLoading();
            showModal('Error', error.message || 'Failed to assign homework', 'error');
        }
    });
}

async function renderExamResults() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    // Get all exam results
    const { data: results } = await client
        .from('exam_results')
        .select('*, students(name, class)')
        .order('created_at', { ascending: false })
        .limit(100);

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìä Exam Results</h3>

            ${results && results.length > 0 ? `
                <table style="width: 100%; margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Student Name</th>
                            <th>Class</th>
                            <th>Exam</th>
                            <th>Subject</th>
                            <th>Marks</th>
                            <th>Grade</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results.map(result => `
                            <tr>
                                <td>${result.student_id}</td>
                                <td>${result.students?.name || 'N/A'}</td>
                                <td>${result.students?.class || 'N/A'}</td>
                                <td>${result.exam_name}</td>
                                <td>${result.subject}</td>
                                <td>${result.marks}/${result.total_marks}</td>
                                <td><span class="badge">${result.grade || 'N/A'}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p style="margin-top: 20px;">No exam results available.</p>'}
        </div>
    `;
}

async function renderUploadMarks() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    // Get all classes
    const { data: classes } = await client
        .from('classes')
        .select('*')
        .order('name');

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìà Upload Marks</h3>

            <form id="uploadMarksForm" style="max-width: 600px;">
                <div class="form-group">
                    <label for="marksClass">Class</label>
                    <select id="marksClass" required>
                        <option value="">-- Select Class --</option>
                        ${classes?.map(c => `<option value="${c.name}">${c.name}</option>`).join('') || ''}
                    </select>
                </div>
                <div class="form-group">
                    <label for="marksExam">Exam Name</label>
                    <input type="text" id="marksExam" placeholder="e.g., Mid-term 2024" required>
                </div>
                <div class="form-group">
                    <label for="marksSubject">Subject</label>
                    <input type="text" id="marksSubject" placeholder="e.g., Mathematics" required>
                </div>
                <div class="form-group">
                    <label for="marksTotalMarks">Total Marks</label>
                    <input type="number" id="marksTotalMarks" placeholder="e.g., 100" required>
                </div>
                <button type="button" class="btn-primary" onclick="loadStudentsForMarks()">Load Students</button>
            </form>

            <div id="marksStudentsList"></div>
        </div>
    `;
}

window.loadStudentsForMarks = async function() {
    const className = document.getElementById('marksClass').value;
    const examName = document.getElementById('marksExam').value;
    const subject = document.getElementById('marksSubject').value;
    const totalMarks = document.getElementById('marksTotalMarks').value;

    if (!className || !examName || !subject || !totalMarks) {
        showModal('Error', 'Please fill all fields', 'error');
        return;
    }

    const client = window.supabaseClient.getClient();

    // Get students in the class
    const { data: students } = await client
        .from('students')
        .select('*')
        .eq('class', className)
        .eq('status', 'active')
        .order('name');

    if (!students || students.length === 0) {
        document.getElementById('marksStudentsList').innerHTML = '<p>No students found in this class.</p>';
        return;
    }

    document.getElementById('marksStudentsList').innerHTML = `
        <h4 style="margin-top: 30px;">Enter Marks for ${className} - ${subject}</h4>
        <form id="marksSubmitForm">
            <table style="width: 100%; margin-top: 15px;">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Marks Obtained</th>
                        <th>Grade</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody>
                    ${students.map(student => `
                        <tr>
                            <td>${student.id}</td>
                            <td>${student.name}</td>
                            <td>
                                <input type="number" class="marks-input" data-student-id="${student.id}"
                                       min="0" max="${totalMarks}" style="width: 80px;">
                            </td>
                            <td>
                                <select class="grade-input" data-student-id="${student.id}">
                                    <option value="A+">A+</option>
                                    <option value="A">A</option>
                                    <option value="B+">B+</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                    <option value="F">F</option>
                                </select>
                            </td>
                            <td>
                                <input type="text" class="remarks-input" data-student-id="${student.id}"
                                       style="width: 150px;" placeholder="Optional">
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div style="margin-top: 20px;">
                <button type="submit" class="btn-primary">Submit All Marks</button>
            </div>
        </form>
    `;

    document.getElementById('marksSubmitForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await submitMarks(students, examName, subject, totalMarks);
    });
};

async function submitMarks(students, examName, subject, totalMarks) {
    const client = window.supabaseClient.getClient();

    const marksRecords = students.map(student => {
        const marksInput = document.querySelector(`.marks-input[data-student-id="${student.id}"]`);
        const gradeInput = document.querySelector(`.grade-input[data-student-id="${student.id}"]`);
        const remarksInput = document.querySelector(`.remarks-input[data-student-id="${student.id}"]`);

        if (!marksInput.value) return null;

        return {
            student_id: student.id,
            exam_name: examName,
            subject: subject,
            marks: parseFloat(marksInput.value),
            total_marks: parseFloat(totalMarks),
            grade: gradeInput.value,
            remarks: remarksInput.value || null
        };
    }).filter(r => r !== null);

    if (marksRecords.length === 0) {
        showModal('Error', 'Please enter marks for at least one student', 'error');
        return;
    }

    try {
        showLoading();

        const { error } = await client
            .from('exam_results')
            .insert(marksRecords);

        if (error) throw error;

        hideLoading();
        showModal('Success', `Marks uploaded successfully for ${marksRecords.length} students!`, 'success');
        renderUploadMarks(); // Refresh
    } catch (error) {
        hideLoading();
        showModal('Error', error.message || 'Failed to upload marks', 'error');
    }
}

async function renderMyClasses() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();
    const currentUser = window.auth.getCurrentUser();

    // Get teacher info
    const { data: teacher } = await client
        .from('teachers')
        .select('*')
        .eq('id', currentUser.username)
        .maybeSingle();

    contentArea.innerHTML = `
        <div class="card">
            <h3>üë• My Classes</h3>

            ${teacher ? `
                <div style="margin-top: 20px;">
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-control">
                                <label>Subjects</label>
                                <input type="text" value="${teacher.subjects || 'N/A'}" readonly>
                            </div>
                            <div class="form-control">
                                <label>Classes</label>
                                <input type="text" value="${teacher.classes || 'N/A'}" readonly>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <h4>Classes Assigned to You:</h4>
                        <p style="margin-top: 10px;">${teacher.classes || 'No classes assigned yet'}</p>
                    </div>

                    <div style="margin-top: 20px;">
                        <h4>Subjects You Teach:</h4>
                        <p style="margin-top: 10px;">${teacher.subjects || 'No subjects assigned yet'}</p>
                    </div>
                </div>
            ` : '<p style="margin-top: 20px;">Teacher information not found.</p>'}
        </div>
    `;
}

async function renderTeacherIssues() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();
    const currentUser = window.auth.getCurrentUser();

    // Get issues reported by this teacher
    const { data: issues } = await client
        .from('issues')
        .select('*')
        .eq('reported_by', currentUser.username)
        .order('created_at', { ascending: false });

    contentArea.innerHTML = `
        <div class="card">
            <h3>‚ö†Ô∏è My Issues</h3>

            <button class="btn-primary" onclick="showCreateTeacherIssue()" style="margin-bottom: 20px;">+ Report New Issue</button>

            <div id="createIssueForm" style="display: none; margin-bottom: 30px;">
                <h4>Report New Issue</h4>
                <form id="issueForm" style="max-width: 600px;">
                    <div class="form-group">
                        <label for="issueClass">Class *</label>
                        <select id="issueClass" required onchange="loadStudentsForIssue()">
                            <option value="">-- Select Class --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="issueStudent">Student Name *</label>
                        <select id="issueStudent" required>
                            <option value="">-- Select Student --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="issueTitle">Title *</label>
                        <input type="text" id="issueTitle" placeholder="Brief description" required>
                    </div>
                    <div class="form-group">
                        <label for="issueDescription">Issue Description *</label>
                        <textarea id="issueDescription" rows="5" placeholder="Describe the issue in detail..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="issuePriority">Priority</label>
                        <select id="issuePriority">
                            <option value="low">Low</option>
                            <option value="normal" selected>Normal</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary">Submit Issue</button>
                    <button type="button" class="btn-secondary" onclick="document.getElementById('createIssueForm').style.display='none'">Cancel</button>
                </form>
            </div>

            ${issues && issues.length > 0 ? `
                <div>
                    ${issues.map(issue => `
                        <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                            <h4 style="margin-top: 0;">${issue.title}</h4>
                            <p>${issue.description || 'No description'}</p>
                            <div style="margin-top: 10px;">
                                <span class="badge badge-${issue.priority}">${issue.priority}</span>
                                <span class="badge badge-${issue.status}">${issue.status}</span>
                                <span style="color: #666; font-size: 0.9em; margin-left: 10px;">
                                    Created: ${new Date(issue.created_at).toLocaleDateString()}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '<p style="margin-top: 20px;">No issues reported yet.</p>'}
        </div>
    `;

    const form = document.getElementById('issueForm');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const studentId = document.getElementById('issueStudent').value;
            const studentName = document.getElementById('issueStudent').selectedOptions[0].text;

            const issueData = {
                title: document.getElementById('issueTitle').value,
                description: document.getElementById('issueDescription').value,
                priority: document.getElementById('issuePriority').value,
                student_id: studentId,
                student_name: studentName,
                class: document.getElementById('issueClass').value,
                reported_by: currentUser.username,
                status: 'pending'
            };

            try {
                showLoading();
                const { error } = await client
                    .from('issues')
                    .insert([issueData]);

                if (error) throw error;

                hideLoading();
                showModal('Success', 'Issue reported successfully!', 'success');
                renderTeacherIssues(); // Refresh
            } catch (error) {
                hideLoading();
                showModal('Error', error.message || 'Failed to report issue', 'error');
            }
        });
    }
}

window.showCreateTeacherIssue = async function() {
    document.getElementById('createIssueForm').style.display = 'block';

    // Load classes
    const client = window.supabaseClient.getClient();
    const { data: classes } = await client
        .from('classes')
        .select('name')
        .order('name');

    const classSelect = document.getElementById('issueClass');
    classSelect.innerHTML = '<option value="">-- Select Class --</option>' +
        (classes?.map(c => `<option value="${c.name}">${c.name}</option>`).join('') || '');
};

window.loadStudentsForIssue = async function() {
    const className = document.getElementById('issueClass').value;
    if (!className) {
        document.getElementById('issueStudent').innerHTML = '<option value="">-- Select Student --</option>';
        return;
    }

    const client = window.supabaseClient.getClient();
    const { data: students } = await client
        .from('students')
        .select('id, name')
        .eq('class', className)
        .eq('status', 'active')
        .order('name');

    const studentSelect = document.getElementById('issueStudent');
    studentSelect.innerHTML = '<option value="">-- Select Student --</option>' +
        (students?.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('') || '');
};

// Coordinator tab functions
async function renderCoordIssues() {
    // Use the same issues management as VP
    await renderVPIssues();
}

async function renderUploadExam() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    // Get all classes
    const { data: classes } = await client
        .from('classes')
        .select('*')
        .order('name');

    // Get existing exams
    const { data: exams } = await client
        .from('exam_schedules')
        .select('*')
        .order('date', { ascending: false })
        .limit(20);

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìã Upload Exam Schedule</h3>

            <h4>Create New Exam</h4>
            <form id="examForm" style="max-width: 600px; margin-bottom: 40px;">
                <div class="form-group">
                    <label for="examClass">Class</label>
                    <select id="examClass" required>
                        <option value="">-- Select Class --</option>
                        ${classes?.map(c => `<option value="${c.name}">${c.name}</option>`).join('') || ''}
                    </select>
                </div>
                <div class="form-group">
                    <label for="examName">Exam Name</label>
                    <input type="text" id="examName" placeholder="e.g., Mid-term 2024" required>
                </div>
                <div class="form-group">
                    <label for="examSubject">Subject</label>
                    <input type="text" id="examSubject" placeholder="e.g., Mathematics" required>
                </div>
                <div class="form-group">
                    <label for="examDate">Date</label>
                    <input type="date" id="examDate" required>
                </div>
                <div class="form-group">
                    <label for="examTime">Time</label>
                    <input type="text" id="examTime" placeholder="e.g., 09:00 AM - 12:00 PM">
                </div>
                <div class="form-group">
                    <label for="examDuration">Duration</label>
                    <input type="text" id="examDuration" placeholder="e.g., 3 hours">
                </div>
                <button type="submit" class="btn-primary">Create Exam</button>
            </form>

            <h4>Recent Exams</h4>
            ${exams && exams.length > 0 ? `
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Class</th>
                            <th>Exam Name</th>
                            <th>Subject</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${exams.map(exam => `
                            <tr>
                                <td>${new Date(exam.date).toLocaleDateString()}</td>
                                <td>${exam.class}</td>
                                <td>${exam.exam_name}</td>
                                <td>${exam.subject}</td>
                                <td>${exam.time || 'TBA'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p style="margin-top: 15px;">No exams scheduled yet.</p>'}
        </div>
    `;

    document.getElementById('examForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const examData = {
            class: document.getElementById('examClass').value,
            exam_name: document.getElementById('examName').value,
            subject: document.getElementById('examSubject').value,
            date: document.getElementById('examDate').value,
            time: document.getElementById('examTime').value || null,
            duration: document.getElementById('examDuration').value || null
        };

        try {
            showLoading();
            const { error } = await client
                .from('exam_schedules')
                .insert([examData]);

            if (error) throw error;

            hideLoading();
            showModal('Success', 'Exam scheduled successfully!', 'success');
            renderUploadExam(); // Refresh
        } catch (error) {
            hideLoading();
            showModal('Error', error.message || 'Failed to schedule exam', 'error');
        }
    });
}

async function renderClasses() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    // Get all classes
    const { data: classes } = await client
        .from('classes')
        .select('*')
        .order('name');

    contentArea.innerHTML = `
        <div class="card">
            <h3>üë• Classes Management</h3>

            ${classes && classes.length > 0 ? `
                <table style="width: 100%; margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>Class Name</th>
                            <th>Grade</th>
                            <th>Section</th>
                            <th>Class Teacher</th>
                            <th>Total Students</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${classes.map(cls => `
                            <tr>
                                <td><strong>${cls.name}</strong></td>
                                <td>${cls.grade}</td>
                                <td>${cls.section}</td>
                                <td>${cls.class_teacher_id || 'Not Assigned'}</td>
                                <td>${cls.total_students}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p style="margin-top: 20px;">No classes found.</p>'}
        </div>
    `;
}

async function renderManageTimetable() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    // Get all classes
    const { data: classes } = await client
        .from('classes')
        .select('*')
        .order('name');

    contentArea.innerHTML = `
        <div class="card">
            <h3>üóìÔ∏è Manage Timetable</h3>

            <div class="form-group" style="max-width: 400px;">
                <label for="timetableClass">Select Class</label>
                <select id="timetableClass" onchange="loadTimetableForClass()">
                    <option value="">-- Select Class --</option>
                    ${classes?.map(c => `<option value="${c.name}">${c.name}</option>`).join('') || ''}
                </select>
            </div>

            <div id="timetableContent"></div>
        </div>
    `;
}

window.loadTimetableForClass = async function() {
    const className = document.getElementById('timetableClass').value;
    if (!className) {
        document.getElementById('timetableContent').innerHTML = '';
        return;
    }

    const client = window.supabaseClient.getClient();

    const { data: timetable } = await client
        .from('timetables')
        .select('*')
        .eq('class', className)
        .maybeSingle();

    document.getElementById('timetableContent').innerHTML = `
        <div style="margin-top: 30px;">
            <h4>Timetable for ${className}</h4>

            ${timetable && timetable.image_data ? `
                <div style="margin-top: 20px;">
                    <h5>Current Timetable Image:</h5>
                    <img src="${timetable.image_data}" alt="Timetable for ${className}"
                         style="max-width: 100%; border: 2px solid #ddd; border-radius: 8px; margin-top: 10px;">
                </div>
            ` : '<p style="margin-top: 15px; color: #888;">No timetable image uploaded yet.</p>'}

            <div style="margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                <h5>Upload New Timetable Image</h5>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    Upload a clear image of the timetable. Supported formats: JPG, PNG, GIF (Max 5MB)
                </p>
                <form id="timetableImageForm">
                    <input type="file" id="timetableImageInput" accept="image/*"
                           style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                    <div id="imagePreview" style="margin-top: 15px; display: none;">
                        <h6>Preview:</h6>
                        <img id="previewImg" style="max-width: 100%; max-height: 400px; border: 2px solid #ddd; border-radius: 8px; margin-top: 10px;">
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 15px;">üì§ Upload Timetable</button>
                </form>
            </div>
        </div>
    `;

    // Add image preview functionality
    const imageInput = document.getElementById('timetableImageInput');
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Check file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
                showModal('Error', 'Image size must be less than 5MB', 'error');
                imageInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById('previewImg').src = event.target.result;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });

    // Add form submit handler
    document.getElementById('timetableImageForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await uploadTimetableImage(className, timetable);
    });
};

async function uploadTimetableImage(className, existingTimetable) {
    const imageInput = document.getElementById('timetableImageInput');
    const file = imageInput.files[0];

    if (!file) {
        showModal('Error', 'Please select an image to upload', 'error');
        return;
    }

    try {
        showLoading();
        const client = window.supabaseClient.getClient();

        // Convert image to base64
        const reader = new FileReader();
        reader.onload = async function(event) {
            const base64Image = event.target.result;

            if (existingTimetable) {
                // Update existing timetable
                const { error } = await client
                    .from('timetables')
                    .update({ image_data: base64Image })
                    .eq('class', className);

                if (error) throw error;
            } else {
                // Create new timetable
                const { error } = await client
                    .from('timetables')
                    .insert([{
                        class: className,
                        image_data: base64Image,
                        periods: null
                    }]);

                if (error) throw error;
            }

            hideLoading();
            showModal('Success', 'Timetable image uploaded successfully!', 'success');
            loadTimetableForClass(); // Reload to show new image
        };

        reader.onerror = function() {
            hideLoading();
            showModal('Error', 'Failed to read image file', 'error');
        };

        reader.readAsDataURL(file);
    } catch (error) {
        hideLoading();
        showModal('Error', error.message || 'Failed to upload timetable image', 'error');
    }
}

async function renderUploadCCA() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    // Get existing CCA events
    const { data: ccaEvents } = await client
        .from('cca_calendars')
        .select('*')
        .order('event_date', { ascending: false })
        .limit(20);

    contentArea.innerHTML = `
        <div class="card">
            <h3>üé® Upload CCA Events</h3>

            <h4>Create New CCA Event</h4>
            <form id="ccaForm" style="max-width: 600px; margin-bottom: 40px;">
                <div class="form-group">
                    <label for="ccaName">Event Name</label>
                    <input type="text" id="ccaName" placeholder="e.g., Annual Sports Day" required>
                </div>
                <div class="form-group">
                    <label for="ccaDate">Event Date</label>
                    <input type="date" id="ccaDate" required>
                </div>
                <div class="form-group">
                    <label for="ccaTime">Event Time</label>
                    <input type="text" id="ccaTime" placeholder="e.g., 9:00 AM - 4:00 PM">
                </div>
                <div class="form-group">
                    <label for="ccaLocation">Location</label>
                    <input type="text" id="ccaLocation" placeholder="e.g., School Auditorium">
                </div>
                <div class="form-group">
                    <label for="ccaDescription">Description</label>
                    <textarea id="ccaDescription" rows="3" placeholder="Event details"></textarea>
                </div>
                <button type="submit" class="btn-primary">Create Event</button>
            </form>

            <h4>Recent CCA Events</h4>
            ${ccaEvents && ccaEvents.length > 0 ? `
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Event Name</th>
                            <th>Time</th>
                            <th>Location</th>
                            <th>Created By</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${ccaEvents.map(event => `
                            <tr>
                                <td>${new Date(event.event_date).toLocaleDateString()}</td>
                                <td><strong>${event.event_name}</strong></td>
                                <td>${event.event_time || 'TBA'}</td>
                                <td>${event.location || 'TBA'}</td>
                                <td>${event.created_by || 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p style="margin-top: 15px;">No CCA events created yet.</p>'}
        </div>
    `;

    const currentUser = window.auth.getCurrentUser();
    document.getElementById('ccaForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const ccaData = {
            event_name: document.getElementById('ccaName').value,
            event_date: document.getElementById('ccaDate').value,
            event_time: document.getElementById('ccaTime').value || null,
            location: document.getElementById('ccaLocation').value || null,
            description: document.getElementById('ccaDescription').value || null,
            created_by: currentUser.username
        };

        try {
            showLoading();
            const { error } = await client
                .from('cca_calendars')
                .insert([ccaData]);

            if (error) throw error;

            hideLoading();
            showModal('Success', 'CCA event created successfully!', 'success');
            renderUploadCCA(); // Refresh
        } catch (error) {
            hideLoading();
            showModal('Error', error.message || 'Failed to create CCA event', 'error');
        }
    });
}

// Vice Principal tab functions

async function renderAppointTeacher() {
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = `
        <div class="card">
            <h3>üë®‚Äçüè´ Appoint Teacher</h3>
            <form id="appointTeacherForm" style="max-width: 600px;">
                <div class="form-group">
                    <label for="teacherId">Teacher ID</label>
                    <input type="text" id="teacherId" placeholder="e.g., T004" required>
                </div>

                <div class="form-group">
                    <label for="teacherName">Teacher Name</label>
                    <input type="text" id="teacherName" placeholder="Enter full name" required>
                </div>

                <div class="form-group">
                    <label for="subjects">Subjects (comma separated)</label>
                    <input type="text" id="subjects" placeholder="e.g., Mathematics, Physics" required>
                </div>

                <div class="form-group">
                    <label for="classes">Classes (comma separated)</label>
                    <input type="text" id="classes" placeholder="e.g., 8B, 10A" required>
                </div>

                <div class="form-group">
                    <label for="teacherPassword">Password</label>
                    <input type="password" id="teacherPassword" placeholder="Set login password" required>
                </div>

                <button type="submit" class="btn-primary">Appoint Teacher</button>
            </form>
        </div>
    `;

    document.getElementById('appointTeacherForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const teacherId = document.getElementById('teacherId').value.trim();
        const teacherName = document.getElementById('teacherName').value.trim();
        const subjects = document.getElementById('subjects').value.trim();
        const classes = document.getElementById('classes').value.trim();
        const password = document.getElementById('teacherPassword').value;

        try {
            showLoading();
            const client = window.supabaseClient.getClient();

            // Check if teacher ID already exists
            const { data: existingTeacher, error: teacherCheckError } = await client
                .from('teachers')
                .select('id')
                .eq('id', teacherId)
                .maybeSingle();

            if (teacherCheckError) {
                throw new Error(`Error checking teacher: ${teacherCheckError.message}`);
            }

            if (existingTeacher) {
                throw new Error('Teacher ID already exists');
            }

            // Check if username already exists
            const { data: existingUser, error: userCheckError } = await client
                .from('users')
                .select('username')
                .eq('username', teacherId)
                .maybeSingle();

            if (userCheckError) {
                throw new Error(`Error checking username: ${userCheckError.message}`);
            }

            if (existingUser) {
                throw new Error('Username already exists');
            }

            // Insert teacher
            const { error: teacherError } = await client
                .from('teachers')
                .insert([{
                    id: teacherId,
                    name: teacherName,
                    subjects: subjects,
                    classes: classes,
                    status: 'active'
                }]);

            if (teacherError) {
                throw new Error(`Failed to create teacher record: ${teacherError.message}`);
            }

            // Create user account
            const { error: userError } = await client
                .from('users')
                .insert([{
                    username: teacherId,
                    password: password,
                    name: teacherName,
                    role: 'teacher'
                }]);

            if (userError) {
                // Rollback teacher creation
                await client.from('teachers').delete().eq('id', teacherId);
                throw new Error(`Failed to create user account: ${userError.message}`);
            }

            hideLoading();
            showModal('Success', `Teacher ${teacherName} appointed successfully!`, 'success');
            document.getElementById('appointTeacherForm').reset();
        } catch (error) {
            hideLoading();
            showModal('Error', error.message || 'Failed to appoint teacher', 'error');
        }
    });
}

async function renderClassManagement() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    // Fetch all classes
    const { data: classes, error: classesError } = await client
        .from('classes')
        .select('*')
        .order('name');

    // Fetch all class teachers
    const { data: classTeachers } = await client
        .from('class_teachers')
        .select('*')
        .eq('status', 'active');

    if (classesError) {
        contentArea.innerHTML = `
            <div class="card">
                <h3>üè´ Class Management</h3>
                <p style="color: #e74c3c;">Error loading classes: ${classesError.message}</p>
            </div>
        `;
        return;
    }

    contentArea.innerHTML = `
        <div class="card">
            <h3>üè´ CLASS MANAGEMENT</h3>
            <p style="color: #666; margin-bottom: 20px;">Manage classes, sections, and class teachers</p>

            <!-- Add New Class Section -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                <h4>‚ûï Add New Class</h4>
                <form id="addClassForm" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
                    <div class="form-group" style="margin: 0;">
                        <label>Class Name *</label>
                        <input type="text" id="newClassName" placeholder="e.g., 8B, 10A" required>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Grade *</label>
                        <input type="number" id="newGrade" placeholder="e.g., 8" min="1" max="12" required>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Section *</label>
                        <input type="text" id="newSection" placeholder="e.g., A, B" required>
                    </div>
                    <button type="submit" class="btn-primary" style="height: 42px;">Add Class</button>
                </form>
            </div>

            <!-- Stats Overview -->
            <div class="performance-overview" style="margin-bottom: 30px;">
                <div class="perf-stat">
                    <div class="perf-value">${classes?.length || 0}</div>
                    <div class="perf-label">üìö Total Classes</div>
                    <div class="perf-sublabel">All classes</div>
                </div>
                <div class="perf-stat">
                    <div class="perf-value">${classTeachers?.length || 0}</div>
                    <div class="perf-label">üë®‚Äçüè´ Class Teachers</div>
                    <div class="perf-sublabel">Assigned</div>
                </div>
                <div class="perf-stat">
                    <div class="perf-value">${classes?.reduce((sum, c) => sum + (c.total_students || 0), 0) || 0}</div>
                    <div class="perf-label">üë• Total Students</div>
                    <div class="perf-sublabel">Across all classes</div>
                </div>
            </div>

            <!-- Classes Table -->
            <div style="overflow-x: auto;">
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Class Name</th>
                            <th>Grade</th>
                            <th>Section</th>
                            <th>Class Teacher</th>
                            <th>Total Students</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${classes && classes.length > 0 ? classes.map(c => {
                            const teacher = classTeachers?.find(t => t.id === c.class_teacher_id);
                            return `
                                <tr>
                                    <td><strong>${c.name}</strong></td>
                                    <td>${c.grade || 'N/A'}</td>
                                    <td>${c.section || 'N/A'}</td>
                                    <td>
                                        <select onchange="updateClassTeacher(${c.id}, this.value)" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="">-- No Teacher --</option>
                                            ${classTeachers?.map(t => `
                                                <option value="${t.id}" ${t.id === c.class_teacher_id ? 'selected' : ''}>
                                                    ${t.name} (${t.id})
                                                </option>
                                            `).join('')}
                                        </select>
                                    </td>
                                    <td>
                                        <input type="number"
                                            value="${c.total_students || 0}"
                                            onchange="updateTotalStudents(${c.id}, this.value)"
                                            style="width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                                    </td>
                                    <td>
                                        <span style="color: ${c.is_active !== false ? '#27ae60' : '#e74c3c'};">
                                            ${c.is_active !== false ? '‚úì Active' : '‚úó Inactive'}
                                        </span>
                                    </td>
                                    <td>
                                        <button onclick="toggleClassStatus(${c.id}, ${c.is_active !== false})"
                                            class="btn-secondary" style="padding: 5px 10px; font-size: 12px;">
                                            ${c.is_active !== false ? 'Deactivate' : 'Activate'}
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('') : '<tr><td colspan="7" style="text-align: center;">No classes found</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>
    `;

    // Handle add class form submission
    document.getElementById('addClassForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const className = document.getElementById('newClassName').value.trim();
        const grade = parseInt(document.getElementById('newGrade').value);
        const section = document.getElementById('newSection').value.trim();

        try {
            showLoading();

            // Check if class already exists
            const { data: existing } = await client
                .from('classes')
                .select('id')
                .eq('name', className)
                .maybeSingle();

            if (existing) {
                throw new Error(`Class "${className}" already exists`);
            }

            // Insert new class
            const { error } = await client
                .from('classes')
                .insert([{
                    name: className,
                    grade: grade,
                    section: section,
                    total_students: 0,
                    is_active: true
                }]);

            if (error) throw error;

            hideLoading();
            showModal('Success', `Class "${className}" added successfully!`, 'success');
            renderClassManagement(); // Refresh
        } catch (error) {
            hideLoading();
            showModal('Error', error.message || 'Failed to add class', 'error');
        }
    });
}

// Helper function to update class teacher
window.updateClassTeacher = async function(classId, teacherId) {
    try {
        showLoading();
        const client = window.supabaseClient.getClient();

        const { error } = await client
            .from('classes')
            .update({ class_teacher_id: teacherId || null })
            .eq('id', classId);

        if (error) throw error;

        hideLoading();
        showModal('Success', 'Class teacher updated successfully!', 'success');
    } catch (error) {
        hideLoading();
        showModal('Error', error.message || 'Failed to update class teacher', 'error');
    }
};

// Helper function to update total students
window.updateTotalStudents = async function(classId, totalStudents) {
    try {
        showLoading();
        const client = window.supabaseClient.getClient();

        const { error } = await client
            .from('classes')
            .update({ total_students: parseInt(totalStudents) || 0 })
            .eq('id', classId);

        if (error) throw error;

        hideLoading();
        showModal('Success', 'Total students updated!', 'success');
    } catch (error) {
        hideLoading();
        showModal('Error', error.message || 'Failed to update total students', 'error');
    }
};

// Helper function to toggle class status
window.toggleClassStatus = async function(classId, currentStatus) {
    try {
        showLoading();
        const client = window.supabaseClient.getClient();

        const newStatus = !currentStatus;
        const { error } = await client
            .from('classes')
            .update({ is_active: newStatus })
            .eq('id', classId);

        if (error) throw error;

        hideLoading();
        showModal('Success', `Class ${newStatus ? 'activated' : 'deactivated'} successfully!`, 'success');
        renderClassManagement(); // Refresh
    } catch (error) {
        hideLoading();
        showModal('Error', error.message || 'Failed to toggle class status', 'error');
    }
};

async function renderAssignDuties() {
    const contentArea = document.getElementById('contentArea');

    // Load teachers list
    const client = window.supabaseClient.getClient();
    const { data: teachers } = await client
        .from('teachers')
        .select('*')
        .eq('status', 'active')
        .order('name');

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìã Assign Duties</h3>
            <form id="assignDutyForm" style="max-width: 600px;">
                <div class="form-group">
                    <label for="dutyTeacher">Select Teacher</label>
                    <select id="dutyTeacher" required>
                        <option value="">-- Select Teacher --</option>
                        ${teachers.map(t => `<option value="${t.id}">${t.name} (${t.id})</option>`).join('')}
                    </select>
                </div>

                <div class="form-group">
                    <label for="dutyName">Duty Name</label>
                    <input type="text" id="dutyName" placeholder="e.g., Morning Assembly, Exam Invigilation" required>
                </div>

                <div class="form-group">
                    <label for="dutyDate">Duty Date</label>
                    <input type="date" id="dutyDate" required>
                </div>

                <div class="form-group">
                    <label for="dutyTime">Duty Time</label>
                    <input type="text" id="dutyTime" placeholder="e.g., 8:00 AM - 9:00 AM" required>
                </div>

                <div class="form-group">
                    <label for="dutyLocation">Location</label>
                    <input type="text" id="dutyLocation" placeholder="e.g., Main Hall, Class 8B">
                </div>

                <button type="submit" class="btn-primary">Assign Duty</button>
            </form>

            <div style="margin-top: 40px;">
                <h4>Recent Duty Assignments</h4>
                <div id="recentDuties">Loading...</div>
            </div>
        </div>
    `;

    // Load recent duties
    const { data: duties } = await client
        .from('teacher_duties')
        .select('*')
        .order('duty_date', { ascending: false })
        .limit(10);

    const recentDutiesDiv = document.getElementById('recentDuties');
    if (duties && duties.length > 0) {
        recentDutiesDiv.innerHTML = `
            <table style="width: 100%; margin-top: 15px;">
                <thead>
                    <tr>
                        <th>Teacher ID</th>
                        <th>Duty</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Location</th>
                    </tr>
                </thead>
                <tbody>
                    ${duties.map(d => `
                        <tr>
                            <td>${d.teacher_id}</td>
                            <td>${d.duty_name}</td>
                            <td>${new Date(d.duty_date).toLocaleDateString()}</td>
                            <td>${d.duty_time}</td>
                            <td>${d.location || 'N/A'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } else {
        recentDutiesDiv.innerHTML = '<p>No duties assigned yet.</p>';
    }

    document.getElementById('assignDutyForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const user = window.auth.getCurrentUser();
        const teacherId = document.getElementById('dutyTeacher').value;
        const dutyName = document.getElementById('dutyName').value;
        const dutyDate = document.getElementById('dutyDate').value;
        const dutyTime = document.getElementById('dutyTime').value;
        const location = document.getElementById('dutyLocation').value;

        try {
            showLoading();
            const { error } = await client
                .from('teacher_duties')
                .insert([{
                    teacher_id: teacherId,
                    duty_name: dutyName,
                    duty_date: dutyDate,
                    duty_time: dutyTime,
                    location: location,
                    assigned_by: user.username
                }]);

            if (error) throw error;

            hideLoading();
            showModal('Success', 'Duty assigned successfully!', 'success');
            renderAssignDuties(); // Refresh the page
        } catch (error) {
            hideLoading();
            showModal('Error', error.message || 'Failed to assign duty', 'error');
        }
    });
}

async function renderVPIssues() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    const { data: allIssues } = await client
        .from('issues')
        .select('*')
        .order('created_at', { ascending: false });

    const pendingIssues = allIssues?.filter(i => i.status !== 'resolved') || [];
    const resolvedIssues = allIssues?.filter(i => i.status === 'resolved') || [];

    contentArea.innerHTML = `
        <div class="card">
            <h3>‚ö†Ô∏è Issues Management</h3>

            <div style="margin-bottom: 20px;">
                <button class="btn-tab active" onclick="showIssueTab('pending')" id="tab-pending">üìã Pending (${pendingIssues.length})</button>
                <button class="btn-tab" onclick="showIssueTab('history')" id="tab-history">‚úÖ Resolved Issues (${resolvedIssues.length})</button>
            </div>

            <div id="pending-tab">
                ${pendingIssues.length > 0 ? pendingIssues.map(issue => `
                    <div class="issue-card">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h4>${issue.title}</h4>
                                ${issue.student_name ? `<p style="color: #5CA870; font-weight: bold; margin: 5px 0;">Student: ${issue.student_name} ${issue.class ? `(${issue.class})` : ''}</p>` : ''}
                                <p style="color: #666; margin: 5px 0;">${issue.description || 'No description'}</p>
                                <div style="margin-top: 10px;">
                                    <span class="badge badge-${issue.priority}">${issue.priority}</span>
                                    <span class="badge badge-${issue.status}">${issue.status}</span>
                                    ${issue.reported_by ? `<span style="color: #666; font-size: 0.9em; margin-left: 10px;">By: ${issue.reported_by}</span>` : ''}
                                    <span style="color: #999; font-size: 0.85em; margin-left: 10px;">${new Date(issue.created_at).toLocaleDateString()}</span>
                                </div>
                            </div>
                            <div>
                                <select onchange="updateIssueStatus(${issue.id}, this.value)" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="pending" ${issue.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="in_progress" ${issue.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="resolved" ${issue.status === 'resolved' ? 'selected' : ''}>‚úÖ Resolved</option>
                                    <option value="escalated" ${issue.status === 'escalated' ? 'selected' : ''}>Escalated</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `).join('') : '<p style="padding: 20px; text-align: center; color: #666;">‚úÖ No pending issues! All issues have been resolved.</p>'}
            </div>

            <div id="history-tab" style="display: none;">
                ${resolvedIssues.length > 0 ? resolvedIssues.map(issue => `
                    <div class="issue-card" style="background: #f8f9fa; border-color: #d4edda;">
                        <div>
                            <h4 style="color: #28a745;">‚úÖ ${issue.title}</h4>
                            ${issue.student_name ? `<p style="color: #5CA870; font-weight: bold; margin: 5px 0;">Student: ${issue.student_name} ${issue.class ? `(${issue.class})` : ''}</p>` : ''}
                            <p style="color: #666; margin: 5px 0;">${issue.description || 'No description'}</p>
                            <div style="margin-top: 10px;">
                                <span class="badge badge-${issue.priority}">${issue.priority}</span>
                                <span class="badge badge-resolved">‚úÖ Resolved</span>
                                ${issue.reported_by ? `<span style="color: #666; font-size: 0.9em; margin-left: 10px;">By: ${issue.reported_by}</span>` : ''}
                                <span style="color: #999; font-size: 0.85em; margin-left: 10px;">${new Date(issue.created_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                    </div>
                `).join('') : '<p style="padding: 20px; text-align: center; color: #666;">No resolved issues in history yet.</p>'}
            </div>
        </div>

        <style>
            .issue-card {
                border: 1px solid #ddd;
                padding: 15px;
                margin-bottom: 10px;
                border-radius: 8px;
                background: white;
            }
            .badge {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.85em;
                margin-right: 8px;
            }
            .badge-low { background: #d4edda; color: #155724; }
            .badge-normal { background: #cce5ff; color: #004085; }
            .badge-high { background: #fff3cd; color: #856404; }
            .badge-critical { background: #f8d7da; color: #721c24; }
            .badge-pending { background: #fff3cd; color: #856404; }
            .badge-in_progress { background: #cce5ff; color: #004085; }
            .badge-resolved { background: #d4edda; color: #155724; }
            .badge-escalated { background: #f8d7da; color: #721c24; }
            .btn-tab {
                padding: 10px 20px;
                margin-right: 10px;
                border: none;
                background: #f0f0f0;
                cursor: pointer;
                border-radius: 8px 8px 0 0;
                font-size: 1em;
                transition: all 0.3s;
            }
            .btn-tab.active {
                background: var(--color-primary);
                color: white;
            }
            .btn-tab:hover {
                background: var(--color-secondary);
                color: white;
            }

            /* PROMPT 1 - NEW CODE: Comprehensive CSS for all UI enhancements */

            /* ========== STICKY TOP BANNER ========== */
            .sticky-top-banner {
                position: sticky;
                top: 0;
                z-index: 100;
                background: var(--color-bg, #fff);
                border-bottom: 1px solid #e0e0e0;
                padding: 12px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }

            .banner-left, .banner-right {
                display: flex;
                align-items: center;
                gap: 15px;
            }

            .banner-datetime {
                font-size: 14px;
                color: #666;
                font-weight: 500;
            }

            .banner-role-badge {
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
                text-transform: uppercase;
            }

            .banner-role-badge.role-hassan,
            .banner-role-badge.role-superviceprincipal,
            .banner-role-badge.role-viceprincipal {
                background: #fee;
                color: #c00;
            }

            .banner-role-badge.role-teacher {
                background: #e3f2fd;
                color: #1976d2;
            }

            .banner-role-badge.role-coordinator {
                background: #f3e5f5;
                color: #7b1fa2;
            }

            .banner-role-badge.role-parent {
                background: #e8f5e9;
                color: #388e3c;
            }

            .banner-role-badge.role-classteacher {
                background: #e0f2f1;
                color: #00796b;
            }

            .banner-tasks {
                font-size: 13px;
                color: #666;
            }

            .banner-notifications {
                position: relative;
            }

            .notification-btn {
                background: transparent;
                border: 1px solid #ddd;
                padding: 6px 12px;
                border-radius: 20px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.2s;
            }

            .notification-btn:hover {
                background: #f5f5f5;
            }

            .notification-count {
                background: #e74c3c;
                color: white;
                padding: 2px 6px;
                border-radius: 10px;
                font-size: 11px;
                font-weight: bold;
            }

            .notification-dropdown {
                position: absolute;
                top: 100%;
                right: 0;
                margin-top: 8px;
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                min-width: 280px;
                max-height: 400px;
                overflow-y: auto;
            }

            .notification-header {
                padding: 12px 16px;
                border-bottom: 1px solid #eee;
                font-weight: 600;
                font-size: 14px;
            }

            .notification-list {
                max-height: 350px;
                overflow-y: auto;
            }

            .notification-item {
                padding: 12px 16px;
                border-bottom: 1px solid #f5f5f5;
                font-size: 13px;
                color: #666;
            }

            .notification-item:last-child {
                border-bottom: none;
            }

            .theme-toggle-btn {
                background: transparent;
                border: 1px solid #ddd;
                padding: 6px 12px;
                border-radius: 20px;
                cursor: pointer;
                font-size: 18px;
                transition: all 0.2s;
            }

            .theme-toggle-btn:hover {
                background: #f5f5f5;
            }

            .hamburger-menu {
                display: none;
                background: transparent;
                border: none;
                cursor: pointer;
                flex-direction: column;
                gap: 4px;
                padding: 8px;
            }

            .hamburger-menu span {
                width: 24px;
                height: 3px;
                background: #333;
                border-radius: 2px;
                transition: all 0.3s;
            }

            /* ========== CONTENT WRAPPER & ACTIVITY FEED ========== */
            .content-wrapper {
                display: flex;
                gap: 20px;
                position: relative;
            }

            .content-area {
                flex: 1;
                min-width: 0;
            }

            .activity-feed-panel {
                width: 320px;
                background: white;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                max-height: calc(100vh - 200px);
                overflow-y: auto;
                position: sticky;
                top: 80px;
            }

            .activity-feed-header h3 {
                margin: 0 0 5px 0;
                font-size: 18px;
            }

            .activity-feed-subtitle {
                color: #999;
                font-size: 12px;
            }

            .activity-feed-list {
                margin-top: 20px;
            }

            .activity-item {
                padding: 12px 0;
                border-bottom: 1px solid #f0f0f0;
            }

            .activity-item:last-child {
                border-bottom: none;
            }

            .activity-time {
                font-size: 11px;
                color: #999;
                margin-bottom: 6px;
            }

            .activity-content {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 13px;
                color: #333;
                margin-bottom: 4px;
            }

            .activity-icon {
                font-size: 14px;
            }

            .activity-subtext {
                font-size: 12px;
                color: #666;
                margin-left: 22px;
            }

            /* ========== INTERACTIVE STAT CARDS ========== */
            .interactive-stat-card {
                cursor: pointer;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
                position: relative;
                overflow: hidden;
            }

            .interactive-stat-card:hover {
                transform: translateY(-5px) scale(1.02);
                box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            }

            .interactive-stat-card::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .interactive-stat-card:hover::after {
                opacity: 1;
            }

            .stat-icon {
                font-size: 36px;
                margin-bottom: 10px;
            }

            .stat-subtitle {
                font-size: 11px;
                color: #999;
                margin-top: 8px;
            }

            .growth-indicator {
                font-size: 18px;
                margin-left: 8px;
                font-weight: bold;
            }

            .growth-indicator.positive {
                color: #27ae60;
            }

            .growth-indicator.negative {
                color: #e74c3c;
            }

            /* ========== COLLAPSIBLE SIDEBAR SECTIONS ========== */
            .menu-section {
                list-style: none;
                margin-bottom: 8px;
            }

            .menu-section-header {
                width: 100%;
                background: transparent;
                border: none;
                padding: 12px 15px;
                text-align: left;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: 600;
                font-size: 12px;
                color: #999;
                letter-spacing: 0.5px;
                transition: all 0.2s;
            }

            .menu-section-header:hover {
                background: rgba(0,0,0,0.03);
            }

            .section-arrow {
                font-size: 10px;
                transition: transform 0.3s ease;
            }

            .section-arrow.collapsed {
                transform: rotate(0deg);
            }

            .section-title {
                text-transform: uppercase;
            }

            .menu-section-items {
                list-style: none;
                padding: 0;
                margin: 0;
                max-height: 1000px;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }

            .menu-section-items.collapsed {
                max-height: 0;
            }

            .menu-section-items .menu-item {
                list-style: none;
            }

            /* ========== SIDEBAR BACKDROP FOR MOBILE ========== */
            .sidebar-backdrop {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 998;
                transition: opacity 0.3s ease;
            }

            .sidebar-backdrop.hidden {
                display: none;
            }

            /* ========== DARK MODE COLORS ========== */
            [data-theme="dark"] {
                --color-bg: #1a1a1a;
                --color-card: #2a2a2a;
                --color-text: #e0e0e0;
                --color-text-secondary: #a0a0a0;
                --color-border: #3a3a3a;
            }

            [data-theme="dark"] body {
                background: #0f0f0f;
                color: #e0e0e0;
            }

            [data-theme="dark"] .sidebar {
                background: #1a1a1a;
                border-right-color: #3a3a3a;
            }

            [data-theme="dark"] .main-content {
                background: #0f0f0f;
            }

            [data-theme="dark"] .sticky-top-banner {
                background: #1a1a1a;
                border-bottom-color: #3a3a3a;
            }

            [data-theme="dark"] .banner-datetime,
            [data-theme="dark"] .banner-tasks {
                color: #a0a0a0;
            }

            [data-theme="dark"] .card,
            [data-theme="dark"] .stat-card,
            [data-theme="dark"] .activity-feed-panel {
                background: #2a2a2a;
                color: #e0e0e0;
                border-color: #3a3a3a;
            }

            [data-theme="dark"] .menu-link {
                color: #e0e0e0;
            }

            [data-theme="dark"] .menu-link:hover {
                background: #3a3a3a;
            }

            [data-theme="dark"] .menu-section-header {
                color: #a0a0a0;
            }

            [data-theme="dark"] .notification-dropdown,
            [data-theme="dark"] .notification-btn {
                background: #2a2a2a;
                border-color: #3a3a3a;
                color: #e0e0e0;
            }

            [data-theme="dark"] .notification-btn:hover,
            [data-theme="dark"] .theme-toggle-btn:hover {
                background: #3a3a3a;
            }

            [data-theme="dark"] .theme-toggle-btn {
                border-color: #3a3a3a;
            }

            [data-theme="dark"] .activity-item {
                border-bottom-color: #3a3a3a;
            }

            [data-theme="dark"] .activity-content {
                color: #e0e0e0;
            }

            [data-theme="dark"] .activity-time,
            [data-theme="dark"] .activity-subtext {
                color: #a0a0a0;
            }

            [data-theme="dark"] .hamburger-menu span {
                background: #e0e0e0;
            }

            [data-theme="dark"] input,
            [data-theme="dark"] select,
            [data-theme="dark"] textarea {
                background: #2a2a2a;
                color: #e0e0e0;
                border-color: #3a3a3a;
            }

            [data-theme="dark"] table {
                color: #e0e0e0;
            }

            [data-theme="dark"] th {
                background: #3a3a3a;
                color: #e0e0e0;
            }

            [data-theme="dark"] td {
                border-color: #3a3a3a;
            }

            /* ========== RESPONSIVE LAYOUT ========== */

            /* Tablet Layout (768px - 1024px) */
            @media (max-width: 1024px) {
                .activity-feed-panel {
                    display: none;
                }

                .content-wrapper {
                    flex-direction: column;
                }

                .content-area {
                    width: 100%;
                }

                .sidebar {
                    width: 240px;
                }
            }

            /* Mobile Layout (<768px) */
            @media (max-width: 768px) {
                .hamburger-menu {
                    display: flex;
                }

                .sidebar {
                    position: fixed;
                    top: 0;
                    left: -280px;
                    bottom: 0;
                    width: 280px;
                    z-index: 999;
                    transition: left 0.3s ease;
                    overflow-y: auto;
                }

                .sidebar.mobile-open {
                    left: 0;
                }

                .activity-feed-panel {
                    display: none;
                }

                .banner-datetime {
                    font-size: 12px;
                }

                .banner-left,
                .banner-right {
                    gap: 8px;
                }

                .banner-tasks {
                    display: none;
                }

                .sticky-top-banner {
                    padding: 10px 15px;
                }

                .stats-grid {
                    grid-template-columns: 1fr !important;
                }

                .interactive-stat-card {
                    padding: 20px !important;
                }

                .content-wrapper {
                    padding: 0;
                }
            }

            /* END PROMPT 1 - NEW CODE */

            /* PROMPT 2 - NEW CODE: CSS for all data management features */

            /* ========== GLOBAL SEARCH OVERLAY ========== */
            .search-toggle-btn {
                background: transparent;
                border: 1px solid #ddd;
                padding: 6px 12px;
                border-radius: 20px;
                cursor: pointer;
                font-size: 18px;
                transition: all 0.2s;
            }

            .search-toggle-btn:hover {
                background: #f5f5f5;
            }

            .search-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: opacity 0.3s ease;
            }

            .search-overlay.hidden {
                display: none;
            }

            .search-panel {
                background: white;
                width: 90%;
                max-width: 500px;
                max-height: 80vh;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            .search-header {
                display: flex;
                align-items: center;
                padding: 15px;
                border-bottom: 1px solid #eee;
            }

            .search-input {
                flex: 1;
                border: none;
                outline: none;
                font-size: 16px;
                padding: 8px;
            }

            .search-close-btn {
                background: transparent;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #999;
                padding: 0 10px;
            }

            .search-close-btn:hover {
                color: #333;
            }

            .search-results {
                flex: 1;
                overflow-y: auto;
                padding: 15px;
            }

            .search-empty,
            .search-loading,
            .search-error {
                text-align: center;
                padding: 40px 20px;
                color: #999;
            }

            .search-results-header {
                font-weight: 600;
                margin-bottom: 15px;
                color: #333;
                font-size: 16px;
            }

            .search-category {
                margin-bottom: 20px;
            }

            .search-category-title {
                font-size: 12px;
                font-weight: 600;
                color: #999;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 10px;
            }

            .search-result-item {
                display: flex;
                align-items: center;
                padding: 12px;
                margin-bottom: 8px;
                border-radius: 8px;
                cursor: pointer;
                transition: background 0.2s;
            }

            .search-result-item:hover {
                background: #f5f5f5;
            }

            .search-result-icon {
                font-size: 24px;
                margin-right: 12px;
            }

            .search-result-content {
                flex: 1;
            }

            .search-result-title {
                font-weight: 500;
                margin-bottom: 4px;
            }

            .search-result-subtitle {
                font-size: 13px;
                color: #666;
            }

            /* ========== TABLE SORTING ========== */
            table th.sortable {
                cursor: pointer;
                user-select: none;
            }

            table th.sortable:hover {
                background: #e8e8e8;
            }

            .sort-arrow {
                margin-left: 5px;
                font-size: 14px;
            }

            /* ========== TOAST NOTIFICATIONS ========== */
            .toast {
                position: fixed;
                bottom: -100px;
                left: 50%;
                transform: translateX(-50%);
                background: #333;
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                transition: bottom 0.3s ease;
                font-size: 14px;
                max-width: 400px;
            }

            .toast.show {
                bottom: 30px;
            }

            .toast-success {
                background: #27ae60;
            }

            .toast-error {
                background: #e74c3c;
            }

            .toast-info {
                background: #3498db;
            }

            /* ========== FORM VALIDATION ========== */
            .field-error {
                color: #e74c3c;
                font-size: 12px;
                margin-top: 5px;
            }

            input.error,
            select.error,
            textarea.error {
                border-color: #e74c3c !important;
                box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
            }

            .error-text {
                color: #e74c3c;
                font-size: 12px;
            }

            .warning-text {
                color: #f39c12;
                font-size: 12px;
            }

            .success-text {
                color: #27ae60;
                font-size: 12px;
            }

            /* ========== BULK UPLOAD FEATURE ========== */
            .upload-step {
                margin-bottom: 40px;
                padding: 25px;
                background: #f9f9f9;
                border-radius: 12px;
            }

            .upload-step h4 {
                margin: 0 0 15px 0;
                color: #333;
                font-size: 18px;
            }

            .upload-dropzone {
                border: 2px dashed #ddd;
                border-radius: 12px;
                padding: 50px 30px;
                text-align: center;
                transition: all 0.3s;
                cursor: pointer;
                background: white;
            }

            .upload-dropzone.drag-over {
                border-color: var(--color-primary);
                background: rgba(52, 152, 219, 0.05);
            }

            .upload-icon {
                font-size: 48px;
                margin-bottom: 15px;
            }

            .upload-text {
                font-size: 16px;
                color: #333;
                margin-bottom: 10px;
            }

            .upload-or {
                color: #999;
                margin: 15px 0;
            }

            .upload-info {
                font-size: 12px;
                color: #999;
                margin-top: 15px;
            }

            .file-selected-info {
                margin-top: 15px;
                padding: 15px;
                background: #e8f5e9;
                border-radius: 8px;
                color: #27ae60;
            }

            .file-selected-info.hidden {
                display: none;
            }

            .preview-summary {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
            }

            .preview-stat {
                background: white;
                padding: 20px;
                border-radius: 8px;
                text-align: center;
                border: 2px solid #e0e0e0;
            }

            .preview-stat.valid {
                border-color: #27ae60;
                background: #e8f5e9;
            }

            .preview-stat.error {
                border-color: #e74c3c;
                background: #fef5f5;
            }

            .preview-stat.warning {
                border-color: #f39c12;
                background: #fef9f3;
            }

            .preview-stat-value {
                display: block;
                font-size: 24px;
                font-weight: bold;
                margin-bottom: 5px;
            }

            .preview-stat-label {
                font-size: 12px;
                color: #666;
            }

            .preview-row-valid {
                background: #f0fdf4;
            }

            .preview-row-warning {
                background: #fffbeb;
            }

            .preview-row-error {
                background: #fef2f2;
            }

            /* ========== BULK OPERATIONS ========== */
            .bulk-action-bar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: #333;
                color: white;
                padding: 15px 20px;
                display: flex;
                align-items: center;
                gap: 15px;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
                z-index: 100;
            }

            .bulk-action-bar.hidden {
                display: none;
            }

            /* ========== ADVANCED FILTERS ========== */
            .filter-bar {
                background: #f9f9f9;
                padding: 15px 20px;
                border-radius: 8px;
                margin-bottom: 20px;
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                align-items: center;
            }

            .filter-select {
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
                background: white;
                cursor: pointer;
            }

            .filter-badge {
                background: #f39c12;
                color: white;
                padding: 5px 10px;
                border-radius: 15px;
                font-size: 12px;
                font-weight: 600;
            }

            .filter-clear-btn {
                background: transparent;
                border: 1px solid #e74c3c;
                color: #e74c3c;
                padding: 6px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                transition: all 0.2s;
            }

            .filter-clear-btn:hover {
                background: #e74c3c;
                color: white;
            }

            /* ========== EXPORT DROPDOWN ========== */
            .export-dropdown {
                position: relative;
                display: inline-block;
            }

            .export-dropdown-content {
                display: none;
                position: absolute;
                right: 0;
                background: white;
                min-width: 160px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                border-radius: 8px;
                z-index: 10;
            }

            .export-dropdown:hover .export-dropdown-content {
                display: block;
            }

            .export-dropdown-content button {
                display: block;
                width: 100%;
                text-align: left;
                padding: 12px 16px;
                border: none;
                background: transparent;
                cursor: pointer;
                transition: background 0.2s;
            }

            .export-dropdown-content button:hover {
                background: #f5f5f5;
            }

            /* ========== DARK MODE ADJUSTMENTS ========== */
            [data-theme="dark"] .search-panel,
            [data-theme="dark"] .search-result-item:hover,
            [data-theme="dark"] .upload-dropzone,
            [data-theme="dark"] .preview-stat {
                background: #2a2a2a;
                color: #e0e0e0;
            }

            [data-theme="dark"] .search-header,
            [data-theme="dark"] .upload-step {
                background: #1a1a1a;
                border-color: #3a3a3a;
            }

            [data-theme="dark"] .search-input {
                background: #2a2a2a;
                color: #e0e0e0;
            }

            [data-theme="dark"] .filter-bar {
                background: #1a1a1a;
            }

            [data-theme="dark"] .filter-select {
                background: #2a2a2a;
                color: #e0e0e0;
                border-color: #3a3a3a;
            }

            [data-theme="dark"] .export-dropdown-content {
                background: #2a2a2a;
                border: 1px solid #3a3a3a;
            }

            /* END PROMPT 2 - NEW CODE */

            /* ========================================== */
            /* PROMPT 3 - NEW CODE: NOTIFICATION & ANALYTICS CSS */
            /* ========================================== */

            /* Enhanced Notification System */
            .banner-notifications {
                position: relative;
            }

            .notification-btn {
                position: relative;
                background: transparent;
                border: none;
                font-size: 24px;
                cursor: pointer;
                padding: 8px;
                transition: transform 0.2s;
            }

            .notification-btn:hover {
                transform: scale(1.1);
            }

            .notification-count {
                position: absolute;
                top: 2px;
                right: 2px;
                background: #e74c3c;
                color: white;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                font-size: 11px;
                font-weight: bold;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.1); }
            }

            .notification-dropdown {
                position: absolute;
                top: 50px;
                right: 0;
                width: 380px;
                max-height: 500px;
                background: white;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.15);
                z-index: 1000;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            .notification-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 16px 20px;
                background: #f8f9fa;
                border-bottom: 1px solid #e0e0e0;
                font-weight: 600;
                font-size: 16px;
            }

            .notification-close-btn {
                background: transparent;
                border: none;
                font-size: 20px;
                cursor: pointer;
                color: #666;
                padding: 0;
                width: 28px;
                height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 4px;
                transition: background 0.2s;
            }

            .notification-close-btn:hover {
                background: #e0e0e0;
            }

            .notification-actions {
                display: flex;
                gap: 8px;
                padding: 12px 20px;
                background: #f8f9fa;
                border-bottom: 1px solid #e0e0e0;
            }

            .notification-action-btn {
                flex: 1;
                padding: 8px 12px;
                background: white;
                border: 1px solid #ddd;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                transition: all 0.2s;
                color: #333;
            }

            .notification-action-btn:hover {
                background: #f0f0f0;
                border-color: #bbb;
            }

            .notification-list {
                overflow-y: auto;
                max-height: 400px;
                flex: 1;
            }

            .notification-item {
                display: flex;
                gap: 12px;
                padding: 16px 20px;
                border-bottom: 1px solid #f0f0f0;
                transition: background 0.2s;
                cursor: pointer;
                position: relative;
            }

            .notification-item:hover {
                background: #f8f9fa;
            }

            .notification-item.unread {
                background: #f0f7ff;
            }

            .notification-item.unread:hover {
                background: #e6f2ff;
            }

            .notification-icon {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                flex-shrink: 0;
            }

            .notification-icon-green {
                background: #d4edda;
                color: #155724;
            }

            .notification-icon-blue {
                background: #d1ecf1;
                color: #0c5460;
            }

            .notification-icon-orange {
                background: #fff3cd;
                color: #856404;
            }

            .notification-icon-red {
                background: #f8d7da;
                color: #721c24;
            }

            .notification-content {
                flex: 1;
                min-width: 0;
            }

            .notification-title {
                font-weight: 600;
                font-size: 14px;
                color: #333;
                margin-bottom: 4px;
            }

            .notification-subtitle {
                font-size: 13px;
                color: #666;
                margin-bottom: 4px;
            }

            .notification-time {
                font-size: 12px;
                color: #999;
            }

            .notification-new-badge {
                position: absolute;
                top: 16px;
                right: 20px;
                background: #3498db;
                color: white;
                font-size: 10px;
                padding: 2px 6px;
                border-radius: 10px;
                font-weight: bold;
            }

            .notification-dismiss {
                position: absolute;
                top: 8px;
                right: 8px;
                background: transparent;
                border: none;
                color: #999;
                cursor: pointer;
                padding: 4px;
                border-radius: 4px;
                opacity: 0;
                transition: all 0.2s;
            }

            .notification-item:hover .notification-dismiss {
                opacity: 1;
            }

            .notification-dismiss:hover {
                background: #f0f0f0;
                color: #333;
            }

            .notification-empty {
                text-align: center;
                padding: 40px 20px;
                color: #999;
                font-size: 14px;
            }

            /* Issues Kanban Dashboard */
            .issues-stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .issue-stat {
                background: white;
                padding: 24px;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                text-align: center;
            }

            .issue-stat-icon {
                font-size: 36px;
                margin-bottom: 12px;
            }

            .issue-stat-value {
                font-size: 32px;
                font-weight: bold;
                margin-bottom: 8px;
                color: #333;
            }

            .issue-stat-label {
                font-size: 14px;
                color: #666;
            }

            .kanban-board {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                gap: 24px;
            }

            .kanban-column {
                background: #f8f9fa;
                border-radius: 12px;
                padding: 20px;
                min-height: 500px;
            }

            .kanban-header {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 20px;
                padding-bottom: 16px;
                border-bottom: 2px solid #e0e0e0;
            }

            .kanban-icon {
                font-size: 24px;
            }

            .kanban-title {
                font-size: 18px;
                font-weight: 600;
                color: #333;
            }

            .kanban-count {
                margin-left: auto;
                background: white;
                padding: 4px 12px;
                border-radius: 20px;
                font-weight: 600;
                color: #666;
            }

            .kanban-cards {
                display: flex;
                flex-direction: column;
                gap: 16px;
            }

            .issue-card {
                background: white;
                border-radius: 10px;
                padding: 16px;
                box-shadow: 0 2px 6px rgba(0,0,0,0.08);
                cursor: pointer;
                transition: all 0.2s;
                border-left: 4px solid #ddd;
            }

            .issue-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            }

            .issue-card-category {
                display: inline-block;
                padding: 4px 10px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 600;
                margin-bottom: 10px;
                text-transform: uppercase;
            }

            .issue-card-category.academic {
                background: #e3f2fd;
                color: #1565c0;
            }

            .issue-card-category.behavioral {
                background: #fff3e0;
                color: #e65100;
            }

            .issue-card-category.attendance {
                background: #f3e5f5;
                color: #6a1b9a;
            }

            .issue-card-category.medical {
                background: #ffebee;
                color: #c62828;
            }

            .issue-card-category.social {
                background: #e8f5e9;
                color: #2e7d32;
            }

            .issue-card-student {
                font-weight: 600;
                font-size: 15px;
                color: #333;
                margin-bottom: 4px;
            }

            .issue-card-class {
                font-size: 13px;
                color: #666;
                margin-bottom: 12px;
            }

            .issue-card-priority {
                display: inline-block;
                padding: 4px 10px;
                border-radius: 6px;
                font-size: 11px;
                font-weight: 600;
                margin-bottom: 8px;
            }

            .priority-high {
                background: #ffebee;
                color: #c62828;
            }

            .priority-medium {
                background: #fff3e0;
                color: #e65100;
            }

            .priority-low {
                background: #e8f5e9;
                color: #2e7d32;
            }

            .issue-card-time {
                font-size: 12px;
                color: #999;
                margin-bottom: 12px;
            }

            .issue-card-view {
                width: 100%;
                padding: 8px;
                background: #f0f0f0;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                color: #333;
                transition: background 0.2s;
            }

            .issue-card-view:hover {
                background: #e0e0e0;
            }

            /* KPI Cards */
            .kpi-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .kpi-card {
                background: white;
                border-radius: 12px;
                padding: 24px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                display: flex;
                flex-direction: column;
                gap: 12px;
                transition: transform 0.2s;
            }

            .kpi-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            }

            .kpi-icon {
                width: 50px;
                height: 50px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
            }

            .kpi-blue .kpi-icon {
                background: #e3f2fd;
            }

            .kpi-green .kpi-icon {
                background: #e8f5e9;
            }

            .kpi-purple .kpi-icon {
                background: #f3e5f5;
            }

            .kpi-orange .kpi-icon {
                background: #fff3e0;
            }

            .kpi-red .kpi-icon {
                background: #ffebee;
            }

            .kpi-value {
                font-size: 32px;
                font-weight: bold;
                color: #333;
            }

            .kpi-label {
                font-size: 14px;
                color: #666;
                font-weight: 500;
            }

            .kpi-change {
                font-size: 13px;
                font-weight: 600;
                padding: 4px 8px;
                border-radius: 6px;
                align-self: flex-start;
            }

            .kpi-change.positive {
                background: #e8f5e9;
                color: #2e7d32;
            }

            .kpi-change.negative {
                background: #ffebee;
                color: #c62828;
            }

            .kpi-change.neutral {
                background: #f5f5f5;
                color: #666;
            }

            /* Analytics Tables */
            .analytics-table {
                width: 100%;
                background: white;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                overflow: hidden;
                margin-bottom: 30px;
            }

            .analytics-table h3 {
                padding: 20px 24px;
                margin: 0;
                background: #f8f9fa;
                border-bottom: 1px solid #e0e0e0;
                font-size: 18px;
                color: #333;
            }

            .analytics-table table {
                width: 100%;
                border-collapse: collapse;
            }

            .analytics-table th {
                text-align: left;
                padding: 16px 24px;
                background: #f8f9fa;
                border-bottom: 2px solid #e0e0e0;
                font-weight: 600;
                color: #666;
                font-size: 13px;
                text-transform: uppercase;
            }

            .analytics-table td {
                padding: 16px 24px;
                border-bottom: 1px solid #f0f0f0;
                color: #333;
            }

            .analytics-table tr:last-child td {
                border-bottom: none;
            }

            .analytics-table tbody tr:hover {
                background: #f8f9fa;
            }

            /* Progress Bars */
            .progress-bar {
                width: 100%;
                height: 8px;
                background: #e0e0e0;
                border-radius: 4px;
                overflow: hidden;
                margin-top: 8px;
            }

            .progress-fill {
                height: 100%;
                background: #4CAF50;
                border-radius: 4px;
                transition: width 0.3s ease;
            }

            .progress-fill.excellent {
                background: #4CAF50;
            }

            .progress-fill.good {
                background: #8BC34A;
            }

            .progress-fill.average {
                background: #FFC107;
            }

            .progress-fill.poor {
                background: #FF9800;
            }

            .progress-fill.critical {
                background: #F44336;
            }

            .progress-bar-large {
                width: 100%;
                height: 24px;
                background: #e0e0e0;
                border-radius: 12px;
                overflow: hidden;
                position: relative;
            }

            .progress-fill-large {
                height: 100%;
                border-radius: 12px;
                transition: width 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 12px;
                font-weight: 600;
            }

            /* Grade Distribution */
            .grade-distribution {
                background: white;
                border-radius: 12px;
                padding: 24px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                margin-bottom: 30px;
            }

            .grade-distribution h3 {
                margin: 0 0 20px 0;
                font-size: 18px;
                color: #333;
            }

            .grade-item {
                display: flex;
                align-items: center;
                gap: 16px;
                margin-bottom: 16px;
            }

            .grade-label {
                font-weight: 600;
                font-size: 14px;
                color: #333;
                min-width: 60px;
            }

            .grade-bar {
                flex: 1;
                height: 32px;
                background: #e0e0e0;
                border-radius: 8px;
                overflow: hidden;
                position: relative;
            }

            .grade-bar-fill {
                height: 100%;
                display: flex;
                align-items: center;
                padding: 0 12px;
                color: white;
                font-weight: 600;
                font-size: 13px;
                transition: width 0.3s ease;
            }

            .grade-bar-fill.grade-a {
                background: #4CAF50;
            }

            .grade-bar-fill.grade-b {
                background: #8BC34A;
            }

            .grade-bar-fill.grade-c {
                background: #FFC107;
            }

            .grade-bar-fill.grade-d {
                background: #FF9800;
            }

            .grade-bar-fill.grade-f {
                background: #F44336;
            }

            /* Attendance Overview */
            .attendance-overview {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .overview-stat {
                background: white;
                border-radius: 12px;
                padding: 24px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                text-align: center;
            }

            .overview-stat-value {
                font-size: 36px;
                font-weight: bold;
                margin-bottom: 8px;
            }

            .overview-stat-value.excellent {
                color: #4CAF50;
            }

            .overview-stat-value.good {
                color: #8BC34A;
            }

            .overview-stat-value.warning {
                color: #FFC107;
            }

            .overview-stat-value.critical {
                color: #F44336;
            }

            .overview-stat-label {
                font-size: 14px;
                color: #666;
                font-weight: 500;
            }

            /* Performance Overview */
            .performance-overview {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .perf-stat {
                background: white;
                border-radius: 12px;
                padding: 24px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .perf-stat-header {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .perf-stat-icon {
                font-size: 32px;
            }

            .perf-stat-value {
                font-size: 28px;
                font-weight: bold;
                color: #333;
            }

            .perf-stat-label {
                font-size: 14px;
                color: #666;
            }

            .perf-stat-trend {
                font-size: 12px;
                font-weight: 600;
                padding: 4px 8px;
                border-radius: 6px;
                align-self: flex-start;
            }

            .perf-stat-trend.up {
                background: #e8f5e9;
                color: #2e7d32;
            }

            .perf-stat-trend.down {
                background: #ffebee;
                color: #c62828;
            }

            /* Submission Stats */
            .submission-stats {
                display: flex;
                flex-direction: column;
                gap: 20px;
                margin-bottom: 30px;
            }

            .submission-item {
                background: white;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }

            .submission-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
            }

            .submission-class {
                font-weight: 600;
                font-size: 15px;
                color: #333;
            }

            .submission-percentage {
                font-weight: bold;
                font-size: 18px;
            }

            .submission-percentage.complete {
                color: #4CAF50;
            }

            .submission-percentage.in-progress {
                color: #FFC107;
            }

            .submission-status {
                font-size: 13px;
                color: #666;
                margin-top: 4px;
            }

            /* Duties Chart */
            .duties-chart {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .duty-stat {
                background: white;
                border-radius: 12px;
                padding: 24px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                text-align: center;
            }

            .duty-circle {
                width: 100px;
                height: 100px;
                border-radius: 50%;
                margin: 0 auto 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 32px;
                font-weight: bold;
                position: relative;
            }

            .duty-circle.complete {
                background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
                color: #2e7d32;
            }

            .duty-circle.upcoming {
                background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
                color: #e65100;
            }

            .duty-circle.pending {
                background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
                color: #c62828;
            }

            .duty-label {
                font-size: 14px;
                font-weight: 600;
                color: #333;
                margin-bottom: 4px;
            }

            .duty-sublabel {
                font-size: 12px;
                color: #666;
            }

            /* Filter Bar for Analytics */
            .analytics-filters {
                background: white;
                border-radius: 12px;
                padding: 20px 24px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                margin-bottom: 30px;
                display: flex;
                gap: 16px;
                flex-wrap: wrap;
                align-items: center;
            }

            .analytics-filters label {
                font-weight: 600;
                font-size: 14px;
                color: #333;
            }

            .analytics-filters select {
                padding: 8px 16px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 14px;
                background: white;
                cursor: pointer;
                transition: border-color 0.2s;
            }

            .analytics-filters select:hover {
                border-color: #3498db;
            }

            .analytics-filters select:focus {
                outline: none;
                border-color: #3498db;
                box-shadow: 0 0 0 3px rgba(52,152,219,0.1);
            }

            /* Student Rank Badge */
            .rank-badge {
                display: inline-block;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                text-align: center;
                line-height: 32px;
                font-weight: bold;
                font-size: 14px;
                margin-right: 8px;
            }

            .rank-badge.gold {
                background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
                color: #333;
            }

            .rank-badge.silver {
                background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
                color: #333;
            }

            .rank-badge.bronze {
                background: linear-gradient(135deg, #cd7f32 0%, #e9b168 100%);
                color: white;
            }

            .rank-badge.regular {
                background: #f5f5f5;
                color: #666;
            }

            /* ========== DARK MODE ADJUSTMENTS FOR PROMPT 3 ========== */
            [data-theme="dark"] .notification-dropdown,
            [data-theme="dark"] .issue-stat,
            [data-theme="dark"] .issue-card,
            [data-theme="dark"] .kpi-card,
            [data-theme="dark"] .analytics-table,
            [data-theme="dark"] .grade-distribution,
            [data-theme="dark"] .overview-stat,
            [data-theme="dark"] .perf-stat,
            [data-theme="dark"] .submission-item,
            [data-theme="dark"] .duty-stat,
            [data-theme="dark"] .analytics-filters {
                background: #2a2a2a;
                color: #e0e0e0;
            }

            [data-theme="dark"] .notification-header,
            [data-theme="dark"] .notification-actions,
            [data-theme="dark"] .analytics-table h3,
            [data-theme="dark"] .analytics-table th {
                background: #1a1a1a;
                border-color: #3a3a3a;
            }

            [data-theme="dark"] .notification-item {
                border-color: #3a3a3a;
            }

            [data-theme="dark"] .notification-item.unread {
                background: #1e3a5f;
            }

            [data-theme="dark"] .notification-item.unread:hover {
                background: #254875;
            }

            [data-theme="dark"] .notification-title,
            [data-theme="dark"] .issue-stat-value,
            [data-theme="dark"] .issue-card-student,
            [data-theme="dark"] .kpi-value,
            [data-theme="dark"] .grade-label,
            [data-theme="dark"] .overview-stat-value,
            [data-theme="dark"] .perf-stat-value,
            [data-theme="dark"] .submission-class,
            [data-theme="dark"] .duty-label,
            [data-theme="dark"] .analytics-table td,
            [data-theme="dark"] .analytics-filters label {
                color: #e0e0e0;
            }

            [data-theme="dark"] .notification-subtitle,
            [data-theme="dark"] .notification-time,
            [data-theme="dark"] .issue-stat-label,
            [data-theme="dark"] .issue-card-class,
            [data-theme="dark"] .kpi-label,
            [data-theme="dark"] .overview-stat-label,
            [data-theme="dark"] .perf-stat-label,
            [data-theme="dark"] .submission-status,
            [data-theme="dark"] .duty-sublabel {
                color: #b0b0b0;
            }

            [data-theme="dark"] .kanban-column {
                background: #1a1a1a;
            }

            [data-theme="dark"] .notification-action-btn,
            [data-theme="dark"] .issue-card-view,
            [data-theme="dark"] .analytics-filters select {
                background: #1a1a1a;
                border-color: #3a3a3a;
                color: #e0e0e0;
            }

            [data-theme="dark"] .notification-action-btn:hover,
            [data-theme="dark"] .issue-card-view:hover {
                background: #2a2a2a;
            }

            [data-theme="dark"] .analytics-table tbody tr:hover {
                background: #1a1a1a;
            }

            [data-theme="dark"] .analytics-table td {
                border-color: #3a3a3a;
            }

            [data-theme="dark"] .progress-bar,
            [data-theme="dark"] .progress-bar-large,
            [data-theme="dark"] .grade-bar {
                background: #3a3a3a;
            }

            [data-theme="dark"] .kanban-header {
                border-color: #3a3a3a;
            }

            [data-theme="dark"] .kanban-count {
                background: #1a1a1a;
                color: #b0b0b0;
            }

            [data-theme="dark"] .kanban-title {
                color: #e0e0e0;
            }

            /* END PROMPT 3 - NEW CODE */
        </style>
    `;
}

window.showIssueTab = function(tab) {
    // Toggle tabs
    document.querySelectorAll('.btn-tab').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');

    // Toggle content
    document.getElementById('pending-tab').style.display = tab === 'pending' ? 'block' : 'none';
    document.getElementById('history-tab').style.display = tab === 'history' ? 'block' : 'none';
};

window.updateIssueStatus = async function(issueId, newStatus) {
    try {
        showLoading();
        const { error } = await window.supabaseClient.getClient()
            .from('issues')
            .update({ status: newStatus })
            .eq('id', issueId);

        if (error) throw error;

        hideLoading();
        if (newStatus === 'resolved') {
            showModal('Success', 'Issue resolved and moved to history!', 'success');
        } else {
            showModal('Success', 'Issue status updated!', 'success');
        }
        renderVPIssues();
    } catch (error) {
        hideLoading();
        showModal('Error', error.message, 'error');
    }
};

async function renderManagePosts() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    try {
        // Get all users
        const { data: users } = await client
            .from('users')
            .select('username, name, role')
            .order('username');

        contentArea.innerHTML = `
            <div class="card">
                <h3>üë• Manage Posts (Assign Roles)</h3>
                <p style="color: #666; margin-bottom: 20px;">
                    Assign multiple posts to users. Each person can have multiple roles like Teacher + Class Teacher + Coordinator.
                </p>

                <div class="form-group" style="max-width: 400px; margin-bottom: 30px;">
                    <label for="userSearch">Search User</label>
                    <input type="text" id="userSearch" placeholder="Search by username or name..."
                           onkeyup="filterUsersTable()" style="padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 5px;">
                </div>

                <div style="overflow-x: auto;">
                    <table id="usersTable" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Name</th>
                                <th>Primary Role</th>
                                <th>Additional Posts</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${await Promise.all(users?.map(async (user) => {
                                // Get additional roles from user_roles table if it exists
                                const { data: userRoles } = await client
                                    .from('user_roles')
                                    .select('role')
                                    .eq('username', user.username);

                                const additionalRoles = userRoles?.map(r => r.role).filter(r => r !== user.role) || [];

                                return `
                                    <tr>
                                        <td><strong>${user.username}</strong></td>
                                        <td>${user.name}</td>
                                        <td><span class="badge">${formatRole(user.role)}</span></td>
                                        <td>
                                            ${additionalRoles.length > 0
                                                ? additionalRoles.map(r => `<span class="badge badge-info">${formatRole(r)}</span>`).join(' ')
                                                : '<span style="color: #999;">None</span>'}
                                        </td>
                                        <td>
                                            <button class="btn-primary" style="padding: 5px 10px; font-size: 13px;"
                                                    onclick="showAssignPostModal('${user.username}', '${user.name}')">
                                                ‚ûï Assign Post
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }) || [])}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Assign Post Modal -->
            <div id="assignPostModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                                             background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
                    <h4 id="modalUsername" style="margin-bottom: 20px;"></h4>

                    <div class="form-group">
                        <label>Select Post to Assign</label>
                        <select id="postToAssign" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="">-- Select Post --</option>
                            <option value="teacher">Teacher</option>
                            <option value="classteacher">Class Teacher</option>
                            <option value="coordinator">Coordinator</option>
                            <option value="parent">Parent</option>
                        </select>
                    </div>

                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn-primary" onclick="assignPost()">Assign Post</button>
                        <button class="btn-secondary" onclick="closeAssignPostModal()">Cancel</button>
                    </div>
                </div>
            </div>
        `;
    } catch (error) {
        console.error('Error loading manage posts:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üë• Manage Posts</h3>
                <p style="color: #e74c3c;">Error loading users. Please try again.</p>
            </div>
        `;
    }
}

window.filterUsersTable = function() {
    const searchTerm = document.getElementById('userSearch').value.toLowerCase();
    const table = document.getElementById('usersTable');
    const rows = table.getElementsByTagName('tr');

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    }
};

window.showAssignPostModal = function(username, name) {
    document.getElementById('modalUsername').textContent = `Assign Post to ${name} (${username})`;
    document.getElementById('assignPostModal').style.display = 'flex';
    window.currentAssignUser = username;
};

window.closeAssignPostModal = function() {
    document.getElementById('assignPostModal').style.display = 'none';
    document.getElementById('postToAssign').value = '';
    window.currentAssignUser = null;
};

window.assignPost = async function() {
    const username = window.currentAssignUser;
    const post = document.getElementById('postToAssign').value;

    if (!post) {
        showModal('Error', 'Please select a post to assign', 'error');
        return;
    }

    try {
        showLoading();
        const client = window.supabaseClient.getClient();
        const currentUser = window.auth.getCurrentUser();

        // Insert into user_roles table
        const { error } = await client
            .from('user_roles')
            .insert([{
                username: username,
                role: post,
                assigned_by: currentUser.username
            }]);

        if (error) {
            if (error.message.includes('duplicate')) {
                throw new Error('This user already has this post assigned');
            }
            throw error;
        }

        hideLoading();
        showModal('Success', `Post "${formatRole(post)}" assigned successfully!`, 'success');
        closeAssignPostModal();
        renderManagePosts(); // Refresh the table
    } catch (error) {
        hideLoading();
        showModal('Error', error.message || 'Failed to assign post', 'error');
    }
};

async function renderRemoveStudent() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    try {
        const { data: students, error } = await client
            .from('students')
            .select('*')
            .eq('status', 'active')
            .order('name');

        if (error) throw error;

        contentArea.innerHTML = `
            <div class="card">
                <h3>üö´ Remove Student (Mark Inactive)</h3>
                <p style="color: #e74c3c; margin-bottom: 20px;">‚ö†Ô∏è This will mark the student as inactive. Student data will be preserved.</p>

                <table style="width: 100%; margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Name</th>
                            <th>Class</th>
                            <th>Parent ID</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${students && students.length > 0 ? students.map(s => `
                            <tr>
                                <td>${s.id}</td>
                                <td>${s.name}</td>
                                <td>${s.class}</td>
                                <td>${s.parent_id || 'N/A'}</td>
                                <td>
                                    <button class="btn-danger" onclick="removeStudent(${s.id}, '${s.name.replace(/'/g, "\\'")}')">Remove</button>
                                </td>
                            </tr>
                        `).join('') : '<tr><td colspan="5" style="text-align: center;">No active students found</td></tr>'}
                    </tbody>
                </table>
            </div>
        `;
    } catch (error) {
        contentArea.innerHTML = `
            <div class="card">
                <h3>üö´ Remove Student (Mark Inactive)</h3>
                <p style="color: #e74c3c;">Error loading students: ${error.message}</p>
            </div>
        `;
    }
}

window.removeStudent = async function(studentId, studentName) {
    showModal('Confirm Remove', `Are you sure you want to remove ${studentName}? Student will be marked as inactive.`, 'warning', true, async function() {
        try {
            showLoading();
            const { error } = await window.supabaseClient.getClient()
                .from('students')
                .update({ status: 'inactive' })
                .eq('id', studentId);

            if (error) throw error;

            hideLoading();
            showModal('Success', `${studentName} has been removed (marked inactive)`, 'success');
            renderRemoveStudent();
        } catch (error) {
            hideLoading();
            showModal('Error', error.message, 'error');
        }
    });
};

async function renderDeleteStudent() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    try {
        const { data: students, error } = await client
            .from('students')
            .select('*')
            .eq('status', 'removed')
            .order('name');

        if (error) throw error;

        contentArea.innerHTML = `
            <div class="card">
                <h3>‚ùå Delete Student (Permanent)</h3>
                <p style="color: #c0392b; margin-bottom: 20px; font-weight: bold;">‚ö†Ô∏è WARNING: This will PERMANENTLY delete the student. This action CANNOT be undone!</p>
                <p style="margin-bottom: 20px;">Only students marked as "removed" can be permanently deleted.</p>

                ${students && students.length > 0 ? `
                    <table style="width: 100%; margin-top: 20px;">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Class</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${students.map(s => `
                                <tr>
                                    <td>${s.id}</td>
                                    <td>${s.name}</td>
                                    <td>${s.class}</td>
                                    <td><span class="badge badge-${s.status}">${s.status}</span></td>
                                    <td>
                                        <button class="btn-danger" onclick="deleteStudentPermanent(${s.id}, '${s.name.replace(/'/g, "\\'")}')">Delete Permanently</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p>No students marked as "removed". Use "Remove Student" feature first to mark students for deletion.</p>'}
            </div>
        `;
    } catch (error) {
        contentArea.innerHTML = `
            <div class="card">
                <h3>‚ùå Delete Student (Permanent)</h3>
                <p style="color: #e74c3c;">Error loading students: ${error.message}</p>
            </div>
        `;
    }
}

window.deleteStudentPermanent = async function(studentId, studentName) {
    showModal('FINAL WARNING', `You are about to PERMANENTLY DELETE ${studentName}. This CANNOT be undone. Type "DELETE" to confirm.`, 'error', true, async function() {
        try {
            showLoading();
            const { error } = await window.supabaseClient.getClient()
                .from('students')
                .delete()
                .eq('id', studentId);

            if (error) throw error;

            hideLoading();
            showModal('Success', `${studentName} has been permanently deleted`, 'success');
            renderDeleteStudent();
        } catch (error) {
            hideLoading();
            showModal('Error', error.message, 'error');
        }
    });
};

async function renderHolidays() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    const { data: holidays } = await client
        .from('holidays')
        .select('*')
        .order('date', { ascending: true });

    contentArea.innerHTML = `
        <div class="card">
            <h3>üéâ Holidays Management</h3>

            <form id="addHolidayForm" style="max-width: 500px; margin-bottom: 30px;">
                <h4>Add New Holiday</h4>
                <div class="form-group">
                    <label for="holidayDate">Date</label>
                    <input type="date" id="holidayDate" required>
                </div>
                <div class="form-group">
                    <label for="holidayReason">Reason</label>
                    <input type="text" id="holidayReason" placeholder="e.g., Independence Day" required>
                </div>
                <button type="submit" class="btn-primary">Add Holiday</button>
            </form>

            <h4>Upcoming Holidays</h4>
            <table style="width: 100%; margin-top: 15px;">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Reason</th>
                        <th>Day</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    ${holidays.map(h => {
                        const date = new Date(h.date);
                        const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                        return `
                            <tr>
                                <td>${date.toLocaleDateString()}</td>
                                <td>${h.reason}</td>
                                <td>${dayName}</td>
                                <td>
                                    <button class="btn-danger" onclick="deleteHoliday('${h.date}')">Delete</button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;

    document.getElementById('addHolidayForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const date = document.getElementById('holidayDate').value;
        const reason = document.getElementById('holidayReason').value;

        try {
            showLoading();
            const { error } = await client
                .from('holidays')
                .insert([{ date, reason }]);

            if (error) throw error;

            hideLoading();
            showModal('Success', 'Holiday added successfully!', 'success');
            renderHolidays();
        } catch (error) {
            hideLoading();
            showModal('Error', error.message, 'error');
        }
    });
}

window.deleteHoliday = async function(date) {
    showModal('Confirm', 'Delete this holiday?', 'warning', true, async function() {
        try {
            showLoading();
            const { error } = await window.supabaseClient.getClient()
                .from('holidays')
                .delete()
                .eq('date', date);

            if (error) throw error;

            hideLoading();
            showModal('Success', 'Holiday deleted', 'success');
            renderHolidays();
        } catch (error) {
            hideLoading();
            showModal('Error', error.message, 'error');
        }
    });
};

async function renderRegister() {
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = `
        <div class="card">
            <h3>üìù Register New User</h3>
            <p style="color: #666; margin-bottom: 20px;">
                Register students, teachers, or coordinators. Parent accounts are created automatically when registering students.
            </p>

            <div style="margin-bottom: 20px;">
                <label>Select User Type:</label><br>
                <button class="btn-filter active" onclick="showRegisterForm('student')" id="reg-student">Student</button>
                <button class="btn-filter" onclick="showRegisterForm('teacher')" id="reg-teacher">Teacher</button>
                <button class="btn-filter" onclick="showRegisterForm('coordinator')" id="reg-coordinator">Coordinator</button>
            </div>

            <div id="registerFormContainer"></div>
        </div>
    `;

    // Auto-show student form
    showRegisterForm('student');
}

window.showRegisterForm = function(userType) {
    document.querySelectorAll('.btn-filter').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`reg-${userType}`).classList.add('active');

    const container = document.getElementById('registerFormContainer');

    if (userType === 'student') {
        container.innerHTML = `
            <form id="registerForm" style="max-width: 600px;">
                <h4>Register Student</h4>
                <p style="background: #e3f2fd; padding: 12px; border-radius: 5px; font-size: 14px; color: #1976d2;">
                    ‚ÑπÔ∏è Parent account will be auto-created with ID: <strong>P[StudentID]A</strong> and password: <strong>parent123</strong>
                </p>
                <div class="form-group">
                    <label>Student ID *</label>
                    <input type="number" id="studentId" placeholder="e.g., 3180076" required>
                </div>
                <div class="form-group">
                    <label>Student Name *</label>
                    <input type="text" id="studentName" placeholder="Full name" required>
                </div>
                <div class="form-group">
                    <label>Class *</label>
                    <input type="text" id="studentClass" placeholder="e.g., 8B" required>
                </div>
                <div class="form-group">
                    <label>Parent Name *</label>
                    <input type="text" id="parentName" placeholder="Parent's full name" required>
                </div>
                <div class="form-group">
                    <label>Parent Phone</label>
                    <input type="tel" id="parentPhone" placeholder="10-digit number">
                </div>
                <button type="submit" class="btn-primary">Register Student & Parent</button>
            </form>
        `;

        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const studentId = parseInt(document.getElementById('studentId').value);
            const studentName = document.getElementById('studentName').value.trim();
            const studentClass = document.getElementById('studentClass').value.trim();
            const parentName = document.getElementById('parentName').value.trim();
            const parentPhone = document.getElementById('parentPhone').value.trim();

            // Auto-generate parent ID: P[StudentID]A
            const parentId = `P${studentId}A`;
            const defaultPassword = 'parent123';

            // Validation
            if (!studentId || !studentName || !studentClass || !parentName) {
                showModal('Error', 'Please fill in all required fields.', 'error');
                return;
            }

            if (isNaN(studentId)) {
                showModal('Error', 'Student ID must be a valid number.', 'error');
                return;
            }

            try {
                showLoading();
                const client = window.supabaseClient.getClient();

                console.log('Starting student & parent registration for:', studentId);

                // Check if student ID already exists
                console.log('Checking if student ID exists:', studentId);
                const { data: existingStudent, error: checkError } = await client
                    .from('students')
                    .select('id, name')
                    .eq('id', studentId)
                    .maybeSingle();

                if (checkError) {
                    console.error('Error checking student:', checkError);
                    throw new Error(`Error checking student: ${checkError.message}`);
                }

                if (existingStudent) {
                    console.log('Student ID already exists:', studentId);
                    hideLoading();
                    showModal('Error', `Student ID ${studentId} already exists (${existingStudent.name}). Please use a different Student ID.`, 'error');
                    return;
                }

                // Insert student
                console.log('Inserting student record...');
                const { data: studentData, error: insertError } = await client
                    .from('students')
                    .insert([{
                        id: studentId,
                        name: studentName,
                        class: studentClass,
                        parent_id: parentId,
                        status: 'active'
                    }])
                    .select();

                if (insertError) {
                    console.error('Error inserting student:', insertError);
                    throw new Error(`Failed to create student record: ${insertError.message}`);
                }
                console.log('Student record created:', studentData);

                // Auto-enroll in class_members if table exists
                try {
                    console.log('Checking for class_members table...');
                    const { data: classData } = await client
                        .from('classes')
                        .select('id')
                        .eq('name', studentClass)
                        .maybeSingle();

                    if (classData) {
                        console.log('Enrolling student in class_members...');
                        await client
                            .from('class_members')
                            .insert([{
                                class_id: classData.id,
                                student_id: studentId,
                                is_active: true
                            }]);
                        console.log('Student enrolled in class_members');
                    }
                } catch (enrollError) {
                    console.log('class_members enrollment skipped (table may not exist yet)');
                }

                // Insert parent record
                console.log('Creating parent record...');
                const { data: parentData, error: parentError } = await client
                    .from('parents')
                    .insert([{
                        id: parentId,
                        name: parentName,
                        student_id: studentId,
                        phone: parentPhone || null
                    }])
                    .select();

                if (parentError) {
                    console.error('Error creating parent:', parentError);
                    // Don't fail - parent might already exist
                    console.log('Parent creation skipped (may already exist)');
                }

                // Create parent user account
                console.log('Creating parent user account...');
                const { data: userData, error: userError } = await client
                    .from('users')
                    .insert([{
                        username: parentId,
                        password: defaultPassword,
                        name: parentName,
                        role: 'parent'
                    }])
                    .select();

                if (userError) {
                    console.error('Error creating user:', userError);
                    // Don't fail - user might already exist
                    console.log('User creation skipped (may already exist)');
                }

                hideLoading();
                showModal('Success', `‚úÖ Student & Parent registered successfully!\n\nüë®‚Äçüéì Student: ${studentName}\nüÜî Student ID: ${studentId}\nüìö Class: ${studentClass}\n\nüë®‚Äçüë©‚Äçüëß Parent: ${parentName}\nüîë Parent Login: ${parentId}\nüîê Password: ${defaultPassword}\n\nParent can now login!`, 'success');
                document.getElementById('registerForm').reset();
            } catch (error) {
                console.error('Registration failed:', error);
                hideLoading();
                showModal('Error', `Registration failed: ${error.message}`, 'error');
            }
        });
    } else if (userType === 'parent') {
        container.innerHTML = `
            <form id="registerForm" style="max-width: 600px;">
                <h4>Register Parent</h4>
                <div class="form-group">
                    <label>Parent ID</label>
                    <input type="text" id="parentId" placeholder="e.g., P3180076A" required>
                </div>
                <div class="form-group">
                    <label>Parent Name</label>
                    <input type="text" id="parentName" required>
                </div>
                <div class="form-group">
                    <label>Student ID</label>
                    <input type="number" id="studentId" required>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="phone" placeholder="10-digit number">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn-primary">Register Parent</button>
            </form>
        `;

        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const parentId = document.getElementById('parentId').value.trim();
            const parentName = document.getElementById('parentName').value.trim();
            const studentId = parseInt(document.getElementById('studentId').value);
            const phone = document.getElementById('phone').value.trim();
            const password = document.getElementById('password').value;

            // Validation
            if (!parentId || !parentName || !studentId || !password) {
                showModal('Error', 'Please fill in all required fields.', 'error');
                return;
            }

            if (isNaN(studentId)) {
                showModal('Error', 'Student ID must be a valid number.', 'error');
                return;
            }

            try {
                showLoading();
                const client = window.supabaseClient.getClient();

                console.log('Starting parent registration for:', parentId);

                // First, check if the student exists
                console.log('Checking if student exists:', studentId);
                const { data: studentExists, error: studentCheckError } = await client
                    .from('students')
                    .select('id, name, class')
                    .eq('id', studentId)
                    .maybeSingle();

                if (studentCheckError) {
                    console.error('Error checking student:', studentCheckError);
                    throw new Error(`Error checking student: ${studentCheckError.message}`);
                }

                if (!studentExists) {
                    console.log('Student not found:', studentId);
                    hideLoading();
                    showModal('Error', `Student with ID ${studentId} does not exist. Please register the student first.`, 'error');
                    return;
                }
                console.log('Student found:', studentExists);

                // Check if parent ID already exists
                console.log('Checking if parent ID exists:', parentId);
                const { data: existingParent, error: parentCheckError } = await client
                    .from('parents')
                    .select('id')
                    .eq('id', parentId)
                    .maybeSingle();

                if (parentCheckError) {
                    console.error('Error checking parent:', parentCheckError);
                    throw new Error(`Error checking parent: ${parentCheckError.message}`);
                }

                if (existingParent) {
                    console.log('Parent ID already exists:', parentId);
                    hideLoading();
                    showModal('Error', `Parent ID ${parentId} already exists. Please use a different Parent ID.`, 'error');
                    return;
                }

                // Check if username already exists
                console.log('Checking if username exists:', parentId);
                const { data: existingUser, error: userCheckError } = await client
                    .from('users')
                    .select('username')
                    .eq('username', parentId)
                    .maybeSingle();

                if (userCheckError) {
                    console.error('Error checking username:', userCheckError);
                    throw new Error(`Error checking username: ${userCheckError.message}`);
                }

                if (existingUser) {
                    console.log('Username already exists:', parentId);
                    hideLoading();
                    showModal('Error', `Username ${parentId} already exists. Please use a different Parent ID.`, 'error');
                    return;
                }

                // Insert parent
                console.log('Inserting parent record...');
                const { data: parentData, error: parentError } = await client
                    .from('parents')
                    .insert([{
                        id: parentId,
                        name: parentName,
                        student_id: studentId,
                        phone: phone || null
                    }])
                    .select();

                if (parentError) {
                    console.error('Error inserting parent:', parentError);
                    throw new Error(`Failed to create parent record: ${parentError.message}`);
                }
                console.log('Parent record created:', parentData);

                // Create user account
                console.log('Creating user account...');
                const { data: userData, error: userError } = await client
                    .from('users')
                    .insert([{
                        username: parentId,
                        password: password,
                        name: parentName,
                        role: 'parent'
                    }])
                    .select();

                if (userError) {
                    console.error('Error creating user account:', userError);
                    // Try to rollback parent creation
                    await client.from('parents').delete().eq('id', parentId);
                    throw new Error(`Failed to create user account: ${userError.message}`);
                }
                console.log('User account created:', userData);

                hideLoading();
                showModal('Success', `Parent registered successfully!\n\nParent: ${parentName}\nStudent: ${studentExists.name} (${studentExists.class})\nUsername: ${parentId}\nPassword: ${password}\n\nYou can now login with these credentials.`, 'success');
                document.getElementById('registerForm').reset();
            } catch (error) {
                console.error('Registration failed:', error);
                hideLoading();
                showModal('Error', `Registration failed: ${error.message}`, 'error');
            }
        });
    } else if (userType === 'teacher') {
        container.innerHTML = `
            <form id="registerForm" style="max-width: 600px;">
                <h4>Register Teacher</h4>
                <div class="form-group">
                    <label>Teacher ID</label>
                    <input type="text" id="teacherId" placeholder="e.g., T001" required>
                </div>
                <div class="form-group">
                    <label>Teacher Name</label>
                    <input type="text" id="teacherName" required>
                </div>
                <div class="form-group">
                    <label>Subjects</label>
                    <input type="text" id="subjects" placeholder="e.g., Mathematics, Physics" required>
                </div>
                <div class="form-group">
                    <label>Classes</label>
                    <input type="text" id="classes" placeholder="e.g., 8A, 9B, 10C">
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="phone" placeholder="10-digit number">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="teacher@school.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn-primary">Register Teacher</button>
            </form>
        `;

        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const teacherId = document.getElementById('teacherId').value.trim();
            const teacherName = document.getElementById('teacherName').value.trim();
            const subjects = document.getElementById('subjects').value.trim();
            const classes = document.getElementById('classes').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            // Validation
            if (!teacherId || !teacherName || !subjects || !password) {
                showModal('Error', 'Please fill in all required fields.', 'error');
                return;
            }

            try {
                showLoading();
                const client = window.supabaseClient.getClient();

                console.log('Starting teacher registration for:', teacherId);

                // Check if teacher ID already exists
                console.log('Checking if teacher ID exists:', teacherId);
                const { data: existingTeacher, error: teacherCheckError } = await client
                    .from('teachers')
                    .select('id, name')
                    .eq('id', teacherId)
                    .maybeSingle();

                if (teacherCheckError) {
                    console.error('Error checking teacher:', teacherCheckError);
                    throw new Error(`Error checking teacher: ${teacherCheckError.message}`);
                }

                if (existingTeacher) {
                    console.log('Teacher ID already exists:', teacherId);
                    hideLoading();
                    showModal('Error', `Teacher ID ${teacherId} already exists (${existingTeacher.name}). Please use a different Teacher ID.`, 'error');
                    return;
                }

                // Check if username already exists
                console.log('Checking if username exists:', teacherId);
                const { data: existingUser, error: userCheckError } = await client
                    .from('users')
                    .select('username')
                    .eq('username', teacherId)
                    .maybeSingle();

                if (userCheckError) {
                    console.error('Error checking username:', userCheckError);
                    throw new Error(`Error checking username: ${userCheckError.message}`);
                }

                if (existingUser) {
                    console.log('Username already exists:', teacherId);
                    hideLoading();
                    showModal('Error', `Username ${teacherId} already exists. Please use a different Teacher ID.`, 'error');
                    return;
                }

                // Insert teacher
                console.log('Inserting teacher record...');
                const { data: teacherData, error: teacherError } = await client
                    .from('teachers')
                    .insert([{
                        id: teacherId,
                        name: teacherName,
                        subjects: subjects,
                        classes: classes || null,
                        phone: phone || null,
                        email: email || null
                    }])
                    .select();

                if (teacherError) {
                    console.error('Error inserting teacher:', teacherError);
                    throw new Error(`Failed to create teacher record: ${teacherError.message}`);
                }
                console.log('Teacher record created:', teacherData);

                // Create user account
                console.log('Creating user account...');
                const { data: userData, error: userError } = await client
                    .from('users')
                    .insert([{
                        username: teacherId,
                        password: password,
                        name: teacherName,
                        role: 'teacher'
                    }])
                    .select();

                if (userError) {
                    console.error('Error creating user account:', userError);
                    // Try to rollback teacher creation
                    await client.from('teachers').delete().eq('id', teacherId);
                    throw new Error(`Failed to create user account: ${userError.message}`);
                }
                console.log('User account created:', userData);

                hideLoading();
                showModal('Success', `Teacher registered successfully!\n\nTeacher: ${teacherName}\nID: ${teacherId}\nSubjects: ${subjects}\nUsername: ${teacherId}\nPassword: ${password}\n\nYou can now login with these credentials.`, 'success');
                document.getElementById('registerForm').reset();
            } catch (error) {
                console.error('Registration failed:', error);
                hideLoading();
                showModal('Error', `Registration failed: ${error.message}`, 'error');
            }
        });
    }
};

async function renderAnalytics() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    try {
        showLoading();

        console.log('=== FETCHING ANALYTICS DATA ===');

        // Fetch analytics data
        const [studentsResult, teachersResult, classesResult, attendanceResult] = await Promise.all([
            client.from('students').select('*'),
            client.from('teachers').select('*'),
            client.from('classes').select('*'),
            client.from('attendance').select('*')
        ]);

        console.log('Students result:', studentsResult);
        console.log('Students data:', studentsResult.data);
        console.log('Students error:', studentsResult.error);
        console.log('Total students fetched:', studentsResult.data?.length);

        if (studentsResult.error) {
            console.error('ERROR fetching students:', studentsResult.error);
            hideLoading();
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìä School Analytics</h3>
                    <p style="color: red;">Error loading students: ${studentsResult.error.message}</p>
                    <p style="color: orange;">This might be due to Row Level Security (RLS) being enabled. Please disable RLS on the students table or add appropriate policies.</p>
                </div>
            `;
            return;
        }

        if (teachersResult.error) {
            console.error('ERROR fetching teachers:', teachersResult.error);
        }

        if (classesResult.error) {
            console.error('ERROR fetching classes:', classesResult.error);
        }

        const totalStudents = studentsResult.data?.length || 0;
        const activeStudents = studentsResult.data?.filter(s => s.status === 'active').length || 0;
        const totalTeachers = teachersResult.data?.length || 0;
        const totalClasses = classesResult.data?.length || 0;

        console.log('Analytics summary:', { totalStudents, activeStudents, totalTeachers, totalClasses });

        hideLoading();

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìä School Analytics</h3>

            <div class="stats-grid" style="margin-top: 20px;">
                <div class="stat-card">
                    <div class="stat-value">${totalStudents}</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${activeStudents}</div>
                    <div class="stat-label">Active Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalTeachers}</div>
                    <div class="stat-label">Total Teachers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalClasses}</div>
                    <div class="stat-label">Total Classes</div>
                </div>
            </div>

            <div style="margin-top: 40px;">
                <h4>All Students</h4>
                <input type="text" id="studentSearch" class="search-box" placeholder="üîç Search by Student ID, Name, Class, or Parent ID..." onkeyup="filterStudents()">
                <table id="studentsTable" style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Name</th>
                            <th>Class</th>
                            <th>Parent ID</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${studentsResult.data?.sort((a, b) => a.class.localeCompare(b.class) || a.name.localeCompare(b.name)).map(s => `
                            <tr>
                                <td><strong>${s.id}</strong></td>
                                <td>${s.name}</td>
                                <td><span class="badge badge-normal">${s.class}</span></td>
                                <td>${s.parent_id || 'N/A'}</td>
                                <td><span class="badge badge-${s.status}">${s.status}</span></td>
                            </tr>
                        `).join('') || '<tr><td colspan="5">No students found</td></tr>'}
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 40px;">
                <h4>Students by Class Summary</h4>
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Class</th>
                            <th>Total Students</th>
                            <th>Active Students</th>
                            <th>Class Teacher</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${classesResult.data?.map(c => {
                            const classStudents = studentsResult.data?.filter(s => s.class === c.name) || [];
                            const activeInClass = classStudents.filter(s => s.status === 'active').length;
                            return `
                                <tr>
                                    <td><strong>${c.name}</strong></td>
                                    <td>${classStudents.length}</td>
                                    <td>${activeInClass}</td>
                                    <td>${c.class_teacher_id || 'Not Assigned'}</td>
                                </tr>
                            `;
                        }).join('') || '<tr><td colspan="4">No data</td></tr>'}
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 40px;">
                <h4>Teacher Statistics</h4>
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Teacher ID</th>
                            <th>Name</th>
                            <th>Subjects</th>
                            <th>Classes</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${teachersResult.data?.map(t => `
                            <tr>
                                <td>${t.id}</td>
                                <td>${t.name}</td>
                                <td>${t.subjects}</td>
                                <td>${t.classes}</td>
                                <td><span class="badge badge-${t.status}">${t.status}</span></td>
                            </tr>
                        `).join('') || '<tr><td colspan="5">No data</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>
    `;
    } catch (error) {
        console.error('FATAL ERROR in renderAnalytics:', error);
        hideLoading();
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìä School Analytics</h3>
                <p style="color: red;">Error loading analytics: ${error.message}</p>
                <p>Please check the console for details.</p>
            </div>
        `;
    }
}

// Filter students table in analytics
window.filterStudents = function() {
    const searchInput = document.getElementById('studentSearch');
    const filter = searchInput.value.toLowerCase();
    const table = document.getElementById('studentsTable');
    const rows = table.getElementsByTagName('tr');

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        let found = false;

        for (let j = 0; j < cells.length; j++) {
            const cell = cells[j];
            if (cell) {
                const textValue = cell.textContent || cell.innerText;
                if (textValue.toLowerCase().indexOf(filter) > -1) {
                    found = true;
                    break;
                }
            }
        }

        if (found) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
};

// Class Teacher tab functions
async function renderClassDashboard() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        // Get class teacher info
        const { data: classTeacher } = await client
            .from('class_teachers')
            .select('*')
            .eq('id', currentUser.username)
            .maybeSingle();

        if (!classTeacher) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìä Class Dashboard</h3>
                    <p style="color: #e74c3c;">Class teacher information not found.</p>
                </div>
            `;
            return;
        }

        // Get students in the class
        const { data: students } = await client
            .from('students')
            .select('*')
            .eq('class', classTeacher.class)
            .eq('status', 'active');

        // Get recent attendance for this class
        const today = new Date().toISOString().split('T')[0];
        const { data: todayAttendance } = await client
            .from('attendance')
            .select('*')
            .eq('date', today)
            .in('student_id', students?.map(s => s.id) || []);

        const presentCount = todayAttendance?.filter(a => a.type === 'present').length || 0;
        const absentCount = todayAttendance?.filter(a => a.type === 'absent').length || 0;
        const lateCount = todayAttendance?.filter(a => a.type === 'late').length || 0;

        contentArea.innerHTML = `
            <div class="card">
                <h3>üìä Class Dashboard - ${classTeacher.class}</h3>

                <div class="stats-grid" style="margin-top: 30px;">
                    <div class="stat-card">
                        <div class="stat-value">${students?.length || 0}</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card" style="background: #d4edda;">
                        <div class="stat-value">${presentCount}</div>
                        <div class="stat-label">Present Today</div>
                    </div>
                    <div class="stat-card" style="background: #f8d7da;">
                        <div class="stat-value">${absentCount}</div>
                        <div class="stat-label">Absent Today</div>
                    </div>
                    <div class="stat-card" style="background: #fff3cd;">
                        <div class="stat-value">${lateCount}</div>
                        <div class="stat-label">Late Today</div>
                    </div>
                </div>

                <div style="margin-top: 40px;">
                    <h4>Students in ${classTeacher.class}</h4>
                    ${students && students.length > 0 ? `
                        <table style="width: 100%; margin-top: 15px;">
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Parent ID</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${students.map(student => `
                                    <tr>
                                        <td>${student.id}</td>
                                        <td>${student.name}</td>
                                        <td>${student.parent_id || 'N/A'}</td>
                                        <td><span class="badge badge-${student.status}">${student.status}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<p style="margin-top: 15px;">No students in this class.</p>'}
                </div>
            </div>
        `;
    } catch (error) {
        console.error('Error loading class dashboard:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìä Class Dashboard</h3>
                <p style="color: #e74c3c;">Error loading dashboard. Please try again.</p>
            </div>
        `;
    }
}

async function renderCTMarkAttendance() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        // Get class teacher info
        const { data: classTeacher } = await client
            .from('class_teachers')
            .select('*')
            .eq('id', currentUser.username)
            .maybeSingle();

        if (!classTeacher) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>‚úÖ Mark Attendance</h3>
                    <p style="color: #e74c3c;">Class teacher information not found.</p>
                </div>
            `;
            return;
        }

        contentArea.innerHTML = `
            <div class="card">
                <h3>‚úÖ Mark Attendance - ${classTeacher.class}</h3>

                <div style="margin-bottom: 30px;">
                    <div class="form-group">
                        <label for="ctAttendanceDate">Date</label>
                        <input type="date" id="ctAttendanceDate" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="form-group">
                        <label for="ctAttendancePeriod">Period</label>
                        <select id="ctAttendancePeriod">
                            <option value="1">Period 1</option>
                            <option value="2">Period 2</option>
                            <option value="3">Period 3</option>
                            <option value="4">Period 4</option>
                            <option value="5">Period 5</option>
                            <option value="6">Period 6</option>
                            <option value="7">Period 7</option>
                            <option value="8">Period 8</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="loadCTStudentsForAttendance('${classTeacher.class}')">Load Students</button>
                </div>

                <div id="ctAttendanceStudentsList"></div>
            </div>
        `;
    } catch (error) {
        console.error('Error loading attendance page:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>‚úÖ Mark Attendance</h3>
                <p style="color: #e74c3c;">Error loading attendance. Please try again.</p>
            </div>
        `;
    }
}

window.loadCTStudentsForAttendance = async function(className) {
    const date = document.getElementById('ctAttendanceDate').value;
    const period = document.getElementById('ctAttendancePeriod').value;
    const client = window.supabaseClient.getClient();

    // Get students in the class
    const { data: students } = await client
        .from('students')
        .select('*')
        .eq('class', className)
        .eq('status', 'active')
        .order('name');

    if (!students || students.length === 0) {
        document.getElementById('ctAttendanceStudentsList').innerHTML = '<p>No students found in this class.</p>';
        return;
    }

    // Get existing attendance
    const { data: existingAttendance } = await client
        .from('attendance')
        .select('*')
        .eq('date', date)
        .eq('period', period)
        .in('student_id', students.map(s => s.id));

    const attendanceMap = {};
    existingAttendance?.forEach(att => {
        attendanceMap[att.student_id] = att;
    });

    document.getElementById('ctAttendanceStudentsList').innerHTML = `
        <h4>Students in ${className}</h4>
        <form id="ctAttendanceForm">
            <table style="width: 100%; margin-top: 15px;">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Behavior</th>
                    </tr>
                </thead>
                <tbody>
                    ${students.map(student => {
                        const att = attendanceMap[student.id];
                        return `
                            <tr>
                                <td>${student.id}</td>
                                <td>${student.name}</td>
                                <td>
                                    <select class="attendance-status" data-student-id="${student.id}">
                                        <option value="present" ${att?.type === 'present' ? 'selected' : ''}>Present</option>
                                        <option value="absent" ${att?.type === 'absent' ? 'selected' : ''}>Absent</option>
                                        <option value="late" ${att?.type === 'late' ? 'selected' : ''}>Late</option>
                                    </select>
                                </td>
                                <td>
                                    <select class="attendance-behavior" data-student-id="${student.id}">
                                        <option value="excellent" ${att?.behavior === 'excellent' ? 'selected' : ''}>Excellent</option>
                                        <option value="good" ${att?.behavior === 'good' || !att ? 'selected' : ''}>Good</option>
                                        <option value="distracting" ${att?.behavior === 'distracting' ? 'selected' : ''}>Distracting</option>
                                    </select>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
            <div style="margin-top: 20px;">
                <button type="submit" class="btn-primary">Submit Attendance</button>
            </div>
        </form>
    `;

    document.getElementById('ctAttendanceForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await submitAttendance(students, date, period);
    });
};

async function renderReportCards() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        // Get class teacher info
        const { data: classTeacher } = await client
            .from('class_teachers')
            .select('*')
            .eq('id', currentUser.username)
            .maybeSingle();

        if (!classTeacher) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìÑ Report Cards</h3>
                    <p style="color: #e74c3c;">Class teacher information not found.</p>
                </div>
            `;
            return;
        }

        // Get students in the class
        const { data: students } = await client
            .from('students')
            .select('id, name')
            .eq('class', classTeacher.class)
            .eq('status', 'active')
            .order('name');

        contentArea.innerHTML = `
            <div class="card">
                <h3>üìÑ Report Cards - ${classTeacher.class}</h3>

                <h4>Generate Report Card</h4>
                <form id="reportCardForm" style="max-width: 600px; margin-bottom: 40px;">
                    <div class="form-group">
                        <label for="rcStudent">Select Student</label>
                        <select id="rcStudent" required>
                            <option value="">-- Select Student --</option>
                            ${students?.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('') || ''}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rcTerm">Term</label>
                        <select id="rcTerm" required>
                            <option value="Term 1">Term 1</option>
                            <option value="Term 2">Term 2</option>
                            <option value="Term 3">Term 3</option>
                            <option value="Final">Final</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rcYear">Academic Year</label>
                        <input type="text" id="rcYear" placeholder="e.g., 2024-2025" required>
                    </div>
                    <div class="form-group">
                        <label for="rcPercentage">Overall Percentage</label>
                        <input type="number" id="rcPercentage" min="0" max="100" step="0.01" placeholder="e.g., 85.5">
                    </div>
                    <div class="form-group">
                        <label for="rcGrade">Overall Grade</label>
                        <select id="rcGrade">
                            <option value="A+">A+</option>
                            <option value="A">A</option>
                            <option value="B+">B+</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                            <option value="F">F</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rcRemarks">Remarks</label>
                        <textarea id="rcRemarks" rows="3" placeholder="Teacher's comments"></textarea>
                    </div>
                    <button type="submit" class="btn-primary">Generate Report Card</button>
                </form>

                <h4>Recent Report Cards for ${classTeacher.class}</h4>
                <div id="recentReportCards">Loading...</div>
            </div>
        `;

        // Load recent report cards
        const studentIds = students?.map(s => s.id) || [];
        if (studentIds.length > 0) {
            const { data: reportCards } = await client
                .from('report_cards')
                .select('*, students(name)')
                .in('student_id', studentIds)
                .order('created_at', { ascending: false })
                .limit(10);

            const recentDiv = document.getElementById('recentReportCards');
            if (reportCards && reportCards.length > 0) {
                recentDiv.innerHTML = `
                    <table style="width: 100%; margin-top: 15px;">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Term</th>
                                <th>Year</th>
                                <th>Percentage</th>
                                <th>Grade</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportCards.map(rc => `
                                <tr>
                                    <td>${rc.students?.name || 'N/A'}</td>
                                    <td>${rc.term}</td>
                                    <td>${rc.academic_year}</td>
                                    <td>${rc.overall_percentage || 'N/A'}%</td>
                                    <td><span class="badge">${rc.overall_grade || 'N/A'}</span></td>
                                    <td>${new Date(rc.created_at).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                recentDiv.innerHTML = '<p style="margin-top: 15px;">No report cards generated yet.</p>';
            }
        }

        // Form submit handler
        document.getElementById('reportCardForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const reportCardData = {
                student_id: parseInt(document.getElementById('rcStudent').value),
                term: document.getElementById('rcTerm').value,
                academic_year: document.getElementById('rcYear').value,
                overall_percentage: parseFloat(document.getElementById('rcPercentage').value) || null,
                overall_grade: document.getElementById('rcGrade').value,
                remarks: document.getElementById('rcRemarks').value || null
            };

            try {
                showLoading();
                const { error } = await client
                    .from('report_cards')
                    .insert([reportCardData]);

                if (error) throw error;

                hideLoading();
                showModal('Success', 'Report card generated successfully!', 'success');
                renderReportCards(); // Refresh
            } catch (error) {
                hideLoading();
                showModal('Error', error.message || 'Failed to generate report card', 'error');
            }
        });
    } catch (error) {
        console.error('Error loading report cards:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìÑ Report Cards</h3>
                <p style="color: #e74c3c;">Error loading report cards. Please try again.</p>
            </div>
        `;
    }
}

async function renderCTManageTimetable() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        // Get class teacher info
        const { data: classTeacher } = await client
            .from('class_teachers')
            .select('*')
            .eq('id', currentUser.username)
            .maybeSingle();

        if (!classTeacher) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìÖ Upload Timetable</h3>
                    <p style="color: #e74c3c;">Class teacher information not found.</p>
                </div>
            `;
            return;
        }

        const className = classTeacher.class;

        // Get existing timetable
        const { data: timetable } = await client
            .from('timetables')
            .select('*')
            .eq('class', className)
            .maybeSingle();

        contentArea.innerHTML = `
            <div class="card">
                <h3>üìÖ Upload Timetable for ${className}</h3>

                ${timetable && timetable.image_data ? `
                    <div style="margin-top: 20px;">
                        <h5>Current Timetable:</h5>
                        <img src="${timetable.image_data}" alt="Timetable for ${className}"
                             style="max-width: 100%; border: 2px solid #ddd; border-radius: 8px; margin-top: 10px;">
                    </div>
                ` : '<p style="margin-top: 15px; color: #888;">No timetable uploaded yet.</p>'}

                <div style="margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                    <h5>Upload New Timetable Image</h5>
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                        Upload a clear image of your class timetable. Supported formats: JPG, PNG, GIF (Max 5MB)
                    </p>
                    <form id="ctTimetableImageForm">
                        <input type="file" id="ctTimetableImageInput" accept="image/*"
                               style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                        <div id="ctImagePreview" style="margin-top: 15px; display: none;">
                            <h6>Preview:</h6>
                            <img id="ctPreviewImg" style="max-width: 100%; max-height: 400px; border: 2px solid #ddd; border-radius: 8px; margin-top: 10px;">
                        </div>
                        <button type="submit" class="btn-primary" style="margin-top: 15px;">üì§ Upload Timetable</button>
                    </form>
                </div>
            </div>
        `;

        // Add image preview functionality
        const imageInput = document.getElementById('ctTimetableImageInput');
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Check file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    showModal('Error', 'Image size must be less than 5MB', 'error');
                    imageInput.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('ctPreviewImg').src = event.target.result;
                    document.getElementById('ctImagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Add form submit handler
        document.getElementById('ctTimetableImageForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await uploadCTTimetableImage(className, timetable);
        });
    } catch (error) {
        console.error('Error loading timetable upload page:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìÖ Upload Timetable</h3>
                <p style="color: #e74c3c;">Error loading page. Please try again.</p>
            </div>
        `;
    }
}

async function uploadCTTimetableImage(className, existingTimetable) {
    const imageInput = document.getElementById('ctTimetableImageInput');
    const file = imageInput.files[0];

    if (!file) {
        showModal('Error', 'Please select an image to upload', 'error');
        return;
    }

    try {
        showLoading();
        const client = window.supabaseClient.getClient();

        // Convert image to base64
        const reader = new FileReader();
        reader.onload = async function(event) {
            const base64Image = event.target.result;

            if (existingTimetable) {
                // Update existing timetable
                const { error } = await client
                    .from('timetables')
                    .update({ image_data: base64Image })
                    .eq('class', className);

                if (error) throw error;
            } else {
                // Create new timetable
                const { error } = await client
                    .from('timetables')
                    .insert([{
                        class: className,
                        image_data: base64Image,
                        periods: null
                    }]);

                if (error) throw error;
            }

            hideLoading();
            showModal('Success', 'Timetable uploaded successfully!', 'success');
            renderCTManageTimetable(); // Reload to show new image
        };

        reader.onerror = function() {
            hideLoading();
            showModal('Error', 'Failed to read image file', 'error');
        };

        reader.readAsDataURL(file);
    } catch (error) {
        hideLoading();
        showModal('Error', error.message || 'Failed to upload timetable', 'error');
    }
}

// Generic coming soon function
function renderComingSoon(feature) {
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = `
        <div class="card">
            <h3>${feature}</h3>
            <div style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 72px; margin-bottom: 20px;">üöß</div>
                <h4 style="color: var(--color-primary); margin-bottom: 10px;">Coming Soon</h4>
                <p style="color: #666;">This feature is under development and will be available soon.</p>
            </div>
        </div>
    `;
}

// Logout functionality
document.getElementById('logoutBtn').addEventListener('click', function() {
    showConfirm('Confirm Logout', 'Are you sure you want to logout?', function() {
        window.auth.logout();
    }, null, 'Logout', 'Cancel', false);
});

// PROMPT 1 - NEW CODE: All new UI enhancement functions

// ========== COLLAPSIBLE SIDEBAR SECTIONS ==========
window.toggleMenuSection = function(sectionKey) {
    const collapsedSections = JSON.parse(localStorage.getItem('sidebarSections') || '{"main": false, "academic": false, "admin": false, "reports": false}');
    collapsedSections[sectionKey] = !collapsedSections[sectionKey];
    localStorage.setItem('sidebarSections', JSON.stringify(collapsedSections));

    // Toggle UI
    const sectionItems = document.querySelector(`[data-section-items="${sectionKey}"]`);
    const arrow = document.querySelector(`[data-section="${sectionKey}"] .section-arrow`);

    if (sectionItems && arrow) {
        sectionItems.classList.toggle('collapsed');
        arrow.classList.toggle('collapsed');
        arrow.textContent = collapsedSections[sectionKey] ? '‚ñ∂' : '‚ñº';
    }
};

// ========== STICKY BANNER FUNCTIONS ==========
function updateStickyBanner() {
    const currentUser = window.auth.getCurrentUser();
    if (!currentUser) return;

    // Update date and time
    const now = new Date();
    const dateOptions = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
    const timeOptions = { hour: '2-digit', minute: '2-digit' };
    const dateStr = now.toLocaleDateString('en-US', dateOptions);
    const timeStr = now.toLocaleTimeString('en-US', timeOptions);

    const bannerDateTime = document.getElementById('bannerDateTime');
    if (bannerDateTime) {
        if (window.innerWidth < 768) {
            bannerDateTime.textContent = timeStr; // Mobile: show only time
        } else {
            bannerDateTime.textContent = `${dateStr} | ${timeStr}`;
        }
    }

    // Update role badge
    const bannerRole = document.getElementById('bannerRole');
    if (bannerRole) {
        bannerRole.textContent = formatRole(currentUser.role);
        bannerRole.className = 'banner-role-badge role-' + currentUser.role;
    }

    // Update pending tasks count (simulate based on role)
    updatePendingTasksCount();
}

async function updatePendingTasksCount() {
    const currentUser = window.auth.getCurrentUser();
    if (!currentUser) return;

    try {
        const client = window.supabaseClient.getClient();
        let taskCount = 0;

        // Calculate pending tasks based on role
        if (currentUser.role === 'teacher' || currentUser.role === 'classteacher') {
            const { count } = await client.from('duties').select('id', { count: 'exact', head: true })
                .eq('teacher_id', currentUser.username).eq('status', 'pending');
            taskCount = count || 0;
        } else if (['viceprincipal', 'superviceprincipal', 'hassan'].includes(currentUser.role)) {
            const { count } = await client.from('issues').select('id', { count: 'exact', head: true })
                .eq('status', 'pending');
            taskCount = count || 0;
        }

        const bannerTasks = document.getElementById('bannerTasks');
        if (bannerTasks) {
            bannerTasks.textContent = `‚ö° ${taskCount} Pending Task${taskCount !== 1 ? 's' : ''}`;
        }
    } catch (error) {
        console.error('Error updating tasks count:', error);
    }
}

// Update banner every minute
setInterval(updateStickyBanner, 60000);

// ========== DARK MODE TOGGLE ==========
function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
}

function toggleTheme() {
    const currentTheme = document.body.getAttribute('data-theme') || 'light';
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';

    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);
}

function updateThemeIcon(theme) {
    const themeIcon = document.querySelector('.theme-icon');
    if (themeIcon) {
        themeIcon.textContent = theme === 'light' ? '‚òÄÔ∏è' : 'üåô';
    }
}

document.getElementById('themeToggle')?.addEventListener('click', toggleTheme);

// ========== HAMBURGER MENU (MOBILE) ==========
document.getElementById('hamburgerMenu')?.addEventListener('click', function() {
    const sidebar = document.querySelector('.sidebar');
    const backdrop = document.getElementById('sidebarBackdrop');

    sidebar.classList.toggle('mobile-open');
    backdrop.classList.toggle('hidden');
});

document.getElementById('sidebarBackdrop')?.addEventListener('click', function() {
    const sidebar = document.querySelector('.sidebar');
    const backdrop = document.getElementById('sidebarBackdrop');

    sidebar.classList.remove('mobile-open');
    backdrop.classList.add('hidden');
});

// ========== NOTIFICATION DROPDOWN ==========
document.getElementById('notificationBtn')?.addEventListener('click', function(e) {
    e.stopPropagation();
    const dropdown = document.getElementById('notificationDropdown');
    dropdown.classList.toggle('hidden');
});

// Close notification dropdown when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('notificationDropdown');
    const notificationBtn = document.getElementById('notificationBtn');

    if (!dropdown.contains(e.target) && e.target !== notificationBtn) {
        dropdown.classList.add('hidden');
    }
});

// ========== ACTIVITY FEED ==========
async function updateActivityFeed() {
    try {
        const client = window.supabaseClient.getClient();
        const activities = [];

        // Fetch recent attendance marks
        const { data: recentAttendance } = await client
            .from('attendance')
            .select('date, student_id, status, created_at')
            .order('created_at', { ascending: false })
            .limit(5);

        if (recentAttendance) {
            recentAttendance.forEach(att => {
                activities.push({
                    type: 'attendance',
                    icon: 'üü¢',
                    text: `Attendance marked`,
                    subtext: `Student ID: ${att.student_id}`,
                    timestamp: new Date(att.created_at)
                });
            });
        }

        // Fetch recent issues
        const { data: recentIssues } = await client
            .from('issues')
            .select('title, status, created_at')
            .order('created_at', { ascending: false })
            .limit(5);

        if (recentIssues) {
            recentIssues.forEach(issue => {
                activities.push({
                    type: 'issue',
                    icon: issue.status === 'resolved' ? 'üü¢' : 'üî¥',
                    text: issue.status === 'resolved' ? 'Issue resolved' : 'New issue reported',
                    subtext: issue.title.substring(0, 40) + (issue.title.length > 40 ? '...' : ''),
                    timestamp: new Date(issue.created_at)
                });
            });
        }

        // Sort by timestamp and take top 10
        activities.sort((a, b) => b.timestamp - a.timestamp);
        const top10 = activities.slice(0, 10);

        // Render activity feed
        const activityFeedList = document.getElementById('activityFeedList');
        if (activityFeedList && top10.length > 0) {
            activityFeedList.innerHTML = top10.map(activity => `
                <div class="activity-item">
                    <div class="activity-time">${getRelativeTime(activity.timestamp)}</div>
                    <div class="activity-content">
                        <span class="activity-icon">${activity.icon}</span>
                        <span class="activity-text">${activity.text}</span>
                    </div>
                    <div class="activity-subtext">${activity.subtext}</div>
                </div>
            `).join('');
        } else if (activityFeedList && top10.length === 0) {
            activityFeedList.innerHTML = `
                <div class="activity-item">
                    <div class="activity-content" style="color: #999;">No recent activities</div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error updating activity feed:', error);
    }
}

function getRelativeTime(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    return date.toLocaleDateString();
}

// Auto-refresh activity feed every 5 seconds
setInterval(updateActivityFeed, 5000);

// ========== INTERACTIVE CARD DRILL-DOWN FUNCTIONS ==========
window.showStudentsDetail = async function() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    try {
        showLoading();
        const { data: students } = await client
            .from('students')
            .select('*')
            .order('name');

        hideLoading();

        contentArea.innerHTML = `
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üë• All Students</h3>
                    <button class="btn-secondary" onclick="renderTab('home')">‚Üê Back to Dashboard</button>
                </div>

                <div class="form-group" style="max-width: 400px; margin-bottom: 20px;">
                    <label>Filter by Grade</label>
                    <select id="studentGradeFilter" onchange="filterStudentsTable()" style="padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="all">All Grades</option>
                        ${[...new Set(students?.map(s => s.class?.match(/^\d+/)?.[0] || '').filter(Boolean))].sort((a, b) => parseInt(a) - parseInt(b)).map(grade => `
                            <option value="${grade}">Grade ${grade}</option>
                        `).join('')}
                    </select>
                </div>

                <div style="overflow-x: auto;">
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Class</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            ${students?.map(student => `
                                <tr class="student-row" data-class="${student.class}" data-status="${student.status || 'active'}">
                                    <td>${student.id}</td>
                                    <td>${student.name}</td>
                                    <td>${student.class}</td>
                                    <td><span class="badge ${student.status === 'active' ? 'badge-resolved' : 'badge-pending'}">${student.status || 'Active'}</span></td>
                                </tr>
                            `).join('') || '<tr><td colspan="4" style="text-align: center;">No students found</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    } catch (error) {
        hideLoading();
        showModal('Error', 'Failed to load students: ' + error.message, 'error');
    }
};

window.filterStudentsTable = function() {
    const filter = document.getElementById('studentGradeFilter')?.value || 'all';
    const rows = document.querySelectorAll('.student-row');

    rows.forEach(row => {
        const studentClass = row.getAttribute('data-class') || '';
        const grade = studentClass.match(/^\d+/)?.[0] || '';
        if (filter === 'all' || grade === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
};

window.showTeachersDetail = async function() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    try {
        showLoading();
        const { data: teachers } = await client
            .from('teachers')
            .select('*')
            .order('name');

        hideLoading();

        contentArea.innerHTML = `
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üë®‚Äçüè´ All Teachers</h3>
                    <button class="btn-secondary" onclick="renderTab('home')">‚Üê Back to Dashboard</button>
                </div>

                <div class="form-group" style="max-width: 400px; margin-bottom: 20px;">
                    <label>Filter by Subject</label>
                    <select id="teacherSubjectFilter" onchange="filterTeachersTable()" style="padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="all">All Subjects</option>
                        ${[...new Set(teachers?.map(t => t.subject).filter(Boolean))].map(subject =>
                            `<option value="${subject}">${subject}</option>`
                        ).join('')}
                    </select>
                </div>

                <div style="overflow-x: auto;">
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Subject</th>
                                <th>Contact</th>
                            </tr>
                        </thead>
                        <tbody id="teachersTableBody">
                            ${teachers?.map(teacher => `
                                <tr class="teacher-row" data-subject="${teacher.subject || ''}">
                                    <td>${teacher.id}</td>
                                    <td>${teacher.name}</td>
                                    <td>${teacher.subject || 'N/A'}</td>
                                    <td>${teacher.contact || 'N/A'}</td>
                                </tr>
                            `).join('') || '<tr><td colspan="4" style="text-align: center;">No teachers found</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    } catch (error) {
        hideLoading();
        showModal('Error', 'Failed to load teachers: ' + error.message, 'error');
    }
};

window.filterTeachersTable = function() {
    const filter = document.getElementById('teacherSubjectFilter')?.value || 'all';
    const rows = document.querySelectorAll('.teacher-row');

    rows.forEach(row => {
        const subject = row.getAttribute('data-subject') || '';
        if (filter === 'all' || subject === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
};

window.showClassesDetail = async function() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    try {
        showLoading();
        const { data: classes } = await client
            .from('classes')
            .select('*')
            .order('name');

        // Get student count for each class
        const classesWithCount = await Promise.all(
            (classes || []).map(async (cls) => {
                const { count } = await client
                    .from('students')
                    .select('id', { count: 'exact', head: true })
                    .eq('class', cls.name);
                return { ...cls, studentCount: count || 0 };
            })
        );

        hideLoading();

        contentArea.innerHTML = `
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üè´ All Classes</h3>
                    <button class="btn-secondary" onclick="renderTab('home')">‚Üê Back to Dashboard</button>
                </div>

                <div style="overflow-x: auto;">
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Class Name</th>
                                <th>Student Count</th>
                                <th>Class Teacher</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${classesWithCount.map(cls => `
                                <tr>
                                    <td><strong>${cls.name}</strong></td>
                                    <td>${cls.studentCount}</td>
                                    <td>${cls.class_teacher || 'Not assigned'}</td>
                                </tr>
                            `).join('') || '<tr><td colspan="3" style="text-align: center;">No classes found</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    } catch (error) {
        hideLoading();
        showModal('Error', 'Failed to load classes: ' + error.message, 'error');
    }
};

window.showAttendanceDetail = async function() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    try {
        showLoading();

        // Get attendance for the current week
        const today = new Date();
        const lastWeek = new Date(today);
        lastWeek.setDate(today.getDate() - 7);

        const { data: attendance } = await client
            .from('attendance')
            .select('*, students(name, class)')
            .gte('date', lastWeek.toISOString().split('T')[0])
            .order('date', { ascending: false })
            .limit(100);

        // Group by class
        const byClass = {};
        attendance?.forEach(att => {
            const className = att.students?.class || 'Unknown';
            if (!byClass[className]) {
                byClass[className] = { total: 0, present: 0, absent: 0, late: 0 };
            }
            byClass[className].total++;
            if (att.status === 'present') byClass[className].present++;
            if (att.status === 'absent') byClass[className].absent++;
            if (att.status === 'late') byClass[className].late++;
        });

        hideLoading();

        contentArea.innerHTML = `
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üìä Attendance This Week (By Class)</h3>
                    <button class="btn-secondary" onclick="renderTab('home')">‚Üê Back to Dashboard</button>
                </div>

                <div style="overflow-x: auto;">
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th>Total Records</th>
                                <th>Present</th>
                                <th>Absent</th>
                                <th>Late</th>
                                <th>Attendance %</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(byClass).map(([className, stats]) => {
                                const percentage = stats.total > 0 ? ((stats.present + stats.late) / stats.total * 100).toFixed(1) : 0;
                                return `
                                    <tr>
                                        <td><strong>${className}</strong></td>
                                        <td>${stats.total}</td>
                                        <td><span class="badge badge-resolved">${stats.present}</span></td>
                                        <td><span class="badge badge-critical">${stats.absent}</span></td>
                                        <td><span class="badge badge-high">${stats.late}</span></td>
                                        <td><strong>${percentage}%</strong></td>
                                    </tr>
                                `;
                            }).join('') || '<tr><td colspan="6" style="text-align: center;">No attendance records this week</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    } catch (error) {
        hideLoading();
        showModal('Error', 'Failed to load attendance: ' + error.message, 'error');
    }
};

// ========== INITIALIZE ALL NEW FEATURES ==========
function initNewUIFeatures() {
    initTheme();
    updateStickyBanner();
    updateActivityFeed();
    updatePendingTasksCount();
}

// END PROMPT 1 - NEW CODE

// PROMPT 2 - NEW CODE: All data management features

// ========== GLOBAL SEARCH FUNCTIONALITY ==========
let searchDebounceTimer;

document.getElementById('searchToggle')?.addEventListener('click', openGlobalSearch);
document.getElementById('searchCloseBtn')?.addEventListener('click', closeGlobalSearch);
document.getElementById('searchInput')?.addEventListener('input', handleSearchInput);

// Click outside to close
document.getElementById('searchOverlay')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeGlobalSearch();
    }
});

// ESC key to close
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const searchOverlay = document.getElementById('searchOverlay');
        if (searchOverlay && !searchOverlay.classList.contains('hidden')) {
            closeGlobalSearch();
        }
    }
});

function openGlobalSearch() {
    const searchOverlay = document.getElementById('searchOverlay');
    const searchInput = document.getElementById('searchInput');

    searchOverlay.classList.remove('hidden');
    searchInput.focus();
    searchInput.value = '';
    document.getElementById('searchResults').innerHTML = '<div class="search-empty">Type to search across all data...</div>';
}

function closeGlobalSearch() {
    const searchOverlay = document.getElementById('searchOverlay');
    searchOverlay.classList.add('hidden');
}

function handleSearchInput(e) {
    const query = e.target.value.trim();

    clearTimeout(searchDebounceTimer);

    if (query.length < 2) {
        document.getElementById('searchResults').innerHTML = '<div class="search-empty">Type at least 2 characters to search...</div>';
        return;
    }

    // Debounce search
    searchDebounceTimer = setTimeout(() => {
        performGlobalSearch(query);
    }, 300);
}

async function performGlobalSearch(query) {
    const searchResults = document.getElementById('searchResults');
    searchResults.innerHTML = '<div class="search-loading">Searching...</div>';

    try {
        const client = window.supabaseClient.getClient();
        const lowerQuery = query.toLowerCase();

        let results = {
            students: [],
            teachers: [],
            attendance: [],
            marks: [],
            homework: []
        };

        // Search students
        const { data: students } = await client
            .from('students')
            .select('*')
            .limit(100);

        if (students) {
            results.students = students.filter(s =>
                s.name?.toLowerCase().includes(lowerQuery) ||
                s.id?.toLowerCase().includes(lowerQuery) ||
                s.class?.toLowerCase().includes(lowerQuery)
            ).slice(0, 5);
        }

        // Search teachers
        const { data: teachers } = await client
            .from('teachers')
            .select('*')
            .limit(100);

        if (teachers) {
            results.teachers = teachers.filter(t =>
                t.name?.toLowerCase().includes(lowerQuery) ||
                t.subject?.toLowerCase().includes(lowerQuery)
            ).slice(0, 5);
        }

        // Search attendance
        const { data: attendance } = await client
            .from('attendance')
            .select('*, students(name, class)')
            .limit(100);

        if (attendance) {
            results.attendance = attendance.filter(a =>
                a.students?.name?.toLowerCase().includes(lowerQuery) ||
                a.students?.class?.toLowerCase().includes(lowerQuery)
            ).slice(0, 5);
        }

        // Display results
        displaySearchResults(results, query);

    } catch (error) {
        console.error('Search error:', error);
        searchResults.innerHTML = '<div class="search-error">Error searching. Please try again.</div>';
    }
}

function displaySearchResults(results, query) {
    const searchResults = document.getElementById('searchResults');
    const totalResults = results.students.length + results.teachers.length + results.attendance.length + results.marks.length + results.homework.length;

    if (totalResults === 0) {
        searchResults.innerHTML = `<div class="search-empty">No results found for "${query}"</div>`;
        return;
    }

    let html = `<div class="search-results-header">üîç Search Results: "${query}"</div>`;

    // Students
    if (results.students.length > 0) {
        html += `
            <div class="search-category">
                <div class="search-category-title">STUDENTS (${results.students.length} results)</div>
                ${results.students.map(s => `
                    <div class="search-result-item" onclick="navigateToStudent('${s.id}')">
                        <div class="search-result-icon">üë•</div>
                        <div class="search-result-content">
                            <div class="search-result-title">${s.name}</div>
                            <div class="search-result-subtitle">${s.id}, Class ${s.class}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // Teachers
    if (results.teachers.length > 0) {
        html += `
            <div class="search-category">
                <div class="search-category-title">TEACHERS (${results.teachers.length} results)</div>
                ${results.teachers.map(t => `
                    <div class="search-result-item" onclick="navigateToTeacher('${t.id}')">
                        <div class="search-result-icon">üë®‚Äçüè´</div>
                        <div class="search-result-content">
                            <div class="search-result-title">${t.name}</div>
                            <div class="search-result-subtitle">${t.subject || 'N/A'}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // Attendance
    if (results.attendance.length > 0) {
        html += `
            <div class="search-category">
                <div class="search-category-title">ATTENDANCE (${results.attendance.length} results)</div>
                ${results.attendance.map(a => `
                    <div class="search-result-item">
                        <div class="search-result-icon">üìä</div>
                        <div class="search-result-content">
                            <div class="search-result-title">${a.students?.name || 'Unknown'}</div>
                            <div class="search-result-subtitle">${a.date}: ${a.status}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    searchResults.innerHTML = html;
}

function navigateToStudent(studentId) {
    closeGlobalSearch();
    // Navigate to students page and highlight
    showModal('Info', 'Navigating to student: ' + studentId, 'info');
}

function navigateToTeacher(teacherId) {
    closeGlobalSearch();
    // Navigate to teachers page and highlight
    showModal('Info', 'Navigating to teacher: ' + teacherId, 'info');
}

// ========== TABLE UTILITIES ==========
let currentTableData = [];
let currentSortColumn = null;
let currentSortDirection = null;
let secondarySortColumn = null;
let secondarySortDirection = null;

// Make table headers sortable
window.makeTableSortable = function(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;

    const headers = table.querySelectorAll('thead th');
    headers.forEach((header, index) => {
        if (!header.classList.contains('no-sort')) {
            header.style.cursor = 'pointer';
            header.style.userSelect = 'none';
            header.setAttribute('data-column', index);

            header.addEventListener('click', function(e) {
                sortTable(tableId, index, e.shiftKey);
            });
        }
    });
};

function sortTable(tableId, columnIndex, isShiftKey) {
    const table = document.getElementById(tableId);
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    // Determine sort direction
    let direction = 'asc';
    if (currentSortColumn === columnIndex) {
        if (currentSortDirection === 'asc') {
            direction = 'desc';
        } else if (currentSortDirection === 'desc') {
            direction = null; // Remove sort
        }
    }

    if (!isShiftKey) {
        // Single column sort
        currentSortColumn = columnIndex;
        currentSortDirection = direction;
        secondarySortColumn = null;
        secondarySortDirection = null;
    } else {
        // Multi-column sort
        secondarySortColumn = columnIndex;
        secondarySortDirection = direction;
    }

    // Clear all sort indicators
    table.querySelectorAll('thead th').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc', 'sort-none');
    });

    if (direction === null) {
        // Reset to original order
        currentSortColumn = null;
        currentSortDirection = null;
        // Restore original order (you'd need to store this)
        return;
    }

    // Sort rows
    rows.sort((a, b) => {
        const aValue = a.cells[columnIndex]?.textContent.trim();
        const bValue = b.cells[columnIndex]?.textContent.trim();

        const comparison = compareValues(aValue, bValue);
        return direction === 'asc' ? comparison : -comparison;
    });

    // Update table
    rows.forEach(row => tbody.appendChild(row));

    // Update sort indicator
    const header = table.querySelectorAll('thead th')[columnIndex];
    header.classList.add(`sort-${direction}`);

    // Add arrow indicator
    updateSortArrows(table, columnIndex, direction);
}

function compareValues(a, b) {
    // Try to parse as numbers
    const aNum = parseFloat(a);
    const bNum = parseFloat(b);

    if (!isNaN(aNum) && !isNaN(bNum)) {
        return aNum - bNum;
    }

    // String comparison
    return a.localeCompare(b);
}

function updateSortArrows(table, columnIndex, direction) {
    const headers = table.querySelectorAll('thead th');
    headers.forEach((th, index) => {
        const existingArrow = th.querySelector('.sort-arrow');
        if (existingArrow) {
            existingArrow.remove();
        }

        if (index === columnIndex) {
            const arrow = document.createElement('span');
            arrow.className = 'sort-arrow';
            arrow.textContent = direction === 'asc' ? ' ‚Üë' : ' ‚Üì';
            th.appendChild(arrow);
        }
    });
}

// ========== DATA EXPORT FUNCTIONALITY ==========
window.exportTableData = function(tableId, format, filename) {
    const table = document.getElementById(tableId);
    if (!table) {
        showModal('Error', 'Table not found', 'error');
        return;
    }

    const data = extractTableData(table);

    switch(format) {
        case 'csv':
            exportToCSV(data, filename);
            break;
        case 'json':
            exportToJSON(data, filename);
            break;
        case 'pdf':
            exportToPDF(table, filename);
            break;
    }
};

function extractTableData(table) {
    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
    const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr =>
        Array.from(tr.cells).map(td => td.textContent.trim())
    );

    return { headers, rows };
}

function exportToCSV(data, filename) {
    const csv = [
        data.headers.join(','),
        ...data.rows.map(row => row.map(cell => `"${cell}"`).join(','))
    ].join('\n');

    downloadFile(csv, `${filename}_${getToday()}.csv`, 'text/csv');
    showToast('‚úì Downloaded as ' + filename + '.csv', 'success');
}

function exportToJSON(data, filename) {
    const jsonData = data.rows.map(row => {
        const obj = {};
        data.headers.forEach((header, index) => {
            obj[header] = row[index];
        });
        return obj;
    });

    const json = JSON.stringify(jsonData, null, 2);
    downloadFile(json, `${filename}_${getToday()}.json`, 'application/json');
    showToast('‚úì Downloaded as ' + filename + '.json', 'success');
}

function exportToPDF(table, filename) {
    // Create print-friendly version
    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write(`
        <html>
        <head>
            <title>${filename}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { text-align: center; margin-bottom: 10px; }
                .date { text-align: center; color: #666; margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f5f5f5; font-weight: bold; }
                @media print {
                    button { display: none; }
                }
            </style>
        </head>
        <body>
            <h1>Delhi Public School, Nadergul</h1>
            <div class="date">${filename} - ${new Date().toLocaleDateString()}</div>
            ${table.outerHTML}
            <br>
            <button onclick="window.print()">Print / Save as PDF</button>
        </body>
        </html>
    `);
    printWindow.document.close();
    showToast('‚úì Opening print dialog...', 'success');
}

function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.click();
    URL.revokeObjectURL(url);
}

function getToday() {
    const today = new Date();
    return today.toISOString().split('T')[0];
}

// ========== BULK OPERATIONS ==========
let selectedRows = new Set();

window.toggleRowSelection = function(checkbox, rowId) {
    if (checkbox.checked) {
        selectedRows.add(rowId);
    } else {
        selectedRows.delete(rowId);
    }
    updateBulkActionBar();
};

window.toggleSelectAll = function(checkbox, tableId) {
    const table = document.getElementById(tableId);
    const rowCheckboxes = table.querySelectorAll('tbody input[type="checkbox"]');

    rowCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        const rowId = cb.getAttribute('data-row-id');
        if (checkbox.checked) {
            selectedRows.add(rowId);
        } else {
            selectedRows.delete(rowId);
        }
    });

    updateBulkActionBar();
};

function updateBulkActionBar() {
    const actionBar = document.getElementById('bulkActionBar');
    if (!actionBar) return;

    if (selectedRows.size > 0) {
        actionBar.classList.remove('hidden');
        document.getElementById('selectedCount').textContent = selectedRows.size;
    } else {
        actionBar.classList.add('hidden');
    }
}

window.clearSelection = function() {
    selectedRows.clear();
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    updateBulkActionBar();
};

window.bulkDeactivate = function() {
    if (selectedRows.size === 0) return;

    showConfirm(
        'Confirm Deactivate',
        `Are you sure you want to deactivate ${selectedRows.size} selected item(s)?`,
        async function() {
            try {
                showLoading();
                // Perform bulk deactivate
                // Implementation depends on your data structure
                hideLoading();
                showToast(`‚úì ${selectedRows.size} items deactivated successfully`, 'success');
                clearSelection();
            } catch (error) {
                hideLoading();
                showModal('Error', error.message, 'error');
            }
        }
    );
};

// ========== FORM VALIDATION ==========
const validationRules = {
    required: (value) => value.trim().length > 0 ? null : 'This field is required',
    email: (value) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value) ? null : 'Please enter valid email',
    marks: (value) => {
        const num = parseFloat(value);
        return (num >= 0 && num <= 100) ? null : 'Marks must be 0-100';
    },
    date: (value) => /^\d{4}-\d{2}-\d{2}$/.test(value) ? null : 'Use format: YYYY-MM-DD',
    phone: (value) => /^\d{10}$/.test(value) ? null : 'Phone must be 10 digits',
    password: (value) => value.length >= 8 ? null : 'Password must be at least 8 characters'
};

window.setupFormValidation = function(formId) {
    const form = document.getElementById(formId);
    if (!form) return;

    const inputs = form.querySelectorAll('input, select, textarea');

    inputs.forEach(input => {
        const rules = input.getAttribute('data-validate')?.split(',') || [];

        input.addEventListener('blur', () => validateField(input, rules));
        input.addEventListener('input', () => {
            if (input.classList.contains('error')) {
                validateField(input, rules);
            }
        });
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        let hasErrors = false;

        inputs.forEach(input => {
            const rules = input.getAttribute('data-validate')?.split(',') || [];
            const error = validateField(input, rules);
            if (error) hasErrors = true;
        });

        if (!hasErrors) {
            // Form is valid, submit
            form.submit();
        } else {
            showModal('Error', '‚ö† Please fix errors below', 'error');
        }
    });
};

function validateField(input, rules) {
    const value = input.value;
    const errorDiv = input.parentElement.querySelector('.field-error');

    for (const rule of rules) {
        const validator = validationRules[rule.trim()];
        if (validator) {
            const error = validator(value);
            if (error) {
                showFieldError(input, error);
                return error;
            }
        }
    }

    clearFieldError(input);
    return null;
}

function showFieldError(input, message) {
    input.classList.add('error');

    let errorDiv = input.parentElement.querySelector('.field-error');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.className = 'field-error';
        input.parentElement.appendChild(errorDiv);
    }
    errorDiv.textContent = message;
}

function clearFieldError(input) {
    input.classList.remove('error');
    const errorDiv = input.parentElement.querySelector('.field-error');
    if (errorDiv) {
        errorDiv.remove();
    }
}

window.showToast = function(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.classList.add('show');
    }, 100);

    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
};

// ========== BULK UPLOAD FEATURE ==========
let uploadedFile = null;
let parsedData = [];
let validationResults = [];

function renderBulkUpload() {
    const contentArea = document.getElementById('contentArea');

    contentArea.innerHTML = `
        <div class="card">
            <h3>üì§ BULK UPLOAD STUDENTS - GRADE 6</h3>
            <p style="color: #666; margin-bottom: 30px;">Import multiple Grade 6 students from Excel or CSV files</p>

            <!-- Step 1: Download Template -->
            <div class="upload-step">
                <h4>Step 1: Download Template</h4>
                <p style="color: #666; margin-bottom: 15px;">Download the Excel template with required column format</p>
                <div class="btn-group">
                    <button class="btn-primary" onclick="downloadExcelTemplate()">üì• Download Excel Template</button>
                    <button class="btn-secondary" onclick="showTemplateSample()">üìã View Sample</button>
                </div>
            </div>

            <!-- Step 2: Upload File -->
            <div class="upload-step">
                <h4>Step 2: Upload Your File</h4>
                <div class="upload-dropzone" id="uploadDropzone">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Drag & drop Excel/CSV file here</div>
                    <div class="upload-or">OR</div>
                    <button class="btn-secondary" onclick="document.getElementById('fileInput').click()">Browse Files</button>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileSelect(event)">
                    <div class="upload-info">Supported: .xlsx, .xls, .csv | Max size: 5MB</div>
                </div>
                <div id="fileSelectedInfo" class="file-selected-info hidden"></div>
            </div>

            <!-- Step 3: Preview & Validate -->
            <div class="upload-step hidden" id="previewStep">
                <h4>Step 3: Preview & Validate</h4>
                <div id="previewContent"></div>
            </div>

            <!-- Step 4: Confirm & Upload -->
            <div class="upload-step hidden" id="confirmStep">
                <h4>Step 4: Confirm & Upload</h4>
                <div class="btn-group">
                    <button class="btn-secondary" onclick="renderBulkUpload()">Cancel</button>
                    <button class="btn-primary" id="confirmUploadBtn" onclick="confirmBulkUpload()" disabled>Upload Students</button>
                </div>
            </div>
        </div>

        <!-- Upload History -->
        <div class="card">
            <h3>üìú Upload History</h3>
            <div id="uploadHistory">
                ${renderUploadHistory()}
            </div>
        </div>
    `;

    // Setup drag and drop
    setupDragAndDrop();
}

function setupDragAndDrop() {
    const dropzone = document.getElementById('uploadDropzone');
    if (!dropzone) return;

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropzone.addEventListener(eventName, () => {
            dropzone.classList.add('drag-over');
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, () => {
            dropzone.classList.remove('drag-over');
        }, false);
    });

    dropzone.addEventListener('drop', handleDrop, false);
}

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;

    if (files.length > 0) {
        handleFile(files[0]);
    }
}

function handleFileSelect(e) {
    const files = e.target.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
}

function handleFile(file) {
    // Check file size (5MB max)
    if (file.size > 5 * 1024 * 1024) {
        showModal('Error', 'File size exceeds 5MB limit', 'error');
        return;
    }

    // Check file type
    const validTypes = ['.xlsx', '.xls', '.csv'];
    const fileExt = '.' + file.name.split('.').pop().toLowerCase();
    if (!validTypes.includes(fileExt)) {
        showModal('Error', 'Invalid file type. Please upload .xlsx, .xls, or .csv file', 'error');
        return;
    }

    uploadedFile = file;

    // Show file selected info
    const fileInfo = document.getElementById('fileSelectedInfo');
    fileInfo.innerHTML = `‚úì Selected: <strong>${file.name}</strong> (${(file.size / 1024).toFixed(2)} KB)`;
    fileInfo.classList.remove('hidden');

    // Parse file
    parseUploadedFile(file);
}

function parseUploadedFile(file) {
    showLoading();

    const reader = new FileReader();

    reader.onload = function(e) {
        try {
            const data = e.target.result;

            if (file.name.endsWith('.csv')) {
                parsedData = parseCSV(data);
            } else {
                // For Excel files, we'd need a library like xlsx.js
                // For now, show message to use CSV
                hideLoading();
                showModal('Info', 'For Excel files, please convert to CSV format first, or use the CSV template', 'info');
                return;
            }

            // Validate parsed data
            validateParsedData();

            hideLoading();
            showPreview();

        } catch (error) {
            hideLoading();
            showModal('Error', 'Failed to parse file: ' + error.message, 'error');
        }
    };

    if (file.name.endsWith('.csv')) {
        reader.readAsText(file);
    } else {
        reader.readAsBinaryString(file);
    }
}

function parseCSV(csvText) {
    const lines = csvText.split('\n').filter(line => line.trim());
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));

    const data = [];
    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        const row = {};
        headers.forEach((header, index) => {
            row[header] = values[index] || '';
        });
        data.push(row);
    }

    return data;
}

function validateParsedData() {
    validationResults = [];

    parsedData.forEach((row, index) => {
        const errors = [];
        const warnings = [];

        // Required fields
        if (!row['Student Name'] || row['Student Name'].trim() === '') {
            errors.push('Student name is required');
        }

        if (!row['Gender'] || !['M', 'F', 'Other'].includes(row['Gender'])) {
            errors.push('Gender must be M, F, or Other');
        }

        if (!row['Class']) {
            errors.push('Class is required');
        }

        // Date of Birth validation
        if (row['Date of Birth'] && !/^\d{4}-\d{2}-\d{2}$/.test(row['Date of Birth'])) {
            errors.push('Date format must be YYYY-MM-DD');
        }

        // Age check
        if (row['Date of Birth']) {
            const age = calculateAge(row['Date of Birth']);
            if (age < 6 || age > 25) {
                warnings.push(`Age ${age} seems unusual`);
            }
        }

        // Phone validation
        if (row['Contact Number'] && !/^\d{10}$/.test(row['Contact Number'])) {
            errors.push('Phone must be 10 digits');
        }

        // Email validation
        if (row['Email'] && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(row['Email'])) {
            errors.push('Invalid email format');
        }

        // Check for duplicate ID
        if (row['Registration ID']) {
            // Check in system (simplified - in real app, query database)
            const isDuplicate = false; // Would check against existing students
            if (isDuplicate) {
                errors.push('Registration ID already exists');
            }
        }

        validationResults.push({
            row: index + 1,
            data: row,
            errors,
            warnings,
            status: errors.length > 0 ? 'error' : warnings.length > 0 ? 'warning' : 'valid'
        });
    });
}

function calculateAge(dob) {
    const today = new Date();
    const birthDate = new Date(dob);
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    return age;
}

function showPreview() {
    const previewStep = document.getElementById('previewStep');
    const previewContent = document.getElementById('previewContent');
    const confirmStep = document.getElementById('confirmStep');

    previewStep.classList.remove('hidden');
    confirmStep.classList.remove('hidden');

    const validCount = validationResults.filter(r => r.status === 'valid').length;
    const errorCount = validationResults.filter(r => r.status === 'error').length;
    const warningCount = validationResults.filter(r => r.status === 'warning').length;

    let html = `
        <div class="preview-summary">
            <div class="preview-stat">
                <span class="preview-stat-value">${parsedData.length}</span>
                <span class="preview-stat-label">Total Rows</span>
            </div>
            <div class="preview-stat valid">
                <span class="preview-stat-value">${validCount} ‚úì</span>
                <span class="preview-stat-label">Valid</span>
            </div>
            ${errorCount > 0 ? `
            <div class="preview-stat error">
                <span class="preview-stat-value">${errorCount} ‚ùå</span>
                <span class="preview-stat-label">Errors</span>
            </div>
            ` : ''}
            ${warningCount > 0 ? `
            <div class="preview-stat warning">
                <span class="preview-stat-value">${warningCount} ‚ö†</span>
                <span class="preview-stat-label">Warnings</span>
            </div>
            ` : ''}
        </div>

        <div style="overflow-x: auto; max-height: 400px; overflow-y: auto; margin-top: 20px;">
            <table style="width: 100%;">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Student Name</th>
                        <th>ID</th>
                        <th>Class</th>
                        <th>Gender</th>
                        <th>Issues</th>
                    </tr>
                </thead>
                <tbody>
                    ${validationResults.map(result => `
                        <tr class="preview-row preview-row-${result.status}">
                            <td>
                                ${result.status === 'valid' ? '‚úì' : result.status === 'warning' ? '‚ö†' : '‚ùå'}
                            </td>
                            <td>${result.data['Student Name']}</td>
                            <td>${result.data['Registration ID'] || 'Auto-generated'}</td>
                            <td>${result.data['Class']}</td>
                            <td>${result.data['Gender']}</td>
                            <td>
                                ${result.errors.length > 0 ? `<span class="error-text">${result.errors.join(', ')}</span>` : ''}
                                ${result.warnings.length > 0 ? `<span class="warning-text">${result.warnings.join(', ')}</span>` : ''}
                                ${result.status === 'valid' ? '<span class="success-text">OK</span>' : ''}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

    previewContent.innerHTML = html;

    // Enable/disable upload button
    const uploadBtn = document.getElementById('confirmUploadBtn');
    if (errorCount === 0) {
        uploadBtn.disabled = false;
    } else {
        uploadBtn.disabled = true;
        showToast('Fix errors before uploading', 'error');
    }
}

function confirmBulkUpload() {
    const validStudents = validationResults.filter(r => r.status !== 'error');

    showConfirm(
        '‚ö†Ô∏è CONFIRM BULK UPLOAD',
        `
        You are about to upload ${validStudents.length} new students to Grade 6.

        <div style="margin: 20px 0; text-align: left;">
            <strong>Details:</strong><br>
            ‚Ä¢ ${validStudents.length} new student records<br>
            ‚Ä¢ Auto-generate missing IDs<br>
            ‚Ä¢ Default status: Active<br>
            <br>
            <strong>IMPACT:</strong><br>
            ‚úì Duplicate students will be skipped (not overwritten)<br>
            ‚úì Existing students will NOT be changed<br>
            ‚úì New records will be created<br>
        </div>

        Are you sure you want to proceed?
        `,
        function() {
            performBulkUpload(validStudents);
        },
        null,
        'I understand, Upload Now',
        'Cancel'
    );
}

async function performBulkUpload(validStudents) {
    showLoading();

    try {
        const client = window.supabaseClient.getClient();
        let successCount = 0;
        let skipCount = 0;

        for (let i = 0; i < validStudents.length; i++) {
            const student = validStudents[i].data;

            // Generate ID if not provided
            if (!student['Registration ID']) {
                student['Registration ID'] = `STU006${String(i + 1).padStart(3, '0')}`;
            }

            // Check if student exists
            const { data: existing } = await client
                .from('students')
                .select('id')
                .eq('id', student['Registration ID'])
                .maybeSingle();

            if (existing) {
                skipCount++;
                continue;
            }

            // Insert student
            const { error } = await client
                .from('students')
                .insert([{
                    id: student['Registration ID'],
                    name: student['Student Name'],
                    dob: student['Date of Birth'] || null,
                    gender: student['Gender'],
                    class: student['Class'],
                    guardian_name: student['Guardian Name'] || null,
                    contact: student['Contact Number'] || null,
                    email: student['Email'] || null,
                    address: student['Address'] || null,
                    status: 'active',
                    imported_date: new Date().toISOString()
                }]);

            if (!error) {
                successCount++;
            }
        }

        // Save upload history
        const uploadHistory = JSON.parse(localStorage.getItem('uploadHistory') || '[]');
        uploadHistory.unshift({
            date: new Date().toISOString(),
            filename: uploadedFile.name,
            total: validStudents.length,
            success: successCount,
            skipped: skipCount
        });
        localStorage.setItem('uploadHistory', JSON.stringify(uploadHistory.slice(0, 10))); // Keep last 10

        hideLoading();

        showModal(
            '‚úì UPLOAD SUCCESSFUL!',
            `
            <div style="text-align: left;">
                <h4>${successCount} students added to Grade 6</h4>
                <br>
                <strong>Summary:</strong><br>
                ‚Ä¢ Created: ${successCount} new students<br>
                ‚Ä¢ Skipped: ${skipCount} duplicates<br>
                ‚Ä¢ File: ${uploadedFile.name}<br>
                <br>
                Next: Go to Student Management to view/edit
            </div>
            `,
            'success'
        );

        // Refresh the page
        setTimeout(() => {
            renderBulkUpload();
        }, 3000);

    } catch (error) {
        hideLoading();
        showModal('Error', 'Upload failed: ' + error.message, 'error');
    }
}

window.downloadExcelTemplate = function() {
    const csvContent = `Student Name,Registration ID,Date of Birth,Gender,Guardian Name,Contact Number,Email,Address,Class,Section
Rahul Kumar,STU006001,2012-03-15,M,Rajesh Kumar,9876543210,rahul@email.com,123 Main St,6A,A
Priya Singh,,2012-05-20,F,Amit Singh,9876543211,priya@email.com,456 Park Ave,6A,A
(Add your students here - delete example rows)`;

    downloadFile(csvContent, 'Student_Upload_Template_Grade6.csv', 'text/csv');
    showToast('‚úì Template downloaded', 'success');
};

window.showTemplateSample = function() {
    showModal(
        'üìã Template Format',
        `
        <div style="text-align: left; font-family: monospace; font-size: 12px;">
            <strong>Required Columns:</strong><br>
            1. Student Name (Required)<br>
            2. Registration ID (Optional - auto-generated if blank)<br>
            3. Date of Birth (Format: YYYY-MM-DD)<br>
            4. Gender (M/F/Other)<br>
            5. Guardian Name<br>
            6. Contact Number (10 digits)<br>
            7. Email<br>
            8. Address<br>
            9. Class (6A, 6B, etc.)<br>
            10. Section (A/B/C)<br>
            <br>
            <strong>Example Row:</strong><br>
            Rahul Kumar, STU006001, 2012-03-15, M, Rajesh Kumar, 9876543210, rahul@email.com, 123 Main St, 6A, A
        </div>
        `,
        'info'
    );
};

function renderUploadHistory() {
    const history = JSON.parse(localStorage.getItem('uploadHistory') || '[]');

    if (history.length === 0) {
        return '<p style="color: #999; text-align: center; padding: 20px;">No upload history yet</p>';
    }

    return `
        <table style="width: 100%;">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Filename</th>
                    <th>Total</th>
                    <th>Success</th>
                    <th>Skipped</th>
                </tr>
            </thead>
            <tbody>
                ${history.map(h => `
                    <tr>
                        <td>${new Date(h.date).toLocaleString()}</td>
                        <td>${h.filename}</td>
                        <td>${h.total}</td>
                        <td><span class="badge badge-resolved">${h.success}</span></td>
                        <td><span class="badge badge-pending">${h.skipped}</span></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// END PROMPT 2 - NEW CODE

// PROMPT 3 - NEW CODE: Notification System & Analytics Dashboards

// ========== NOTIFICATION SYSTEM ==========
let notifications = [];
let notificationIdCounter = 1;

function initNotificationSystem() {
    // Load notifications from localStorage
    const saved = localStorage.getItem('campuscore_notifications');
    if (saved) {
        notifications = JSON.parse(saved);
    }

    // Update UI
    updateNotificationUI();

    // Start simulating real-time notifications (every 45-60 seconds)
    setInterval(simulateNewNotification, 50000);

    // Setup close button
    document.getElementById('notificationCloseBtn')?.addEventListener('click', () => {
        document.getElementById('notificationDropdown').classList.add('hidden');
    });
}

function simulateNewNotification() {
    const currentUser = window.auth.getCurrentUser();
    if (!currentUser) return;

    const notificationTypes = {
        teacher: [
            { icon: '‚úì', color: 'green', title: 'Marks submitted for approval', subtitle: 'Mathematics - Class 10A' },
            { icon: '‚ö†', color: 'orange', title: 'New duty assigned: Science Fair', subtitle: 'Organize exhibits and judges' },
            { icon: 'üìù', color: 'blue', title: 'New homework added to your class', subtitle: 'Class 10A - Math homework' },
            { icon: 'üí¨', color: 'red', title: 'Student issue reported', subtitle: 'Behavioral concern in Class 10B' }
        ],
        coordinator: [
            { icon: '‚è≥', color: 'orange', title: 'Pending marks waiting approval', subtitle: '5 submissions need review' },
            { icon: '‚ùó', color: 'red', title: 'New issue reported', subtitle: 'Academic performance concern' },
            { icon: '‚úì', color: 'green', title: 'Report card ready to send', subtitle: 'Class 10A Midterm completed' }
        ],
        viceprincipal: [
            { icon: '‚ûï', color: 'green', title: 'New student registered', subtitle: 'Rahul Kumar - Class 6A' },
            { icon: '‚ùó', color: 'red', title: 'Issue reported in class', subtitle: 'Attendance concern - Class 9A' },
            { icon: '‚úì', color: 'blue', title: 'Duty marked complete', subtitle: 'Science Fair setup completed' },
            { icon: 'üìä', color: 'blue', title: 'Analytics updated', subtitle: 'Monthly performance report ready' },
            { icon: 'üì§', color: 'green', title: 'Bulk upload completed', subtitle: '23 students added to Grade 6' }
        ],
        parent: [
            { icon: '‚úì', color: 'green', title: 'Marks published for Math', subtitle: 'Rahul Kumar - 92/100' },
            { icon: 'üìù', color: 'blue', title: 'Homework assigned', subtitle: 'Complete exercises 1-10' },
            { icon: 'üìÑ', color: 'green', title: 'Report card ready to download', subtitle: 'Midterm results available' },
            { icon: 'üìç', color: 'blue', title: 'Attendance updated', subtitle: 'Present today' }
        ]
    };

    const userNotifs = notificationTypes[currentUser.role] || notificationTypes.viceprincipal;
    const randomNotif = userNotifs[Math.floor(Math.random() * userNotifs.length)];

    addNotification(randomNotif.icon, randomNotif.color, randomNotif.title, randomNotif.subtitle);
}

function addNotification(icon, color, title, subtitle) {
    const notification = {
        id: notificationIdCounter++,
        icon,
        color,
        title,
        subtitle,
        timestamp: new Date().toISOString(),
        read: false
    };

    notifications.unshift(notification);

    // Keep only last 20
    if (notifications.length > 20) {
        notifications = notifications.slice(0, 20);
    }

    saveNotifications();
    updateNotificationUI();
}

function saveNotifications() {
    localStorage.setItem('campuscore_notifications', JSON.stringify(notifications));
}

function updateNotificationUI() {
    const unreadCount = notifications.filter(n => !n.read).length;
    const badge = document.getElementById('notificationCount');
    const list = document.getElementById('notificationList');

    // Update badge
    if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }

    // Update list
    if (notifications.length === 0) {
        list.innerHTML = '<div class="notification-empty">No new notifications</div>';
        return;
    }

    list.innerHTML = notifications.map(n => `
        <div class="notification-item ${n.read ? 'read' : 'unread'}" onclick="markNotificationAsRead(${n.id})">
            <div class="notification-icon notification-icon-${n.color}">${n.icon}</div>
            <div class="notification-content">
                <div class="notification-title">
                    ${!n.read ? '<span class="notification-new-badge">NEW</span>' : ''}
                    ${n.title}
                </div>
                <div class="notification-subtitle">${n.subtitle}</div>
                <div class="notification-time">${getRelativeTime(new Date(n.timestamp))}</div>
            </div>
            <button class="notification-dismiss" onclick="event.stopPropagation(); dismissNotification(${n.id})">√ó</button>
        </div>
    `).join('');
}

window.markNotificationAsRead = function(notificationId) {
    const notification = notifications.find(n => n.id === notificationId);
    if (notification) {
        notification.read = true;
        saveNotifications();
        updateNotificationUI();
    }
};

window.dismissNotification = function(notificationId) {
    notifications = notifications.filter(n => n.id !== notificationId);
    saveNotifications();
    updateNotificationUI();
};

window.markAllNotificationsAsRead = function() {
    notifications.forEach(n => n.read = true);
    saveNotifications();
    updateNotificationUI();
};

window.clearAllNotifications = function() {
    if (confirm('Are you sure you want to clear all notifications?')) {
        notifications = [];
        saveNotifications();
        updateNotificationUI();
    }
};

// ========== ISSUES KANBAN DASHBOARD ==========
function renderIssuesDashboard() {
    const contentArea = document.getElementById('contentArea');

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìã ISSUES DASHBOARD</h3>
            <p style="color: #666; margin-bottom: 20px;">Manage and track all reported issues</p>

            <div class="issues-stats">
                <div class="issue-stat">
                    <span class="issue-stat-label">Total</span>
                    <span class="issue-stat-value">15</span>
                </div>
                <div class="issue-stat open">
                    <span class="issue-stat-label">Open</span>
                    <span class="issue-stat-value">8 üî¥</span>
                </div>
                <div class="issue-stat progress">
                    <span class="issue-stat-label">In Progress</span>
                    <span class="issue-stat-value">5 üü†</span>
                </div>
                <div class="issue-stat resolved">
                    <span class="issue-stat-label">Resolved</span>
                    <span class="issue-stat-value">2 üü¢</span>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px;">
                <div class="kanban-column">
                    <div class="kanban-header kanban-header-open">
                        <h4>OPEN (8)</h4>
                    </div>
                    <div class="kanban-cards" id="openColumn">
                        ${generateIssueCards('open')}
                    </div>
                </div>

                <div class="kanban-column">
                    <div class="kanban-header kanban-header-progress">
                        <h4>IN PROGRESS (5)</h4>
                    </div>
                    <div class="kanban-cards" id="progressColumn">
                        ${generateIssueCards('in_progress')}
                    </div>
                </div>

                <div class="kanban-column">
                    <div class="kanban-header kanban-header-resolved">
                        <h4>RESOLVED (2)</h4>
                    </div>
                    <div class="kanban-cards" id="resolvedColumn">
                        ${generateIssueCards('resolved')}
                    </div>
                </div>
            </div>
        </div>
    `;
}

function generateIssueCards(status) {
    const mockIssues = {
        open: [
            { id: 1, student: 'Rahul Kumar', class: '10A', category: 'Behavioral', priority: 'HIGH', days: 8 },
            { id: 2, student: 'John Doe', class: '9A', category: 'Attendance', priority: 'HIGH', days: 5 },
            { id: 3, student: 'Priya Singh', class: '10B', category: 'Academic', priority: 'MEDIUM', days: 3 }
        ],
        in_progress: [
            { id: 4, student: 'Priya Singh', class: '10A', category: 'Academic', priority: 'MEDIUM', days: 3 },
            { id: 5, student: 'Sai Charan', class: '10B', category: 'Health', priority: 'HIGH', days: 2 }
        ],
        resolved: [
            { id: 6, student: 'Amit Patel', class: '10B', category: 'Behavioral', priority: 'LOW', days: 0 }
        ]
    };

    const issues = mockIssues[status] || [];

    return issues.map(issue => `
        <div class="issue-card" onclick="viewIssueDetails(${issue.id})">
            <div class="issue-card-category ${issue.category.toLowerCase()}">${issue.category}</div>
            <div class="issue-card-student">${issue.student}</div>
            <div class="issue-card-class">Class ${issue.class}</div>
            <div class="issue-card-priority priority-${issue.priority.toLowerCase()}">${issue.priority} ${issue.priority === 'HIGH' ? 'üî¥' : issue.priority === 'MEDIUM' ? 'üü†' : 'üü¢'}</div>
            <div class="issue-card-time">${issue.days === 0 ? 'Resolved' : issue.days + ' days ago'}</div>
            <button class="issue-card-view">View</button>
        </div>
    `).join('');
}

window.viewIssueDetails = function(issueId) {
    // Mock issue data
    const issue = {
        id: issueId,
        student: 'Rahul Kumar',
        studentId: 'STU001',
        class: '10A',
        category: 'Behavioral',
        priority: 'HIGH',
        reportedBy: 'Mr. Sharma (Teacher)',
        reportedDate: 'Jan 19, 2026',
        description: 'Disruptive behavior during class. Not following instructions, talking out of turn, distracting others.',
        status: 'open',
        assignedTo: 'VP001',
        timeline: [
            { date: 'Jan 19', event: 'Issue reported by Mr. Sharma' },
            { date: 'Jan 20', event: 'VP contacted parents' },
            { date: 'Jan 21', event: 'Status changed to In Progress' }
        ],
        comments: [
            { author: 'VP001', date: 'Jan 20', text: 'Parent meeting scheduled for Jan 23' }
        ]
    };

    showModal('Issue Details', `
        <div class="issue-modal">
            <div class="issue-modal-header">
                <strong>Student:</strong> ${issue.student} (${issue.studentId}, Class ${issue.class})
            </div>
            <div class="issue-modal-row">
                <div><strong>Category:</strong> ${issue.category} üî¥</div>
                <div><strong>Priority:</strong> ${issue.priority} üî¥</div>
            </div>
            <div class="issue-modal-row">
                <div><strong>Reported by:</strong> ${issue.reportedBy}</div>
                <div><strong>Reported date:</strong> ${issue.reportedDate}</div>
            </div>
            <div class="issue-modal-description">
                <strong>Description:</strong><br>
                ${issue.description}
            </div>
            <div class="issue-modal-status">
                <label><strong>Status:</strong></label>
                <select style="padding: 8px; border-radius: 4px;">
                    <option value="open" ${issue.status === 'open' ? 'selected' : ''}>Open</option>
                    <option value="in_progress" ${issue.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                    <option value="resolved" ${issue.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                </select>
            </div>
            <div class="issue-modal-timeline">
                <strong>TIMELINE:</strong>
                ${issue.timeline.map(t => `<div>‚Ä¢ ${t.date} - ${t.event}</div>`).join('')}
            </div>
            <div class="issue-modal-comments">
                <strong>COMMENTS:</strong>
                ${issue.comments.map(c => `<div class="comment">üìù "${c.text}" - ${c.author}, ${c.date}</div>`).join('')}
            </div>
            <div style="margin-top: 15px;">
                <input type="text" placeholder="Add a comment..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>
    `, 'info');
};

// ========== ESCALATED ISSUES ==========
async function renderEscalatedIssues() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    try {
        const { data: escalatedIssues, error } = await client
            .from('issues')
            .select('*')
            .eq('status', 'escalated')
            .order('created_at', { ascending: false });

        if (error) throw error;

        contentArea.innerHTML = `
            <div class="card">
                <h3>üö® ESCALATED ISSUES</h3>
                <p style="color: #666; margin-bottom: 20px;">View and manage escalated issues - can be revoked if resolved</p>

                <!-- Stats -->
                <div class="performance-overview" style="margin-bottom: 30px;">
                    <div class="perf-stat">
                        <div class="perf-value">${escalatedIssues?.length || 0}</div>
                        <div class="perf-label">üö® Escalated Issues</div>
                        <div class="perf-sublabel">Requires attention</div>
                    </div>
                    <div class="perf-stat">
                        <div class="perf-value">${escalatedIssues?.filter(i => i.priority === 'critical').length || 0}</div>
                        <div class="perf-label">üî¥ Critical</div>
                        <div class="perf-sublabel">Urgent priority</div>
                    </div>
                    <div class="perf-stat">
                        <div class="perf-value">${escalatedIssues?.filter(i => i.priority === 'high').length || 0}</div>
                        <div class="perf-label">üü† High</div>
                        <div class="perf-sublabel">High priority</div>
                    </div>
                </div>

                <!-- Escalated Issues Table -->
                <div style="overflow-x: auto;">
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Student</th>
                                <th>Class</th>
                                <th>Priority</th>
                                <th>Reported By</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${escalatedIssues && escalatedIssues.length > 0 ? escalatedIssues.map(issue => `
                                <tr>
                                    <td>${issue.id}</td>
                                    <td><strong>${issue.title}</strong></td>
                                    <td>${issue.student_name || 'N/A'}</td>
                                    <td>${issue.class || 'N/A'}</td>
                                    <td>
                                        <span class="badge ${
                                            issue.priority === 'critical' ? 'badge-pending' :
                                            issue.priority === 'high' ? 'badge-pending' :
                                            'badge-resolved'
                                        }">
                                            ${issue.priority === 'critical' ? 'üî¥' :
                                              issue.priority === 'high' ? 'üü†' :
                                              issue.priority === 'normal' ? 'üü°' : 'üü¢'}
                                            ${(issue.priority || 'normal').toUpperCase()}
                                        </span>
                                    </td>
                                    <td>${issue.reported_by || 'Unknown'}</td>
                                    <td>${new Date(issue.created_at).toLocaleDateString()}</td>
                                    <td>
                                        <button onclick="viewEscalatedIssueDetails(${issue.id})" class="btn-primary" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;">View</button>
                                        <button onclick="revokeEscalation(${issue.id}, '${issue.title.replace(/'/g, "\\'")}
')" class="btn-secondary" style="padding: 5px 10px; font-size: 12px;">Revoke</button>
                                    </td>
                                </tr>
                            `).join('') : '<tr><td colspan="8" style="text-align: center;">No escalated issues found</td></tr>'}
                        </tbody>
                    </table>
                </div>

                <p style="color: #999; margin-top: 20px; text-align: center;">
                    üí° Tip: Click "Revoke" to mark an issue as resolved and move it back to resolved status
                </p>
            </div>
        `;
    } catch (error) {
        contentArea.innerHTML = `
            <div class="card">
                <h3>üö® ESCALATED ISSUES</h3>
                <p style="color: #e74c3c;">Error loading escalated issues: ${error.message}</p>
            </div>
        `;
    }
}

// View escalated issue details
window.viewEscalatedIssueDetails = async function(issueId) {
    try {
        const client = window.supabaseClient.getClient();
        const { data: issue, error } = await client
            .from('issues')
            .select('*')
            .eq('id', issueId)
            .single();

        if (error) throw error;

        showModal('Issue Details', `
            <div style="text-align: left;">
                <p><strong>Title:</strong> ${issue.title}</p>
                <p><strong>Description:</strong> ${issue.description || 'No description'}</p>
                <p><strong>Student:</strong> ${issue.student_name || 'N/A'} ${issue.student_id ? `(ID: ${issue.student_id})` : ''}</p>
                <p><strong>Class:</strong> ${issue.class || 'N/A'}</p>
                <p><strong>Priority:</strong> ${(issue.priority || 'normal').toUpperCase()}</p>
                <p><strong>Reported By:</strong> ${issue.reported_by || 'Unknown'}</p>
                <p><strong>Assigned To:</strong> ${issue.assigned_to || 'Unassigned'}</p>
                <p><strong>Created:</strong> ${new Date(issue.created_at).toLocaleString()}</p>
                <p><strong>Status:</strong> <span style="color: #e74c3c; font-weight: bold;">ESCALATED</span></p>
            </div>
        `, 'info');
    } catch (error) {
        showModal('Error', 'Failed to load issue details: ' + error.message, 'error');
    }
};

// Revoke escalation (mark as resolved)
window.revokeEscalation = async function(issueId, issueTitle) {
    showModal('Confirm Revoke', `Are you sure you want to revoke the escalation for "${issueTitle}"? This will mark it as resolved.`, 'warning', true, async function() {
        try {
            showLoading();
            const client = window.supabaseClient.getClient();

            const { error } = await client
                .from('issues')
                .update({ status: 'resolved', updated_at: new Date().toISOString() })
                .eq('id', issueId);

            if (error) throw error;

            hideLoading();
            showModal('Success', 'Escalation revoked successfully! Issue marked as resolved.', 'success');
            renderEscalatedIssues(); // Refresh the list
        } catch (error) {
            hideLoading();
            showModal('Error', 'Failed to revoke escalation: ' + error.message, 'error');
        }
    });
};

// ========== PRINCIPAL ANALYTICS DASHBOARD ==========
function renderPrincipalAnalytics() {
    const contentArea = document.getElementById('contentArea');

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìä PRINCIPAL ANALYTICS DASHBOARD</h3>
            <p style="color: #666; margin-bottom: 20px;">Overview of school performance and key metrics</p>

            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-card kpi-blue">
                    <div class="kpi-icon">üë•</div>
                    <div class="kpi-value">175</div>
                    <div class="kpi-label">Total Active Students</div>
                    <div class="kpi-change positive">+17% from last month</div>
                </div>
                <div class="kpi-card kpi-green">
                    <div class="kpi-icon">üìö</div>
                    <div class="kpi-value">18</div>
                    <div class="kpi-label">Total Classes Running</div>
                    <div class="kpi-change neutral">Same as last month</div>
                </div>
                <div class="kpi-card kpi-purple">
                    <div class="kpi-icon">üìä</div>
                    <div class="kpi-value">82%</div>
                    <div class="kpi-label">Avg Marks (School-Wide)</div>
                    <div class="kpi-change positive">+3% improvement</div>
                </div>
                <div class="kpi-card kpi-orange">
                    <div class="kpi-icon">üí¨</div>
                    <div class="kpi-value">3</div>
                    <div class="kpi-label">Pending Issues</div>
                    <div class="kpi-change positive">-2 from yesterday</div>
                </div>
            </div>
        </div>

        <!-- Attendance by Class -->
        <div class="card">
            <h3>üìà Attendance by Class</h3>
            <table style="width: 100%;">
                <thead>
                    <tr>
                        <th>Class</th>
                        <th>Attendance %</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>10A</td><td><div class="progress-bar"><div class="progress-fill" style="width: 92%">92%</div></div></td><td><span class="badge badge-resolved">Excellent</span></td></tr>
                    <tr><td>10B</td><td><div class="progress-bar"><div class="progress-fill" style="width: 88%">88%</div></div></td><td><span class="badge badge-normal">Good</span></td></tr>
                    <tr><td>9A</td><td><div class="progress-bar"><div class="progress-fill" style="width: 85%">85%</div></div></td><td><span class="badge badge-normal">Good</span></td></tr>
                    <tr><td>9B</td><td><div class="progress-bar"><div class="progress-fill" style="width: 90%">90%</div></div></td><td><span class="badge badge-resolved">Excellent</span></td></tr>
                </tbody>
            </table>
        </div>

        <!-- Top Students -->
        <div class="card">
            <h3>üèÜ Top 5 Students</h3>
            <table style="width: 100%;">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Class</th>
                        <th>Marks %</th>
                        <th>Medal</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>1</td><td>Rahul Kumar</td><td>10A</td><td>92%</td><td>ü•á</td></tr>
                    <tr><td>2</td><td>Priya Singh</td><td>10A</td><td>91%</td><td>ü•à</td></tr>
                    <tr><td>3</td><td>Amit Patel</td><td>10B</td><td>90%</td><td>ü•â</td></tr>
                    <tr><td>4</td><td>Sai Charan</td><td>10A</td><td>89%</td><td>‚≠ê</td></tr>
                    <tr><td>5</td><td>Ananya Sharma</td><td>9A</td><td>88%</td><td>‚≠ê</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Grade Distribution -->
        <div class="card">
            <h3>üìä Grade Distribution</h3>
            <div class="grade-distribution">
                <div class="grade-item grade-a">
                    <div class="grade-label">A</div>
                    <div class="grade-bar" style="width: 30%">30%</div>
                </div>
                <div class="grade-item grade-a">
                    <div class="grade-label">A</div>
                    <div class="grade-bar" style="width: 40%">40%</div>
                </div>
                <div class="grade-item grade-b">
                    <div class="grade-label">B</div>
                    <div class="grade-bar" style="width: 20%">20%</div>
                </div>
                <div class="grade-item grade-c">
                    <div class="grade-label">C</div>
                    <div class="grade-bar" style="width: 8%">8%</div>
                </div>
                <div class="grade-item grade-d">
                    <div class="grade-label">D</div>
                    <div class="grade-bar" style="width: 2%">2%</div>
                </div>
            </div>
        </div>
    `;
}

// ========== COORDINATOR ANALYTICS DASHBOARD ==========
function renderCoordinatorAnalytics() {
    const contentArea = document.getElementById('contentArea');

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìä COORDINATOR ANALYTICS DASHBOARD</h3>
            <p style="color: #666; margin-bottom: 20px;">Track submissions, approvals, and report card progress</p>

            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-card kpi-orange">
                    <div class="kpi-icon">‚è≥</div>
                    <div class="kpi-value">15</div>
                    <div class="kpi-label">Pending Approvals</div>
                    <div class="kpi-change neutral">Need review</div>
                </div>
                <div class="kpi-card kpi-green">
                    <div class="kpi-icon">‚úì</div>
                    <div class="kpi-value">142</div>
                    <div class="kpi-label">Approved</div>
                    <div class="kpi-change positive">This semester</div>
                </div>
                <div class="kpi-card kpi-red">
                    <div class="kpi-icon">‚ùå</div>
                    <div class="kpi-value">3</div>
                    <div class="kpi-label">Rejected</div>
                    <div class="kpi-change neutral">Corrections needed</div>
                </div>
                <div class="kpi-card kpi-blue">
                    <div class="kpi-icon">‚è±</div>
                    <div class="kpi-value">2.1</div>
                    <div class="kpi-label">Avg Time (days)</div>
                    <div class="kpi-change positive">Faster than target</div>
                </div>
            </div>
        </div>

        <!-- Report Cards Progress -->
        <div class="card">
            <h3>üìÑ Report Cards Progress</h3>
            <div style="margin: 20px 0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Completed: 45 out of 50</span>
                    <span><strong>90%</strong></span>
                </div>
                <div class="progress-bar-large">
                    <div class="progress-fill-large" style="width: 90%">90%</div>
                </div>
            </div>
            <table style="width: 100%; margin-top: 20px;">
                <thead>
                    <tr>
                        <th>Class</th>
                        <th>Completed</th>
                        <th>Pending</th>
                        <th>Progress</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>10A</td><td>25</td><td>0</td><td><div class="progress-bar"><div class="progress-fill" style="width: 100%">100%</div></div></td></tr>
                    <tr><td>10B</td><td>20</td><td>5</td><td><div class="progress-bar"><div class="progress-fill" style="width: 80%">80%</div></div></td></tr>
                    <tr><td>9A</td><td>0</td><td>20</td><td><div class="progress-bar"><div class="progress-fill" style="width: 0%">0%</div></div></td></tr>
                </tbody>
            </table>
        </div>

        <!-- Submission Status -->
        <div class="card">
            <h3>üìã Submission Status</h3>
            <div class="submission-stats">
                <div class="submission-item submitted">
                    <div class="submission-percent">45%</div>
                    <div class="submission-label">Submitted</div>
                </div>
                <div class="submission-item pending">
                    <div class="submission-percent">35%</div>
                    <div class="submission-label">Pending</div>
                </div>
                <div class="submission-item rejected">
                    <div class="submission-percent">20%</div>
                    <div class="submission-label">Rejected</div>
                </div>
            </div>
        </div>
    `;
}

// ========== TEACHER ANALYTICS DASHBOARD ==========
function renderTeacherAnalytics() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìä MY ANALYTICS</h3>
            <p style="color: #666; margin-bottom: 20px;">Your performance and class statistics</p>

            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-card kpi-blue">
                    <div class="kpi-icon">üìä</div>
                    <div class="kpi-value">92%</div>
                    <div class="kpi-label">Class Attendance</div>
                    <div class="kpi-change positive">‚Üë Improving</div>
                </div>
                <div class="kpi-card kpi-green">
                    <div class="kpi-icon">üéØ</div>
                    <div class="kpi-value">3</div>
                    <div class="kpi-label">Classes</div>
                    <div class="kpi-change neutral">Teaching</div>
                </div>
                <div class="kpi-card kpi-purple">
                    <div class="kpi-icon">üë•</div>
                    <div class="kpi-value">95</div>
                    <div class="kpi-label">Total Students</div>
                    <div class="kpi-change neutral">Across all classes</div>
                </div>
                <div class="kpi-card kpi-orange">
                    <div class="kpi-icon">‚úÖ</div>
                    <div class="kpi-value">2</div>
                    <div class="kpi-label">Pending Duties</div>
                    <div class="kpi-change neutral">Complete soon</div>
                </div>
            </div>
        </div>

        <!-- My Classes Performance -->
        <div class="card">
            <h3>üìö My Classes Performance</h3>
            <table style="width: 100%;">
                <thead>
                    <tr>
                        <th>Class</th>
                        <th>Subject</th>
                        <th>Students</th>
                        <th>Avg Marks</th>
                        <th>Attendance</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>10A</td><td>Mathematics</td><td>35</td><td>85%</td><td>92%</td></tr>
                    <tr><td>10B</td><td>Mathematics</td><td>32</td><td>82%</td><td>88%</td></tr>
                    <tr><td>9A</td><td>Mathematics</td><td>28</td><td>78%</td><td>90%</td></tr>
                </tbody>
            </table>
        </div>

        <!-- My Duties -->
        <div class="card">
            <h3>üìã My Duties Status</h3>
            <div class="duties-chart">
                <div class="duty-stat">
                    <div class="duty-circle completed">60%</div>
                    <div class="duty-label">Completed (6)</div>
                </div>
                <div class="duty-stat">
                    <div class="duty-circle pending">30%</div>
                    <div class="duty-label">Pending (3)</div>
                </div>
                <div class="duty-stat">
                    <div class="duty-circle overdue">10%</div>
                    <div class="duty-label">Overdue (1)</div>
                </div>
            </div>
        </div>
    `;
}

// ========== ATTENDANCE ANALYTICS ==========
function renderAttendanceAnalytics() {
    const contentArea = document.getElementById('contentArea');

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìà ATTENDANCE ANALYTICS</h3>
            <p style="color: #666; margin-bottom: 20px;">School-wide attendance tracking and insights</p>

            <!-- Overview Stats -->
            <div class="attendance-overview">
                <div class="overview-stat">
                    <div class="overview-value">89.2%</div>
                    <div class="overview-label">üè´ School Attendance</div>
                    <div class="overview-sublabel">Overall average</div>
                </div>
                <div class="overview-stat">
                    <div class="overview-value">91.1% ‚Üë</div>
                    <div class="overview-label">üìà This Week</div>
                    <div class="overview-sublabel">Up from 88.2% last week</div>
                </div>
                <div class="overview-stat">
                    <div class="overview-value">9A (82%)</div>
                    <div class="overview-label">üìâ Lowest Class</div>
                    <div class="overview-sublabel">Needs attention</div>
                </div>
            </div>
        </div>

        <!-- Class Comparison -->
        <div class="card">
            <h3>üè´ Class Comparison</h3>
            <table style="width: 100%;">
                <thead>
                    <tr>
                        <th>Class</th>
                        <th>Attendance %</th>
                        <th>Status</th>
                        <th>Trend</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>10A</td><td><div class="progress-bar"><div class="progress-fill bg-green" style="width: 92%">92%</div></div></td><td><span class="badge badge-resolved">Excellent</span></td><td>‚Üë</td></tr>
                    <tr><td>10B</td><td><div class="progress-bar"><div class="progress-fill bg-green" style="width: 88%">88%</div></div></td><td><span class="badge badge-normal">Good</span></td><td>‚Üí</td></tr>
                    <tr><td>9A</td><td><div class="progress-bar"><div class="progress-fill bg-yellow" style="width: 82%">82%</div></div></td><td><span class="badge badge-high">Needs Improvement</span></td><td>‚Üì</td></tr>
                    <tr><td>9B</td><td><div class="progress-bar"><div class="progress-fill bg-green" style="width: 90%">90%</div></div></td><td><span class="badge badge-resolved">Excellent</span></td><td>‚Üë</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Student-wise Attendance -->
        <div class="card">
            <h3>üë• Student-wise Attendance</h3>
            <div style="margin-bottom: 20px;">
                <select style="padding: 8px; border-radius: 4px; margin-right: 10px;">
                    <option>All Classes</option>
                    <option>10A</option>
                    <option>10B</option>
                    <option>9A</option>
                    <option>9B</option>
                </select>
                <select style="padding: 8px; border-radius: 4px;">
                    <option>January 2026</option>
                    <option>December 2025</option>
                    <option>November 2025</option>
                </select>
            </div>
            <table style="width: 100%;">
                <thead>
                    <tr>
                        <th>Class</th>
                        <th>Student</th>
                        <th>Present</th>
                        <th>Absent</th>
                        <th>%</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>10A</td><td>Rahul Kumar</td><td>19</td><td>1</td><td>95%</td><td><span class="badge badge-resolved">Excellent</span></td></tr>
                    <tr><td>10A</td><td>Priya Singh</td><td>20</td><td>0</td><td>100%</td><td><span class="badge badge-resolved">Perfect</span></td></tr>
                    <tr><td>10B</td><td>Amit Patel</td><td>16</td><td>4</td><td>80%</td><td><span class="badge badge-high">Low</span></td></tr>
                </tbody>
            </table>
            <div style="margin-top: 20px;">
                <button class="btn-primary" onclick="exportTableData('attendanceTable', 'pdf', 'Attendance Report')">üìÑ Export as PDF</button>
            </div>
        </div>
    `;
}

// ========== PERFORMANCE ANALYTICS ==========
function renderPerformanceAnalytics() {
    const contentArea = document.getElementById('contentArea');

    contentArea.innerHTML = `
        <div class="card">
            <h3>üéØ ACADEMIC PERFORMANCE ANALYTICS</h3>
            <p style="color: #666; margin-bottom: 20px;">Comprehensive performance insights and trends</p>

            <!-- Overview -->
            <div class="performance-overview">
                <div class="perf-stat">
                    <div class="perf-value">82%</div>
                    <div class="perf-label">üìä Overall Performance</div>
                    <div class="perf-sublabel">School average</div>
                </div>
                <div class="perf-stat">
                    <div class="perf-value">10A (85%)</div>
                    <div class="perf-label">üéØ Best Performing</div>
                    <div class="perf-sublabel">Top class</div>
                </div>
                <div class="perf-stat">
                    <div class="perf-value">9A (78%)</div>
                    <div class="perf-label">‚ö†Ô∏è Needs Improvement</div>
                    <div class="perf-sublabel">Focus area</div>
                </div>
            </div>
        </div>

        <!-- Class Averages -->
        <div class="card">
            <h3>üìö Class Averages</h3>
            <table style="width: 100%;">
                <thead>
                    <tr>
                        <th>Class</th>
                        <th>Average %</th>
                        <th>Grade</th>
                        <th>Trend</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>10A</td><td><div class="progress-bar"><div class="progress-fill" style="width: 85%">85%</div></div></td><td>A</td><td>‚Üë +3%</td></tr>
                    <tr><td>10B</td><td><div class="progress-bar"><div class="progress-fill" style="width: 82%">82%</div></div></td><td>A</td><td>‚Üí 0%</td></tr>
                    <tr><td>9A</td><td><div class="progress-bar"><div class="progress-fill" style="width: 78%">78%</div></div></td><td>B</td><td>‚Üì -2%</td></tr>
                    <tr><td>9B</td><td><div class="progress-bar"><div class="progress-fill" style="width: 80%">80%</div></div></td><td>A</td><td>‚Üë +1%</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Top 10 Students -->
        <div class="card">
            <h3>üèÜ Top 10 Students</h3>
            <table style="width: 100%;">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Class</th>
                        <th>Average</th>
                        <th>Best Subject</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>1 ü•á</td><td>Rahul Kumar</td><td>10A</td><td>92%</td><td>Math (95%)</td></tr>
                    <tr><td>2 ü•à</td><td>Priya Singh</td><td>10A</td><td>91%</td><td>Science (93%)</td></tr>
                    <tr><td>3 ü•â</td><td>Amit Patel</td><td>10B</td><td>90%</td><td>English (92%)</td></tr>
                    <tr><td>4</td><td>Sai Charan</td><td>10A</td><td>89%</td><td>Math (91%)</td></tr>
                    <tr><td>5</td><td>Ananya Sharma</td><td>9A</td><td>88%</td><td>Science (90%)</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Students Needing Support -->
        <div class="card">
            <h3>‚ö†Ô∏è Students Needing Support</h3>
            <table style="width: 100%;">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Class</th>
                        <th>Average</th>
                        <th>Needs Help In</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Mohit Singh</td><td>9A</td><td>62%</td><td>Math, Science</td><td><button class="btn-secondary btn-sm">Create Plan</button></td></tr>
                    <tr><td>Anjali Patel</td><td>10B</td><td>68%</td><td>Science</td><td><button class="btn-secondary btn-sm">Create Plan</button></td></tr>
                </tbody>
            </table>
        </div>

        <!-- Subject Performance -->
        <div class="card">
            <h3>üìñ Subject Performance</h3>
            <table style="width: 100%;">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>School Average</th>
                        <th>Topper</th>
                        <th>Top Score</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Mathematics</td><td>85%</td><td>Rahul Kumar (10A)</td><td>95/100</td></tr>
                    <tr><td>Science</td><td>82%</td><td>Priya Singh (10A)</td><td>93/100</td></tr>
                    <tr><td>English</td><td>78%</td><td>Sai Charan (10A)</td><td>91/100</td></tr>
                    <tr><td>Social Studies</td><td>80%</td><td>Ananya Sharma (9A)</td><td>89/100</td></tr>
                </tbody>
            </table>
        </div>
    `;
}

async function renderStudentAnalysis() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    try {
        // Check if class_members table exists (after migration)
        const { data: tableCheck } = await client
            .from('class_members')
            .select('id')
            .limit(1);

        const hasClassMembers = tableCheck !== null;

        // Fetch all students with optional class enrollment info
        let students;
        if (hasClassMembers) {
            // Use the new structure with class_members
            const { data: studentsData, error } = await client
                .from('students')
                .select(`
                    *,
                    class_members (
                        id,
                        is_active,
                        joined_date,
                        classes (
                            id,
                            name,
                            section,
                            pre_classes (
                                name
                            )
                        )
                    )
                `)
                .eq('status', 'active')
                .order('name');

            if (error) throw error;
            students = studentsData;
        } else {
            // Fallback to simple query
            const { data: studentsData, error } = await client
                .from('students')
                .select('*')
                .eq('status', 'active')
                .order('name');

            if (error) throw error;
            students = studentsData;
        }

        contentArea.innerHTML = `
            <div class="card">
                <h3>üë• STUDENT ANALYSIS</h3>
                <p style="color: #666; margin-bottom: 20px;">View and search all active students</p>

                <!-- Search Box -->
                <div style="margin-bottom: 20px;">
                    <input
                        type="text"
                        id="studentSearchBox"
                        placeholder="üîç Search by name, ID, class, or parent ID..."
                        style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;"
                    >
                </div>

                <!-- Stats Overview -->
                <div class="performance-overview" style="margin-bottom: 20px;">
                    <div class="perf-stat">
                        <div class="perf-value">${students.length}</div>
                        <div class="perf-label">üë• Total Students</div>
                        <div class="perf-sublabel">Active students</div>
                    </div>
                    <div class="perf-stat">
                        <div class="perf-value">${[...new Set(students.map(s => s.class))].length}</div>
                        <div class="perf-label">üìö Classes</div>
                        <div class="perf-sublabel">Unique classes</div>
                    </div>
                    <div class="perf-stat">
                        <div class="perf-value">${[...new Set(students.filter(s => s.parent_id).map(s => s.parent_id))].length}</div>
                        <div class="perf-label">üë®‚Äçüë©‚Äçüëß Parents</div>
                        <div class="perf-sublabel">Unique parents</div>
                    </div>
                </div>

                <!-- Students Table -->
                <div style="overflow-x: auto;">
                    <table id="studentsTable" style="width: 100%; margin-top: 20px;">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Class</th>
                                <th>Parent ID</th>
                                ${hasClassMembers ? '<th>Enrollment</th>' : ''}
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            ${students.map(s => {
                                const enrollment = s.class_members && s.class_members.length > 0
                                    ? s.class_members[0]
                                    : null;
                                const enrollmentStatus = enrollment
                                    ? (enrollment.is_active ? '‚úÖ Enrolled' : '‚ö†Ô∏è Inactive')
                                    : '‚ùå Not Enrolled';

                                return `
                                    <tr class="student-row">
                                        <td>${s.id}</td>
                                        <td>${s.name}</td>
                                        <td>${s.class}</td>
                                        <td>${s.parent_id || 'N/A'}</td>
                                        ${hasClassMembers ? `<td>${enrollmentStatus}</td>` : ''}
                                        <td><span style="color: #27ae60; font-weight: bold;">‚óè</span> Active</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>

                <p style="color: #999; margin-top: 20px; text-align: center;">
                    Showing <span id="visibleStudentCount">${students.length}</span> of ${students.length} students
                    ${hasClassMembers ? '‚Ä¢ <span style="color: #27ae60;">New enrollment tracking enabled</span>' : ''}
                </p>
            </div>
        `;

        // Add search functionality
        const searchBox = document.getElementById('studentSearchBox');
        const visibleCountSpan = document.getElementById('visibleStudentCount');

        searchBox.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            const rows = document.querySelectorAll('.student-row');
            let visibleCount = 0;

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            visibleCountSpan.textContent = visibleCount;
        });

        // Subscribe to real-time updates for new students
        const subscription = client
            .channel('student-changes')
            .on('postgres_changes',
                { event: '*', schema: 'public', table: 'students' },
                (payload) => {
                    console.log('Student data changed:', payload);
                    // Reload the student analysis when data changes
                    renderStudentAnalysis();
                }
            )
            .subscribe();

        // Clean up subscription when navigating away
        window.addEventListener('beforeunload', () => {
            subscription.unsubscribe();
        });

    } catch (error) {
        console.error('Error loading students:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üë• Student Analysis</h3>
                <p style="color: #e74c3c;">Error loading students: ${error.message}</p>
            </div>
        `;
    }
}

// END PROMPT 3 - NEW CODE

// Initialize app on page load
window.addEventListener('DOMContentLoaded', () => {
    initApp();
    // PROMPT 1 - NEW CODE: Initialize new UI features after app loads
    setTimeout(initNewUIFeatures, 1000);
    // PROMPT 3 - NEW CODE: Initialize notification system
    setTimeout(initNotificationSystem, 1500);
    // END PROMPT 1 & 3 - NEW CODE
});
</script>

</body>
</html>
