<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusCore - Dashboard</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

<div class="dashboard">
    <!-- Sidebar -->
    <aside class="sidebar">
        <!-- Logo Section -->
        <div class="logo-section">
            <div class="logo-icon">
                <img src="logo.png" alt="CampusCore Logo" style="width: 55px; height: 55px; object-fit: contain;">
            </div>
            <div class="logo-text">
                <h2>CAMPUSCORE</h2>
                <p>Smart Campus</p>
            </div>
        </div>

        <!-- User Block -->
        <div class="user-block">
            <div class="user-avatar" id="userAvatar">?</div>
            <div class="user-name" id="userName">Loading...</div>
            <div class="user-id" id="userId"></div>
            <div class="user-role" id="userRole"></div>
        </div>

        <!-- Menu -->
        <nav>
            <ul class="menu" id="menuList">
                <!-- Menu items will be dynamically generated -->
            </ul>
        </nav>

        <!-- Logout Button -->
        <button class="logout-btn" id="logoutBtn">
            <span class="menu-icon">üö™</span>
            <span>Logout</span>
        </button>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header Banner -->
        <div class="header-banner">
            <h1>Delhi Public School, Nadergul</h1>
            <p>Excellence in Education</p>
        </div>

        <!-- Content Area -->
        <div class="content-area" id="contentArea">
            <!-- Dynamic content will be loaded here -->
        </div>
    </main>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay hidden" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>
</div>

<!-- Load Supabase from CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Load application scripts -->
<script src="assets/js/supabase-client.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/database.js"></script>
<script src="assets/js/utils.js"></script>

<script>
// Global variables
let currentTab = 'home';
let initialized = false;

// Menu items by role
const menuItems = {
    parent: [
        { id: 'home', icon: 'üè†', label: 'Dashboard' },
        { id: 'attendance', icon: 'üìä', label: 'Attendance' },
        { id: 'viewhomework', icon: 'üìù', label: 'Homework' },
        { id: 'viewexamresults', icon: 'üìà', label: 'Exam Results' },
        { id: 'viewreportcards', icon: 'üìÑ', label: 'Report Cards' },
        { id: 'examschedule', icon: 'üìÖ', label: 'Exam Schedule' },
        { id: 'timetable', icon: 'üóìÔ∏è', label: 'Timetable' },
        { id: 'profile', icon: 'üë§', label: 'Profile' },
        { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ],
    teacher: [
        { id: 'home', icon: 'üè†', label: 'Dashboard' },
        { id: 'myduties', icon: 'üìã', label: 'My Duties' },
        { id: 'markattendance', icon: '‚úÖ', label: 'Mark Attendance' },
        { id: 'homework', icon: 'üìù', label: 'Homework' },
        { id: 'examresults', icon: 'üìä', label: 'Exam Results' },
        { id: 'uploadmarks', icon: 'üìà', label: 'Upload Marks' },
        { id: 'myclasses', icon: 'üë•', label: 'My Classes' },
        { id: 'teacherissues', icon: '‚ö†Ô∏è', label: 'Issues' },
        { id: 'timetable', icon: 'üóìÔ∏è', label: 'Timetable' },
        { id: 'profile', icon: 'üë§', label: 'Profile' },
        { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ],
    coordinator: [
        { id: 'home', icon: 'üè†', label: 'Dashboard' },
        { id: 'coordissues', icon: '‚ö†Ô∏è', label: 'Issues' },
        { id: 'uploadexam', icon: 'üìã', label: 'Upload Exam' },
        { id: 'classes', icon: 'üë•', label: 'Classes' },
        { id: 'managetimetable', icon: 'üóìÔ∏è', label: 'Manage Timetable' },
        { id: 'uploadcca', icon: 'üé®', label: 'Upload CCA' },
        { id: 'timetable', icon: 'üìÖ', label: 'View Timetable' },
        { id: 'profile', icon: 'üë§', label: 'Profile' },
        { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ],
    viceprincipal: [
        { id: 'home', icon: 'üè†', label: 'Dashboard' },
        { id: 'appointteacher', icon: 'üë®‚Äçüè´', label: 'Appoint Teacher' },
        { id: 'assignduties', icon: 'üìã', label: 'Assign Duties' },
        { id: 'vpissues', icon: '‚ö†Ô∏è', label: 'Issues' },
        { id: 'removestudent', icon: 'üö´', label: 'Remove Student' },
        { id: 'deletestudent', icon: '‚ùå', label: 'Delete Student' },
        { id: 'holidays', icon: 'üéâ', label: 'Holidays' },
        { id: 'register', icon: 'üìù', label: 'Register' },
        { id: 'analytics', icon: 'üìä', label: 'Analytics' },
        { id: 'timetable', icon: 'üóìÔ∏è', label: 'Timetable' },
        { id: 'profile', icon: 'üë§', label: 'Profile' },
        { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ],
    superviceprincipal: [
        { id: 'home', icon: 'üè†', label: 'Dashboard' },
        { id: 'appointteacher', icon: 'üë®‚Äçüè´', label: 'Appoint Teacher' },
        { id: 'assignduties', icon: 'üìã', label: 'Assign Duties' },
        { id: 'svpissues', icon: '‚ö†Ô∏è', label: 'Issues' },
        { id: 'removestudent', icon: 'üö´', label: 'Remove Student' },
        { id: 'deletestudent', icon: '‚ùå', label: 'Delete Student' },
        { id: 'holidays', icon: 'üéâ', label: 'Holidays' },
        { id: 'register', icon: 'üìù', label: 'Register' },
        { id: 'analytics', icon: 'üìä', label: 'Analytics' },
        { id: 'timetable', icon: 'üóìÔ∏è', label: 'Timetable' },
        { id: 'profile', icon: 'üë§', label: 'Profile' },
        { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ],
    classteacher: [
        { id: 'home', icon: 'üè†', label: 'Dashboard' },
        { id: 'classdashboard', icon: 'üìä', label: 'Class Dashboard' },
        { id: 'ctmarkattendance', icon: '‚úÖ', label: 'Mark Attendance' },
        { id: 'reportcards', icon: 'üìÑ', label: 'Report Cards' },
        { id: 'myduties', icon: 'üìã', label: 'My Duties' },
        { id: 'homework', icon: 'üìù', label: 'Homework' },
        { id: 'teacherissues', icon: '‚ö†Ô∏è', label: 'Issues' },
        { id: 'timetable', icon: 'üóìÔ∏è', label: 'Timetable' },
        { id: 'profile', icon: 'üë§', label: 'Profile' },
        { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ]
};

// Initialize application
async function initApp() {
    if (initialized) return;

    try {
        showLoading();

        // Initialize Supabase client
        await window.supabaseClient.init();

        // Initialize database
        window.database.init();

        // Check authentication
        if (!window.auth.requireAuth()) {
            return;
        }

        // Get current user
        const currentUser = window.auth.getCurrentUser();

        // Render user info
        renderUserInfo(currentUser);

        // Render menu
        renderMenu(currentUser.role);

        // Render default tab (home)
        renderTab('home');

        initialized = true;
        hideLoading();
    } catch (error) {
        console.error('Initialization error:', error);
        hideLoading();
        showModal('Error', 'Failed to initialize application. Please refresh the page.', 'error');
    }
}

// Render user info
function renderUserInfo(user) {
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const userId = document.getElementById('userId');
    const userRole = document.getElementById('userRole');

    // Generate avatar initials
    const initials = user.name ? user.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : '?';
    userAvatar.textContent = initials;

    userName.textContent = user.name || user.username;
    userId.textContent = `@${user.username}`;
    userRole.textContent = formatRole(user.role);
}

// Format role for display
function formatRole(role) {
    const roleMap = {
        parent: 'Parent',
        teacher: 'Teacher',
        coordinator: 'Coordinator',
        viceprincipal: 'Vice Principal',
        superviceprincipal: 'Super Vice Principal',
        classteacher: 'Class Teacher'
    };
    return roleMap[role] || role;
}

// Render menu based on role
function renderMenu(role) {
    const menuList = document.getElementById('menuList');
    const items = menuItems[role] || menuItems.parent;

    menuList.innerHTML = items.map(item => `
        <li class="menu-item">
            <button class="menu-link" data-tab="${item.id}">
                <span class="menu-icon">${item.icon}</span>
                <span>${item.label}</span>
            </button>
        </li>
    `).join('');

    // Add click event listeners
    menuList.querySelectorAll('.menu-link').forEach(link => {
        link.addEventListener('click', function() {
            const tab = this.getAttribute('data-tab');
            renderTab(tab);

            // Update active state
            menuList.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Set home as active by default
    const homeLink = menuList.querySelector('[data-tab="home"]');
    if (homeLink) {
        homeLink.classList.add('active');
    }
}

// Render tab content
function renderTab(tabId) {
    currentTab = tabId;
    const contentArea = document.getElementById('contentArea');

    // Clear content
    contentArea.innerHTML = '';

    // Render tab-specific content
    switch(tabId) {
        case 'home':
            renderHomeDashboard();
            break;
        case 'attendance':
            renderAttendance();
            break;
        case 'viewhomework':
            renderViewHomework();
            break;
        case 'viewexamresults':
            renderViewExamResults();
            break;
        case 'viewreportcards':
            renderViewReportCards();
            break;
        case 'examschedule':
            renderExamSchedule();
            break;
        case 'timetable':
            renderTimetable();
            break;
        case 'profile':
            renderProfile();
            break;
        case 'changepassword':
            renderChangePassword();
            break;
        // Teacher tabs
        case 'myduties':
            renderMyDuties();
            break;
        case 'markattendance':
            renderMarkAttendance();
            break;
        case 'homework':
            renderHomework();
            break;
        case 'examresults':
            renderExamResults();
            break;
        case 'uploadmarks':
            renderUploadMarks();
            break;
        case 'myclasses':
            renderMyClasses();
            break;
        case 'teacherissues':
            renderTeacherIssues();
            break;
        // Coordinator tabs
        case 'coordissues':
            renderCoordIssues();
            break;
        case 'uploadexam':
            renderUploadExam();
            break;
        case 'classes':
            renderClasses();
            break;
        case 'managetimetable':
            renderManageTimetable();
            break;
        case 'uploadcca':
            renderUploadCCA();
            break;
        // Vice Principal tabs
        case 'appointteacher':
            renderAppointTeacher();
            break;
        case 'assignduties':
            renderAssignDuties();
            break;
        case 'vpissues':
        case 'svpissues':
            renderVPIssues();
            break;
        case 'removestudent':
            renderRemoveStudent();
            break;
        case 'deletestudent':
            renderDeleteStudent();
            break;
        case 'holidays':
            renderHolidays();
            break;
        case 'register':
            renderRegister();
            break;
        case 'analytics':
            renderAnalytics();
            break;
        // Class Teacher tabs
        case 'classdashboard':
            renderClassDashboard();
            break;
        case 'ctmarkattendance':
            renderCTMarkAttendance();
            break;
        case 'reportcards':
            renderReportCards();
            break;
        default:
            renderComingSoon(tabId);
    }
}

// Tab rendering functions

async function renderHomeDashboard() {
    const currentUser = window.auth.getCurrentUser();
    const contentArea = document.getElementById('contentArea');

    // Show loading state
    contentArea.innerHTML = `
        <div class="card">
            <h3>Welcome, ${currentUser.name}!</h3>
            <p>You are logged in as <strong>${formatRole(currentUser.role)}</strong></p>

            <div class="stats-grid" style="margin-top: 30px;">
                <div class="stat-card">
                    <div class="stat-value">Loading...</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">Loading...</div>
                    <div class="stat-label">Total Teachers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">Loading...</div>
                    <div class="stat-label">Total Classes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">Loading...</div>
                    <div class="stat-label">Pending Issues</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Quick Actions</h3>
            <div class="btn-group">
                <button class="btn-primary" onclick="renderTab('profile')">View Profile</button>
                <button class="btn-secondary" onclick="renderTab('changepassword')">Change Password</button>
            </div>
        </div>
    `;

    try {
        const client = window.supabaseClient.getClient();

        // Fetch statistics in parallel
        const [studentsResult, teachersResult, classesResult, issuesResult] = await Promise.all([
            client.from('students').select('id', { count: 'exact', head: true }),
            client.from('teachers').select('id', { count: 'exact', head: true }),
            client.from('classes').select('id', { count: 'exact', head: true }),
            client.from('issues').select('id', { count: 'exact', head: true }).eq('status', 'pending')
        ]);

        const totalStudents = studentsResult.count || 0;
        const totalTeachers = teachersResult.count || 0;
        const totalClasses = classesResult.count || 0;
        const pendingIssues = issuesResult.count || 0;

        // Update with actual data
        contentArea.innerHTML = `
            <div class="card">
                <h3>Welcome, ${currentUser.name}!</h3>
                <p>You are logged in as <strong>${formatRole(currentUser.role)}</strong></p>

                <div class="stats-grid" style="margin-top: 30px;">
                    <div class="stat-card">
                        <div class="stat-value">${totalStudents}</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalTeachers}</div>
                        <div class="stat-label">Total Teachers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalClasses}</div>
                        <div class="stat-label">Total Classes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${pendingIssues}</div>
                        <div class="stat-label">Pending Issues</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Quick Actions</h3>
                <div class="btn-group">
                    <button class="btn-primary" onclick="renderTab('profile')">View Profile</button>
                    <button class="btn-secondary" onclick="renderTab('changepassword')">Change Password</button>
                </div>
            </div>
        `;
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>Welcome, ${currentUser.name}!</h3>
                <p>You are logged in as <strong>${formatRole(currentUser.role)}</strong></p>

                <div class="stats-grid" style="margin-top: 30px;">
                    <div class="stat-card">
                        <div class="stat-value">-</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">-</div>
                        <div class="stat-label">Total Teachers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">-</div>
                        <div class="stat-label">Total Classes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">-</div>
                        <div class="stat-label">Pending Issues</div>
                    </div>
                </div>
                <p style="color: #e74c3c; margin-top: 20px;">Error loading statistics. Please refresh the page.</p>
            </div>

            <div class="card">
                <h3>Quick Actions</h3>
                <div class="btn-group">
                    <button class="btn-primary" onclick="renderTab('profile')">View Profile</button>
                    <button class="btn-secondary" onclick="renderTab('changepassword')">Change Password</button>
                </div>
            </div>
        `;
    }
}

async function renderAttendance() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        showLoading();

        // Get parent's student
        const { data: parent } = await client
            .from('parents')
            .select('student_id')
            .eq('id', currentUser.username)
            .maybeSingle();

        if (!parent) {
            hideLoading();
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìä Attendance Records</h3>
                    <p style="color: #e74c3c;">Parent information not found.</p>
                </div>
            `;
            return;
        }

        // Get student info
        const { data: student } = await client
            .from('students')
            .select('id, name, class')
            .eq('id', parent.student_id)
            .maybeSingle();

        // Get attendance records for the student
        const { data: attendanceRecords } = await client
            .from('attendance')
            .select('*')
            .eq('student_id', parent.student_id)
            .order('date', { ascending: false })
            .limit(50);

        // Calculate statistics
        const total = attendanceRecords?.length || 0;
        const present = attendanceRecords?.filter(a => a.status === 'present').length || 0;
        const absent = attendanceRecords?.filter(a => a.status === 'absent').length || 0;
        const late = attendanceRecords?.filter(a => a.status === 'late').length || 0;
        const percentage = total > 0 ? ((present + late) / total * 100).toFixed(1) : 0;

        hideLoading();

        contentArea.innerHTML = `
            <div class="card">
                <h3>üìä Attendance Records - ${student?.name || 'Student'}</h3>
                <p style="color: #666; margin-bottom: 20px;">Class: ${student?.class || 'N/A'}</p>

                <div class="attendance-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;">${total}</div>
                        <div style="opacity: 0.9;">Total Days</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); padding: 20px; border-radius: 10px; color: white; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;">${present}</div>
                        <div style="opacity: 0.9;">Present</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; color: white; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;">${absent}</div>
                        <div style="opacity: 0.9;">Absent</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #FFA726 0%, #FB8C00 100%); padding: 20px; border-radius: 10px; color: white; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;">${late}</div>
                        <div style="opacity: 0.9;">Late</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #00BCD4 0%, #0097A7 100%); padding: 20px; border-radius: 10px; color: white; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold;">${percentage}%</div>
                        <div style="opacity: 0.9;">Attendance Rate</div>
                    </div>
                </div>

                <h4>Recent Attendance</h4>
                ${attendanceRecords && attendanceRecords.length > 0 ? `
                    <table style="width: 100%; margin-top: 15px;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Period</th>
                                <th>Status</th>
                                <th>Behavior</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${attendanceRecords.map(a => {
                                const date = new Date(a.date).toLocaleDateString();
                                const statusColor = a.status === 'present' ? '#4CAF50' : a.status === 'absent' ? '#f44336' : '#FF9800';
                                return `
                                    <tr>
                                        <td>${date}</td>
                                        <td>Period ${a.period}</td>
                                        <td><span class="badge" style="background: ${statusColor};">${a.status.toUpperCase()}</span></td>
                                        <td>${a.behavior || 'N/A'}</td>
                                        <td>${a.remarks || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                ` : '<p style="margin-top: 15px; color: #666;">No attendance records found.</p>'}
            </div>
        `;
    } catch (error) {
        hideLoading();
        console.error('Error loading attendance:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìä Attendance Records</h3>
                <p style="color: #e74c3c;">Error loading attendance data. Please try again.</p>
            </div>
        `;
    }
}

async function renderViewHomework() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        // Get parent's student
        const { data: parent } = await client
            .from('parents')
            .select('student_id')
            .eq('id', currentUser.username)
            .maybeSingle();

        if (!parent) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìù Homework</h3>
                    <p style="color: #e74c3c;">Parent information not found.</p>
                </div>
            `;
            return;
        }

        // Get student's class
        const { data: student } = await client
            .from('students')
            .select('class, name')
            .eq('id', parent.student_id)
            .maybeSingle();

        if (!student) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìù Homework</h3>
                    <p style="color: #e74c3c;">Student information not found.</p>
                </div>
            `;
            return;
        }

        // Get homework for student's class
        const { data: homework } = await client
            .from('homework')
            .select('*')
            .eq('class', student.class)
            .order('date', { ascending: false })
            .limit(50);

        contentArea.innerHTML = `
            <div class="card">
                <h3>üìù Homework - ${student.name} (${student.class})</h3>

                ${homework && homework.length > 0 ? `
                    <table style="width: 100%; margin-top: 20px;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Subject</th>
                                <th>Title</th>
                                <th>Description</th>
                                <th>Due Date</th>
                                <th>Assigned By</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${homework.map(hw => `
                                <tr>
                                    <td>${new Date(hw.date).toLocaleDateString()}</td>
                                    <td><strong>${hw.subject}</strong></td>
                                    <td>${hw.title}</td>
                                    <td>${hw.description || 'N/A'}</td>
                                    <td>${hw.due_date ? new Date(hw.due_date).toLocaleDateString() : 'N/A'}</td>
                                    <td>${hw.assigned_by || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p style="margin-top: 20px; color: #666;">No homework assigned yet.</p>'}
            </div>
        `;
    } catch (error) {
        console.error('Error loading homework:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìù Homework</h3>
                <p style="color: #e74c3c;">Error loading homework. Please try again.</p>
            </div>
        `;
    }
}

async function renderViewExamResults() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        // Get parent's student
        const { data: parent } = await client
            .from('parents')
            .select('student_id')
            .eq('id', currentUser.username)
            .maybeSingle();

        if (!parent) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìà Exam Results</h3>
                    <p style="color: #e74c3c;">Parent information not found.</p>
                </div>
            `;
            return;
        }

        // Get student info
        const { data: student } = await client
            .from('students')
            .select('name')
            .eq('id', parent.student_id)
            .maybeSingle();

        // Get exam results for student
        const { data: results } = await client
            .from('exam_results')
            .select('*')
            .eq('student_id', parent.student_id)
            .order('created_at', { ascending: false });

        contentArea.innerHTML = `
            <div class="card">
                <h3>üìà Exam Results - ${student?.name || 'Student'}</h3>

                ${results && results.length > 0 ? `
                    <table style="width: 100%; margin-top: 20px;">
                        <thead>
                            <tr>
                                <th>Exam Name</th>
                                <th>Subject</th>
                                <th>Marks Obtained</th>
                                <th>Total Marks</th>
                                <th>Percentage</th>
                                <th>Grade</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map(result => {
                                const percentage = result.total_marks > 0
                                    ? ((result.marks / result.total_marks) * 100).toFixed(2)
                                    : 'N/A';
                                return `
                                    <tr>
                                        <td><strong>${result.exam_name}</strong></td>
                                        <td>${result.subject}</td>
                                        <td>${result.marks}</td>
                                        <td>${result.total_marks}</td>
                                        <td>${percentage}%</td>
                                        <td><span class="badge badge-${result.grade || 'normal'}">${result.grade || 'N/A'}</span></td>
                                        <td>${result.remarks || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                ` : '<p style="margin-top: 20px; color: #666;">No exam results available yet.</p>'}
            </div>
        `;
    } catch (error) {
        console.error('Error loading exam results:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìà Exam Results</h3>
                <p style="color: #e74c3c;">Error loading exam results. Please try again.</p>
            </div>
        `;
    }
}

async function renderViewReportCards() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        // Get parent's student
        const { data: parent } = await client
            .from('parents')
            .select('student_id')
            .eq('id', currentUser.username)
            .maybeSingle();

        if (!parent) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìÑ Report Cards</h3>
                    <p style="color: #e74c3c;">Parent information not found.</p>
                </div>
            `;
            return;
        }

        // Get student info
        const { data: student } = await client
            .from('students')
            .select('name, class')
            .eq('id', parent.student_id)
            .maybeSingle();

        // Get report cards for student
        const { data: reportCards } = await client
            .from('report_cards')
            .select('*')
            .eq('student_id', parent.student_id)
            .order('created_at', { ascending: false });

        contentArea.innerHTML = `
            <div class="card">
                <h3>üìÑ Report Cards - ${student?.name || 'Student'} (${student?.class || ''})</h3>

                ${reportCards && reportCards.length > 0 ? `
                    <div style="margin-top: 20px;">
                        ${reportCards.map(card => `
                            <div style="border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 8px; background: #f9f9f9;">
                                <h4 style="margin-top: 0;">${card.term} - ${card.academic_year}</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                    <div>
                                        <strong>Overall Percentage:</strong>
                                        <div style="font-size: 24px; color: var(--color-primary); margin-top: 5px;">
                                            ${card.overall_percentage ? card.overall_percentage + '%' : 'N/A'}
                                        </div>
                                    </div>
                                    <div>
                                        <strong>Overall Grade:</strong>
                                        <div style="font-size: 24px; color: var(--color-primary); margin-top: 5px;">
                                            ${card.overall_grade || 'N/A'}
                                        </div>
                                    </div>
                                </div>
                                ${card.remarks ? `
                                    <div style="margin-top: 15px;">
                                        <strong>Remarks:</strong>
                                        <p style="margin: 5px 0 0 0;">${card.remarks}</p>
                                    </div>
                                ` : ''}
                                <div style="margin-top: 15px; color: #666; font-size: 0.9em;">
                                    Generated on: ${new Date(card.created_at).toLocaleDateString()}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : '<p style="margin-top: 20px; color: #666;">No report cards available yet.</p>'}
            </div>
        `;
    } catch (error) {
        console.error('Error loading report cards:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìÑ Report Cards</h3>
                <p style="color: #e74c3c;">Error loading report cards. Please try again.</p>
            </div>
        `;
    }
}

async function renderExamSchedule() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        // Get parent's student
        const { data: parent } = await client
            .from('parents')
            .select('student_id')
            .eq('id', currentUser.username)
            .maybeSingle();

        if (!parent) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìÖ Exam Schedule</h3>
                    <p style="color: #e74c3c;">Parent information not found.</p>
                </div>
            `;
            return;
        }

        // Get student's class
        const { data: student } = await client
            .from('students')
            .select('class, name')
            .eq('id', parent.student_id)
            .maybeSingle();

        if (!student) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìÖ Exam Schedule</h3>
                    <p style="color: #e74c3c;">Student information not found.</p>
                </div>
            `;
            return;
        }

        // Get exam schedules for student's class
        const { data: exams } = await client
            .from('exam_schedules')
            .select('*')
            .eq('class', student.class)
            .order('date', { ascending: true });

        const today = new Date();
        const upcomingExams = exams?.filter(exam => new Date(exam.date) >= today) || [];
        const pastExams = exams?.filter(exam => new Date(exam.date) < today) || [];

        contentArea.innerHTML = `
            <div class="card">
                <h3>üìÖ Exam Schedule - ${student.name} (${student.class})</h3>

                ${upcomingExams.length > 0 ? `
                    <div style="margin-top: 20px;">
                        <h4>Upcoming Exams</h4>
                        <table style="width: 100%; margin-top: 15px;">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Exam Name</th>
                                    <th>Subject</th>
                                    <th>Time</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${upcomingExams.map(exam => `
                                    <tr style="background: #e8f5e9;">
                                        <td><strong>${new Date(exam.date).toLocaleDateString()}</strong></td>
                                        <td>${exam.exam_name}</td>
                                        <td>${exam.subject}</td>
                                        <td>${exam.time || 'TBA'}</td>
                                        <td>${exam.duration || 'TBA'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : ''}

                ${pastExams.length > 0 ? `
                    <div style="margin-top: 30px;">
                        <h4>Past Exams</h4>
                        <table style="width: 100%; margin-top: 15px;">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Exam Name</th>
                                    <th>Subject</th>
                                    <th>Time</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pastExams.map(exam => `
                                    <tr style="opacity: 0.6;">
                                        <td>${new Date(exam.date).toLocaleDateString()}</td>
                                        <td>${exam.exam_name}</td>
                                        <td>${exam.subject}</td>
                                        <td>${exam.time || 'TBA'}</td>
                                        <td>${exam.duration || 'TBA'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : ''}

                ${!exams || exams.length === 0 ? '<p style="margin-top: 20px; color: #666;">No exam schedules available yet.</p>' : ''}
            </div>
        `;
    } catch (error) {
        console.error('Error loading exam schedule:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìÖ Exam Schedule</h3>
                <p style="color: #e74c3c;">Error loading exam schedule. Please try again.</p>
            </div>
        `;
    }
}

async function renderTimetable() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        showLoading();

        let className = '';

        // Determine the class based on user role
        if (currentUser.role === 'parent') {
            // Get parent's student class
            const { data: parent } = await client
                .from('parents')
                .select('student_id')
                .eq('id', currentUser.username)
                .maybeSingle();

            if (parent) {
                const { data: student } = await client
                    .from('students')
                    .select('class')
                    .eq('id', parent.student_id)
                    .maybeSingle();
                className = student?.class || '';
            }
        } else if (currentUser.role === 'classteacher') {
            // Get class teacher's class
            const { data: classTeacher } = await client
                .from('class_teachers')
                .select('class')
                .eq('id', currentUser.username)
                .maybeSingle();
            className = classTeacher?.class || '';
        } else if (currentUser.role === 'teacher') {
            // For teachers, get all classes
            const { data: classes } = await client
                .from('classes')
                .select('name')
                .order('name');

            hideLoading();

            contentArea.innerHTML = `
                <div class="card">
                    <h3>üóìÔ∏è Class Timetable</h3>
                    <p style="margin-bottom: 20px; color: #666;">Select a class to view its timetable</p>

                    <div class="form-group" style="max-width: 300px;">
                        <label>Select Class</label>
                        <select id="classSelect" class="form-control" onchange="showClassTimetable(this.value)">
                            <option value="">-- Select Class --</option>
                            ${classes?.map(c => `<option value="${c.name}">${c.name}</option>`).join('') || ''}
                        </select>
                    </div>

                    <div id="timetableContent"></div>
                </div>
            `;
            return;
        }

        // Fetch timetable for the class
        const { data: timetable } = await client
            .from('timetables')
            .select('*')
            .eq('class', className)
            .maybeSingle();

        hideLoading();

        contentArea.innerHTML = `
            <div class="card">
                <h3>üóìÔ∏è Class Timetable</h3>
                <p style="margin-bottom: 20px; color: #666;">Class: ${className}</p>

                ${timetable && timetable.periods ? `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; min-width: 600px;">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Monday</th>
                                    <th>Tuesday</th>
                                    <th>Wednesday</th>
                                    <th>Thursday</th>
                                    <th>Friday</th>
                                    <th>Saturday</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.keys(timetable.periods || {}).map(period => `
                                    <tr>
                                        <td><strong>${period}</strong></td>
                                        <td>${timetable.periods[period].monday || '-'}</td>
                                        <td>${timetable.periods[period].tuesday || '-'}</td>
                                        <td>${timetable.periods[period].wednesday || '-'}</td>
                                        <td>${timetable.periods[period].thursday || '-'}</td>
                                        <td>${timetable.periods[period].friday || '-'}</td>
                                        <td>${timetable.periods[period].saturday || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 30px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px;">üìö Notes</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #666;">
                            <li>School timings: 8:00 AM - 3:30 PM</li>
                            <li>Lunch break: 12:30 PM - 1:15 PM</li>
                            <li>Each period: 45 minutes</li>
                        </ul>
                    </div>
                ` : '<p style="margin-top: 15px; color: #666;">No timetable found for this class. Please contact your coordinator.</p>'}
            </div>
        `;
    } catch (error) {
        hideLoading();
        console.error('Error loading timetable:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üóìÔ∏è Class Timetable</h3>
                <p style="color: #e74c3c;">Error loading timetable. Please try again.</p>
            </div>
        `;
    }
}

// Function to show timetable for a selected class (for teachers)
window.showClassTimetable = async function(className) {
    if (!className) {
        document.getElementById('timetableContent').innerHTML = '';
        return;
    }

    const client = window.supabaseClient.getClient();

    const { data: timetable } = await client
        .from('timetables')
        .select('*')
        .eq('class', className)
        .maybeSingle();

    document.getElementById('timetableContent').innerHTML = `
        <div style="margin-top: 30px;">
            <h4>Timetable for ${className}</h4>
            ${timetable && timetable.periods ? `
                <div style="overflow-x: auto; margin-top: 15px;">
                    <table style="width: 100%; min-width: 600px;">
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th>Monday</th>
                                <th>Tuesday</th>
                                <th>Wednesday</th>
                                <th>Thursday</th>
                                <th>Friday</th>
                                <th>Saturday</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.keys(timetable.periods || {}).map(period => `
                                <tr>
                                    <td><strong>${period}</strong></td>
                                    <td>${timetable.periods[period].monday || '-'}</td>
                                    <td>${timetable.periods[period].tuesday || '-'}</td>
                                    <td>${timetable.periods[period].wednesday || '-'}</td>
                                    <td>${timetable.periods[period].thursday || '-'}</td>
                                    <td>${timetable.periods[period].friday || '-'}</td>
                                    <td>${timetable.periods[period].saturday || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : '<p style="margin-top: 15px;">No timetable found for this class.</p>'}
        </div>
    `;
};

function renderProfile() {
    const currentUser = window.auth.getCurrentUser();
    const contentArea = document.getElementById('contentArea');

    contentArea.innerHTML = `
        <div class="card">
            <h3>Profile Information</h3>
            <div class="form-section">
                <div class="form-row">
                    <div class="form-control">
                        <label>Name</label>
                        <input type="text" value="${currentUser.name || ''}" readonly>
                    </div>
                    <div class="form-control">
                        <label>Username</label>
                        <input type="text" value="${currentUser.username}" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-control">
                        <label>Role</label>
                        <input type="text" value="${formatRole(currentUser.role)}" readonly>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderChangePassword() {
    const contentArea = document.getElementById('contentArea');

    contentArea.innerHTML = `
        <div class="card">
            <h3>Change Password</h3>
            <form id="changePasswordForm" class="form-section">
                <div class="form-row">
                    <div class="form-control">
                        <label>Current Password</label>
                        <input type="password" id="currentPassword" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-control">
                        <label>New Password</label>
                        <input type="password" id="newPassword" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-control">
                        <label>Confirm New Password</label>
                        <input type="password" id="confirmPassword" required>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn-primary">Change Password</button>
                    <button type="button" class="btn-secondary" onclick="renderTab('home')">Cancel</button>
                </div>
            </form>
        </div>
    `;

    // Add form submit handler
    document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            showModal('Error', 'New passwords do not match', 'error');
            return;
        }

        try {
            showLoading();
            await window.auth.changePassword(currentPassword, newPassword);
            hideLoading();
            showModal('Success', 'Password changed successfully', 'success');
            renderTab('home');
        } catch (error) {
            hideLoading();
            showModal('Error', error.message || 'Failed to change password', 'error');
        }
    });
}

// Teacher tab functions
async function renderMyDuties() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        // Get duties for current teacher
        const { data: duties } = await client
            .from('teacher_duties')
            .select('*')
            .eq('teacher_id', currentUser.username)
            .order('duty_date', { ascending: true });

        const today = new Date();
        const upcomingDuties = duties?.filter(duty => new Date(duty.duty_date) >= today) || [];
        const pastDuties = duties?.filter(duty => new Date(duty.duty_date) < today) || [];

        contentArea.innerHTML = `
            <div class="card">
                <h3>üìã My Duties</h3>

                ${upcomingDuties.length > 0 ? `
                    <div style="margin-top: 20px;">
                        <h4>Upcoming Duties</h4>
                        <table style="width: 100%; margin-top: 15px;">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Duty Name</th>
                                    <th>Time</th>
                                    <th>Location</th>
                                    <th>Assigned By</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${upcomingDuties.map(duty => `
                                    <tr style="background: #e8f5e9;">
                                        <td><strong>${new Date(duty.duty_date).toLocaleDateString()}</strong></td>
                                        <td>${duty.duty_name}</td>
                                        <td>${duty.duty_time || 'N/A'}</td>
                                        <td>${duty.location || 'N/A'}</td>
                                        <td>${duty.assigned_by || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : '<p style="margin-top: 20px; color: #666;">No upcoming duties.</p>'}

                ${pastDuties.length > 0 ? `
                    <div style="margin-top: 30px;">
                        <h4>Past Duties</h4>
                        <table style="width: 100%; margin-top: 15px;">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Duty Name</th>
                                    <th>Time</th>
                                    <th>Location</th>
                                    <th>Assigned By</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pastDuties.map(duty => `
                                    <tr style="opacity: 0.6;">
                                        <td>${new Date(duty.duty_date).toLocaleDateString()}</td>
                                        <td>${duty.duty_name}</td>
                                        <td>${duty.duty_time || 'N/A'}</td>
                                        <td>${duty.location || 'N/A'}</td>
                                        <td>${duty.assigned_by || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : ''}
            </div>
        `;
    } catch (error) {
        console.error('Error loading duties:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìã My Duties</h3>
                <p style="color: #e74c3c;">Error loading duties. Please try again.</p>
            </div>
        `;
    }
}

async function renderMarkAttendance() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    // Get all classes
    const { data: classes } = await client
        .from('classes')
        .select('*')
        .order('name');

    contentArea.innerHTML = `
        <div class="card">
            <h3>‚úÖ Mark Attendance</h3>

            <div style="margin-bottom: 30px;">
                <div class="form-group">
                    <label for="attendanceClass">Select Class</label>
                    <select id="attendanceClass">
                        <option value="">-- Select Class --</option>
                        ${classes?.map(c => `<option value="${c.name}">${c.name}</option>`).join('') || ''}
                    </select>
                </div>
                <div class="form-group">
                    <label for="attendanceDate">Date</label>
                    <input type="date" id="attendanceDate" value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="form-group">
                    <label for="attendancePeriod">Period</label>
                    <select id="attendancePeriod">
                        <option value="Period 1">Period 1</option>
                        <option value="Period 2">Period 2</option>
                        <option value="Period 3">Period 3</option>
                        <option value="Period 4">Period 4</option>
                        <option value="Period 5">Period 5</option>
                        <option value="Period 6">Period 6</option>
                        <option value="Period 7">Period 7</option>
                        <option value="Period 8">Period 8</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="loadStudentsForAttendance()">Load Students</button>
            </div>

            <div id="attendanceStudentsList"></div>
        </div>
    `;
}

window.loadStudentsForAttendance = async function() {
    const className = document.getElementById('attendanceClass').value;
    const date = document.getElementById('attendanceDate').value;
    const period = document.getElementById('attendancePeriod').value;

    if (!className) {
        showModal('Error', 'Please select a class', 'error');
        return;
    }

    const client = window.supabaseClient.getClient();

    // Get students in the class
    const { data: students } = await client
        .from('students')
        .select('*')
        .eq('class', className)
        .eq('status', 'active')
        .order('name');

    if (!students || students.length === 0) {
        document.getElementById('attendanceStudentsList').innerHTML = '<p>No students found in this class.</p>';
        return;
    }

    // Get existing attendance for this date and period
    const { data: existingAttendance } = await client
        .from('attendance')
        .select('*')
        .eq('date', date)
        .eq('period', period)
        .in('student_id', students.map(s => s.id));

    const attendanceMap = {};
    existingAttendance?.forEach(att => {
        attendanceMap[att.student_id] = att;
    });

    document.getElementById('attendanceStudentsList').innerHTML = `
        <h4>Students in ${className}</h4>
        <form id="attendanceForm">
            <table style="width: 100%; margin-top: 15px;">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Behavior</th>
                    </tr>
                </thead>
                <tbody>
                    ${students.map(student => {
                        const att = attendanceMap[student.id];
                        return `
                            <tr>
                                <td>${student.id}</td>
                                <td>${student.name}</td>
                                <td>
                                    <select class="attendance-status" data-student-id="${student.id}">
                                        <option value="present" ${att?.type === 'present' ? 'selected' : ''}>Present</option>
                                        <option value="absent" ${att?.type === 'absent' ? 'selected' : ''}>Absent</option>
                                        <option value="late" ${att?.type === 'late' ? 'selected' : ''}>Late</option>
                                    </select>
                                </td>
                                <td>
                                    <select class="attendance-behavior" data-student-id="${student.id}">
                                        <option value="excellent" ${att?.behavior === 'excellent' ? 'selected' : ''}>Excellent</option>
                                        <option value="good" ${att?.behavior === 'good' || !att ? 'selected' : ''}>Good</option>
                                        <option value="distracting" ${att?.behavior === 'distracting' ? 'selected' : ''}>Distracting</option>
                                    </select>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
            <div style="margin-top: 20px;">
                <button type="submit" class="btn-primary">Submit Attendance</button>
            </div>
        </form>
    `;

    document.getElementById('attendanceForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await submitAttendance(students, date, period);
    });
};

async function submitAttendance(students, date, period) {
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    const attendanceRecords = students.map(student => {
        const statusSelect = document.querySelector(`.attendance-status[data-student-id="${student.id}"]`);
        const behaviorSelect = document.querySelector(`.attendance-behavior[data-student-id="${student.id}"]`);

        return {
            student_id: student.id,
            date: date,
            period: period,
            type: statusSelect.value,
            behavior: behaviorSelect.value,
            marked_by: currentUser.username
        };
    });

    try {
        showLoading();

        // Delete existing attendance for this date/period/students
        await client
            .from('attendance')
            .delete()
            .eq('date', date)
            .eq('period', period)
            .in('student_id', students.map(s => s.id));

        // Insert new attendance records
        const { error } = await client
            .from('attendance')
            .insert(attendanceRecords);

        if (error) throw error;

        hideLoading();
        showModal('Success', 'Attendance submitted successfully!', 'success');
    } catch (error) {
        hideLoading();
        showModal('Error', error.message || 'Failed to submit attendance', 'error');
    }
}

async function renderHomework() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();
    const currentUser = window.auth.getCurrentUser();

    // Get all classes
    const { data: classes } = await client
        .from('classes')
        .select('*')
        .order('name');

    // Get existing homework assigned by this teacher
    const { data: homeworkList } = await client
        .from('homework')
        .select('*')
        .eq('assigned_by', currentUser.username)
        .order('date', { ascending: false })
        .limit(20);

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìù Homework Management</h3>

            <h4>Assign New Homework</h4>
            <form id="homeworkForm" style="max-width: 600px; margin-bottom: 40px;">
                <div class="form-group">
                    <label for="hwClass">Class</label>
                    <select id="hwClass" required>
                        <option value="">-- Select Class --</option>
                        ${classes?.map(c => `<option value="${c.name}">${c.name}</option>`).join('') || ''}
                    </select>
                </div>
                <div class="form-group">
                    <label for="hwSubject">Subject</label>
                    <input type="text" id="hwSubject" placeholder="e.g., Mathematics" required>
                </div>
                <div class="form-group">
                    <label for="hwTitle">Title</label>
                    <input type="text" id="hwTitle" placeholder="e.g., Chapter 5 Exercises" required>
                </div>
                <div class="form-group">
                    <label for="hwDescription">Description</label>
                    <textarea id="hwDescription" rows="3" placeholder="Details about the homework"></textarea>
                </div>
                <div class="form-group">
                    <label for="hwDate">Assigned Date</label>
                    <input type="date" id="hwDate" value="${new Date().toISOString().split('T')[0]}" required>
                </div>
                <div class="form-group">
                    <label for="hwDueDate">Due Date</label>
                    <input type="date" id="hwDueDate">
                </div>
                <button type="submit" class="btn-primary">Assign Homework</button>
            </form>

            <h4>Recently Assigned Homework</h4>
            ${homeworkList && homeworkList.length > 0 ? `
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Class</th>
                            <th>Subject</th>
                            <th>Title</th>
                            <th>Due Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${homeworkList.map(hw => `
                            <tr>
                                <td>${new Date(hw.date).toLocaleDateString()}</td>
                                <td>${hw.class}</td>
                                <td>${hw.subject}</td>
                                <td>${hw.title}</td>
                                <td>${hw.due_date ? new Date(hw.due_date).toLocaleDateString() : 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p style="margin-top: 15px;">No homework assigned yet.</p>'}
        </div>
    `;

    document.getElementById('homeworkForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const homeworkData = {
            class: document.getElementById('hwClass').value,
            subject: document.getElementById('hwSubject').value,
            title: document.getElementById('hwTitle').value,
            description: document.getElementById('hwDescription').value,
            date: document.getElementById('hwDate').value,
            due_date: document.getElementById('hwDueDate').value || null,
            assigned_by: currentUser.username
        };

        try {
            showLoading();
            const { error } = await client
                .from('homework')
                .insert([homeworkData]);

            if (error) throw error;

            hideLoading();
            showModal('Success', 'Homework assigned successfully!', 'success');
            renderHomework(); // Refresh the page
        } catch (error) {
            hideLoading();
            showModal('Error', error.message || 'Failed to assign homework', 'error');
        }
    });
}

async function renderExamResults() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    // Get all exam results
    const { data: results } = await client
        .from('exam_results')
        .select('*, students(name, class)')
        .order('created_at', { ascending: false })
        .limit(100);

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìä Exam Results</h3>

            ${results && results.length > 0 ? `
                <table style="width: 100%; margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Student Name</th>
                            <th>Class</th>
                            <th>Exam</th>
                            <th>Subject</th>
                            <th>Marks</th>
                            <th>Grade</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results.map(result => `
                            <tr>
                                <td>${result.student_id}</td>
                                <td>${result.students?.name || 'N/A'}</td>
                                <td>${result.students?.class || 'N/A'}</td>
                                <td>${result.exam_name}</td>
                                <td>${result.subject}</td>
                                <td>${result.marks}/${result.total_marks}</td>
                                <td><span class="badge">${result.grade || 'N/A'}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p style="margin-top: 20px;">No exam results available.</p>'}
        </div>
    `;
}

async function renderUploadMarks() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    // Get all classes
    const { data: classes } = await client
        .from('classes')
        .select('*')
        .order('name');

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìà Upload Marks</h3>

            <form id="uploadMarksForm" style="max-width: 600px;">
                <div class="form-group">
                    <label for="marksClass">Class</label>
                    <select id="marksClass" required>
                        <option value="">-- Select Class --</option>
                        ${classes?.map(c => `<option value="${c.name}">${c.name}</option>`).join('') || ''}
                    </select>
                </div>
                <div class="form-group">
                    <label for="marksExam">Exam Name</label>
                    <input type="text" id="marksExam" placeholder="e.g., Mid-term 2024" required>
                </div>
                <div class="form-group">
                    <label for="marksSubject">Subject</label>
                    <input type="text" id="marksSubject" placeholder="e.g., Mathematics" required>
                </div>
                <div class="form-group">
                    <label for="marksTotalMarks">Total Marks</label>
                    <input type="number" id="marksTotalMarks" placeholder="e.g., 100" required>
                </div>
                <button type="button" class="btn-primary" onclick="loadStudentsForMarks()">Load Students</button>
            </form>

            <div id="marksStudentsList"></div>
        </div>
    `;
}

window.loadStudentsForMarks = async function() {
    const className = document.getElementById('marksClass').value;
    const examName = document.getElementById('marksExam').value;
    const subject = document.getElementById('marksSubject').value;
    const totalMarks = document.getElementById('marksTotalMarks').value;

    if (!className || !examName || !subject || !totalMarks) {
        showModal('Error', 'Please fill all fields', 'error');
        return;
    }

    const client = window.supabaseClient.getClient();

    // Get students in the class
    const { data: students } = await client
        .from('students')
        .select('*')
        .eq('class', className)
        .eq('status', 'active')
        .order('name');

    if (!students || students.length === 0) {
        document.getElementById('marksStudentsList').innerHTML = '<p>No students found in this class.</p>';
        return;
    }

    document.getElementById('marksStudentsList').innerHTML = `
        <h4 style="margin-top: 30px;">Enter Marks for ${className} - ${subject}</h4>
        <form id="marksSubmitForm">
            <table style="width: 100%; margin-top: 15px;">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Marks Obtained</th>
                        <th>Grade</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody>
                    ${students.map(student => `
                        <tr>
                            <td>${student.id}</td>
                            <td>${student.name}</td>
                            <td>
                                <input type="number" class="marks-input" data-student-id="${student.id}"
                                       min="0" max="${totalMarks}" style="width: 80px;">
                            </td>
                            <td>
                                <select class="grade-input" data-student-id="${student.id}">
                                    <option value="A+">A+</option>
                                    <option value="A">A</option>
                                    <option value="B+">B+</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                    <option value="F">F</option>
                                </select>
                            </td>
                            <td>
                                <input type="text" class="remarks-input" data-student-id="${student.id}"
                                       style="width: 150px;" placeholder="Optional">
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div style="margin-top: 20px;">
                <button type="submit" class="btn-primary">Submit All Marks</button>
            </div>
        </form>
    `;

    document.getElementById('marksSubmitForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await submitMarks(students, examName, subject, totalMarks);
    });
};

async function submitMarks(students, examName, subject, totalMarks) {
    const client = window.supabaseClient.getClient();

    const marksRecords = students.map(student => {
        const marksInput = document.querySelector(`.marks-input[data-student-id="${student.id}"]`);
        const gradeInput = document.querySelector(`.grade-input[data-student-id="${student.id}"]`);
        const remarksInput = document.querySelector(`.remarks-input[data-student-id="${student.id}"]`);

        if (!marksInput.value) return null;

        return {
            student_id: student.id,
            exam_name: examName,
            subject: subject,
            marks: parseFloat(marksInput.value),
            total_marks: parseFloat(totalMarks),
            grade: gradeInput.value,
            remarks: remarksInput.value || null
        };
    }).filter(r => r !== null);

    if (marksRecords.length === 0) {
        showModal('Error', 'Please enter marks for at least one student', 'error');
        return;
    }

    try {
        showLoading();

        const { error } = await client
            .from('exam_results')
            .insert(marksRecords);

        if (error) throw error;

        hideLoading();
        showModal('Success', `Marks uploaded successfully for ${marksRecords.length} students!`, 'success');
        renderUploadMarks(); // Refresh
    } catch (error) {
        hideLoading();
        showModal('Error', error.message || 'Failed to upload marks', 'error');
    }
}

async function renderMyClasses() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();
    const currentUser = window.auth.getCurrentUser();

    // Get teacher info
    const { data: teacher } = await client
        .from('teachers')
        .select('*')
        .eq('id', currentUser.username)
        .maybeSingle();

    contentArea.innerHTML = `
        <div class="card">
            <h3>üë• My Classes</h3>

            ${teacher ? `
                <div style="margin-top: 20px;">
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-control">
                                <label>Subjects</label>
                                <input type="text" value="${teacher.subjects || 'N/A'}" readonly>
                            </div>
                            <div class="form-control">
                                <label>Classes</label>
                                <input type="text" value="${teacher.classes || 'N/A'}" readonly>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <h4>Classes Assigned to You:</h4>
                        <p style="margin-top: 10px;">${teacher.classes || 'No classes assigned yet'}</p>
                    </div>

                    <div style="margin-top: 20px;">
                        <h4>Subjects You Teach:</h4>
                        <p style="margin-top: 10px;">${teacher.subjects || 'No subjects assigned yet'}</p>
                    </div>
                </div>
            ` : '<p style="margin-top: 20px;">Teacher information not found.</p>'}
        </div>
    `;
}

async function renderTeacherIssues() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();
    const currentUser = window.auth.getCurrentUser();

    // Get issues reported by this teacher
    const { data: issues } = await client
        .from('issues')
        .select('*')
        .eq('reported_by', currentUser.username)
        .order('created_at', { ascending: false });

    contentArea.innerHTML = `
        <div class="card">
            <h3>‚ö†Ô∏è My Issues</h3>

            <button class="btn-primary" onclick="showCreateTeacherIssue()" style="margin-bottom: 20px;">+ Report New Issue</button>

            <div id="createIssueForm" style="display: none; margin-bottom: 30px;">
                <h4>Report New Issue</h4>
                <form id="issueForm" style="max-width: 600px;">
                    <div class="form-group">
                        <label for="issueTitle">Title</label>
                        <input type="text" id="issueTitle" placeholder="Brief description" required>
                    </div>
                    <div class="form-group">
                        <label for="issueDescription">Description</label>
                        <textarea id="issueDescription" rows="4" placeholder="Detailed description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="issuePriority">Priority</label>
                        <select id="issuePriority">
                            <option value="low">Low</option>
                            <option value="normal" selected>Normal</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary">Submit Issue</button>
                    <button type="button" class="btn-secondary" onclick="document.getElementById('createIssueForm').style.display='none'">Cancel</button>
                </form>
            </div>

            ${issues && issues.length > 0 ? `
                <div>
                    ${issues.map(issue => `
                        <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                            <h4 style="margin-top: 0;">${issue.title}</h4>
                            <p>${issue.description || 'No description'}</p>
                            <div style="margin-top: 10px;">
                                <span class="badge badge-${issue.priority}">${issue.priority}</span>
                                <span class="badge badge-${issue.status}">${issue.status}</span>
                                <span style="color: #666; font-size: 0.9em; margin-left: 10px;">
                                    Created: ${new Date(issue.created_at).toLocaleDateString()}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '<p style="margin-top: 20px;">No issues reported yet.</p>'}
        </div>
    `;

    const form = document.getElementById('issueForm');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const issueData = {
                title: document.getElementById('issueTitle').value,
                description: document.getElementById('issueDescription').value,
                priority: document.getElementById('issuePriority').value,
                reported_by: currentUser.username,
                status: 'pending'
            };

            try {
                showLoading();
                const { error } = await client
                    .from('issues')
                    .insert([issueData]);

                if (error) throw error;

                hideLoading();
                showModal('Success', 'Issue reported successfully!', 'success');
                renderTeacherIssues(); // Refresh
            } catch (error) {
                hideLoading();
                showModal('Error', error.message || 'Failed to report issue', 'error');
            }
        });
    }
}

window.showCreateTeacherIssue = function() {
    document.getElementById('createIssueForm').style.display = 'block';
};

// Coordinator tab functions
async function renderCoordIssues() {
    // Use the same issues management as VP
    await renderVPIssues();
}

async function renderUploadExam() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    // Get all classes
    const { data: classes } = await client
        .from('classes')
        .select('*')
        .order('name');

    // Get existing exams
    const { data: exams } = await client
        .from('exam_schedules')
        .select('*')
        .order('date', { ascending: false })
        .limit(20);

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìã Upload Exam Schedule</h3>

            <h4>Create New Exam</h4>
            <form id="examForm" style="max-width: 600px; margin-bottom: 40px;">
                <div class="form-group">
                    <label for="examClass">Class</label>
                    <select id="examClass" required>
                        <option value="">-- Select Class --</option>
                        ${classes?.map(c => `<option value="${c.name}">${c.name}</option>`).join('') || ''}
                    </select>
                </div>
                <div class="form-group">
                    <label for="examName">Exam Name</label>
                    <input type="text" id="examName" placeholder="e.g., Mid-term 2024" required>
                </div>
                <div class="form-group">
                    <label for="examSubject">Subject</label>
                    <input type="text" id="examSubject" placeholder="e.g., Mathematics" required>
                </div>
                <div class="form-group">
                    <label for="examDate">Date</label>
                    <input type="date" id="examDate" required>
                </div>
                <div class="form-group">
                    <label for="examTime">Time</label>
                    <input type="text" id="examTime" placeholder="e.g., 09:00 AM - 12:00 PM">
                </div>
                <div class="form-group">
                    <label for="examDuration">Duration</label>
                    <input type="text" id="examDuration" placeholder="e.g., 3 hours">
                </div>
                <button type="submit" class="btn-primary">Create Exam</button>
            </form>

            <h4>Recent Exams</h4>
            ${exams && exams.length > 0 ? `
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Class</th>
                            <th>Exam Name</th>
                            <th>Subject</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${exams.map(exam => `
                            <tr>
                                <td>${new Date(exam.date).toLocaleDateString()}</td>
                                <td>${exam.class}</td>
                                <td>${exam.exam_name}</td>
                                <td>${exam.subject}</td>
                                <td>${exam.time || 'TBA'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p style="margin-top: 15px;">No exams scheduled yet.</p>'}
        </div>
    `;

    document.getElementById('examForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const examData = {
            class: document.getElementById('examClass').value,
            exam_name: document.getElementById('examName').value,
            subject: document.getElementById('examSubject').value,
            date: document.getElementById('examDate').value,
            time: document.getElementById('examTime').value || null,
            duration: document.getElementById('examDuration').value || null
        };

        try {
            showLoading();
            const { error } = await client
                .from('exam_schedules')
                .insert([examData]);

            if (error) throw error;

            hideLoading();
            showModal('Success', 'Exam scheduled successfully!', 'success');
            renderUploadExam(); // Refresh
        } catch (error) {
            hideLoading();
            showModal('Error', error.message || 'Failed to schedule exam', 'error');
        }
    });
}

async function renderClasses() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    // Get all classes
    const { data: classes } = await client
        .from('classes')
        .select('*')
        .order('name');

    contentArea.innerHTML = `
        <div class="card">
            <h3>üë• Classes Management</h3>

            ${classes && classes.length > 0 ? `
                <table style="width: 100%; margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>Class Name</th>
                            <th>Grade</th>
                            <th>Section</th>
                            <th>Class Teacher</th>
                            <th>Total Students</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${classes.map(cls => `
                            <tr>
                                <td><strong>${cls.name}</strong></td>
                                <td>${cls.grade}</td>
                                <td>${cls.section}</td>
                                <td>${cls.class_teacher_id || 'Not Assigned'}</td>
                                <td>${cls.total_students}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p style="margin-top: 20px;">No classes found.</p>'}
        </div>
    `;
}

async function renderManageTimetable() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    // Get all classes
    const { data: classes } = await client
        .from('classes')
        .select('*')
        .order('name');

    contentArea.innerHTML = `
        <div class="card">
            <h3>üóìÔ∏è Manage Timetable</h3>

            <div class="form-group" style="max-width: 400px;">
                <label for="timetableClass">Select Class</label>
                <select id="timetableClass" onchange="loadTimetableForClass()">
                    <option value="">-- Select Class --</option>
                    ${classes?.map(c => `<option value="${c.name}">${c.name}</option>`).join('') || ''}
                </select>
            </div>

            <div id="timetableContent"></div>
        </div>
    `;
}

window.loadTimetableForClass = async function() {
    const className = document.getElementById('timetableClass').value;
    if (!className) {
        document.getElementById('timetableContent').innerHTML = '';
        return;
    }

    const client = window.supabaseClient.getClient();

    const { data: timetable } = await client
        .from('timetables')
        .select('*')
        .eq('class', className)
        .maybeSingle();

    document.getElementById('timetableContent').innerHTML = `
        <div style="margin-top: 30px;">
            <h4>Timetable for ${className}</h4>
            ${timetable ? `
                <p style="margin-top: 15px;">Timetable data (JSON format):</p>
                <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow: auto;">${JSON.stringify(timetable.periods, null, 2)}</pre>
                <p style="margin-top: 15px; color: #666;">Note: Timetable editing interface can be implemented here.</p>
            ` : '<p style="margin-top: 15px;">No timetable found for this class.</p>'}
        </div>
    `;
};

async function renderUploadCCA() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    // Get existing CCA events
    const { data: ccaEvents } = await client
        .from('cca_calendars')
        .select('*')
        .order('event_date', { ascending: false })
        .limit(20);

    contentArea.innerHTML = `
        <div class="card">
            <h3>üé® Upload CCA Events</h3>

            <h4>Create New CCA Event</h4>
            <form id="ccaForm" style="max-width: 600px; margin-bottom: 40px;">
                <div class="form-group">
                    <label for="ccaName">Event Name</label>
                    <input type="text" id="ccaName" placeholder="e.g., Annual Sports Day" required>
                </div>
                <div class="form-group">
                    <label for="ccaDate">Event Date</label>
                    <input type="date" id="ccaDate" required>
                </div>
                <div class="form-group">
                    <label for="ccaTime">Event Time</label>
                    <input type="text" id="ccaTime" placeholder="e.g., 9:00 AM - 4:00 PM">
                </div>
                <div class="form-group">
                    <label for="ccaLocation">Location</label>
                    <input type="text" id="ccaLocation" placeholder="e.g., School Auditorium">
                </div>
                <div class="form-group">
                    <label for="ccaDescription">Description</label>
                    <textarea id="ccaDescription" rows="3" placeholder="Event details"></textarea>
                </div>
                <button type="submit" class="btn-primary">Create Event</button>
            </form>

            <h4>Recent CCA Events</h4>
            ${ccaEvents && ccaEvents.length > 0 ? `
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Event Name</th>
                            <th>Time</th>
                            <th>Location</th>
                            <th>Created By</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${ccaEvents.map(event => `
                            <tr>
                                <td>${new Date(event.event_date).toLocaleDateString()}</td>
                                <td><strong>${event.event_name}</strong></td>
                                <td>${event.event_time || 'TBA'}</td>
                                <td>${event.location || 'TBA'}</td>
                                <td>${event.created_by || 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p style="margin-top: 15px;">No CCA events created yet.</p>'}
        </div>
    `;

    const currentUser = window.auth.getCurrentUser();
    document.getElementById('ccaForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const ccaData = {
            event_name: document.getElementById('ccaName').value,
            event_date: document.getElementById('ccaDate').value,
            event_time: document.getElementById('ccaTime').value || null,
            location: document.getElementById('ccaLocation').value || null,
            description: document.getElementById('ccaDescription').value || null,
            created_by: currentUser.username
        };

        try {
            showLoading();
            const { error } = await client
                .from('cca_calendars')
                .insert([ccaData]);

            if (error) throw error;

            hideLoading();
            showModal('Success', 'CCA event created successfully!', 'success');
            renderUploadCCA(); // Refresh
        } catch (error) {
            hideLoading();
            showModal('Error', error.message || 'Failed to create CCA event', 'error');
        }
    });
}

// Vice Principal tab functions

async function renderAppointTeacher() {
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = `
        <div class="card">
            <h3>üë®‚Äçüè´ Appoint Teacher</h3>
            <form id="appointTeacherForm" style="max-width: 600px;">
                <div class="form-group">
                    <label for="teacherId">Teacher ID</label>
                    <input type="text" id="teacherId" placeholder="e.g., T004" required>
                </div>

                <div class="form-group">
                    <label for="teacherName">Teacher Name</label>
                    <input type="text" id="teacherName" placeholder="Enter full name" required>
                </div>

                <div class="form-group">
                    <label for="subjects">Subjects (comma separated)</label>
                    <input type="text" id="subjects" placeholder="e.g., Mathematics, Physics" required>
                </div>

                <div class="form-group">
                    <label for="classes">Classes (comma separated)</label>
                    <input type="text" id="classes" placeholder="e.g., 8B, 10A" required>
                </div>

                <div class="form-group">
                    <label for="teacherPassword">Password</label>
                    <input type="password" id="teacherPassword" placeholder="Set login password" required>
                </div>

                <button type="submit" class="btn-primary">Appoint Teacher</button>
            </form>
        </div>
    `;

    document.getElementById('appointTeacherForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const teacherId = document.getElementById('teacherId').value.trim();
        const teacherName = document.getElementById('teacherName').value.trim();
        const subjects = document.getElementById('subjects').value.trim();
        const classes = document.getElementById('classes').value.trim();
        const password = document.getElementById('teacherPassword').value;

        try {
            showLoading();
            const client = window.supabaseClient.getClient();

            // Insert teacher
            const { error: teacherError } = await client
                .from('teachers')
                .insert([{
                    id: teacherId,
                    name: teacherName,
                    subjects: subjects,
                    classes: classes,
                    status: 'active'
                }]);

            if (teacherError) throw teacherError;

            // Create user account
            const { error: userError } = await client
                .from('users')
                .insert([{
                    username: teacherId,
                    password: password,
                    name: teacherName,
                    role: 'teacher'
                }]);

            if (userError) throw userError;

            hideLoading();
            showModal('Success', `Teacher ${teacherName} appointed successfully!`, 'success');
            document.getElementById('appointTeacherForm').reset();
        } catch (error) {
            hideLoading();
            showModal('Error', error.message || 'Failed to appoint teacher', 'error');
        }
    });
}

async function renderAssignDuties() {
    const contentArea = document.getElementById('contentArea');

    // Load teachers list
    const client = window.supabaseClient.getClient();
    const { data: teachers } = await client
        .from('teachers')
        .select('*')
        .eq('status', 'active')
        .order('name');

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìã Assign Duties</h3>
            <form id="assignDutyForm" style="max-width: 600px;">
                <div class="form-group">
                    <label for="dutyTeacher">Select Teacher</label>
                    <select id="dutyTeacher" required>
                        <option value="">-- Select Teacher --</option>
                        ${teachers.map(t => `<option value="${t.id}">${t.name} (${t.id})</option>`).join('')}
                    </select>
                </div>

                <div class="form-group">
                    <label for="dutyName">Duty Name</label>
                    <input type="text" id="dutyName" placeholder="e.g., Morning Assembly, Exam Invigilation" required>
                </div>

                <div class="form-group">
                    <label for="dutyDate">Duty Date</label>
                    <input type="date" id="dutyDate" required>
                </div>

                <div class="form-group">
                    <label for="dutyTime">Duty Time</label>
                    <input type="text" id="dutyTime" placeholder="e.g., 8:00 AM - 9:00 AM" required>
                </div>

                <div class="form-group">
                    <label for="dutyLocation">Location</label>
                    <input type="text" id="dutyLocation" placeholder="e.g., Main Hall, Class 8B">
                </div>

                <button type="submit" class="btn-primary">Assign Duty</button>
            </form>

            <div style="margin-top: 40px;">
                <h4>Recent Duty Assignments</h4>
                <div id="recentDuties">Loading...</div>
            </div>
        </div>
    `;

    // Load recent duties
    const { data: duties } = await client
        .from('teacher_duties')
        .select('*')
        .order('duty_date', { ascending: false })
        .limit(10);

    const recentDutiesDiv = document.getElementById('recentDuties');
    if (duties && duties.length > 0) {
        recentDutiesDiv.innerHTML = `
            <table style="width: 100%; margin-top: 15px;">
                <thead>
                    <tr>
                        <th>Teacher ID</th>
                        <th>Duty</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Location</th>
                    </tr>
                </thead>
                <tbody>
                    ${duties.map(d => `
                        <tr>
                            <td>${d.teacher_id}</td>
                            <td>${d.duty_name}</td>
                            <td>${new Date(d.duty_date).toLocaleDateString()}</td>
                            <td>${d.duty_time}</td>
                            <td>${d.location || 'N/A'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } else {
        recentDutiesDiv.innerHTML = '<p>No duties assigned yet.</p>';
    }

    document.getElementById('assignDutyForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const user = window.auth.getCurrentUser();
        const teacherId = document.getElementById('dutyTeacher').value;
        const dutyName = document.getElementById('dutyName').value;
        const dutyDate = document.getElementById('dutyDate').value;
        const dutyTime = document.getElementById('dutyTime').value;
        const location = document.getElementById('dutyLocation').value;

        try {
            showLoading();
            const { error } = await client
                .from('teacher_duties')
                .insert([{
                    teacher_id: teacherId,
                    duty_name: dutyName,
                    duty_date: dutyDate,
                    duty_time: dutyTime,
                    location: location,
                    assigned_by: user.username
                }]);

            if (error) throw error;

            hideLoading();
            showModal('Success', 'Duty assigned successfully!', 'success');
            renderAssignDuties(); // Refresh the page
        } catch (error) {
            hideLoading();
            showModal('Error', error.message || 'Failed to assign duty', 'error');
        }
    });
}

async function renderVPIssues() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    const { data: issues } = await client
        .from('issues')
        .select('*')
        .order('created_at', { ascending: false });

    contentArea.innerHTML = `
        <div class="card">
            <h3>‚ö†Ô∏è Issues Management</h3>

            <div style="margin-bottom: 20px;">
                <button class="btn-primary" onclick="showCreateIssueModal()">+ Create New Issue</button>
            </div>

            <div style="margin-bottom: 20px;">
                <button class="btn-filter" onclick="filterIssues('all')" id="filter-all">All (${issues.length})</button>
                <button class="btn-filter" onclick="filterIssues('pending')" id="filter-pending">Pending (${issues.filter(i => i.status === 'pending').length})</button>
                <button class="btn-filter" onclick="filterIssues('in_progress')" id="filter-in_progress">In Progress (${issues.filter(i => i.status === 'in_progress').length})</button>
                <button class="btn-filter" onclick="filterIssues('resolved')" id="filter-resolved">Resolved (${issues.filter(i => i.status === 'resolved').length})</button>
            </div>

            <div id="issuesList">
                ${issues.map(issue => `
                    <div class="issue-card" data-status="${issue.status}">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4>${issue.title}</h4>
                                <p style="color: #666; margin: 5px 0;">${issue.description || 'No description'}</p>
                                <div style="margin-top: 10px;">
                                    <span class="badge badge-${issue.priority}">${issue.priority}</span>
                                    <span class="badge badge-${issue.status}">${issue.status}</span>
                                    ${issue.reported_by ? `<span style="color: #666; font-size: 0.9em;">Reported by: ${issue.reported_by}</span>` : ''}
                                </div>
                            </div>
                            <div>
                                <select onchange="updateIssueStatus(${issue.id}, this.value)" style="padding: 5px;">
                                    <option value="pending" ${issue.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="in_progress" ${issue.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="resolved" ${issue.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                                    <option value="escalated" ${issue.status === 'escalated' ? 'selected' : ''}>Escalated</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>

        <style>
            .issue-card {
                border: 1px solid #ddd;
                padding: 15px;
                margin-bottom: 10px;
                border-radius: 8px;
                background: white;
            }
            .badge {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.85em;
                margin-right: 8px;
            }
            .badge-low { background: #d4edda; color: #155724; }
            .badge-normal { background: #cce5ff; color: #004085; }
            .badge-high { background: #fff3cd; color: #856404; }
            .badge-critical { background: #f8d7da; color: #721c24; }
            .badge-pending { background: #fff3cd; color: #856404; }
            .badge-in_progress { background: #cce5ff; color: #004085; }
            .badge-resolved { background: #d4edda; color: #155724; }
            .badge-escalated { background: #f8d7da; color: #721c24; }
            .btn-filter {
                padding: 8px 15px;
                margin-right: 10px;
                border: 1px solid #ddd;
                background: white;
                cursor: pointer;
                border-radius: 4px;
            }
            .btn-filter.active {
                background: var(--color-primary);
                color: white;
                border-color: var(--color-primary);
            }
        </style>
    `;
}

window.filterIssues = function(status) {
    const issues = document.querySelectorAll('.issue-card');
    document.querySelectorAll('.btn-filter').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`filter-${status}`).classList.add('active');

    issues.forEach(issue => {
        if (status === 'all') {
            issue.style.display = 'block';
        } else {
            issue.style.display = issue.dataset.status === status ? 'block' : 'none';
        }
    });
};

window.updateIssueStatus = async function(issueId, newStatus) {
    try {
        showLoading();
        const { error } = await window.supabaseClient.getClient()
            .from('issues')
            .update({ status: newStatus })
            .eq('id', issueId);

        if (error) throw error;

        hideLoading();
        showModal('Success', 'Issue status updated!', 'success');
        renderVPIssues();
    } catch (error) {
        hideLoading();
        showModal('Error', error.message, 'error');
    }
};

async function renderRemoveStudent() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    const { data: students } = await client
        .from('students')
        .select('*')
        .eq('status', 'active')
        .order('name');

    contentArea.innerHTML = `
        <div class="card">
            <h3>üö´ Remove Student (Mark Inactive)</h3>
            <p style="color: #e74c3c; margin-bottom: 20px;">‚ö†Ô∏è This will mark the student as inactive. Student data will be preserved.</p>

            <table style="width: 100%; margin-top: 20px;">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Class</th>
                        <th>Parent ID</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    ${students.map(s => `
                        <tr>
                            <td>${s.id}</td>
                            <td>${s.name}</td>
                            <td>${s.class}</td>
                            <td>${s.parent_id}</td>
                            <td>
                                <button class="btn-danger" onclick="removeStudent(${s.id}, '${s.name}')">Remove</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

window.removeStudent = async function(studentId, studentName) {
    showModal('Confirm Remove', `Are you sure you want to remove ${studentName}? Student will be marked as inactive.`, 'warning', true, async function() {
        try {
            showLoading();
            const { error } = await window.supabaseClient.getClient()
                .from('students')
                .update({ status: 'inactive' })
                .eq('id', studentId);

            if (error) throw error;

            hideLoading();
            showModal('Success', `${studentName} has been removed (marked inactive)`, 'success');
            renderRemoveStudent();
        } catch (error) {
            hideLoading();
            showModal('Error', error.message, 'error');
        }
    });
};

async function renderDeleteStudent() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    const { data: students } = await client
        .from('students')
        .select('*')
        .eq('status', 'removed')
        .order('name');

    contentArea.innerHTML = `
        <div class="card">
            <h3>‚ùå Delete Student (Permanent)</h3>
            <p style="color: #c0392b; margin-bottom: 20px; font-weight: bold;">‚ö†Ô∏è WARNING: This will PERMANENTLY delete the student. This action CANNOT be undone!</p>
            <p style="margin-bottom: 20px;">Only students marked as "removed" can be permanently deleted.</p>

            ${students.length > 0 ? `
                <table style="width: 100%; margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Name</th>
                            <th>Class</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${students.map(s => `
                            <tr>
                                <td>${s.id}</td>
                                <td>${s.name}</td>
                                <td>${s.class}</td>
                                <td><span class="badge badge-${s.status}">${s.status}</span></td>
                                <td>
                                    <button class="btn-danger" onclick="deleteStudentPermanent(${s.id}, '${s.name}')">Delete Permanently</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p>No students marked as "removed". Use "Remove Student" feature first to mark students for deletion.</p>'}
        </div>
    `;
}

window.deleteStudentPermanent = async function(studentId, studentName) {
    showModal('FINAL WARNING', `You are about to PERMANENTLY DELETE ${studentName}. This CANNOT be undone. Type "DELETE" to confirm.`, 'error', true, async function() {
        try {
            showLoading();
            const { error } = await window.supabaseClient.getClient()
                .from('students')
                .delete()
                .eq('id', studentId);

            if (error) throw error;

            hideLoading();
            showModal('Success', `${studentName} has been permanently deleted`, 'success');
            renderDeleteStudent();
        } catch (error) {
            hideLoading();
            showModal('Error', error.message, 'error');
        }
    });
};

async function renderHolidays() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    const { data: holidays } = await client
        .from('holidays')
        .select('*')
        .order('date', { ascending: true });

    contentArea.innerHTML = `
        <div class="card">
            <h3>üéâ Holidays Management</h3>

            <form id="addHolidayForm" style="max-width: 500px; margin-bottom: 30px;">
                <h4>Add New Holiday</h4>
                <div class="form-group">
                    <label for="holidayDate">Date</label>
                    <input type="date" id="holidayDate" required>
                </div>
                <div class="form-group">
                    <label for="holidayReason">Reason</label>
                    <input type="text" id="holidayReason" placeholder="e.g., Independence Day" required>
                </div>
                <button type="submit" class="btn-primary">Add Holiday</button>
            </form>

            <h4>Upcoming Holidays</h4>
            <table style="width: 100%; margin-top: 15px;">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Reason</th>
                        <th>Day</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    ${holidays.map(h => {
                        const date = new Date(h.date);
                        const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                        return `
                            <tr>
                                <td>${date.toLocaleDateString()}</td>
                                <td>${h.reason}</td>
                                <td>${dayName}</td>
                                <td>
                                    <button class="btn-danger" onclick="deleteHoliday('${h.date}')">Delete</button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;

    document.getElementById('addHolidayForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const date = document.getElementById('holidayDate').value;
        const reason = document.getElementById('holidayReason').value;

        try {
            showLoading();
            const { error } = await client
                .from('holidays')
                .insert([{ date, reason }]);

            if (error) throw error;

            hideLoading();
            showModal('Success', 'Holiday added successfully!', 'success');
            renderHolidays();
        } catch (error) {
            hideLoading();
            showModal('Error', error.message, 'error');
        }
    });
}

window.deleteHoliday = async function(date) {
    showModal('Confirm', 'Delete this holiday?', 'warning', true, async function() {
        try {
            showLoading();
            const { error } = await window.supabaseClient.getClient()
                .from('holidays')
                .delete()
                .eq('date', date);

            if (error) throw error;

            hideLoading();
            showModal('Success', 'Holiday deleted', 'success');
            renderHolidays();
        } catch (error) {
            hideLoading();
            showModal('Error', error.message, 'error');
        }
    });
};

async function renderRegister() {
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = `
        <div class="card">
            <h3>üìù Register New User</h3>

            <div style="margin-bottom: 20px;">
                <label>Select User Type:</label><br>
                <button class="btn-filter" onclick="showRegisterForm('student')" id="reg-student">Student</button>
                <button class="btn-filter" onclick="showRegisterForm('parent')" id="reg-parent">Parent</button>
                <button class="btn-filter" onclick="showRegisterForm('teacher')" id="reg-teacher">Teacher</button>
            </div>

            <div id="registerFormContainer"></div>
        </div>
    `;
}

window.showRegisterForm = function(userType) {
    document.querySelectorAll('.btn-filter').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`reg-${userType}`).classList.add('active');

    const container = document.getElementById('registerFormContainer');

    if (userType === 'student') {
        container.innerHTML = `
            <form id="registerForm" style="max-width: 600px;">
                <h4>Register Student</h4>
                <div class="form-group">
                    <label>Student ID</label>
                    <input type="number" id="studentId" required>
                </div>
                <div class="form-group">
                    <label>Student Name</label>
                    <input type="text" id="studentName" required>
                </div>
                <div class="form-group">
                    <label>Class</label>
                    <input type="text" id="studentClass" placeholder="e.g., 8B" required>
                </div>
                <div class="form-group">
                    <label>Parent ID</label>
                    <input type="text" id="parentId" placeholder="e.g., P3180076A" required>
                </div>
                <button type="submit" class="btn-primary">Register Student</button>
            </form>
        `;

        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const studentId = parseInt(document.getElementById('studentId').value);
            const studentName = document.getElementById('studentName').value.trim();
            const studentClass = document.getElementById('studentClass').value.trim();
            const parentId = document.getElementById('parentId').value.trim();

            // Validation
            if (!studentId || !studentName || !studentClass || !parentId) {
                showModal('Error', 'Please fill in all required fields.', 'error');
                return;
            }

            if (isNaN(studentId)) {
                showModal('Error', 'Student ID must be a valid number.', 'error');
                return;
            }

            try {
                showLoading();
                const client = window.supabaseClient.getClient();

                console.log('Starting student registration for:', studentId);

                // Check if student ID already exists
                console.log('Checking if student ID exists:', studentId);
                const { data: existingStudent, error: checkError } = await client
                    .from('students')
                    .select('id, name')
                    .eq('id', studentId)
                    .maybeSingle();

                if (checkError) {
                    console.error('Error checking student:', checkError);
                    throw new Error(`Error checking student: ${checkError.message}`);
                }

                if (existingStudent) {
                    console.log('Student ID already exists:', studentId);
                    hideLoading();
                    showModal('Error', `Student ID ${studentId} already exists (${existingStudent.name}). Please use a different Student ID.`, 'error');
                    return;
                }

                // Insert student
                console.log('Inserting student record...');
                const { data: studentData, error: insertError } = await client
                    .from('students')
                    .insert([{
                        id: studentId,
                        name: studentName,
                        class: studentClass,
                        parent_id: parentId,
                        status: 'active'
                    }])
                    .select();

                if (insertError) {
                    console.error('Error inserting student:', insertError);
                    throw new Error(`Failed to create student record: ${insertError.message}`);
                }
                console.log('Student record created:', studentData);

                hideLoading();
                showModal('Success', `Student registered successfully!\n\nStudent: ${studentName}\nID: ${studentId}\nClass: ${studentClass}\n\nNext: Register parent with ID: ${parentId}`, 'success');
                document.getElementById('registerForm').reset();
            } catch (error) {
                console.error('Registration failed:', error);
                hideLoading();
                showModal('Error', `Registration failed: ${error.message}`, 'error');
            }
        });
    } else if (userType === 'parent') {
        container.innerHTML = `
            <form id="registerForm" style="max-width: 600px;">
                <h4>Register Parent</h4>
                <div class="form-group">
                    <label>Parent ID</label>
                    <input type="text" id="parentId" placeholder="e.g., P3180076A" required>
                </div>
                <div class="form-group">
                    <label>Parent Name</label>
                    <input type="text" id="parentName" required>
                </div>
                <div class="form-group">
                    <label>Student ID</label>
                    <input type="number" id="studentId" required>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="phone" placeholder="10-digit number">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn-primary">Register Parent</button>
            </form>
        `;

        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const parentId = document.getElementById('parentId').value.trim();
            const parentName = document.getElementById('parentName').value.trim();
            const studentId = parseInt(document.getElementById('studentId').value);
            const phone = document.getElementById('phone').value.trim();
            const password = document.getElementById('password').value;

            // Validation
            if (!parentId || !parentName || !studentId || !password) {
                showModal('Error', 'Please fill in all required fields.', 'error');
                return;
            }

            if (isNaN(studentId)) {
                showModal('Error', 'Student ID must be a valid number.', 'error');
                return;
            }

            try {
                showLoading();
                const client = window.supabaseClient.getClient();

                console.log('Starting parent registration for:', parentId);

                // First, check if the student exists
                console.log('Checking if student exists:', studentId);
                const { data: studentExists, error: studentCheckError } = await client
                    .from('students')
                    .select('id, name, class')
                    .eq('id', studentId)
                    .maybeSingle();

                if (studentCheckError) {
                    console.error('Error checking student:', studentCheckError);
                    throw new Error(`Error checking student: ${studentCheckError.message}`);
                }

                if (!studentExists) {
                    console.log('Student not found:', studentId);
                    hideLoading();
                    showModal('Error', `Student with ID ${studentId} does not exist. Please register the student first.`, 'error');
                    return;
                }
                console.log('Student found:', studentExists);

                // Check if parent ID already exists
                console.log('Checking if parent ID exists:', parentId);
                const { data: existingParent, error: parentCheckError } = await client
                    .from('parents')
                    .select('id')
                    .eq('id', parentId)
                    .maybeSingle();

                if (parentCheckError) {
                    console.error('Error checking parent:', parentCheckError);
                    throw new Error(`Error checking parent: ${parentCheckError.message}`);
                }

                if (existingParent) {
                    console.log('Parent ID already exists:', parentId);
                    hideLoading();
                    showModal('Error', `Parent ID ${parentId} already exists. Please use a different Parent ID.`, 'error');
                    return;
                }

                // Check if username already exists
                console.log('Checking if username exists:', parentId);
                const { data: existingUser, error: userCheckError } = await client
                    .from('users')
                    .select('username')
                    .eq('username', parentId)
                    .maybeSingle();

                if (userCheckError) {
                    console.error('Error checking username:', userCheckError);
                    throw new Error(`Error checking username: ${userCheckError.message}`);
                }

                if (existingUser) {
                    console.log('Username already exists:', parentId);
                    hideLoading();
                    showModal('Error', `Username ${parentId} already exists. Please use a different Parent ID.`, 'error');
                    return;
                }

                // Insert parent
                console.log('Inserting parent record...');
                const { data: parentData, error: parentError } = await client
                    .from('parents')
                    .insert([{
                        id: parentId,
                        name: parentName,
                        student_id: studentId,
                        phone: phone || null
                    }])
                    .select();

                if (parentError) {
                    console.error('Error inserting parent:', parentError);
                    throw new Error(`Failed to create parent record: ${parentError.message}`);
                }
                console.log('Parent record created:', parentData);

                // Create user account
                console.log('Creating user account...');
                const { data: userData, error: userError } = await client
                    .from('users')
                    .insert([{
                        username: parentId,
                        password: password,
                        name: parentName,
                        role: 'parent'
                    }])
                    .select();

                if (userError) {
                    console.error('Error creating user account:', userError);
                    // Try to rollback parent creation
                    await client.from('parents').delete().eq('id', parentId);
                    throw new Error(`Failed to create user account: ${userError.message}`);
                }
                console.log('User account created:', userData);

                hideLoading();
                showModal('Success', `Parent registered successfully!\n\nParent: ${parentName}\nStudent: ${studentExists.name} (${studentExists.class})\nUsername: ${parentId}\nPassword: ${password}\n\nYou can now login with these credentials.`, 'success');
                document.getElementById('registerForm').reset();
            } catch (error) {
                console.error('Registration failed:', error);
                hideLoading();
                showModal('Error', `Registration failed: ${error.message}`, 'error');
            }
        });
    } else if (userType === 'teacher') {
        container.innerHTML = `
            <form id="registerForm" style="max-width: 600px;">
                <h4>Register Teacher</h4>
                <div class="form-group">
                    <label>Teacher ID</label>
                    <input type="text" id="teacherId" placeholder="e.g., T001" required>
                </div>
                <div class="form-group">
                    <label>Teacher Name</label>
                    <input type="text" id="teacherName" required>
                </div>
                <div class="form-group">
                    <label>Subjects</label>
                    <input type="text" id="subjects" placeholder="e.g., Mathematics, Physics" required>
                </div>
                <div class="form-group">
                    <label>Classes</label>
                    <input type="text" id="classes" placeholder="e.g., 8A, 9B, 10C">
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="phone" placeholder="10-digit number">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="teacher@school.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn-primary">Register Teacher</button>
            </form>
        `;

        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const teacherId = document.getElementById('teacherId').value.trim();
            const teacherName = document.getElementById('teacherName').value.trim();
            const subjects = document.getElementById('subjects').value.trim();
            const classes = document.getElementById('classes').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            // Validation
            if (!teacherId || !teacherName || !subjects || !password) {
                showModal('Error', 'Please fill in all required fields.', 'error');
                return;
            }

            try {
                showLoading();
                const client = window.supabaseClient.getClient();

                console.log('Starting teacher registration for:', teacherId);

                // Check if teacher ID already exists
                console.log('Checking if teacher ID exists:', teacherId);
                const { data: existingTeacher, error: teacherCheckError } = await client
                    .from('teachers')
                    .select('id, name')
                    .eq('id', teacherId)
                    .maybeSingle();

                if (teacherCheckError) {
                    console.error('Error checking teacher:', teacherCheckError);
                    throw new Error(`Error checking teacher: ${teacherCheckError.message}`);
                }

                if (existingTeacher) {
                    console.log('Teacher ID already exists:', teacherId);
                    hideLoading();
                    showModal('Error', `Teacher ID ${teacherId} already exists (${existingTeacher.name}). Please use a different Teacher ID.`, 'error');
                    return;
                }

                // Check if username already exists
                console.log('Checking if username exists:', teacherId);
                const { data: existingUser, error: userCheckError } = await client
                    .from('users')
                    .select('username')
                    .eq('username', teacherId)
                    .maybeSingle();

                if (userCheckError) {
                    console.error('Error checking username:', userCheckError);
                    throw new Error(`Error checking username: ${userCheckError.message}`);
                }

                if (existingUser) {
                    console.log('Username already exists:', teacherId);
                    hideLoading();
                    showModal('Error', `Username ${teacherId} already exists. Please use a different Teacher ID.`, 'error');
                    return;
                }

                // Insert teacher
                console.log('Inserting teacher record...');
                const { data: teacherData, error: teacherError } = await client
                    .from('teachers')
                    .insert([{
                        id: teacherId,
                        name: teacherName,
                        subjects: subjects,
                        classes: classes || null,
                        phone: phone || null,
                        email: email || null
                    }])
                    .select();

                if (teacherError) {
                    console.error('Error inserting teacher:', teacherError);
                    throw new Error(`Failed to create teacher record: ${teacherError.message}`);
                }
                console.log('Teacher record created:', teacherData);

                // Create user account
                console.log('Creating user account...');
                const { data: userData, error: userError } = await client
                    .from('users')
                    .insert([{
                        username: teacherId,
                        password: password,
                        name: teacherName,
                        role: 'teacher'
                    }])
                    .select();

                if (userError) {
                    console.error('Error creating user account:', userError);
                    // Try to rollback teacher creation
                    await client.from('teachers').delete().eq('id', teacherId);
                    throw new Error(`Failed to create user account: ${userError.message}`);
                }
                console.log('User account created:', userData);

                hideLoading();
                showModal('Success', `Teacher registered successfully!\n\nTeacher: ${teacherName}\nID: ${teacherId}\nSubjects: ${subjects}\nUsername: ${teacherId}\nPassword: ${password}\n\nYou can now login with these credentials.`, 'success');
                document.getElementById('registerForm').reset();
            } catch (error) {
                console.error('Registration failed:', error);
                hideLoading();
                showModal('Error', `Registration failed: ${error.message}`, 'error');
            }
        });
    }
};

async function renderAnalytics() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    try {
        showLoading();

        console.log('=== FETCHING ANALYTICS DATA ===');

        // Fetch analytics data
        const [studentsResult, teachersResult, classesResult, attendanceResult] = await Promise.all([
            client.from('students').select('*'),
            client.from('teachers').select('*'),
            client.from('classes').select('*'),
            client.from('attendance').select('*')
        ]);

        console.log('Students result:', studentsResult);
        console.log('Students data:', studentsResult.data);
        console.log('Students error:', studentsResult.error);
        console.log('Total students fetched:', studentsResult.data?.length);

        if (studentsResult.error) {
            console.error('ERROR fetching students:', studentsResult.error);
            hideLoading();
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìä School Analytics</h3>
                    <p style="color: red;">Error loading students: ${studentsResult.error.message}</p>
                    <p style="color: orange;">This might be due to Row Level Security (RLS) being enabled. Please disable RLS on the students table or add appropriate policies.</p>
                </div>
            `;
            return;
        }

        if (teachersResult.error) {
            console.error('ERROR fetching teachers:', teachersResult.error);
        }

        if (classesResult.error) {
            console.error('ERROR fetching classes:', classesResult.error);
        }

        const totalStudents = studentsResult.data?.length || 0;
        const activeStudents = studentsResult.data?.filter(s => s.status === 'active').length || 0;
        const totalTeachers = teachersResult.data?.length || 0;
        const totalClasses = classesResult.data?.length || 0;

        console.log('Analytics summary:', { totalStudents, activeStudents, totalTeachers, totalClasses });

        hideLoading();

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìä School Analytics</h3>

            <div class="stats-grid" style="margin-top: 20px;">
                <div class="stat-card">
                    <div class="stat-value">${totalStudents}</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${activeStudents}</div>
                    <div class="stat-label">Active Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalTeachers}</div>
                    <div class="stat-label">Total Teachers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalClasses}</div>
                    <div class="stat-label">Total Classes</div>
                </div>
            </div>

            <div style="margin-top: 40px;">
                <h4>All Students</h4>
                <input type="text" id="studentSearch" class="search-box" placeholder="üîç Search by Student ID, Name, Class, or Parent ID..." onkeyup="filterStudents()">
                <table id="studentsTable" style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Name</th>
                            <th>Class</th>
                            <th>Parent ID</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${studentsResult.data?.sort((a, b) => a.class.localeCompare(b.class) || a.name.localeCompare(b.name)).map(s => `
                            <tr>
                                <td><strong>${s.id}</strong></td>
                                <td>${s.name}</td>
                                <td><span class="badge badge-normal">${s.class}</span></td>
                                <td>${s.parent_id || 'N/A'}</td>
                                <td><span class="badge badge-${s.status}">${s.status}</span></td>
                            </tr>
                        `).join('') || '<tr><td colspan="5">No students found</td></tr>'}
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 40px;">
                <h4>Students by Class Summary</h4>
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Class</th>
                            <th>Total Students</th>
                            <th>Active Students</th>
                            <th>Class Teacher</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${classesResult.data?.map(c => {
                            const classStudents = studentsResult.data?.filter(s => s.class === c.name) || [];
                            const activeInClass = classStudents.filter(s => s.status === 'active').length;
                            return `
                                <tr>
                                    <td><strong>${c.name}</strong></td>
                                    <td>${classStudents.length}</td>
                                    <td>${activeInClass}</td>
                                    <td>${c.class_teacher_id || 'Not Assigned'}</td>
                                </tr>
                            `;
                        }).join('') || '<tr><td colspan="4">No data</td></tr>'}
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 40px;">
                <h4>Teacher Statistics</h4>
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Teacher ID</th>
                            <th>Name</th>
                            <th>Subjects</th>
                            <th>Classes</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${teachersResult.data?.map(t => `
                            <tr>
                                <td>${t.id}</td>
                                <td>${t.name}</td>
                                <td>${t.subjects}</td>
                                <td>${t.classes}</td>
                                <td><span class="badge badge-${t.status}">${t.status}</span></td>
                            </tr>
                        `).join('') || '<tr><td colspan="5">No data</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>
    `;
    } catch (error) {
        console.error('FATAL ERROR in renderAnalytics:', error);
        hideLoading();
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìä School Analytics</h3>
                <p style="color: red;">Error loading analytics: ${error.message}</p>
                <p>Please check the console for details.</p>
            </div>
        `;
    }
}

// Filter students table in analytics
window.filterStudents = function() {
    const searchInput = document.getElementById('studentSearch');
    const filter = searchInput.value.toLowerCase();
    const table = document.getElementById('studentsTable');
    const rows = table.getElementsByTagName('tr');

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        let found = false;

        for (let j = 0; j < cells.length; j++) {
            const cell = cells[j];
            if (cell) {
                const textValue = cell.textContent || cell.innerText;
                if (textValue.toLowerCase().indexOf(filter) > -1) {
                    found = true;
                    break;
                }
            }
        }

        if (found) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
};

// Class Teacher tab functions
async function renderClassDashboard() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        // Get class teacher info
        const { data: classTeacher } = await client
            .from('class_teachers')
            .select('*')
            .eq('id', currentUser.username)
            .maybeSingle();

        if (!classTeacher) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìä Class Dashboard</h3>
                    <p style="color: #e74c3c;">Class teacher information not found.</p>
                </div>
            `;
            return;
        }

        // Get students in the class
        const { data: students } = await client
            .from('students')
            .select('*')
            .eq('class', classTeacher.class)
            .eq('status', 'active');

        // Get recent attendance for this class
        const today = new Date().toISOString().split('T')[0];
        const { data: todayAttendance } = await client
            .from('attendance')
            .select('*')
            .eq('date', today)
            .in('student_id', students?.map(s => s.id) || []);

        const presentCount = todayAttendance?.filter(a => a.type === 'present').length || 0;
        const absentCount = todayAttendance?.filter(a => a.type === 'absent').length || 0;
        const lateCount = todayAttendance?.filter(a => a.type === 'late').length || 0;

        contentArea.innerHTML = `
            <div class="card">
                <h3>üìä Class Dashboard - ${classTeacher.class}</h3>

                <div class="stats-grid" style="margin-top: 30px;">
                    <div class="stat-card">
                        <div class="stat-value">${students?.length || 0}</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card" style="background: #d4edda;">
                        <div class="stat-value">${presentCount}</div>
                        <div class="stat-label">Present Today</div>
                    </div>
                    <div class="stat-card" style="background: #f8d7da;">
                        <div class="stat-value">${absentCount}</div>
                        <div class="stat-label">Absent Today</div>
                    </div>
                    <div class="stat-card" style="background: #fff3cd;">
                        <div class="stat-value">${lateCount}</div>
                        <div class="stat-label">Late Today</div>
                    </div>
                </div>

                <div style="margin-top: 40px;">
                    <h4>Students in ${classTeacher.class}</h4>
                    ${students && students.length > 0 ? `
                        <table style="width: 100%; margin-top: 15px;">
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Parent ID</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${students.map(student => `
                                    <tr>
                                        <td>${student.id}</td>
                                        <td>${student.name}</td>
                                        <td>${student.parent_id || 'N/A'}</td>
                                        <td><span class="badge badge-${student.status}">${student.status}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<p style="margin-top: 15px;">No students in this class.</p>'}
                </div>
            </div>
        `;
    } catch (error) {
        console.error('Error loading class dashboard:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìä Class Dashboard</h3>
                <p style="color: #e74c3c;">Error loading dashboard. Please try again.</p>
            </div>
        `;
    }
}

async function renderCTMarkAttendance() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        // Get class teacher info
        const { data: classTeacher } = await client
            .from('class_teachers')
            .select('*')
            .eq('id', currentUser.username)
            .maybeSingle();

        if (!classTeacher) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>‚úÖ Mark Attendance</h3>
                    <p style="color: #e74c3c;">Class teacher information not found.</p>
                </div>
            `;
            return;
        }

        contentArea.innerHTML = `
            <div class="card">
                <h3>‚úÖ Mark Attendance - ${classTeacher.class}</h3>

                <div style="margin-bottom: 30px;">
                    <div class="form-group">
                        <label for="ctAttendanceDate">Date</label>
                        <input type="date" id="ctAttendanceDate" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="form-group">
                        <label for="ctAttendancePeriod">Period</label>
                        <select id="ctAttendancePeriod">
                            <option value="Period 1">Period 1</option>
                            <option value="Period 2">Period 2</option>
                            <option value="Period 3">Period 3</option>
                            <option value="Period 4">Period 4</option>
                            <option value="Period 5">Period 5</option>
                            <option value="Period 6">Period 6</option>
                            <option value="Period 7">Period 7</option>
                            <option value="Period 8">Period 8</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="loadCTStudentsForAttendance('${classTeacher.class}')">Load Students</button>
                </div>

                <div id="ctAttendanceStudentsList"></div>
            </div>
        `;
    } catch (error) {
        console.error('Error loading attendance page:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>‚úÖ Mark Attendance</h3>
                <p style="color: #e74c3c;">Error loading attendance. Please try again.</p>
            </div>
        `;
    }
}

window.loadCTStudentsForAttendance = async function(className) {
    const date = document.getElementById('ctAttendanceDate').value;
    const period = document.getElementById('ctAttendancePeriod').value;
    const client = window.supabaseClient.getClient();

    // Get students in the class
    const { data: students } = await client
        .from('students')
        .select('*')
        .eq('class', className)
        .eq('status', 'active')
        .order('name');

    if (!students || students.length === 0) {
        document.getElementById('ctAttendanceStudentsList').innerHTML = '<p>No students found in this class.</p>';
        return;
    }

    // Get existing attendance
    const { data: existingAttendance } = await client
        .from('attendance')
        .select('*')
        .eq('date', date)
        .eq('period', period)
        .in('student_id', students.map(s => s.id));

    const attendanceMap = {};
    existingAttendance?.forEach(att => {
        attendanceMap[att.student_id] = att;
    });

    document.getElementById('ctAttendanceStudentsList').innerHTML = `
        <h4>Students in ${className}</h4>
        <form id="ctAttendanceForm">
            <table style="width: 100%; margin-top: 15px;">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Behavior</th>
                    </tr>
                </thead>
                <tbody>
                    ${students.map(student => {
                        const att = attendanceMap[student.id];
                        return `
                            <tr>
                                <td>${student.id}</td>
                                <td>${student.name}</td>
                                <td>
                                    <select class="attendance-status" data-student-id="${student.id}">
                                        <option value="present" ${att?.type === 'present' ? 'selected' : ''}>Present</option>
                                        <option value="absent" ${att?.type === 'absent' ? 'selected' : ''}>Absent</option>
                                        <option value="late" ${att?.type === 'late' ? 'selected' : ''}>Late</option>
                                    </select>
                                </td>
                                <td>
                                    <select class="attendance-behavior" data-student-id="${student.id}">
                                        <option value="excellent" ${att?.behavior === 'excellent' ? 'selected' : ''}>Excellent</option>
                                        <option value="good" ${att?.behavior === 'good' || !att ? 'selected' : ''}>Good</option>
                                        <option value="distracting" ${att?.behavior === 'distracting' ? 'selected' : ''}>Distracting</option>
                                    </select>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
            <div style="margin-top: 20px;">
                <button type="submit" class="btn-primary">Submit Attendance</button>
            </div>
        </form>
    `;

    document.getElementById('ctAttendanceForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await submitAttendance(students, date, period);
    });
};

async function renderReportCards() {
    const contentArea = document.getElementById('contentArea');
    const currentUser = window.auth.getCurrentUser();
    const client = window.supabaseClient.getClient();

    try {
        // Get class teacher info
        const { data: classTeacher } = await client
            .from('class_teachers')
            .select('*')
            .eq('id', currentUser.username)
            .maybeSingle();

        if (!classTeacher) {
            contentArea.innerHTML = `
                <div class="card">
                    <h3>üìÑ Report Cards</h3>
                    <p style="color: #e74c3c;">Class teacher information not found.</p>
                </div>
            `;
            return;
        }

        // Get students in the class
        const { data: students } = await client
            .from('students')
            .select('id, name')
            .eq('class', classTeacher.class)
            .eq('status', 'active')
            .order('name');

        contentArea.innerHTML = `
            <div class="card">
                <h3>üìÑ Report Cards - ${classTeacher.class}</h3>

                <h4>Generate Report Card</h4>
                <form id="reportCardForm" style="max-width: 600px; margin-bottom: 40px;">
                    <div class="form-group">
                        <label for="rcStudent">Select Student</label>
                        <select id="rcStudent" required>
                            <option value="">-- Select Student --</option>
                            ${students?.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('') || ''}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rcTerm">Term</label>
                        <select id="rcTerm" required>
                            <option value="Term 1">Term 1</option>
                            <option value="Term 2">Term 2</option>
                            <option value="Term 3">Term 3</option>
                            <option value="Final">Final</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rcYear">Academic Year</label>
                        <input type="text" id="rcYear" placeholder="e.g., 2024-2025" required>
                    </div>
                    <div class="form-group">
                        <label for="rcPercentage">Overall Percentage</label>
                        <input type="number" id="rcPercentage" min="0" max="100" step="0.01" placeholder="e.g., 85.5">
                    </div>
                    <div class="form-group">
                        <label for="rcGrade">Overall Grade</label>
                        <select id="rcGrade">
                            <option value="A+">A+</option>
                            <option value="A">A</option>
                            <option value="B+">B+</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                            <option value="F">F</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rcRemarks">Remarks</label>
                        <textarea id="rcRemarks" rows="3" placeholder="Teacher's comments"></textarea>
                    </div>
                    <button type="submit" class="btn-primary">Generate Report Card</button>
                </form>

                <h4>Recent Report Cards for ${classTeacher.class}</h4>
                <div id="recentReportCards">Loading...</div>
            </div>
        `;

        // Load recent report cards
        const studentIds = students?.map(s => s.id) || [];
        if (studentIds.length > 0) {
            const { data: reportCards } = await client
                .from('report_cards')
                .select('*, students(name)')
                .in('student_id', studentIds)
                .order('created_at', { ascending: false })
                .limit(10);

            const recentDiv = document.getElementById('recentReportCards');
            if (reportCards && reportCards.length > 0) {
                recentDiv.innerHTML = `
                    <table style="width: 100%; margin-top: 15px;">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Term</th>
                                <th>Year</th>
                                <th>Percentage</th>
                                <th>Grade</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportCards.map(rc => `
                                <tr>
                                    <td>${rc.students?.name || 'N/A'}</td>
                                    <td>${rc.term}</td>
                                    <td>${rc.academic_year}</td>
                                    <td>${rc.overall_percentage || 'N/A'}%</td>
                                    <td><span class="badge">${rc.overall_grade || 'N/A'}</span></td>
                                    <td>${new Date(rc.created_at).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                recentDiv.innerHTML = '<p style="margin-top: 15px;">No report cards generated yet.</p>';
            }
        }

        // Form submit handler
        document.getElementById('reportCardForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const reportCardData = {
                student_id: parseInt(document.getElementById('rcStudent').value),
                term: document.getElementById('rcTerm').value,
                academic_year: document.getElementById('rcYear').value,
                overall_percentage: parseFloat(document.getElementById('rcPercentage').value) || null,
                overall_grade: document.getElementById('rcGrade').value,
                remarks: document.getElementById('rcRemarks').value || null
            };

            try {
                showLoading();
                const { error } = await client
                    .from('report_cards')
                    .insert([reportCardData]);

                if (error) throw error;

                hideLoading();
                showModal('Success', 'Report card generated successfully!', 'success');
                renderReportCards(); // Refresh
            } catch (error) {
                hideLoading();
                showModal('Error', error.message || 'Failed to generate report card', 'error');
            }
        });
    } catch (error) {
        console.error('Error loading report cards:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>üìÑ Report Cards</h3>
                <p style="color: #e74c3c;">Error loading report cards. Please try again.</p>
            </div>
        `;
    }
}

// Generic coming soon function
function renderComingSoon(feature) {
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = `
        <div class="card">
            <h3>${feature}</h3>
            <div style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 72px; margin-bottom: 20px;">üöß</div>
                <h4 style="color: var(--color-primary); margin-bottom: 10px;">Coming Soon</h4>
                <p style="color: #666;">This feature is under development and will be available soon.</p>
            </div>
        </div>
    `;
}

// Logout functionality
document.getElementById('logoutBtn').addEventListener('click', function() {
    showConfirm('Confirm Logout', 'Are you sure you want to logout?', function() {
        window.auth.logout();
    }, null, 'Logout', 'Cancel', false);
});

// Initialize app on page load
window.addEventListener('DOMContentLoaded', initApp);
</script>

</body>
</html>
