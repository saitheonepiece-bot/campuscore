<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusCore - Dashboard</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

<div class="dashboard">
    <!-- Sidebar -->
    <aside class="sidebar">
        <!-- Logo Section -->
        <div class="logo-section">
            <div class="logo-icon">
                <img src="logo.png" alt="CampusCore Logo" style="width: 55px; height: 55px; object-fit: contain;">
            </div>
            <div class="logo-text">
                <h2>CAMPUSCORE</h2>
                <p>Smart Campus</p>
            </div>
        </div>

        <!-- User Block -->
        <div class="user-block">
            <div class="user-avatar" id="userAvatar">?</div>
            <div class="user-name" id="userName">Loading...</div>
            <div class="user-id" id="userId"></div>
            <div class="user-role" id="userRole"></div>
        </div>

        <!-- Menu -->
        <nav>
            <ul class="menu" id="menuList">
                <!-- Menu items will be dynamically generated -->
            </ul>
        </nav>

        <!-- Logout Button -->
        <button class="logout-btn" id="logoutBtn">
            <span class="menu-icon">üö™</span>
            <span>Logout</span>
        </button>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header Banner -->
        <div class="header-banner">
            <h1>Delhi Public School, Nadergul</h1>
            <p>Excellence in Education</p>
        </div>

        <!-- Content Area -->
        <div class="content-area" id="contentArea">
            <!-- Dynamic content will be loaded here -->
        </div>
    </main>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay hidden" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>
</div>

<!-- Load Supabase from CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Load application scripts -->
<script src="assets/js/supabase-client.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/database.js"></script>
<script src="assets/js/utils.js"></script>

<script>
// Global variables
let currentTab = 'home';
let initialized = false;

// Menu items by role
const menuItems = {
    parent: [
        { id: 'home', icon: 'üè†', label: 'Dashboard' },
        { id: 'attendance', icon: 'üìä', label: 'Attendance' },
        { id: 'viewhomework', icon: 'üìù', label: 'Homework' },
        { id: 'viewexamresults', icon: 'üìà', label: 'Exam Results' },
        { id: 'viewreportcards', icon: 'üìÑ', label: 'Report Cards' },
        { id: 'examschedule', icon: 'üìÖ', label: 'Exam Schedule' },
        { id: 'timetable', icon: 'üóìÔ∏è', label: 'Timetable' },
        { id: 'profile', icon: 'üë§', label: 'Profile' },
        { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ],
    teacher: [
        { id: 'home', icon: 'üè†', label: 'Dashboard' },
        { id: 'myduties', icon: 'üìã', label: 'My Duties' },
        { id: 'markattendance', icon: '‚úÖ', label: 'Mark Attendance' },
        { id: 'homework', icon: 'üìù', label: 'Homework' },
        { id: 'examresults', icon: 'üìä', label: 'Exam Results' },
        { id: 'uploadmarks', icon: 'üìà', label: 'Upload Marks' },
        { id: 'myclasses', icon: 'üë•', label: 'My Classes' },
        { id: 'teacherissues', icon: '‚ö†Ô∏è', label: 'Issues' },
        { id: 'timetable', icon: 'üóìÔ∏è', label: 'Timetable' },
        { id: 'profile', icon: 'üë§', label: 'Profile' },
        { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ],
    coordinator: [
        { id: 'home', icon: 'üè†', label: 'Dashboard' },
        { id: 'coordissues', icon: '‚ö†Ô∏è', label: 'Issues' },
        { id: 'uploadexam', icon: 'üìã', label: 'Upload Exam' },
        { id: 'classes', icon: 'üë•', label: 'Classes' },
        { id: 'managetimetable', icon: 'üóìÔ∏è', label: 'Manage Timetable' },
        { id: 'uploadcca', icon: 'üé®', label: 'Upload CCA' },
        { id: 'timetable', icon: 'üìÖ', label: 'View Timetable' },
        { id: 'profile', icon: 'üë§', label: 'Profile' },
        { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ],
    viceprincipal: [
        { id: 'home', icon: 'üè†', label: 'Dashboard' },
        { id: 'appointteacher', icon: 'üë®‚Äçüè´', label: 'Appoint Teacher' },
        { id: 'assignduties', icon: 'üìã', label: 'Assign Duties' },
        { id: 'vpissues', icon: '‚ö†Ô∏è', label: 'Issues' },
        { id: 'removestudent', icon: 'üö´', label: 'Remove Student' },
        { id: 'deletestudent', icon: '‚ùå', label: 'Delete Student' },
        { id: 'holidays', icon: 'üéâ', label: 'Holidays' },
        { id: 'register', icon: 'üìù', label: 'Register' },
        { id: 'analytics', icon: 'üìä', label: 'Analytics' },
        { id: 'timetable', icon: 'üóìÔ∏è', label: 'Timetable' },
        { id: 'profile', icon: 'üë§', label: 'Profile' },
        { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ],
    superviceprincipal: [
        { id: 'home', icon: 'üè†', label: 'Dashboard' },
        { id: 'appointteacher', icon: 'üë®‚Äçüè´', label: 'Appoint Teacher' },
        { id: 'assignduties', icon: 'üìã', label: 'Assign Duties' },
        { id: 'svpissues', icon: '‚ö†Ô∏è', label: 'Issues' },
        { id: 'removestudent', icon: 'üö´', label: 'Remove Student' },
        { id: 'deletestudent', icon: '‚ùå', label: 'Delete Student' },
        { id: 'holidays', icon: 'üéâ', label: 'Holidays' },
        { id: 'register', icon: 'üìù', label: 'Register' },
        { id: 'analytics', icon: 'üìä', label: 'Analytics' },
        { id: 'timetable', icon: 'üóìÔ∏è', label: 'Timetable' },
        { id: 'profile', icon: 'üë§', label: 'Profile' },
        { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ],
    classteacher: [
        { id: 'home', icon: 'üè†', label: 'Dashboard' },
        { id: 'classdashboard', icon: 'üìä', label: 'Class Dashboard' },
        { id: 'ctmarkattendance', icon: '‚úÖ', label: 'Mark Attendance' },
        { id: 'reportcards', icon: 'üìÑ', label: 'Report Cards' },
        { id: 'myduties', icon: 'üìã', label: 'My Duties' },
        { id: 'homework', icon: 'üìù', label: 'Homework' },
        { id: 'teacherissues', icon: '‚ö†Ô∏è', label: 'Issues' },
        { id: 'timetable', icon: 'üóìÔ∏è', label: 'Timetable' },
        { id: 'profile', icon: 'üë§', label: 'Profile' },
        { id: 'changepassword', icon: 'üîê', label: 'Change Password' }
    ]
};

// Initialize application
async function initApp() {
    if (initialized) return;

    try {
        showLoading();

        // Initialize Supabase client
        await window.supabaseClient.init();

        // Initialize database
        window.database.init();

        // Check authentication
        if (!window.auth.requireAuth()) {
            return;
        }

        // Get current user
        const currentUser = window.auth.getCurrentUser();

        // Render user info
        renderUserInfo(currentUser);

        // Render menu
        renderMenu(currentUser.role);

        // Render default tab (home)
        renderTab('home');

        initialized = true;
        hideLoading();
    } catch (error) {
        console.error('Initialization error:', error);
        hideLoading();
        showModal('Error', 'Failed to initialize application. Please refresh the page.', 'error');
    }
}

// Render user info
function renderUserInfo(user) {
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const userId = document.getElementById('userId');
    const userRole = document.getElementById('userRole');

    // Generate avatar initials
    const initials = user.name ? user.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : '?';
    userAvatar.textContent = initials;

    userName.textContent = user.name || user.username;
    userId.textContent = `@${user.username}`;
    userRole.textContent = formatRole(user.role);
}

// Format role for display
function formatRole(role) {
    const roleMap = {
        parent: 'Parent',
        teacher: 'Teacher',
        coordinator: 'Coordinator',
        viceprincipal: 'Vice Principal',
        superviceprincipal: 'Super Vice Principal',
        classteacher: 'Class Teacher'
    };
    return roleMap[role] || role;
}

// Render menu based on role
function renderMenu(role) {
    const menuList = document.getElementById('menuList');
    const items = menuItems[role] || menuItems.parent;

    menuList.innerHTML = items.map(item => `
        <li class="menu-item">
            <button class="menu-link" data-tab="${item.id}">
                <span class="menu-icon">${item.icon}</span>
                <span>${item.label}</span>
            </button>
        </li>
    `).join('');

    // Add click event listeners
    menuList.querySelectorAll('.menu-link').forEach(link => {
        link.addEventListener('click', function() {
            const tab = this.getAttribute('data-tab');
            renderTab(tab);

            // Update active state
            menuList.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Set home as active by default
    const homeLink = menuList.querySelector('[data-tab="home"]');
    if (homeLink) {
        homeLink.classList.add('active');
    }
}

// Render tab content
function renderTab(tabId) {
    currentTab = tabId;
    const contentArea = document.getElementById('contentArea');

    // Clear content
    contentArea.innerHTML = '';

    // Render tab-specific content
    switch(tabId) {
        case 'home':
            renderHomeDashboard();
            break;
        case 'attendance':
            renderAttendance();
            break;
        case 'viewhomework':
            renderViewHomework();
            break;
        case 'viewexamresults':
            renderViewExamResults();
            break;
        case 'viewreportcards':
            renderViewReportCards();
            break;
        case 'examschedule':
            renderExamSchedule();
            break;
        case 'timetable':
            renderTimetable();
            break;
        case 'profile':
            renderProfile();
            break;
        case 'changepassword':
            renderChangePassword();
            break;
        // Teacher tabs
        case 'myduties':
            renderMyDuties();
            break;
        case 'markattendance':
            renderMarkAttendance();
            break;
        case 'homework':
            renderHomework();
            break;
        case 'examresults':
            renderExamResults();
            break;
        case 'uploadmarks':
            renderUploadMarks();
            break;
        case 'myclasses':
            renderMyClasses();
            break;
        case 'teacherissues':
            renderTeacherIssues();
            break;
        // Coordinator tabs
        case 'coordissues':
            renderCoordIssues();
            break;
        case 'uploadexam':
            renderUploadExam();
            break;
        case 'classes':
            renderClasses();
            break;
        case 'managetimetable':
            renderManageTimetable();
            break;
        case 'uploadcca':
            renderUploadCCA();
            break;
        // Vice Principal tabs
        case 'appointteacher':
            renderAppointTeacher();
            break;
        case 'assignduties':
            renderAssignDuties();
            break;
        case 'vpissues':
        case 'svpissues':
            renderVPIssues();
            break;
        case 'removestudent':
            renderRemoveStudent();
            break;
        case 'deletestudent':
            renderDeleteStudent();
            break;
        case 'holidays':
            renderHolidays();
            break;
        case 'register':
            renderRegister();
            break;
        case 'analytics':
            renderAnalytics();
            break;
        // Class Teacher tabs
        case 'classdashboard':
            renderClassDashboard();
            break;
        case 'ctmarkattendance':
            renderCTMarkAttendance();
            break;
        case 'reportcards':
            renderReportCards();
            break;
        default:
            renderComingSoon(tabId);
    }
}

// Tab rendering functions

async function renderHomeDashboard() {
    const currentUser = window.auth.getCurrentUser();
    const contentArea = document.getElementById('contentArea');

    // Show loading state
    contentArea.innerHTML = `
        <div class="card">
            <h3>Welcome, ${currentUser.name}!</h3>
            <p>You are logged in as <strong>${formatRole(currentUser.role)}</strong></p>

            <div class="stats-grid" style="margin-top: 30px;">
                <div class="stat-card">
                    <div class="stat-value">Loading...</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">Loading...</div>
                    <div class="stat-label">Total Teachers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">Loading...</div>
                    <div class="stat-label">Total Classes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">Loading...</div>
                    <div class="stat-label">Pending Issues</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Quick Actions</h3>
            <div class="btn-group">
                <button class="btn-primary" onclick="renderTab('profile')">View Profile</button>
                <button class="btn-secondary" onclick="renderTab('changepassword')">Change Password</button>
            </div>
        </div>
    `;

    try {
        const client = window.supabaseClient.getClient();

        // Fetch statistics in parallel
        const [studentsResult, teachersResult, classesResult, issuesResult] = await Promise.all([
            client.from('students').select('id', { count: 'exact', head: true }),
            client.from('teachers').select('id', { count: 'exact', head: true }),
            client.from('classes').select('id', { count: 'exact', head: true }),
            client.from('issues').select('id', { count: 'exact', head: true }).eq('status', 'pending')
        ]);

        const totalStudents = studentsResult.count || 0;
        const totalTeachers = teachersResult.count || 0;
        const totalClasses = classesResult.count || 0;
        const pendingIssues = issuesResult.count || 0;

        // Update with actual data
        contentArea.innerHTML = `
            <div class="card">
                <h3>Welcome, ${currentUser.name}!</h3>
                <p>You are logged in as <strong>${formatRole(currentUser.role)}</strong></p>

                <div class="stats-grid" style="margin-top: 30px;">
                    <div class="stat-card">
                        <div class="stat-value">${totalStudents}</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalTeachers}</div>
                        <div class="stat-label">Total Teachers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalClasses}</div>
                        <div class="stat-label">Total Classes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${pendingIssues}</div>
                        <div class="stat-label">Pending Issues</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Quick Actions</h3>
                <div class="btn-group">
                    <button class="btn-primary" onclick="renderTab('profile')">View Profile</button>
                    <button class="btn-secondary" onclick="renderTab('changepassword')">Change Password</button>
                </div>
            </div>
        `;
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
        contentArea.innerHTML = `
            <div class="card">
                <h3>Welcome, ${currentUser.name}!</h3>
                <p>You are logged in as <strong>${formatRole(currentUser.role)}</strong></p>

                <div class="stats-grid" style="margin-top: 30px;">
                    <div class="stat-card">
                        <div class="stat-value">-</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">-</div>
                        <div class="stat-label">Total Teachers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">-</div>
                        <div class="stat-label">Total Classes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">-</div>
                        <div class="stat-label">Pending Issues</div>
                    </div>
                </div>
                <p style="color: #e74c3c; margin-top: 20px;">Error loading statistics. Please refresh the page.</p>
            </div>

            <div class="card">
                <h3>Quick Actions</h3>
                <div class="btn-group">
                    <button class="btn-primary" onclick="renderTab('profile')">View Profile</button>
                    <button class="btn-secondary" onclick="renderTab('changepassword')">Change Password</button>
                </div>
            </div>
        `;
    }
}

function renderAttendance() {
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = `
        <div class="card">
            <h3>Attendance Records</h3>
            <div class="attendance-grid">
                <div class="attendance-stat present">
                    <div class="attendance-stat-number">0</div>
                    <div class="attendance-stat-label">Present</div>
                </div>
                <div class="attendance-stat absent">
                    <div class="attendance-stat-number">0</div>
                    <div class="attendance-stat-label">Absent</div>
                </div>
                <div class="attendance-stat late">
                    <div class="attendance-stat-number">0</div>
                    <div class="attendance-stat-label">Late</div>
                </div>
            </div>
            <p style="margin-top: 20px; color: #666;">Attendance data will be displayed here.</p>
        </div>
    `;
}

function renderViewHomework() {
    renderComingSoon('Homework');
}

function renderViewExamResults() {
    renderComingSoon('Exam Results');
}

function renderViewReportCards() {
    renderComingSoon('Report Cards');
}

function renderExamSchedule() {
    renderComingSoon('Exam Schedule');
}

function renderTimetable() {
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = `
        <div class="card">
            <h3>Class Timetable</h3>
            <p style="color: #666;">Timetable will be displayed here.</p>
        </div>
    `;
}

function renderProfile() {
    const currentUser = window.auth.getCurrentUser();
    const contentArea = document.getElementById('contentArea');

    contentArea.innerHTML = `
        <div class="card">
            <h3>Profile Information</h3>
            <div class="form-section">
                <div class="form-row">
                    <div class="form-control">
                        <label>Name</label>
                        <input type="text" value="${currentUser.name || ''}" readonly>
                    </div>
                    <div class="form-control">
                        <label>Username</label>
                        <input type="text" value="${currentUser.username}" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-control">
                        <label>Role</label>
                        <input type="text" value="${formatRole(currentUser.role)}" readonly>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderChangePassword() {
    const contentArea = document.getElementById('contentArea');

    contentArea.innerHTML = `
        <div class="card">
            <h3>Change Password</h3>
            <form id="changePasswordForm" class="form-section">
                <div class="form-row">
                    <div class="form-control">
                        <label>Current Password</label>
                        <input type="password" id="currentPassword" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-control">
                        <label>New Password</label>
                        <input type="password" id="newPassword" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-control">
                        <label>Confirm New Password</label>
                        <input type="password" id="confirmPassword" required>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn-primary">Change Password</button>
                    <button type="button" class="btn-secondary" onclick="renderTab('home')">Cancel</button>
                </div>
            </form>
        </div>
    `;

    // Add form submit handler
    document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            showModal('Error', 'New passwords do not match', 'error');
            return;
        }

        try {
            showLoading();
            await window.auth.changePassword(currentPassword, newPassword);
            hideLoading();
            showModal('Success', 'Password changed successfully', 'success');
            renderTab('home');
        } catch (error) {
            hideLoading();
            showModal('Error', error.message || 'Failed to change password', 'error');
        }
    });
}

// Teacher tab functions
function renderMyDuties() {
    renderComingSoon('My Duties');
}

function renderMarkAttendance() {
    renderComingSoon('Mark Attendance');
}

function renderHomework() {
    renderComingSoon('Homework Management');
}

function renderExamResults() {
    renderComingSoon('Exam Results');
}

function renderUploadMarks() {
    renderComingSoon('Upload Marks');
}

function renderMyClasses() {
    renderComingSoon('My Classes');
}

function renderTeacherIssues() {
    renderComingSoon('Teacher Issues');
}

// Coordinator tab functions
function renderCoordIssues() {
    renderComingSoon('Coordinator Issues');
}

function renderUploadExam() {
    renderComingSoon('Upload Exam');
}

function renderClasses() {
    renderComingSoon('Classes Management');
}

function renderManageTimetable() {
    renderComingSoon('Manage Timetable');
}

function renderUploadCCA() {
    renderComingSoon('Upload CCA');
}

// Vice Principal tab functions

async function renderAppointTeacher() {
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = `
        <div class="card">
            <h3>üë®‚Äçüè´ Appoint Teacher</h3>
            <form id="appointTeacherForm" style="max-width: 600px;">
                <div class="form-group">
                    <label for="teacherId">Teacher ID</label>
                    <input type="text" id="teacherId" placeholder="e.g., T004" required>
                </div>

                <div class="form-group">
                    <label for="teacherName">Teacher Name</label>
                    <input type="text" id="teacherName" placeholder="Enter full name" required>
                </div>

                <div class="form-group">
                    <label for="subjects">Subjects (comma separated)</label>
                    <input type="text" id="subjects" placeholder="e.g., Mathematics, Physics" required>
                </div>

                <div class="form-group">
                    <label for="classes">Classes (comma separated)</label>
                    <input type="text" id="classes" placeholder="e.g., 8B, 10A" required>
                </div>

                <div class="form-group">
                    <label for="teacherPassword">Password</label>
                    <input type="password" id="teacherPassword" placeholder="Set login password" required>
                </div>

                <button type="submit" class="btn-primary">Appoint Teacher</button>
            </form>
        </div>
    `;

    document.getElementById('appointTeacherForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const teacherId = document.getElementById('teacherId').value.trim();
        const teacherName = document.getElementById('teacherName').value.trim();
        const subjects = document.getElementById('subjects').value.trim();
        const classes = document.getElementById('classes').value.trim();
        const password = document.getElementById('teacherPassword').value;

        try {
            showLoading();
            const client = window.supabaseClient.getClient();

            // Insert teacher
            const { error: teacherError } = await client
                .from('teachers')
                .insert([{
                    id: teacherId,
                    name: teacherName,
                    subjects: subjects,
                    classes: classes,
                    status: 'active'
                }]);

            if (teacherError) throw teacherError;

            // Create user account
            const { error: userError } = await client
                .from('users')
                .insert([{
                    username: teacherId,
                    password: password,
                    name: teacherName,
                    role: 'teacher'
                }]);

            if (userError) throw userError;

            hideLoading();
            showModal('Success', `Teacher ${teacherName} appointed successfully!`, 'success');
            document.getElementById('appointTeacherForm').reset();
        } catch (error) {
            hideLoading();
            showModal('Error', error.message || 'Failed to appoint teacher', 'error');
        }
    });
}

async function renderAssignDuties() {
    const contentArea = document.getElementById('contentArea');

    // Load teachers list
    const client = window.supabaseClient.getClient();
    const { data: teachers } = await client
        .from('teachers')
        .select('*')
        .eq('status', 'active')
        .order('name');

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìã Assign Duties</h3>
            <form id="assignDutyForm" style="max-width: 600px;">
                <div class="form-group">
                    <label for="dutyTeacher">Select Teacher</label>
                    <select id="dutyTeacher" required>
                        <option value="">-- Select Teacher --</option>
                        ${teachers.map(t => `<option value="${t.id}">${t.name} (${t.id})</option>`).join('')}
                    </select>
                </div>

                <div class="form-group">
                    <label for="dutyName">Duty Name</label>
                    <input type="text" id="dutyName" placeholder="e.g., Morning Assembly, Exam Invigilation" required>
                </div>

                <div class="form-group">
                    <label for="dutyDate">Duty Date</label>
                    <input type="date" id="dutyDate" required>
                </div>

                <div class="form-group">
                    <label for="dutyTime">Duty Time</label>
                    <input type="text" id="dutyTime" placeholder="e.g., 8:00 AM - 9:00 AM" required>
                </div>

                <div class="form-group">
                    <label for="dutyLocation">Location</label>
                    <input type="text" id="dutyLocation" placeholder="e.g., Main Hall, Class 8B">
                </div>

                <button type="submit" class="btn-primary">Assign Duty</button>
            </form>

            <div style="margin-top: 40px;">
                <h4>Recent Duty Assignments</h4>
                <div id="recentDuties">Loading...</div>
            </div>
        </div>
    `;

    // Load recent duties
    const { data: duties } = await client
        .from('teacher_duties')
        .select('*')
        .order('duty_date', { ascending: false })
        .limit(10);

    const recentDutiesDiv = document.getElementById('recentDuties');
    if (duties && duties.length > 0) {
        recentDutiesDiv.innerHTML = `
            <table style="width: 100%; margin-top: 15px;">
                <thead>
                    <tr>
                        <th>Teacher ID</th>
                        <th>Duty</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Location</th>
                    </tr>
                </thead>
                <tbody>
                    ${duties.map(d => `
                        <tr>
                            <td>${d.teacher_id}</td>
                            <td>${d.duty_name}</td>
                            <td>${new Date(d.duty_date).toLocaleDateString()}</td>
                            <td>${d.duty_time}</td>
                            <td>${d.location || 'N/A'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } else {
        recentDutiesDiv.innerHTML = '<p>No duties assigned yet.</p>';
    }

    document.getElementById('assignDutyForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const user = window.auth.getCurrentUser();
        const teacherId = document.getElementById('dutyTeacher').value;
        const dutyName = document.getElementById('dutyName').value;
        const dutyDate = document.getElementById('dutyDate').value;
        const dutyTime = document.getElementById('dutyTime').value;
        const location = document.getElementById('dutyLocation').value;

        try {
            showLoading();
            const { error } = await client
                .from('teacher_duties')
                .insert([{
                    teacher_id: teacherId,
                    duty_name: dutyName,
                    duty_date: dutyDate,
                    duty_time: dutyTime,
                    location: location,
                    assigned_by: user.username
                }]);

            if (error) throw error;

            hideLoading();
            showModal('Success', 'Duty assigned successfully!', 'success');
            renderAssignDuties(); // Refresh the page
        } catch (error) {
            hideLoading();
            showModal('Error', error.message || 'Failed to assign duty', 'error');
        }
    });
}

async function renderVPIssues() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    const { data: issues } = await client
        .from('issues')
        .select('*')
        .order('created_at', { ascending: false });

    contentArea.innerHTML = `
        <div class="card">
            <h3>‚ö†Ô∏è Issues Management</h3>

            <div style="margin-bottom: 20px;">
                <button class="btn-primary" onclick="showCreateIssueModal()">+ Create New Issue</button>
            </div>

            <div style="margin-bottom: 20px;">
                <button class="btn-filter" onclick="filterIssues('all')" id="filter-all">All (${issues.length})</button>
                <button class="btn-filter" onclick="filterIssues('pending')" id="filter-pending">Pending (${issues.filter(i => i.status === 'pending').length})</button>
                <button class="btn-filter" onclick="filterIssues('in_progress')" id="filter-in_progress">In Progress (${issues.filter(i => i.status === 'in_progress').length})</button>
                <button class="btn-filter" onclick="filterIssues('resolved')" id="filter-resolved">Resolved (${issues.filter(i => i.status === 'resolved').length})</button>
            </div>

            <div id="issuesList">
                ${issues.map(issue => `
                    <div class="issue-card" data-status="${issue.status}">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4>${issue.title}</h4>
                                <p style="color: #666; margin: 5px 0;">${issue.description || 'No description'}</p>
                                <div style="margin-top: 10px;">
                                    <span class="badge badge-${issue.priority}">${issue.priority}</span>
                                    <span class="badge badge-${issue.status}">${issue.status}</span>
                                    ${issue.reported_by ? `<span style="color: #666; font-size: 0.9em;">Reported by: ${issue.reported_by}</span>` : ''}
                                </div>
                            </div>
                            <div>
                                <select onchange="updateIssueStatus(${issue.id}, this.value)" style="padding: 5px;">
                                    <option value="pending" ${issue.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="in_progress" ${issue.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="resolved" ${issue.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                                    <option value="escalated" ${issue.status === 'escalated' ? 'selected' : ''}>Escalated</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>

        <style>
            .issue-card {
                border: 1px solid #ddd;
                padding: 15px;
                margin-bottom: 10px;
                border-radius: 8px;
                background: white;
            }
            .badge {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.85em;
                margin-right: 8px;
            }
            .badge-low { background: #d4edda; color: #155724; }
            .badge-normal { background: #cce5ff; color: #004085; }
            .badge-high { background: #fff3cd; color: #856404; }
            .badge-critical { background: #f8d7da; color: #721c24; }
            .badge-pending { background: #fff3cd; color: #856404; }
            .badge-in_progress { background: #cce5ff; color: #004085; }
            .badge-resolved { background: #d4edda; color: #155724; }
            .badge-escalated { background: #f8d7da; color: #721c24; }
            .btn-filter {
                padding: 8px 15px;
                margin-right: 10px;
                border: 1px solid #ddd;
                background: white;
                cursor: pointer;
                border-radius: 4px;
            }
            .btn-filter.active {
                background: var(--color-primary);
                color: white;
                border-color: var(--color-primary);
            }
        </style>
    `;
}

window.filterIssues = function(status) {
    const issues = document.querySelectorAll('.issue-card');
    document.querySelectorAll('.btn-filter').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`filter-${status}`).classList.add('active');

    issues.forEach(issue => {
        if (status === 'all') {
            issue.style.display = 'block';
        } else {
            issue.style.display = issue.dataset.status === status ? 'block' : 'none';
        }
    });
};

window.updateIssueStatus = async function(issueId, newStatus) {
    try {
        showLoading();
        const { error } = await window.supabaseClient.getClient()
            .from('issues')
            .update({ status: newStatus })
            .eq('id', issueId);

        if (error) throw error;

        hideLoading();
        showModal('Success', 'Issue status updated!', 'success');
        renderVPIssues();
    } catch (error) {
        hideLoading();
        showModal('Error', error.message, 'error');
    }
};

async function renderRemoveStudent() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    const { data: students } = await client
        .from('students')
        .select('*')
        .eq('status', 'active')
        .order('name');

    contentArea.innerHTML = `
        <div class="card">
            <h3>üö´ Remove Student (Mark Inactive)</h3>
            <p style="color: #e74c3c; margin-bottom: 20px;">‚ö†Ô∏è This will mark the student as inactive. Student data will be preserved.</p>

            <table style="width: 100%; margin-top: 20px;">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Class</th>
                        <th>Parent ID</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    ${students.map(s => `
                        <tr>
                            <td>${s.id}</td>
                            <td>${s.name}</td>
                            <td>${s.class}</td>
                            <td>${s.parent_id}</td>
                            <td>
                                <button class="btn-danger" onclick="removeStudent(${s.id}, '${s.name}')">Remove</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

window.removeStudent = async function(studentId, studentName) {
    showModal('Confirm Remove', `Are you sure you want to remove ${studentName}? Student will be marked as inactive.`, 'warning', true, async function() {
        try {
            showLoading();
            const { error } = await window.supabaseClient.getClient()
                .from('students')
                .update({ status: 'inactive' })
                .eq('id', studentId);

            if (error) throw error;

            hideLoading();
            showModal('Success', `${studentName} has been removed (marked inactive)`, 'success');
            renderRemoveStudent();
        } catch (error) {
            hideLoading();
            showModal('Error', error.message, 'error');
        }
    });
};

async function renderDeleteStudent() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    const { data: students } = await client
        .from('students')
        .select('*')
        .eq('status', 'removed')
        .order('name');

    contentArea.innerHTML = `
        <div class="card">
            <h3>‚ùå Delete Student (Permanent)</h3>
            <p style="color: #c0392b; margin-bottom: 20px; font-weight: bold;">‚ö†Ô∏è WARNING: This will PERMANENTLY delete the student. This action CANNOT be undone!</p>
            <p style="margin-bottom: 20px;">Only students marked as "removed" can be permanently deleted.</p>

            ${students.length > 0 ? `
                <table style="width: 100%; margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Name</th>
                            <th>Class</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${students.map(s => `
                            <tr>
                                <td>${s.id}</td>
                                <td>${s.name}</td>
                                <td>${s.class}</td>
                                <td><span class="badge badge-${s.status}">${s.status}</span></td>
                                <td>
                                    <button class="btn-danger" onclick="deleteStudentPermanent(${s.id}, '${s.name}')">Delete Permanently</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p>No students marked as "removed". Use "Remove Student" feature first to mark students for deletion.</p>'}
        </div>
    `;
}

window.deleteStudentPermanent = async function(studentId, studentName) {
    showModal('FINAL WARNING', `You are about to PERMANENTLY DELETE ${studentName}. This CANNOT be undone. Type "DELETE" to confirm.`, 'error', true, async function() {
        try {
            showLoading();
            const { error } = await window.supabaseClient.getClient()
                .from('students')
                .delete()
                .eq('id', studentId);

            if (error) throw error;

            hideLoading();
            showModal('Success', `${studentName} has been permanently deleted`, 'success');
            renderDeleteStudent();
        } catch (error) {
            hideLoading();
            showModal('Error', error.message, 'error');
        }
    });
};

async function renderHolidays() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    const { data: holidays } = await client
        .from('holidays')
        .select('*')
        .order('date', { ascending: true });

    contentArea.innerHTML = `
        <div class="card">
            <h3>üéâ Holidays Management</h3>

            <form id="addHolidayForm" style="max-width: 500px; margin-bottom: 30px;">
                <h4>Add New Holiday</h4>
                <div class="form-group">
                    <label for="holidayDate">Date</label>
                    <input type="date" id="holidayDate" required>
                </div>
                <div class="form-group">
                    <label for="holidayReason">Reason</label>
                    <input type="text" id="holidayReason" placeholder="e.g., Independence Day" required>
                </div>
                <button type="submit" class="btn-primary">Add Holiday</button>
            </form>

            <h4>Upcoming Holidays</h4>
            <table style="width: 100%; margin-top: 15px;">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Reason</th>
                        <th>Day</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    ${holidays.map(h => {
                        const date = new Date(h.date);
                        const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                        return `
                            <tr>
                                <td>${date.toLocaleDateString()}</td>
                                <td>${h.reason}</td>
                                <td>${dayName}</td>
                                <td>
                                    <button class="btn-danger" onclick="deleteHoliday('${h.date}')">Delete</button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;

    document.getElementById('addHolidayForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const date = document.getElementById('holidayDate').value;
        const reason = document.getElementById('holidayReason').value;

        try {
            showLoading();
            const { error } = await client
                .from('holidays')
                .insert([{ date, reason }]);

            if (error) throw error;

            hideLoading();
            showModal('Success', 'Holiday added successfully!', 'success');
            renderHolidays();
        } catch (error) {
            hideLoading();
            showModal('Error', error.message, 'error');
        }
    });
}

window.deleteHoliday = async function(date) {
    showModal('Confirm', 'Delete this holiday?', 'warning', true, async function() {
        try {
            showLoading();
            const { error } = await window.supabaseClient.getClient()
                .from('holidays')
                .delete()
                .eq('date', date);

            if (error) throw error;

            hideLoading();
            showModal('Success', 'Holiday deleted', 'success');
            renderHolidays();
        } catch (error) {
            hideLoading();
            showModal('Error', error.message, 'error');
        }
    });
};

async function renderRegister() {
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = `
        <div class="card">
            <h3>üìù Register New User</h3>

            <div style="margin-bottom: 20px;">
                <label>Select User Type:</label><br>
                <button class="btn-filter" onclick="showRegisterForm('student')" id="reg-student">Student</button>
                <button class="btn-filter" onclick="showRegisterForm('parent')" id="reg-parent">Parent</button>
                <button class="btn-filter" onclick="showRegisterForm('teacher')" id="reg-teacher">Teacher</button>
            </div>

            <div id="registerFormContainer"></div>
        </div>
    `;
}

window.showRegisterForm = function(userType) {
    document.querySelectorAll('.btn-filter').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`reg-${userType}`).classList.add('active');

    const container = document.getElementById('registerFormContainer');

    if (userType === 'student') {
        container.innerHTML = `
            <form id="registerForm" style="max-width: 600px;">
                <h4>Register Student</h4>
                <div class="form-group">
                    <label>Student ID</label>
                    <input type="number" id="studentId" required>
                </div>
                <div class="form-group">
                    <label>Student Name</label>
                    <input type="text" id="studentName" required>
                </div>
                <div class="form-group">
                    <label>Class</label>
                    <input type="text" id="studentClass" placeholder="e.g., 8B" required>
                </div>
                <div class="form-group">
                    <label>Parent ID</label>
                    <input type="text" id="parentId" placeholder="e.g., P3180076A" required>
                </div>
                <button type="submit" class="btn-primary">Register Student</button>
            </form>
        `;

        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const studentData = {
                id: parseInt(document.getElementById('studentId').value),
                name: document.getElementById('studentName').value,
                class: document.getElementById('studentClass').value,
                parent_id: document.getElementById('parentId').value,
                status: 'active'
            };

            try {
                showLoading();
                const { error } = await window.supabaseClient.getClient()
                    .from('students')
                    .insert([studentData]);

                if (error) throw error;

                hideLoading();
                showModal('Success', 'Student registered successfully!', 'success');
                document.getElementById('registerForm').reset();
            } catch (error) {
                hideLoading();
                showModal('Error', error.message, 'error');
            }
        });
    } else if (userType === 'parent') {
        container.innerHTML = `
            <form id="registerForm" style="max-width: 600px;">
                <h4>Register Parent</h4>
                <div class="form-group">
                    <label>Parent ID</label>
                    <input type="text" id="parentId" placeholder="e.g., P3180076A" required>
                </div>
                <div class="form-group">
                    <label>Parent Name</label>
                    <input type="text" id="parentName" required>
                </div>
                <div class="form-group">
                    <label>Student ID</label>
                    <input type="number" id="studentId" required>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="phone" placeholder="10-digit number">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn-primary">Register Parent</button>
            </form>
        `;

        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const parentId = document.getElementById('parentId').value;
            const parentName = document.getElementById('parentName').value;
            const studentId = parseInt(document.getElementById('studentId').value);
            const phone = document.getElementById('phone').value;
            const password = document.getElementById('password').value;

            try {
                showLoading();
                const client = window.supabaseClient.getClient();

                // Insert parent
                const { error: parentError } = await client
                    .from('parents')
                    .insert([{
                        id: parentId,
                        name: parentName,
                        student_id: studentId,
                        phone: phone
                    }]);

                if (parentError) throw parentError;

                // Create user account
                const { error: userError } = await client
                    .from('users')
                    .insert([{
                        username: parentId,
                        password: password,
                        name: parentName,
                        role: 'parent'
                    }]);

                if (userError) throw userError;

                hideLoading();
                showModal('Success', 'Parent registered successfully!', 'success');
                document.getElementById('registerForm').reset();
            } catch (error) {
                hideLoading();
                showModal('Error', error.message, 'error');
            }
        });
    }
};

async function renderAnalytics() {
    const contentArea = document.getElementById('contentArea');
    const client = window.supabaseClient.getClient();

    // Fetch analytics data
    const [studentsResult, teachersResult, classesResult, attendanceResult] = await Promise.all([
        client.from('students').select('*'),
        client.from('teachers').select('*'),
        client.from('classes').select('*'),
        client.from('attendance').select('*')
    ]);

    const totalStudents = studentsResult.data?.length || 0;
    const activeStudents = studentsResult.data?.filter(s => s.status === 'active').length || 0;
    const totalTeachers = teachersResult.data?.length || 0;
    const totalClasses = classesResult.data?.length || 0;

    contentArea.innerHTML = `
        <div class="card">
            <h3>üìä School Analytics</h3>

            <div class="stats-grid" style="margin-top: 20px;">
                <div class="stat-card">
                    <div class="stat-value">${totalStudents}</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${activeStudents}</div>
                    <div class="stat-label">Active Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalTeachers}</div>
                    <div class="stat-label">Total Teachers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalClasses}</div>
                    <div class="stat-label">Total Classes</div>
                </div>
            </div>

            <div style="margin-top: 40px;">
                <h4>Students by Class</h4>
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Class</th>
                            <th>Total Students</th>
                            <th>Class Teacher</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${classesResult.data?.map(c => `
                            <tr>
                                <td>${c.name}</td>
                                <td>${c.total_students}</td>
                                <td>${c.class_teacher_id || 'Not Assigned'}</td>
                            </tr>
                        `).join('') || '<tr><td colspan="3">No data</td></tr>'}
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 40px;">
                <h4>Teacher Statistics</h4>
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Teacher ID</th>
                            <th>Name</th>
                            <th>Subjects</th>
                            <th>Classes</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${teachersResult.data?.map(t => `
                            <tr>
                                <td>${t.id}</td>
                                <td>${t.name}</td>
                                <td>${t.subjects}</td>
                                <td>${t.classes}</td>
                                <td><span class="badge badge-${t.status}">${t.status}</span></td>
                            </tr>
                        `).join('') || '<tr><td colspan="5">No data</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// Class Teacher tab functions
function renderClassDashboard() {
    renderComingSoon('Class Dashboard');
}

function renderCTMarkAttendance() {
    renderComingSoon('Mark Attendance (Class Teacher)');
}

function renderReportCards() {
    renderComingSoon('Report Cards');
}

// Generic coming soon function
function renderComingSoon(feature) {
    const contentArea = document.getElementById('contentArea');
    contentArea.innerHTML = `
        <div class="card">
            <h3>${feature}</h3>
            <div style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 72px; margin-bottom: 20px;">üöß</div>
                <h4 style="color: var(--color-primary); margin-bottom: 10px;">Coming Soon</h4>
                <p style="color: #666;">This feature is under development and will be available soon.</p>
            </div>
        </div>
    `;
}

// Logout functionality
document.getElementById('logoutBtn').addEventListener('click', function() {
    showModal('Confirm Logout', 'Are you sure you want to logout?', 'warning', true, function() {
        window.auth.logout();
    });
});

// Initialize app on page load
window.addEventListener('DOMContentLoaded', initApp);
</script>

</body>
</html>
